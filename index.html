<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Scribbies</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, deleteDoc, onSnapshot, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDGxyWj05Gls74Gexzm1QOfKYf86bNT0k4",
      authDomain: "scribbies.firebaseapp.com",
      projectId: "scribbies",
      storageBucket: "scribbies.firebasestorage.app",
      messagingSenderId: "706156357042",
      appId: "1:706156357042:web:2323ed1f59d91e83d0b0ab"
    };

    // Initialize Firebase
    const firebaseApp = initializeApp(firebaseConfig);
    const auth = getAuth(firebaseApp);
    const db = getFirestore(firebaseApp);
    const googleProvider = new GoogleAuthProvider();

    // Make Firebase functions available globally
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.currentUser = null;

    // Sign in with Google
    window.signInWithGoogle = async function() {
      try {
        const result = await signInWithPopup(auth, googleProvider);
        console.log('Signed in:', result.user.displayName);
        return result.user;
      } catch (error) {
        console.error('Sign in error:', error);
        alert('Sign in failed: ' + error.message);
        return null;
      }
    };

    // Sign out
    window.signOutUser = async function() {
      try {
        await signOut(auth);
        console.log('Signed out');
      } catch (error) {
        console.error('Sign out error:', error);
      }
    };

    // Listen for auth state changes
    onAuthStateChanged(auth, async (user) => {
      window.currentUser = user;
      if (user) {
        console.log('User signed in:', user.displayName, user.uid);
        // Check if user document exists, create if not
        const userRef = doc(db, 'users', user.uid);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) {
          // Create new user document
          await setDoc(userRef, {
            displayName: user.displayName,
            email: user.email,
            photoURL: user.photoURL,
            createdAt: serverTimestamp(),
            graduatedBuddies: []
          });
          console.log('Created new user document');
        }
        // Sync local graduated buddies to cloud
        if (typeof syncToCloud === 'function') {
          syncToCloud();
        }
      } else {
        console.log('User signed out');
      }
      // Re-render to update UI
      if (typeof render === 'function') {
        render();
      }
    });

    // Cloud functions for trading
    window.cloudFunctions = {
      // Save graduated buddy to cloud
      saveGraduatedBuddy: async function(buddy) {
        if (!window.currentUser) return false;
        try {
          const buddyRef = doc(db, 'users', window.currentUser.uid, 'scribbies', buddy.id.toString());
          await setDoc(buddyRef, {
            ...buddy,
            ownerId: window.currentUser.uid,
            ownerName: window.currentUser.displayName,
            updatedAt: serverTimestamp()
          });
          return true;
        } catch (error) {
          console.error('Error saving buddy:', error);
          return false;
        }
      },

      // Create a trade offer - stores item data in Firebase, removes from local inventory
      // tradeData should contain: {type: 'scribby'|'accessory', ...itemData, inventoryPosition: number}
      createTradeOffer: async function(tradeData) {
        if (!window.currentUser) return null;
        try {
          const tradeCode = 'SCRIB-' + Math.random().toString(36).substring(2, 8).toUpperCase();
          const tradeRef = doc(db, 'trades', tradeCode);
          await setDoc(tradeRef, {
            tradeData: tradeData,
            senderId: window.currentUser.uid,
            senderName: window.currentUser.displayName,
            createdAt: serverTimestamp(),
            expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24 hours
            status: 'pending'
          });
          return tradeCode;
        } catch (error) {
          console.error('Error creating trade:', error);
          return null;
        }
      },

      // Claim a trade offer (uses transaction to prevent race conditions)
      // After successful claim, DELETES the trade document to keep DB clean
      claimTradeOffer: async function(tradeCode) {
        if (!window.currentUser) return { success: false, error: 'Must be signed in to receive items' };
        try {
          const tradeRef = doc(db, 'trades', tradeCode.toUpperCase());

          // Use a transaction to ensure only one person can claim
          const result = await runTransaction(db, async (transaction) => {
            const tradeSnap = await transaction.get(tradeRef);

            if (!tradeSnap.exists()) {
              throw new Error('Trade code not found');
            }

            const trade = tradeSnap.data();

            if (trade.status !== 'pending') {
              throw new Error('This trade has already been claimed');
            }

            if (new Date() > trade.expiresAt.toDate()) {
              // Delete expired trade
              transaction.delete(tradeRef);
              throw new Error('This trade code has expired');
            }

            // TEMPORARY: Disabled for testing - re-enable before release!
            // if (trade.senderId === window.currentUser.uid) {
            //   throw new Error('You cannot claim your own trade!');
            // }

            // Delete the trade document (claimed successfully)
            transaction.delete(tradeRef);

            // Return the trade data (supports both old 'buddy' format and new 'tradeData' format)
            return {
              tradeData: trade.tradeData || trade.buddy,
              senderName: trade.senderName,
              senderId: trade.senderId
            };
          });

          return { success: true, tradeData: result.tradeData, senderName: result.senderName, senderId: result.senderId };
        } catch (error) {
          console.error('Error claiming trade:', error);
          return { success: false, error: error.message };
        }
      },

      // Cancel a trade - deletes from Firebase so item can be restored locally
      cancelTrade: async function(tradeCode) {
        if (!window.currentUser) return { success: false, error: 'Must be signed in' };
        try {
          const tradeRef = doc(db, 'trades', tradeCode.toUpperCase());
          const tradeSnap = await getDoc(tradeRef);

          if (!tradeSnap.exists()) {
            return { success: true, alreadyGone: true }; // Already deleted/claimed
          }

          const trade = tradeSnap.data();

          // Only the sender can cancel their own trade
          if (trade.senderId !== window.currentUser.uid) {
            return { success: false, error: 'You can only cancel your own trades' };
          }

          // Delete the trade document
          await deleteDoc(tradeRef);
          return { success: true, tradeData: trade.tradeData || trade.buddy };
        } catch (error) {
          console.error('Error cancelling trade:', error);
          return { success: false, error: error.message };
        }
      },

      // Check if a trade was claimed (returns 'pending', 'claimed', 'expired', or 'not_found')
      // Note: 'claimed' now means deleted, so will return 'not_found' instead
      checkTradeStatus: async function(tradeCode) {
        try {
          const tradeRef = doc(db, 'trades', tradeCode.toUpperCase());
          const tradeSnap = await getDoc(tradeRef);
          if (!tradeSnap.exists()) return 'not_found'; // Could be claimed or never existed
          const trade = tradeSnap.data();
          if (new Date() > trade.expiresAt.toDate()) return 'expired';
          return 'pending';
        } catch (error) {
          console.error('Error checking trade status:', error);
          return 'error';
        }
      },

      // Delete buddy from sender's cloud after successful trade
      deleteBuddyFromCloud: async function(buddyId) {
        if (!window.currentUser) return false;
        try {
          const buddyRef = doc(db, 'users', window.currentUser.uid, 'scribbies', buddyId.toString());
          await deleteDoc(buddyRef);
          return true;
        } catch (error) {
          console.error('Error deleting buddy:', error);
          return false;
        }
      },

      // Load all user's scribbies from cloud
      loadScribbiesFromCloud: async function() {
        if (!window.currentUser) return [];
        try {
          const scribbiesRef = collection(db, 'users', window.currentUser.uid, 'scribbies');
          const snapshot = await getDocs(scribbiesRef);
          return snapshot.docs.map(doc => doc.data());
        } catch (error) {
          console.error('Error loading scribbies:', error);
          return [];
        }
      }
    };

    console.log('Firebase initialized successfully!');
  </script>
  <style>
    @keyframes bounce-slow{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    @keyframes shake{0%,100%{transform:translateX(0)}25%,75%{transform:translateX(-5px)}50%{transform:translateX(5px)}}
    @keyframes wiggle{0%,100%{transform:rotate(0deg)}25%{transform:rotate(-8deg) translateY(-2px)}75%{transform:rotate(8deg) translateY(-2px)}}
    @keyframes penguin-waddle{0%,30%{transform:rotate(0deg)}35%{transform:rotate(-2deg)}40%{transform:rotate(2deg)}45%{transform:rotate(-2deg)}50%{transform:rotate(2deg)}55%{transform:rotate(-2deg)}60%{transform:rotate(2deg)}65%,100%{transform:rotate(0deg)}}
    @keyframes penguin-foot-l{0%,30%{transform:rotate(0deg) translateY(0)}35%{transform:rotate(8deg) translateY(-4px)}40%{transform:rotate(0deg) translateY(0)}45%{transform:rotate(8deg) translateY(-4px)}50%{transform:rotate(0deg) translateY(0)}55%{transform:rotate(8deg) translateY(-4px)}60%,100%{transform:rotate(0deg) translateY(0)}}
    @keyframes penguin-foot-r{0%,32%{transform:rotate(0deg) translateY(0)}37%{transform:rotate(-8deg) translateY(-4px)}42%{transform:rotate(0deg) translateY(0)}47%{transform:rotate(-8deg) translateY(-4px)}52%{transform:rotate(0deg) translateY(0)}57%{transform:rotate(-8deg) translateY(-4px)}62%,100%{transform:rotate(0deg) translateY(0)}}
    @keyframes penguin-flip-l{0%,30%{transform:rotate(15deg)}35%{transform:rotate(45deg)}38%{transform:rotate(15deg)}42%{transform:rotate(45deg)}45%{transform:rotate(15deg)}50%{transform:rotate(45deg)}53%{transform:rotate(15deg)}58%{transform:rotate(45deg)}62%,100%{transform:rotate(15deg)}}
    @keyframes penguin-flip-r{0%,30%{transform:rotate(-15deg)}35%{transform:rotate(-45deg)}38%{transform:rotate(-15deg)}42%{transform:rotate(-45deg)}45%{transform:rotate(-15deg)}50%{transform:rotate(-45deg)}53%{transform:rotate(-15deg)}58%{transform:rotate(-45deg)}62%,100%{transform:rotate(-15deg)}}
    @keyframes penguin-tail{0%,30%{transform:translateX(-50%) rotate(0deg)}35%,40%,45%,50%,55%,60%{transform:translateX(-50%) rotate(5deg)}37%,42%,47%,52%,57%{transform:translateX(-50%) rotate(-5deg)}65%,100%{transform:translateX(-50%) rotate(0deg)}}
    @keyframes duck-waddle{0%,30%{transform:rotate(0deg)}35%{transform:rotate(-4deg)}40%{transform:rotate(4deg)}45%{transform:rotate(-4deg)}50%{transform:rotate(4deg)}55%{transform:rotate(-4deg)}60%{transform:rotate(4deg)}65%,100%{transform:rotate(0deg)}}
    @keyframes duck-leg-l{0%,30%{transform:rotate(0deg)}35%{transform:rotate(15deg)}40%{transform:rotate(0deg)}45%{transform:rotate(15deg)}50%{transform:rotate(0deg)}55%{transform:rotate(15deg)}60%,100%{transform:rotate(0deg)}}
    @keyframes duck-leg-r{0%,32%{transform:rotate(0deg)}37%{transform:rotate(-15deg)}42%{transform:rotate(0deg)}47%{transform:rotate(-15deg)}52%{transform:rotate(0deg)}57%{transform:rotate(-15deg)}62%,100%{transform:rotate(0deg)}}
    @keyframes duck-wing-l{0%,100%{transform:rotate(15deg)}50%{transform:rotate(-20deg)}}
    @keyframes duck-wing-r{0%,100%{transform:rotate(-15deg)}50%{transform:rotate(20deg)}}
    @keyframes duck-quack{0%,70%,100%{transform:translateX(-50%) translateY(0)}75%,85%,95%{transform:translateX(-50%) translateY(3px)}80%,90%{transform:translateX(-50%) translateY(0)}}
    @keyframes duck-tail-wag{0%,30%{transform:translateX(-50%) rotate(0deg)}35%,45%,55%{transform:translateX(-50%) rotate(10deg)}40%,50%,60%{transform:translateX(-50%) rotate(-10deg)}65%,100%{transform:translateX(-50%) rotate(0deg)}}
    @keyframes duck-head-bob{0%,100%{transform:translateY(0)}25%,75%{transform:translateY(-2px)}}
    @keyframes rooster-strut{0%,100%{transform:rotate(0deg) translateY(0)}25%{transform:rotate(-2deg) translateY(-2px)}50%{transform:rotate(0deg) translateY(0)}75%{transform:rotate(2deg) translateY(-2px)}}
    @keyframes rooster-leg-l{0%,100%{transform:rotate(0deg)}25%{transform:rotate(12deg)}50%{transform:rotate(0deg)}75%{transform:rotate(-4deg)}}
    @keyframes rooster-leg-r{0%,100%{transform:rotate(0deg)}25%{transform:rotate(-4deg)}50%{transform:rotate(0deg)}75%{transform:rotate(12deg)}}
    @keyframes rooster-wing{0%,100%{transform:rotate(3deg)}50%{transform:rotate(-5deg)}}
    @keyframes rooster-crow{0%,70%,100%{transform:rotate(0deg)}75%,85%{transform:rotate(-12deg) translateY(-3px)}80%,90%{transform:rotate(-8deg) translateY(-1px)}}
    @keyframes rooster-tail-sway{0%,100%{transform:rotate(-3deg)}50%{transform:rotate(3deg)}}
    @keyframes rooster-wattle{0%,100%{transform:translateX(-50%) rotate(0deg)}50%{transform:translateX(-50%) rotate(4deg)}}
    @keyframes rooster-beak-crow{0%,70%,100%{transform:translateX(-50%) translateY(0)}75%,85%{transform:translateX(-50%) translateY(4px)}80%,90%{transform:translateX(-50%) translateY(2px)}}
    @keyframes rooster-eye-look{0%,20%{top:3px;left:3px}25%,35%{top:3px;left:1px}40%,55%{top:2px;left:3px}60%,75%{top:3px;left:4px}80%,95%{top:4px;left:2px}100%{top:3px;left:3px}}
    @keyframes rooster-blink{0%,92%,100%{transform:scaleY(1)}93%,99%{transform:scaleY(0.1)}}
    @keyframes baby-arm-wave{0%,100%{transform:rotate(-15deg)}25%{transform:rotate(-25deg) translateY(-3px)}50%{transform:rotate(-10deg)}75%{transform:rotate(-20deg) translateY(-2px)}}
    @keyframes baby-leg-kick{0%,100%{transform:rotate(0deg)}20%{transform:rotate(-12deg)}40%{transform:rotate(8deg)}60%{transform:rotate(-8deg)}80%{transform:rotate(10deg)}}
    @keyframes glow{0%,100%{filter:drop-shadow(0 0 5px rgba(168,85,247,0.5))}50%{filter:drop-shadow(0 0 15px rgba(168,85,247,0.8))}}
    @keyframes sparkle{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.7;transform:scale(1.1)}}
    @keyframes collectXP{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-80vh) scale(0.5);opacity:0}}
    @keyframes pop-in{0%{transform:scale(0);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
    @keyframes pulse-grow{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    @keyframes pulse-gentle{0%,100%{opacity:1}50%{opacity:0.85}}
    .animate-pulse-gentle{animation:pulse-gentle 2s ease-in-out infinite}
    /* Practice reaction animations */
    @keyframes practice-bounce{0%{transform:scale(1) translateY(0)}30%{transform:scale(1.15) translateY(-8px)}60%{transform:scale(1.05) translateY(-2px)}100%{transform:scale(1) translateY(0)}}
    @keyframes practice-sad{0%{transform:rotate(0deg)}20%{transform:rotate(-8deg)}40%{transform:rotate(8deg)}60%{transform:rotate(-5deg)}80%{transform:rotate(5deg)}100%{transform:rotate(0deg)}}
    @keyframes practice-celebrate{0%{transform:scale(1) rotate(0deg)}25%{transform:scale(1.2) rotate(-6deg)}50%{transform:scale(1.25) translateY(-10px)}75%{transform:scale(1.2) rotate(6deg)}100%{transform:scale(1) rotate(0deg)}}
    @keyframes float-up{0%{transform:translateY(0) scale(0);opacity:0}20%{transform:translateY(-10px) scale(1.2);opacity:1}100%{transform:translateY(-40px) scale(0.8);opacity:0}}
    @keyframes float-up-hearts{0%{transform:translateY(0) scale(0);opacity:0}15%{transform:translateY(-5px) scale(1.3);opacity:1}100%{transform:translateY(-50px) scale(0.5);opacity:0}}
    .practice-bounce{animation:practice-bounce 0.4s ease-out}
    .practice-sad{animation:practice-sad 0.4s ease-in-out}
    .practice-celebrate{animation:practice-celebrate 0.6s ease-out}
    @keyframes food-fly{0%{transform:translateY(150px) scale(1);opacity:1}60%{transform:translateY(20px) scale(0.8);opacity:1}100%{transform:translateY(0) scale(0);opacity:0}}
    @keyframes reaction-pop{0%{transform:translate(-50%,-50%) scale(0);opacity:0}50%{transform:translate(-50%,-50%) scale(1.3);opacity:1}100%{transform:translate(-50%,-50%) scale(1);opacity:1}}
    @keyframes message-slide{0%{transform:translateY(20px);opacity:0}100%{transform:translateY(0);opacity:1}}
    /* Teen reptile animations */
    @keyframes teen-tail-sway{0%,100%{transform:translateY(-50%) rotate(0deg)}30%{transform:translateY(-50%) rotate(-8deg)}70%{transform:translateY(-50%) rotate(6deg)}}
    @keyframes teen-body-breathe{0%,100%{transform:translateY(-50%) scale(1)}50%{transform:translateY(-50%) scale(1.02,0.98)}}
    @keyframes teen-leg-walk{0%,100%{transform:rotate(0deg)}25%{transform:rotate(8deg)}75%{transform:rotate(-6deg)}}
    @keyframes teen-arm-wave{0%,100%{transform:rotate(45deg)}50%{transform:rotate(60deg)}}
    @keyframes teen-snake-slither{0%,100%{transform:translateY(-50%) skewX(0deg)}30%{transform:translateY(-50%) skewX(3deg)}70%{transform:translateY(-50%) skewX(-3deg)}}
    @keyframes teen-snake-writhe{0%,100%{transform:scaleX(1) skewY(0deg)}25%{transform:scaleX(1.03) skewY(1.5deg)}50%{transform:scaleX(0.98) skewY(-1deg)}75%{transform:scaleX(1.02) skewY(-1.5deg)}}
    .bounce-slow{animation:bounce-slow 2s ease-in-out infinite}
    .shake{animation:shake 0.3s}
    .wiggle{animation:wiggle 1s ease-in-out infinite}
    .glow{animation:glow 2s ease-in-out infinite}
    .sparkle{animation:sparkle 1.5s ease-in-out infinite}
    .collect-xp{animation:collectXP 0.8s ease-in forwards}
    .pop-in{animation:pop-in 0.5s ease-out}
    .pulse-grow{animation:pulse-grow 1.5s ease-in-out infinite}
    #xp-sparkles{position:fixed;pointer-events:none;z-index:9999}
    .xp-sparkle{position:absolute;font-size:24px;animation:collectXP 0.8s ease-in forwards}

    /* Sleeping/snoring animations - ONLY gentle breathing, no other movement */
    @keyframes sleep-breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.015)}}
    @keyframes float-z{0%{opacity:0;transform:translate(0,0) scale(0.5)}20%{opacity:1}80%{opacity:1}100%{opacity:0;transform:translate(20px,-40px) scale(1.2)}}
    @keyframes float-z-delayed{0%{opacity:0;transform:translate(0,0) scale(0.5)}20%{opacity:1}80%{opacity:1}100%{opacity:0;transform:translate(25px,-50px) scale(1.3)}}
    .sleeping{animation:sleep-breathe 4s ease-in-out infinite !important}
    /* Stop creature part animations when sleeping - creature should be completely still except breathing */
    .sleeping div:not(.sleeping-zs):not(.sleeping-z){animation:none !important}
    .sleeping-zs{position:absolute;top:-10px;right:-20px;font-size:24px;pointer-events:none;z-index:100}
    .sleeping-z{position:absolute;font-weight:bold;color:#a78bfa;text-shadow:0 0 4px rgba(167,139,250,0.5)}

    /* Fancy Flamingo animations */
    @keyframes flamingo-sway{0%,100%{transform:rotate(-1deg) translateY(0)}50%{transform:rotate(1deg) translateY(-8px)}}
    @keyframes flamingo-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes neck-bob{0%,100%{transform:rotate(-2deg)}50%{transform:rotate(2deg)}}
    @keyframes wing-flutter-l{0%,100%{transform:rotate(20deg)}50%{transform:rotate(30deg)}}
    @keyframes wing-flutter-r{0%,100%{transform:rotate(-20deg)}50%{transform:rotate(-30deg)}}
    @keyframes tail-wag{0%,100%{transform:rotate(-20deg)}50%{transform:rotate(-10deg)}}
    @keyframes tuft-sway{0%,100%{transform:rotate(var(--base-rotate, 0deg))}50%{transform:rotate(calc(var(--base-rotate, 0deg) + 10deg))}}
    @keyframes flamingo-upper-leg-tuck{0%,40%{transform:rotate(5deg)}45%,95%{transform:rotate(60deg)}100%{transform:rotate(5deg)}}
    @keyframes flamingo-lower-leg-fold{0%,40%{transform:rotate(0deg)}45%,95%{transform:rotate(-140deg)}100%{transform:rotate(0deg)}}
    @keyframes flamingo-foot-tuck{0%,40%{transform:rotate(0deg) scale(1)}45%,95%{transform:rotate(50deg) scale(0.7)}100%{transform:rotate(0deg) scale(1)}}
    /* Swan floating animation */
    @keyframes swan-float{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-3px) rotate(0.5deg)}50%{transform:translateY(-5px) rotate(0deg)}75%{transform:translateY(-3px) rotate(-0.5deg)}}
    @keyframes swan-wing-left{0%,100%{transform:rotate(0deg)}25%{transform:rotate(-2deg)}50%{transform:rotate(-4deg)}75%{transform:rotate(-2deg)}}
    @keyframes swan-wing-right{0%,100%{transform:rotate(0deg)}25%{transform:rotate(2deg)}50%{transform:rotate(4deg)}75%{transform:rotate(2deg)}}
    /* Custom creature creator animations */
    @keyframes swing-custom{0%,100%{transform:rotate(-10deg)}50%{transform:rotate(10deg)}}
    @keyframes breathe-custom{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.05);opacity:0.9}}

    /* Tutorial popup animation */
    @keyframes bounce-in{0%{transform:scale(0.3);opacity:0}50%{transform:scale(1.05)}70%{transform:scale(0.95)}100%{transform:scale(1);opacity:1}}
    .animate-bounce-in{animation:bounce-in 0.4s ease-out forwards}
    .sleeping-z:nth-child(1){animation:float-z 2s ease-out infinite;font-size:16px}
    .sleeping-z:nth-child(2){animation:float-z-delayed 2s ease-out infinite 0.6s;font-size:20px;left:8px}
    .sleeping-z:nth-child(3){animation:float-z 2s ease-out infinite 1.2s;font-size:14px;left:16px}
    /* Closed eyes when sleeping - completely flat line */
    .sleeping .bl-eye{transform:scaleY(0.05) !important;animation:none !important;border-radius:50% !important}
    .sleeping .s-eye{transform:scaleY(0.05) !important;animation:none !important;border-radius:50% !important}
    .sleeping .f-eye{transform:scaleY(0.05) !important;animation:none !important;border-radius:50% !important}
    .sleeping .tn-eye{transform:scaleY(0.05) !important;animation:none !important;border-radius:50% !important}
    .sleeping .dr-eye{transform:scaleY(0.05) !important;animation:none !important;border-radius:50% !important}

    /* XP State Animations */
    /* 10-25%: Drowsy - slow sway, half-closed eyes */
    @keyframes drowsy-sway{0%,100%{transform:rotate(-2deg)}50%{transform:rotate(2deg)}}
    .drowsy{animation:drowsy-sway 4s ease-in-out infinite !important}
    .drowsy .bl-eye,.drowsy .s-eye,.drowsy .f-eye,.drowsy .tn-eye,.drowsy .dr-eye{transform:scaleY(0.6) !important}

    /* 25-50%: Awake - normal idle, looking around */
    @keyframes awake-idle{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
    .awake{animation:awake-idle 2s ease-in-out infinite !important}

    /* 50-75%: Happy - faster bounce, sparkles */
    @keyframes happy-bounce{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-8px) scale(1.02)}}
    .happy{animation:happy-bounce 1.2s ease-in-out infinite !important}
    .happy::after{content:'âœ¨';position:absolute;top:-15px;right:-10px;font-size:16px;animation:sparkle-float 2s ease-in-out infinite;pointer-events:none}
    @keyframes sparkle-float{0%,100%{opacity:0.5;transform:translateY(0) scale(0.8)}50%{opacity:1;transform:translateY(-5px) scale(1.1)}}

    /* 75-90%: Excited - energetic bounce, glow, hearts/stars */
    @keyframes excited-bounce{0%,100%{transform:translateY(0) scale(1)}25%{transform:translateY(-12px) scale(1.05)}50%{transform:translateY(-2px) scale(0.98)}75%{transform:translateY(-10px) scale(1.03)}}
    .excited{animation:excited-bounce 0.8s ease-in-out infinite !important;filter:drop-shadow(0 0 8px rgba(168,85,247,0.5))}
    .excited-particles{position:absolute;top:-20px;left:50%;transform:translateX(-50%);pointer-events:none;font-size:14px}
    .excited-particles span{position:absolute;animation:particle-burst 1.5s ease-out infinite}
    .excited-particles span:nth-child(1){animation-delay:0s;left:-20px}
    .excited-particles span:nth-child(2){animation-delay:0.5s;left:0}
    .excited-particles span:nth-child(3){animation-delay:1s;left:20px}
    @keyframes particle-burst{0%{opacity:0;transform:translateY(10px) scale(0.5)}30%{opacity:1;transform:translateY(-15px) scale(1)}100%{opacity:0;transform:translateY(-30px) scale(0.7)}}

    /* 90-100%: Ready to evolve - intense glow, shake, rainbow pulse */
    @keyframes ready-shake{0%,100%{transform:translateX(0) scale(1)}10%{transform:translateX(-3px) scale(1.02)}20%{transform:translateX(3px) scale(1.02)}30%{transform:translateX(-3px) scale(1.01)}40%{transform:translateX(3px) scale(1.01)}50%{transform:translateX(0) translateY(-5px) scale(1.03)}60%{transform:translateX(-2px)}70%{transform:translateX(2px)}80%{transform:translateX(-2px)}90%{transform:translateX(2px)}}
    @keyframes rainbow-glow{0%{filter:drop-shadow(0 0 12px rgba(255,100,100,0.7))}25%{filter:drop-shadow(0 0 15px rgba(255,200,100,0.7))}50%{filter:drop-shadow(0 0 12px rgba(100,255,150,0.7))}75%{filter:drop-shadow(0 0 15px rgba(150,100,255,0.7))}100%{filter:drop-shadow(0 0 12px rgba(255,100,100,0.7))}}
    .ready-evolve{animation:ready-shake 0.6s ease-in-out infinite,rainbow-glow 2s linear infinite !important}
    .ready-sparkles{position:absolute;top:-25px;left:50%;transform:translateX(-50%);pointer-events:none}
    .ready-sparkles span{position:absolute;font-size:18px;animation:rainbow-sparkle 1s ease-out infinite}
    .ready-sparkles span:nth-child(1){left:-30px;animation-delay:0s}
    .ready-sparkles span:nth-child(2){left:-10px;animation-delay:0.2s}
    .ready-sparkles span:nth-child(3){left:10px;animation-delay:0.4s}
    .ready-sparkles span:nth-child(4){left:30px;animation-delay:0.6s}
    @keyframes rainbow-sparkle{0%{opacity:0;transform:translateY(20px) rotate(0deg) scale(0.3)}50%{opacity:1;transform:translateY(-10px) rotate(180deg) scale(1.2)}100%{opacity:0;transform:translateY(-30px) rotate(360deg) scale(0.5)}}

    /* Milestone confetti burst */
    .confetti-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;overflow:hidden}
    .confetti{position:absolute;width:10px;height:10px;opacity:0;animation:confetti-fall 3s ease-out forwards}
    @keyframes confetti-fall{0%{opacity:1;transform:translateY(0) rotate(0deg) scale(1)}100%{opacity:0;transform:translateY(100vh) rotate(720deg) scale(0.5)}}

    /* Egg crack overlays */
    .egg-container{position:relative;display:inline-block;transition:none !important}
    .egg-crack-1{position:absolute;top:30%;left:50%;width:2px;height:40%;background:linear-gradient(to bottom,rgba(0,0,0,0.4),rgba(0,0,0,0.6));transform:translateX(-50%) rotate(-15deg)}
    .egg-crack-2{position:absolute;top:25%;left:60%;width:1.5px;height:35%;background:linear-gradient(to bottom,rgba(0,0,0,0.3),rgba(0,0,0,0.5));transform:rotate(10deg)}
    .egg-crack-3{position:absolute;top:40%;left:40%;width:1.5px;height:30%;background:linear-gradient(to bottom,rgba(0,0,0,0.35),rgba(0,0,0,0.55));transform:rotate(-25deg)}
    .egg-crack-4{position:absolute;top:50%;left:55%;width:2px;height:25%;background:linear-gradient(to bottom,rgba(0,0,0,0.4),rgba(0,0,0,0.6));transform:rotate(5deg)}

    /* Fluff ball creature - PREFIX: bl- */
    .bl-creature{position:relative;width:90px;height:90px;display:inline-block;animation:bl-float 2.5s ease-in-out infinite}
    .bl-body{width:70px;height:70px;background:radial-gradient(circle at 40% 35%,rgba(255,255,255,0.95),rgba(236,72,153,0.85),rgba(168,85,247,0.9));border-radius:50%;position:absolute;top:10px;left:10px;box-shadow:0 0 0 3px rgba(255,255,255,0.4),0 0 0 6px rgba(236,72,153,0.3),0 0 0 9px rgba(168,85,247,0.2),0 4px 12px rgba(124,58,237,0.4);animation:bl-fluff-pulse 2s ease-in-out infinite}
    .bl-eyes{position:absolute;top:28px;left:50%;transform:translateX(-50%);display:flex;gap:14px;z-index:2}
    .bl-eye{width:16px;height:16px;background:rgba(0,0,0,0.95);border-radius:50%;position:relative;animation:bl-blink 4s ease-in-out infinite}
    .bl-eye-shine{position:absolute;top:3px;left:4px;width:5px;height:5px;background:white;border-radius:50%;opacity:1}
    .bl-arm{position:absolute;width:18px;height:12px;background:radial-gradient(ellipse at center,rgba(255,255,255,0.9),rgba(236,72,153,0.7));border-radius:50% 50% 60% 60%;top:38px;box-shadow:0 0 3px rgba(168,85,247,0.3);animation:bl-arm-wiggle 1.5s ease-in-out infinite}
    .bl-arm-left{left:-8px;transform:rotate(-20deg)}
    .bl-arm-right{right:-8px;transform:rotate(20deg)}
    .bl-leg{position:absolute;width:16px;height:14px;background:radial-gradient(ellipse at center,rgba(255,255,255,0.9),rgba(236,72,153,0.7));border-radius:50% 50% 70% 70%;bottom:2px;box-shadow:0 0 3px rgba(168,85,247,0.3);animation:bl-leg-wiggle 2s ease-in-out infinite}
    .bl-leg-left{left:16px}
    .bl-leg-right{right:16px}

    /* Teen creature styling - PREFIX: tn- */
    .tn-creature{position:relative;display:inline-block;animation:tn-float 3s ease-in-out infinite}
    .tn-glow{position:absolute;inset:-15px;background:radial-gradient(circle,var(--tn-glow-color,rgba(168,85,247,0.2)),transparent 60%);border-radius:50%;animation:tn-glow-pulse 3s ease-in-out infinite;pointer-events:none}
    .tn-shadow{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);width:80%;height:20px;background:radial-gradient(ellipse,rgba(0,0,0,0.25),transparent 70%);border-radius:50%;filter:blur(6px);animation:tn-shadow-pulse 3s ease-in-out infinite}
    .tn-body{position:relative;border-radius:30px;box-shadow:0 8px 32px rgba(0,0,0,0.15),0 0 0 3px rgba(255,255,255,0.2),inset 0 -8px 20px rgba(0,0,0,0.1)}
    @keyframes tn-float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes tn-glow-pulse{0%,100%{opacity:0.6;transform:scale(1)}50%{opacity:1;transform:scale(1.05)}}
    @keyframes tn-shadow-pulse{0%,100%{opacity:0.4;transform:translateX(-50%) scale(1)}50%{opacity:0.25;transform:translateX(-50%) scale(0.85)}}

    /* Adult creature ground shadow - closer to body since they're bigger */
    .adult-shadow{position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:70%;height:18px;background:radial-gradient(ellipse,rgba(0,0,0,0.2),transparent 70%);border-radius:50%;filter:blur(5px);animation:adult-shadow-pulse 3s ease-in-out infinite;pointer-events:none;z-index:1}
    @keyframes adult-shadow-pulse{0%,100%{opacity:0.35;transform:translateX(-50%) scale(1)}50%{opacity:0.2;transform:translateX(-50%) scale(0.9)}}

    /* Egg ground shadow - replaces ground effects */
    .egg-shadow{position:absolute;bottom:-5px;left:50%;transform:translateX(-50%);width:65%;height:15px;background:radial-gradient(ellipse,rgba(0,0,0,0.18),transparent 70%);border-radius:50%;filter:blur(4px);animation:egg-shadow-pulse 3s ease-in-out infinite;pointer-events:none;z-index:0}
    @keyframes egg-shadow-pulse{0%,100%{opacity:0.3;transform:translateX(-50%) scale(1)}50%{opacity:0.15;transform:translateX(-50%) scale(0.85)}}

    /* Blob ground shadow - simple shadow like adults */
    .blob-shadow{position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:70%;height:14px;background:radial-gradient(ellipse,rgba(0,0,0,0.2),transparent 70%);border-radius:50%;filter:blur(4px);animation:blob-shadow-pulse 2.5s ease-in-out infinite;pointer-events:none;z-index:0}
    @keyframes blob-shadow-pulse{0%,100%{opacity:0.3;transform:translateX(-50%) scale(1)}50%{opacity:0.18;transform:translateX(-50%) scale(0.88)}}

    /* Blob creature animations - PREFIX: bl- */
    @keyframes bl-float{0%,100%{transform:translateY(0px)}50%{transform:translateY(-6px)}}
    @keyframes bl-fluff-pulse{0%,100%{box-shadow:0 0 0 3px rgba(255,255,255,0.4),0 0 0 6px rgba(236,72,153,0.3),0 0 0 9px rgba(168,85,247,0.2),0 4px 12px rgba(124,58,237,0.4)}50%{box-shadow:0 0 0 4px rgba(255,255,255,0.5),0 0 0 8px rgba(236,72,153,0.4),0 0 0 12px rgba(168,85,247,0.3),0 4px 12px rgba(124,58,237,0.5)}}
    @keyframes bl-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes bl-arm-wiggle{0%,100%{transform:rotate(-25deg) translateY(0)}25%{transform:rotate(-10deg) translateY(-3px)}50%{transform:rotate(-20deg) translateY(-1px)}75%{transform:rotate(-5deg) translateY(-4px)}}
    @keyframes bl-leg-wiggle{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-4px) rotate(-5deg)}50%{transform:translateY(-2px) rotate(0deg)}75%{transform:translateY(-5px) rotate(5deg)}}
    @keyframes flapLeft{0%,100%{transform:translateY(-50%) rotate(0deg)}50%{transform:translateY(-50%) rotate(-25deg)}}
    @keyframes flapRight{0%,100%{transform:translateY(-50%) rotate(0deg)}50%{transform:translateY(-50%) rotate(25deg)}}

    /* Adult bird animations */
    @keyframes wing-flap-left{0%,100%{transform:translateY(-50%) rotate(-5deg) scaleY(1)}50%{transform:translateY(-50%) rotate(-35deg) scaleY(1.1)}}
    @keyframes wing-flap-right{0%,100%{transform:translateY(-50%) rotate(5deg) scaleY(1)}50%{transform:translateY(-50%) rotate(35deg) scaleY(1.1)}}
    @keyframes tail-sway{0%,100%{transform:rotate(0deg) translateX(0)}50%{transform:rotate(-8deg) translateX(-2px)}}
    @keyframes head-bob{0%,100%{transform:translateY(0) translateX(-50%)}50%{transform:translateY(-3px) translateX(-50%)}}
    @keyframes neck-sway{0%,100%{transform:rotate(15deg)}50%{transform:rotate(18deg)}}
    @keyframes peacock-fan{0%,100%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.05)}}
    @keyframes peacock-fan-dance{0%,15%{transform:rotate(0deg) translateY(0) scale(0.6)}35%{transform:rotate(var(--angle)) translateY(var(--y)) scale(1)}40%,60%{transform:rotate(calc(var(--angle) + 1deg)) translateY(var(--y)) scale(1.02)}65%{transform:rotate(calc(var(--angle) - 1deg)) translateY(var(--y)) scale(1.02)}70%{transform:rotate(var(--angle)) translateY(var(--y)) scale(1)}85%,100%{transform:rotate(0deg) translateY(0) scale(0.6)}}
    @keyframes peacock-strut{0%,100%{transform:translateY(0) rotate(0deg)}12%{transform:translateY(-3px) rotate(1deg)}25%{transform:translateY(0) rotate(0deg)}37%{transform:translateY(-3px) rotate(-1deg)}50%{transform:translateY(0) rotate(0deg)}62%{transform:translateY(-3px) rotate(1deg)}75%{transform:translateY(0) rotate(0deg)}87%{transform:translateY(-3px) rotate(-1deg)}}
    @keyframes peacock-leg-left{0%,100%{transform:rotate(0deg)}12%{transform:rotate(12deg) translateY(-2px)}25%{transform:rotate(0deg)}37%{transform:rotate(-6deg)}50%{transform:rotate(0deg)}62%{transform:rotate(12deg) translateY(-2px)}75%{transform:rotate(0deg)}87%{transform:rotate(-6deg)}}
    @keyframes peacock-leg-right{0%,100%{transform:rotate(0deg)}12%{transform:rotate(-6deg)}25%{transform:rotate(0deg)}37%{transform:rotate(12deg) translateY(-2px)}50%{transform:rotate(0deg)}62%{transform:rotate(-6deg)}75%{transform:rotate(0deg)}87%{transform:rotate(12deg) translateY(-2px)}}
    @keyframes peacock-shimmer{0%{filter:brightness(1) hue-rotate(0deg)}25%{filter:brightness(1.1) hue-rotate(8deg)}50%{filter:brightness(1.2) hue-rotate(0deg)}75%{filter:brightness(1.1) hue-rotate(-8deg)}100%{filter:brightness(1) hue-rotate(0deg)}}
    @keyframes peacock-crest{0%,100%{transform:rotate(0deg)}50%{transform:rotate(12deg)}}
    @keyframes owl-head-scan{0%,15%{transform:rotate(0deg)}20%,35%{transform:rotate(-55deg)}40%,55%{transform:rotate(55deg)}60%,100%{transform:rotate(0deg)}}
    @keyframes owl-eye-look{0%,10%{transform:translate(0,0)}15%,25%{transform:translate(-2px,-3px)}30%,40%{transform:translate(0,-4px)}45%,55%{transform:translate(2px,-3px)}60%,70%{transform:translate(0,0)}75%,85%{transform:translate(0,-2px)}90%,100%{transform:translate(0,0)}}
    @keyframes owl-wing-flap-l{0%,100%{transform:rotate(12deg)}50%{transform:rotate(-25deg)}}
    @keyframes owl-wing-flap-r{0%,100%{transform:rotate(-12deg)}50%{transform:rotate(25deg)}}
    @keyframes owl-breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
    @keyframes ladybug-bob{0%,30%{transform:translateY(0)}15%{transform:translateY(-3px)}40%,70%{transform:translateY(0)}85%{transform:translateY(-3px)}100%{transform:translateY(0)}}
    @keyframes ladybug-scuttle-a{0%,30%,70%,100%{transform:rotate(var(--base-rot,0deg))}5%,15%,25%,75%,85%,95%{transform:rotate(calc(var(--base-rot,0deg) - 12deg)) translateY(-3px)}10%,20%,80%,90%{transform:rotate(var(--base-rot,0deg))}}
    @keyframes ladybug-scuttle-b{0%,30%,70%,100%{transform:rotate(calc(var(--base-rot,0deg) - 12deg)) translateY(-3px)}5%,15%,25%,75%,85%,95%{transform:rotate(var(--base-rot,0deg))}10%,20%,80%,90%{transform:rotate(calc(var(--base-rot,0deg) - 12deg)) translateY(-3px)}}
    @keyframes ladybug-antenna{0%,30%{transform:rotate(-15deg)}35%{transform:rotate(-8deg)}40%{transform:rotate(-20deg)}45%{transform:rotate(-8deg)}50%{transform:rotate(-18deg)}65%,100%{transform:rotate(-15deg)}}
    @keyframes ladybug-shine{0%,100%{opacity:0.4}50%{opacity:0.6}}
    @keyframes dragonfly-hover{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
    @keyframes dragonfly-flutter-fore{0%{transform:rotate(0deg) scaleY(1)}25%{transform:rotate(3deg) scaleY(0.85)}50%{transform:rotate(0deg) scaleY(0.2)}75%{transform:rotate(-3deg) scaleY(0.85)}100%{transform:rotate(0deg) scaleY(1)}}
    @keyframes dragonfly-flutter-hind{0%{transform:rotate(0deg) scaleY(1)}25%{transform:rotate(-2deg) scaleY(0.85)}50%{transform:rotate(0deg) scaleY(0.2)}75%{transform:rotate(2deg) scaleY(0.85)}100%{transform:rotate(0deg) scaleY(1)}}
    @keyframes dragonfly-tail-pulse{0%,100%{filter:brightness(1);box-shadow:0 0 3px #22d3ee}50%{filter:brightness(1.3);box-shadow:0 0 10px #22d3ee}}
    @keyframes dragonfly-tail-sway{0%,100%{transform:rotate(3deg)}50%{transform:rotate(-3deg)}}
    @keyframes dragonfly-antenna-sway{0%,100%{transform:rotate(-20deg)}50%{transform:rotate(-12deg)}}
    @keyframes dragonfly-leg-twitch{0%,100%{transform:rotate(0deg)}50%{transform:rotate(4deg)}}
    @keyframes fly-hover{0%,100%{transform:translateY(0) scale(1) rotate(0deg)}5%{transform:translateY(-5px) scale(1) rotate(2deg)}10%{transform:translateY(-8px) scale(1.1) rotate(-1deg)}20%{transform:translateY(-12px) scale(1.35) rotate(0deg)}25%{transform:translateY(-10px) scale(1.4) rotate(-8deg)}30%{transform:translateY(-8px) scale(1.4) rotate(10deg)}35%{transform:translateY(-12px) scale(1.4) rotate(-6deg)}40%{transform:translateY(-10px) scale(1.4) rotate(8deg)}45%{transform:translateY(-8px) scale(1.35) rotate(0deg)}55%{transform:translateY(-10px) scale(1.2) rotate(3deg)}65%{transform:translateY(-5px) scale(1.1) rotate(-2deg)}75%{transform:translateY(-8px) scale(1.05) rotate(1deg)}85%{transform:translateY(-3px) scale(1) rotate(-1deg)}95%{transform:translateY(-6px) scale(1) rotate(2deg)}}
    @keyframes fly-wing-buzz{0%{transform:scaleY(1) rotate(0deg)}25%{transform:scaleY(0.3) rotate(5deg)}50%{transform:scaleY(1) rotate(0deg)}75%{transform:scaleY(0.3) rotate(-5deg)}100%{transform:scaleY(1) rotate(0deg)}}
    @keyframes fly-leg-dangle{0%,100%{transform:rotate(var(--base-rot,0deg))}50%{transform:rotate(calc(var(--base-rot,0deg) + 8deg))}}
    @keyframes fly-antenna-twitch{0%,100%{transform:rotate(-15deg)}30%{transform:rotate(-20deg)}60%{transform:rotate(-10deg)}}
    @keyframes beetle-idle{0%,100%{transform:translateY(0) rotate(0deg)}15%{transform:translateY(-2px) rotate(1deg)}30%{transform:translateY(0) rotate(0deg)}45%{transform:translateY(-3px) rotate(-1deg)}60%{transform:translateY(-1px) rotate(0deg)}75%{transform:translateY(-2px) rotate(1deg)}90%{transform:translateY(0) rotate(-0.5deg)}}
    @keyframes beetle-leg-twitch{0%,85%,100%{transform:rotate(0deg)}88%{transform:rotate(8deg)}91%{transform:rotate(-5deg)}94%{transform:rotate(6deg)}97%{transform:rotate(0deg)}}
    @keyframes beetle-elytra-l{0%,70%,100%{transform:rotateY(0deg)}72%,95%{transform:rotateY(-85deg)}}
    @keyframes beetle-elytra-r{0%,70%,100%{transform:rotateY(0deg)}72%,95%{transform:rotateY(85deg)}}
    @keyframes beetle-elytra-open-l{0%,70%,100%{transform:rotate(0deg)}72%,95%{transform:rotate(55deg)}}
    @keyframes beetle-elytra-open-r{0%,70%,100%{transform:rotate(0deg)}72%,95%{transform:rotate(-55deg)}}
    @keyframes beetle-flight-wing-l{0%,70%,100%{opacity:0;transform:translateX(0) rotate(0deg)}72%{opacity:1;transform:translateX(-95px) rotate(-8deg)}74%,78%,82%,86%,90%{opacity:1;transform:translateX(-95px) rotate(-15deg)}76%,80%,84%,88%,92%{opacity:1;transform:translateX(-95px) rotate(3deg)}94%{opacity:1;transform:translateX(-95px) rotate(-8deg)}95%{opacity:0;transform:translateX(0) rotate(0deg)}}
    @keyframes beetle-flight-wing-r{0%,70%,100%{opacity:0;transform:translateX(0) rotate(0deg)}72%{opacity:1;transform:translateX(95px) rotate(8deg)}74%,78%,82%,86%,90%{opacity:1;transform:translateX(95px) rotate(15deg)}76%,80%,84%,88%,92%{opacity:1;transform:translateX(95px) rotate(-3deg)}94%{opacity:1;transform:translateX(95px) rotate(8deg)}95%{opacity:0;transform:translateX(0) rotate(0deg)}}
    @keyframes beetle-antenna{0%,100%{transform:rotate(-20deg)}50%{transform:rotate(-12deg)}}
    @keyframes mandible-snap-l{0%,60%,100%{transform:rotate(0deg)}70%,90%{transform:rotate(38deg)}80%{transform:rotate(35deg)}}
    @keyframes mandible-snap-r{0%,60%,100%{transform:rotate(0deg)}70%,90%{transform:rotate(-38deg)}80%{transform:rotate(-35deg)}}
    @keyframes bee-float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
    @keyframes bee-wing-l{0%{transform:rotateY(5deg)}100%{transform:rotateY(70deg)}}
    @keyframes bee-wing-r{0%{transform:rotateY(-5deg)}100%{transform:rotateY(-70deg)}}
    @keyframes ant-sway{0%,100%{transform:rotate(-15deg)}50%{transform:rotate(-30deg)}}
    @keyframes firefly-float{0%,100%{transform:translateY(0)}25%{transform:translateY(-8px)}50%{transform:translateY(-4px)}75%{transform:translateY(-10px)}}
    @keyframes firefly-elytra-l{0%,70%,100%{transform:rotate(0deg)}75%,95%{transform:rotate(35deg)}}
    @keyframes firefly-elytra-r{0%,70%,100%{transform:rotate(0deg)}75%,95%{transform:rotate(-35deg)}}
    @keyframes firefly-flight-wing-l{0%,70%,100%{opacity:0;transform:translateX(0)}72%{opacity:1;transform:translateX(-95px)}74%,78%,82%,86%,90%{opacity:1;transform:translateX(-95px) rotate(-12deg)}76%,80%,84%,88%,92%{opacity:1;transform:translateX(-95px) rotate(5deg)}94%{opacity:1;transform:translateX(-95px)}95%{opacity:0;transform:translateX(0)}}
    @keyframes firefly-flight-wing-r{0%,70%,100%{opacity:0;transform:translateX(0)}72%{opacity:1;transform:translateX(95px)}74%,78%,82%,86%,90%{opacity:1;transform:translateX(95px) rotate(12deg)}76%,80%,84%,88%,92%{opacity:1;transform:translateX(95px) rotate(-5deg)}94%{opacity:1;transform:translateX(95px)}95%{opacity:0;transform:translateX(0)}}
    @keyframes firefly-antenna-l{0%,100%{transform:rotate(-20deg)}50%{transform:rotate(-30deg)}}
    @keyframes firefly-antenna-r{0%,100%{transform:rotate(20deg)}50%{transform:rotate(30deg)}}
    @keyframes firefly-glow{0%,45%{opacity:1;box-shadow:0 0 25px #f5f99a,0 0 45px rgba(245,250,150,0.6),0 0 65px rgba(245,250,150,0.3)}50%,95%{opacity:0.15;box-shadow:0 0 5px rgba(200,210,100,0.2)}100%{opacity:1;box-shadow:0 0 25px #f5f99a,0 0 45px rgba(245,250,150,0.6),0 0 65px rgba(245,250,150,0.3)}}
    @keyframes firefly-glow-seg1{0%,45%{background:linear-gradient(180deg,#6a6a4a,#8b8b6a,#b0b080);box-shadow:0 0 8px rgba(180,190,100,0.4)}50%,95%{background:linear-gradient(180deg,#3a3a2a,#4a4a3a,#5a5a4a);box-shadow:none}100%{background:linear-gradient(180deg,#6a6a4a,#8b8b6a,#b0b080);box-shadow:0 0 8px rgba(180,190,100,0.4)}}
    @keyframes firefly-ambient{0%,45%{opacity:0.4;transform:translateX(-50%) scale(1)}50%,95%{opacity:0;transform:translateX(-50%) scale(0.6)}100%{opacity:0.4;transform:translateX(-50%) scale(1)}}
    @keyframes firefly-halo{0%,45%{opacity:0.7;box-shadow:0 0 60px 30px rgba(255,255,140,0.5),0 0 100px 50px rgba(255,255,100,0.3),0 0 140px 70px rgba(255,255,80,0.15)}50%,95%{opacity:0;box-shadow:0 0 20px 10px rgba(255,255,140,0.05)}100%{opacity:0.7;box-shadow:0 0 60px 30px rgba(255,255,140,0.5),0 0 100px 50px rgba(255,255,100,0.3),0 0 140px 70px rgba(255,255,80,0.15)}}
    @keyframes bee-zoom{0%,100%{transform:translate(0,60px) scale(1)}5%{transform:translate(8px,50px) scale(1.2)}10%{transform:translate(-10px,35px) scale(1.8)}15%{transform:translate(12px,15px) scale(3)}20%{transform:translate(-15px,-10px) scale(4.5)}25%{transform:translate(18px,-25px) scale(6)}28%{transform:translate(-20px,-30px) scale(6.2)}31%{transform:translate(22px,-25px) scale(6)}34%{transform:translate(-18px,-28px) scale(6.2)}37%{transform:translate(20px,-22px) scale(5.8)}40%{transform:translate(-15px,-18px) scale(5)}45%{transform:translate(12px,-5px) scale(4)}50%{transform:translate(-10px,10px) scale(3)}55%{transform:translate(8px,25px) scale(2)}60%{transform:translate(-6px,40px) scale(1.5)}65%{transform:translate(4px,50px) scale(1.2)}70%{transform:translate(-3px,58px) scale(1)}80%{transform:translate(2px,62px) scale(1)}90%{transform:translate(-2px,60px) scale(1)}}
    @keyframes flamingo-stand{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}

    /* Toucan animations */
    @keyframes toucan-bob{0%,100%{transform:rotate(0deg) translateY(0)}20%{transform:rotate(2deg) translateY(-4px)}40%{transform:rotate(-2deg) translateY(0)}60%{transform:rotate(1deg) translateY(-2px)}80%{transform:rotate(-1deg) translateY(0)}}
    @keyframes toucan-head-turn{0%,45%{transform:scaleX(1)}50%,95%{transform:scaleX(-1)}100%{transform:scaleX(1)}}
    @keyframes toucan-beak-clack{0%,70%,100%{transform:rotate(0deg)}75%,85%{transform:rotate(15deg)}80%,90%{transform:rotate(0deg)}}
    @keyframes toucan-blink{0%,94%,100%{transform:scaleY(1)}95%,99%{transform:scaleY(0.1)}}
    @keyframes toucan-tail-wag{0%,100%{transform:rotate(125deg) scaleY(-1)}50%{transform:rotate(135deg) scaleY(-1)}}
    @keyframes toucan-hop{0%,60%,100%{transform:translateY(0)}65%{transform:translateY(-8px)}70%{transform:translateY(0)}75%{transform:translateY(-5px)}80%{transform:translateY(0)}}
    @keyframes toucan-wing-flap{0%,100%{transform:rotate(-5deg) scaleY(1)}15%{transform:rotate(-45deg) scaleY(0.9)}30%{transform:rotate(15deg) scaleY(1.05)}45%{transform:rotate(-30deg) scaleY(0.95)}60%{transform:rotate(10deg) scaleY(1)}75%{transform:rotate(-20deg) scaleY(0.95)}90%{transform:rotate(5deg) scaleY(1)}}
    @keyframes beak-shimmer{0%,100%{opacity:0.2}50%{opacity:0.5}}
    @keyframes tropical-float{0%,100%{transform:translateY(0) rotate(0deg);opacity:0.7}50%{transform:translateY(-20px) rotate(15deg);opacity:0.3}}

    /* Axolotl animations */
    @keyframes axo-float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
    @keyframes axo-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes axo-tail-swish{0%,100%{transform:rotate(-5deg)}50%{transform:rotate(8deg)}}
    @keyframes gill-fan-l-1{0%,100%{transform:rotate(35deg)}50%{transform:rotate(45deg)}}
    @keyframes gill-fan-l-2{0%,100%{transform:rotate(0deg)}50%{transform:rotate(5deg)}}
    @keyframes gill-fan-l-3{0%,100%{transform:rotate(-35deg)}50%{transform:rotate(-25deg)}}
    @keyframes gill-fan-r-1{0%,100%{transform:rotate(-35deg)}50%{transform:rotate(-45deg)}}
    @keyframes gill-fan-r-2{0%,100%{transform:rotate(0deg)}50%{transform:rotate(-5deg)}}
    @keyframes gill-fan-r-3{0%,100%{transform:rotate(35deg)}50%{transform:rotate(25deg)}}
    @keyframes axo-leg-paddle-l{0%,100%{transform:rotate(25deg)}50%{transform:rotate(40deg)}}
    @keyframes axo-leg-paddle-r{0%,100%{transform:rotate(-25deg)}50%{transform:rotate(-40deg)}}
    @keyframes axo-leg-back-l{0%,100%{transform:rotate(10deg)}50%{transform:rotate(20deg)}}
    @keyframes axo-leg-back-r{0%,100%{transform:rotate(-10deg)}50%{transform:rotate(-20deg)}}
    @keyframes axo-eye-look{0%,40%,100%{transform:translateX(0)}45%,95%{transform:translateX(2px)}}
    @keyframes axo-happy-wiggle{0%,85%,100%{transform:rotate(0deg)}87%{transform:rotate(-3deg)}89%{transform:rotate(3deg)}91%{transform:rotate(-2deg)}93%{transform:rotate(2deg)}95%{transform:rotate(0deg)}}
    /* Narwhal animations */
    @keyframes narwhal-bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
    @keyframes narwhal-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes narwhal-tail-flip{0%,100%{transform:translateX(-50%) translateY(0) scaleY(1)}50%{transform:translateX(-50%) translateY(-30px) scaleY(0.7)}}
    @keyframes narwhal-tusk-wobble{0%,100%{transform:translateX(-50%) rotate(-2deg)}50%{transform:translateX(-50%) rotate(2deg)}}
    @keyframes narwhal-flip-l{0%,100%{transform:rotate(25deg)}50%{transform:rotate(40deg)}}
    @keyframes narwhal-flip-r{0%,100%{transform:rotate(-25deg)}50%{transform:rotate(-40deg)}}
    /* Jellyfish animations */
    @keyframes jelly-pulse{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-15px) scale(1.02,0.98)}}
    @keyframes jelly-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes jelly-tentacle{0%,100%{transform:scaleX(1) skewX(0deg) translateY(0)}50%{transform:scaleX(1.1) skewX(5deg) translateY(10px)}}
    @keyframes jelly-frill{0%,100%{transform:scaleX(1) skewX(0deg)}50%{transform:scaleX(1.08) skewX(6deg)}}
    /* Bubble animations for aquatic creatures */
    @keyframes bubble-rise{0%{transform:translateY(0) scale(1);opacity:0.8}50%{opacity:0.9}100%{transform:translateY(-200px) scale(0.6);opacity:0}}
    @keyframes bubble-rise-slow{0%{transform:translateY(0) scale(1);opacity:0.7}50%{opacity:0.85}100%{transform:translateY(-220px) scale(0.5);opacity:0}}
    @keyframes bubble-wobble{0%,100%{transform:translateX(0)}50%{transform:translateX(3px)}}
    /* Octopus animations */
    @keyframes octo-float{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-8px) rotate(2deg)}50%{transform:translateY(-12px) rotate(0deg)}75%{transform:translateY(-8px) rotate(-2deg)}}
    @keyframes octo-blink{0%,92%,100%{transform:scaleY(1)}94%,98%{transform:scaleY(0.1)}}
    @keyframes octo-eye-look{0%,20%{transform:translate(0,0)}22%,28%{transform:translate(3px,-1px)}30%,38%{transform:translate(-2px,1px)}40%,48%{transform:translate(0,-4px)}50%,58%{transform:translate(2px,0)}60%,68%{transform:translate(-1px,-3px)}70%,90%{transform:translate(0,0)}92%,96%{transform:translate(0,-5px)}}
    @keyframes octo-eye-look-around{0%,15%{transform:translate(0,0)}18%,28%{transform:translate(0,-6px)}30%,38%{transform:translate(4px,-4px)}40%,48%{transform:translate(4px,0)}50%,55%{transform:translate(0,0)}58%,68%{transform:translate(-4px,-4px)}70%,78%{transform:translate(-4px,0)}80%,88%{transform:translate(0,-5px)}90%,100%{transform:translate(0,0)}}
    /* Alien animations */
    @keyframes alien-float{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-10px) rotate(1deg)}50%{transform:translateY(-15px) rotate(0deg)}75%{transform:translateY(-10px) rotate(-1deg)}}
    @keyframes alien-blink{0%,92%,100%{transform:scaleY(1)}94%,98%{transform:scaleY(0.1)}}
    @keyframes alien-eye-look{0%,10%{transform:translate(-50%,-50%)}12%,22%{transform:translate(-50%,-58%)}24%,34%{transform:translate(-42%,-55%)}36%,46%{transform:translate(-42%,-50%)}48%,58%{transform:translate(-50%,-50%)}60%,70%{transform:translate(-58%,-55%)}72%,82%{transform:translate(-58%,-50%)}84%,94%{transform:translate(-50%,-45%)}96%,100%{transform:translate(-50%,-50%)}}
    @keyframes alien-waddle{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-3px) rotate(-2deg)}50%{transform:translateY(0) rotate(0deg)}75%{transform:translateY(-3px) rotate(2deg)}}
    @keyframes alien-antenna-l{0%,100%{transform:rotate(-15deg)}25%{transform:rotate(-25deg)}50%{transform:rotate(-10deg)}75%{transform:rotate(-20deg)}}
    @keyframes alien-antenna-r{0%,100%{transform:rotate(15deg)}25%{transform:rotate(25deg)}50%{transform:rotate(10deg)}75%{transform:rotate(20deg)}}
    @keyframes alien-glow{0%,100%{opacity:0.6;transform:scale(1)}50%{opacity:1;transform:scale(1.2)}}
    @keyframes alien-arm-wave-l{0%,100%{transform:rotate(20deg)}50%{transform:rotate(35deg)}}
    @keyframes alien-arm-wave-r{0%,100%{transform:rotate(-20deg)}50%{transform:rotate(-35deg)}}
    @keyframes alien-happy{0%,80%,100%{transform:rotate(0deg)}82%{transform:rotate(-3deg)}84%{transform:rotate(3deg)}86%{transform:rotate(-2deg)}88%{transform:rotate(2deg)}}
    @keyframes flying-eye-float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes flying-eye-look{0%,100%{transform:translate(0,0)}25%{transform:translate(2px,-1px)}50%{transform:translate(-1px,1px)}75%{transform:translate(-2px,-1px)}}
    @keyframes orbit-spin{0%{transform:rotateX(70deg) rotateZ(0deg)}100%{transform:rotateX(70deg) rotateZ(360deg)}}
    @keyframes flame-flicker{0%,100%{opacity:0.6;transform:scaleY(1)}50%{opacity:1;transform:scaleY(1.15)}}
    @keyframes octo-tentacle-1{0%,100%{transform:rotate(-5deg) scaleX(1)}50%{transform:rotate(8deg) scaleX(1.05)}}
    @keyframes octo-tentacle-2{0%,100%{transform:rotate(5deg) scaleX(1)}50%{transform:rotate(-8deg) scaleX(1.05)}}
    @keyframes octo-tentacle-3{0%,100%{transform:rotate(-8deg)}50%{transform:rotate(5deg)}}
    @keyframes octo-tentacle-4{0%,100%{transform:rotate(8deg)}50%{transform:rotate(-5deg)}}
    @keyframes octo-head-squish{0%,100%{transform:scale(1,1)}50%{transform:scale(1.03,0.97)}}
    @keyframes octo-color-shift{0%,100%{filter:hue-rotate(0deg)}50%{filter:hue-rotate(15deg)}}
    @keyframes octo-sucker-pulse{0%,100%{transform:scale(1);opacity:0.6}50%{transform:scale(1.2);opacity:0.8}}
    @keyframes octo-happy-wiggle{0%,70%,100%{transform:rotate(0deg)}72%{transform:rotate(-5deg)}74%{transform:rotate(5deg)}76%{transform:rotate(-4deg)}78%{transform:rotate(4deg)}80%{transform:rotate(0deg)}}
    @keyframes octo-fin-left{0%,100%{transform:rotate(-15deg) scaleY(1)}50%{transform:rotate(-25deg) scaleY(0.9)}}
    @keyframes octo-fin-right{0%,100%{transform:rotate(15deg) scaleY(1)}50%{transform:rotate(25deg) scaleY(0.9)}}
    @keyframes octo-brow-raise{0%,85%,100%{transform:translateY(0) rotate(-8deg)}88%,95%{transform:translateY(-2px) rotate(-12deg)}}
    @keyframes octo-ink-squirt{0%,90%,100%{transform:scale(0);opacity:0}92%{transform:scale(1);opacity:0.6}96%{transform:scale(1.5) translateY(10px);opacity:0.3}}

    /* Reptile animations (gecko, etc) */
    @keyframes breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
    @keyframes snake-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes gecko-breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
    @keyframes gecko-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes gecko-tail-sway{0%,100%{transform:rotate(0deg) translateX(0)}50%{transform:rotate(-8deg) translateX(-2px)}}
    @keyframes gecko-eye-look{0%,45%,100%{transform:translateX(0)}50%,95%{transform:translateX(5px)}}
    @keyframes gecko-tongue-extend{0%,88%,100%{clip-path:inset(100% 0 0 0)}90%,96%{clip-path:inset(0 0 0 0)}}
    @keyframes gecko-tongue-lick{0%,88%,100%{transform:rotate(0deg)}91%{transform:rotate(-8deg)}93%{transform:rotate(8deg)}95%{transform:rotate(-5deg)}97%{transform:rotate(0deg)}}
    @keyframes gecko-mouth-open{0%,86%,100%{transform:translateX(-50%) rotate(-2deg) scaleY(1)}88%,99%{transform:translateX(-50%) rotate(-2deg) scaleY(2.5)}}
    @keyframes gecko-mouth-inside{0%,86%,100%{opacity:0;transform:translateX(-50%) scaleY(0)}88%,99%{opacity:1;transform:translateX(-50%) scaleY(1)}}
    @keyframes gecko-leg-burst{0%,70%,100%{transform:rotate(var(--leg-rest))}72%,74%,76%,78%{transform:rotate(var(--leg-run1))}73%,75%,77%,79%{transform:rotate(var(--leg-run2))}}
    /* Frog animations */
    @keyframes frog-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-15px)}}
    @keyframes frog-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes frog-paw-wiggle{0%,40%,60%,100%{transform:scale(1)}50%{transform:scale(1.1) rotate(15deg)}}
    @keyframes frog-croak{0%,80%,100%{transform:translateX(-50%) scale(1)}90%{transform:translateX(-50%) scale(1.3)}}
    @keyframes frog-fly-buzz{0%{transform:translate(-80px,0) scale(1) rotate(0deg)}6%{transform:translate(-40px,-10px) scale(1) rotate(10deg)}14%{transform:translate(20px,-25px) scale(1) rotate(-5deg)}22%{transform:translate(60px,-15px) scale(1) rotate(15deg)}30%{transform:translate(80px,5px) scale(1) rotate(-10deg)}38%{transform:translate(50px,20px) scale(1) rotate(20deg)}46%{transform:translate(20px,0px) scale(1) rotate(-15deg)}54%{transform:translate(40px,-20px) scale(1) rotate(10deg)}62%{transform:translate(70px,10px) scale(1) rotate(-5deg)}70%{transform:translate(55px,25px) scale(1) rotate(15deg)}78%{transform:translate(60px,15px) scale(1) rotate(0deg)}80%{transform:translate(60px,15px) scale(0) rotate(0deg)}95%{transform:translate(60px,15px) scale(0) rotate(0deg)}95.1%{transform:translate(-80px,0) scale(0) rotate(0deg)}98%{transform:translate(-80px,0) scale(1) rotate(0deg)}100%{transform:translate(-80px,0) scale(1) rotate(0deg)}}
    @keyframes frog-fly-wings{0%,100%{transform:scaleY(1)}50%{transform:scaleY(0.3)}}
    @keyframes frog-tongue-shoot{0%,75%{transform:translateY(0) scaleY(0);opacity:0}76%{transform:translateY(0) scaleY(0);opacity:1}77%{transform:translateY(0) scaleY(0.4);opacity:1}79%{transform:translateY(0) scaleY(1);opacity:1}83%{transform:translateY(-10px) scaleY(1.1);opacity:1}87%{transform:translateY(0) scaleY(0.6);opacity:1}90%{transform:translateY(0) scaleY(0);opacity:0}100%{transform:translateY(0) scaleY(0);opacity:0}}
    @keyframes frog-eye-track{0%{transform:translate(-6px,0)}6%{transform:translate(-4px,-1px)}14%{transform:translate(2px,-3px)}22%{transform:translate(5px,-2px)}30%{transform:translate(6px,0)}38%{transform:translate(4px,2px)}46%{transform:translate(2px,0)}54%{transform:translate(3px,-2px)}62%{transform:translate(5px,1px)}70%{transform:translate(4px,2px)}78%{transform:translate(5px,2px)}80%{transform:translate(5px,2px)}85%{transform:translate(0,0)}90%{transform:translate(-6px,0)}100%{transform:translate(-6px,0)}}
    @keyframes frog-mouth-open{0%,74%,93%,100%{transform:translateX(-50%) scaleY(1)}76%,90%{transform:translateX(-50%) scaleY(2.5)}}
    @keyframes frog-mouth-inside{0%,74%,93%,100%{opacity:0;transform:translateX(-50%) scaleY(0)}76%,90%{opacity:1;transform:translateX(-50%) scaleY(1)}}
    @keyframes frog-hop{0%,70%,100%{transform:translateY(0) scale(1)}76%{transform:translateY(-25px) scale(1.05,0.95)}82%{transform:translateY(-30px) scale(0.95,1.05)}88%{transform:translateY(-10px) scale(1.02,0.98)}}
    @keyframes frog-leg-jump{0%,70%,100%{transform:translateY(0)}76%{transform:translateY(25px)}82%{transform:translateY(30px)}84%{transform:translateY(15px)}86%{transform:translateY(0)}88%,92%{transform:translateY(0)}}
    /* Turtle animations */
    @keyframes turtle-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    @keyframes turtle-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes turtle-tail-wiggle{0%,100%{transform:rotate(-20deg)}50%{transform:rotate(20deg)}}
    @keyframes turtle-walk-left{0%,100%{transform:rotate(-15deg)}50%{transform:rotate(10deg)}}
    @keyframes turtle-walk-right{0%,100%{transform:rotate(15deg)}50%{transform:rotate(-10deg)}}
    @keyframes turtle-head-tuck{0%,100%{transform:translateY(0)}50%{transform:translateY(8px)}}
    @keyframes cobra-sway{0%{transform:rotate(-2deg) translateY(0)}100%{transform:rotate(2deg) translateY(-5px)}}
    @keyframes cobra-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes cobra-tail-wag{0%{transform:rotate(-10deg)}100%{transform:rotate(-35deg)}}
    @keyframes cobra-tongue{0%,70%{transform:scaleY(0)}75%{transform:scaleY(1.2) rotate(5deg)}80%{transform:scaleY(1.1) rotate(-5deg)}85%{transform:scaleY(1) rotate(0deg)}90%,100%{transform:scaleY(0)}}
    @keyframes emerald-sway{0%{transform:rotate(-2deg) translateY(0)}100%{transform:rotate(2deg) translateY(-5px)}}
    @keyframes emerald-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes emerald-tail-wag{0%{transform:rotate(-10deg)}100%{transform:rotate(-35deg)}}
    @keyframes emerald-tongue{0%,70%{transform:scaleY(0)}75%{transform:scaleY(1.2) rotate(5deg)}80%{transform:scaleY(1.1) rotate(-5deg)}85%{transform:scaleY(1) rotate(0deg)}90%,100%{transform:scaleY(0)}}
    @keyframes snake-eye-look{0%,40%{transform:translateX(0)}45%,85%{transform:translateX(2px)}90%,100%{transform:translateX(0)}}
    @keyframes purple-sway{0%{transform:rotate(-2deg) translateY(0)}100%{transform:rotate(2deg) translateY(-5px)}}
    @keyframes purple-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes purple-tail-wag{0%{transform:rotate(-10deg)}100%{transform:rotate(-35deg)}}
    @keyframes purple-tongue{0%,70%{transform:scaleY(0)}75%{transform:scaleY(1.2) rotate(5deg)}80%{transform:scaleY(1.1) rotate(-5deg)}85%{transform:scaleY(1) rotate(0deg)}90%,100%{transform:scaleY(0)}}
    @keyframes rattle-buzz{0%,100%{transform:rotate(0deg)}50%{transform:rotate(25deg)}}
    @keyframes rattle-slither{0%,100%{transform:scaleX(1) skewY(0deg)}25%{transform:scaleX(1.03) skewY(1.5deg)}50%{transform:scaleX(0.98) skewY(-1deg)}75%{transform:scaleX(1.02) skewY(1deg)}}
    @keyframes rattle-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    @keyframes rattle-tongue{0%,80%,100%{transform:translateX(-50%) scaleY(0)}85%,92%,98%{transform:translateX(-50%) scaleY(1)}}
    @keyframes rattle-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes coiled-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes coiled-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes coiled-tongue{0%,70%{transform:scaleY(0)}75%{transform:scaleY(1.2)}85%{transform:scaleY(1)}90%{transform:scaleY(0)}}
    @keyframes coiled-rattle{0%{transform:rotate(0deg)}100%{transform:rotate(15deg)}}
    @keyframes rainbow-bounce{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-15px) rotate(1deg)}}
    @keyframes rainbow-wiggle{0%,100%{transform:scaleX(1) skewY(0deg)}25%{transform:scaleX(1.05) skewY(2deg)}75%{transform:scaleX(0.95) skewY(-2deg)}}
    @keyframes rainbow-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes rainbow-tongue{0%,80%,100%{transform:translateX(-50%) scaleY(0)}85%,92%,98%{transform:translateX(-50%) scaleY(1)}}
    @keyframes pcobra-sway{0%{transform:rotate(-2deg) translateY(0)}100%{transform:rotate(2deg) translateY(-5px)}}
    @keyframes pcobra-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes pcobra-tail{0%{transform:rotate(-10deg)}100%{transform:rotate(-35deg)}}
    @keyframes pcobra-tongue{0%,70%{transform:scaleY(0)}75%{transform:scaleY(1.2) rotate(5deg)}80%{transform:scaleY(1.1) rotate(-5deg)}85%{transform:scaleY(1) rotate(0deg)}90%,100%{transform:scaleY(0)}}
    @keyframes fcobra-sway{0%{transform:rotate(-2deg) translateY(0)}100%{transform:rotate(2deg) translateY(-5px)}}
    @keyframes fcobra-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes fcobra-tail{0%{transform:rotate(-10deg)}100%{transform:rotate(-35deg)}}
    @keyframes fcobra-tongue{0%,70%{transform:scaleY(0)}75%{transform:scaleY(1.2) rotate(5deg)}80%{transform:scaleY(1.1) rotate(-5deg)}85%{transform:scaleY(1) rotate(0deg)}90%,100%{transform:scaleY(0)}}
    @keyframes fcobra-flicker{0%{transform:translateX(-50%) rotate(45deg) scale(1);filter:brightness(1)}50%{transform:translateX(-50%) rotate(45deg) scale(0.95,1.05)}100%{transform:translateX(-50%) rotate(45deg) scale(1.02);filter:brightness(1.2)}}
    @keyframes icobra-sway{0%{transform:rotate(-2deg) translateY(0)}100%{transform:rotate(2deg) translateY(-5px)}}
    @keyframes icobra-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes icobra-tail{0%{transform:rotate(-10deg)}100%{transform:rotate(-35deg)}}
    @keyframes icobra-tongue{0%,70%{transform:scaleY(0)}75%{transform:scaleY(1.2) rotate(5deg)}80%{transform:scaleY(1.1) rotate(-5deg)}85%{transform:scaleY(1) rotate(0deg)}90%,100%{transform:scaleY(0)}}
    @keyframes icobra-snow{0%,100%{transform:translateY(0) rotate(0deg);opacity:0.6}50%{transform:translateY(-8px) rotate(30deg);opacity:1}}
    @keyframes icobra-mist{0%,100%{opacity:0.4;transform:translateX(-50%) scale(1)}50%{opacity:0.7;transform:translateX(-50%) scale(1.1)}}

    /* New snake animations */
    @keyframes cobra-hood-flare{0%,100%{transform:scaleX(1) scaleY(1)}15%{transform:scaleX(1.08) scaleY(1.03)}30%{transform:scaleX(1.12) scaleY(1.05)}50%{transform:scaleX(1.08) scaleY(1.03)}70%{transform:scaleX(1) scaleY(1)}}
    @keyframes cobra-hypnotic-rise{0%,100%{transform:translateY(0)}25%{transform:translateY(-8px)}50%{transform:translateY(-4px)}75%{transform:translateY(-10px)}}
    @keyframes cobra-head-sway{0%,100%{transform:rotate(0deg) translateX(0)}20%{transform:rotate(-4deg) translateX(-3px)}40%{transform:rotate(2deg) translateX(2px)}60%{transform:rotate(-3deg) translateX(-2px)}80%{transform:rotate(3deg) translateX(2px)}}
    @keyframes cobra-neck-sway{0%,100%{transform:rotate(0deg)}20%{transform:rotate(-3deg)}40%{transform:rotate(1.5deg)}60%{transform:rotate(-2deg)}80%{transform:rotate(2deg)}}
    @keyframes python-pulse{0%,100%{transform:scale(1)}30%{transform:scale(1.02)}50%{transform:scale(0.98)}80%{transform:scale(1.01)}}
    @keyframes python-head-sway{0%,100%{transform:rotate(0deg) translateX(0)}20%{transform:rotate(-3deg) translateX(-2px)}50%{transform:rotate(2deg) translateX(2px)}80%{transform:rotate(-1deg) translateX(-1px)}}
    @keyframes snake-head-tilt{0%,30%{transform:rotate(0deg)}35%{transform:rotate(-8deg)}40%,70%{transform:rotate(0deg)}75%{transform:rotate(6deg)}80%,100%{transform:rotate(0deg)}}

    /* Egg animations */
    @keyframes egg-hatch-wiggle{0%,100%{transform:rotate(0deg) translateX(0)}10%{transform:rotate(-8deg) translateX(-2px)}30%{transform:rotate(8deg) translateX(2px)}50%{transform:rotate(-6deg) translateX(-1px)}70%{transform:rotate(6deg) translateX(1px)}90%{transform:rotate(-3deg) translateX(-0.5px)}}
    @keyframes egg-wiggle{0%,100%{transform:rotate(0deg) translateX(0)}20%{transform:rotate(-5deg) translateX(-1px)}60%{transform:rotate(5deg) translateX(1px)}}
    @keyframes egg-rock{0%,100%{transform:rotate(0deg)}25%{transform:rotate(-3deg)}75%{transform:rotate(3deg)}}
    @keyframes egg-pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.003)}}
    .egg-hatch-wiggle{animation:egg-hatch-wiggle 0.8s ease-in-out infinite}
    .egg-wiggle{animation:egg-wiggle 1.2s ease-in-out infinite}
    .egg-rock{animation:egg-rock 2s ease-in-out infinite}
    .egg-pulse{animation:egg-pulse 7s ease-in-out infinite}

    /* Progressive egg particle effects */
    @keyframes star-float{0%{transform:translateY(0) scale(1) rotate(0deg);opacity:1}50%{transform:translateY(-30px) scale(1.2) rotate(180deg);opacity:0.8}100%{transform:translateY(-60px) scale(0.5) rotate(360deg);opacity:0}}
    @keyframes music-float{0%{transform:translateY(0) translateX(0) scale(1);opacity:0.9}50%{transform:translateY(-25px) translateX(10px) scale(1.1);opacity:0.7}100%{transform:translateY(-50px) translateX(-5px) scale(0.8);opacity:0}}
    @keyframes spark-burst{0%{transform:scale(0) rotate(0deg);opacity:1}50%{transform:scale(1.5) rotate(180deg);opacity:0.8}100%{transform:scale(0.3) rotate(360deg);opacity:0}}
    @keyframes smoke-rise{0%{transform:translateY(0) scale(1);opacity:0.4}50%{transform:translateY(-40px) scale(1.5);opacity:0.25}100%{transform:translateY(-80px) scale(2);opacity:0}}
    @keyframes mystical-swirl{0%{transform:rotate(0deg) scale(1);opacity:0.3}50%{transform:rotate(180deg) scale(1.2);opacity:0.5}100%{transform:rotate(360deg) scale(1);opacity:0.3}}
    @keyframes heart-pop{0%{transform:scale(0) translateY(0);opacity:1}30%{transform:scale(1.3) translateY(-10px);opacity:0.9}100%{transform:scale(0.6) translateY(-40px);opacity:0}}
    @keyframes crack-glow{0%,100%{opacity:0.3;filter:brightness(1)}50%{opacity:0.8;filter:brightness(1.5)}}
    @keyframes energy-pulse{0%{transform:scale(0.8);opacity:0.2}50%{transform:scale(1.3);opacity:0.5}100%{transform:scale(0.8);opacity:0.2}}
    .egg-particles{position:absolute;width:100%;height:100%;top:0;left:0;pointer-events:none;overflow:visible}
    .egg-particle{position:absolute;animation-fill-mode:forwards;animation-iteration-count:infinite}

    /* Hatching celebration animations */
    @keyframes hatch-shake{0%,100%{transform:rotate(0deg) translateX(0)}5%{transform:rotate(-12deg) translateX(-8px)}10%{transform:rotate(12deg) translateX(8px)}15%{transform:rotate(-10deg) translateX(-6px)}20%{transform:rotate(10deg) translateX(6px)}25%{transform:rotate(-8deg) translateX(-4px)}30%{transform:rotate(8deg) translateX(4px)}35%,65%{transform:rotate(0deg) translateX(0)}70%{transform:rotate(-15deg) translateX(-10px)}75%{transform:rotate(15deg) translateX(10px)}80%{transform:rotate(-12deg) translateX(-8px)}85%{transform:rotate(12deg) translateX(8px)}90%{transform:rotate(-8deg) translateX(-5px)}95%{transform:rotate(8deg) translateX(5px)}}
    @keyframes hatch-crack-appear{0%{opacity:0;transform:scaleY(0)}100%{opacity:1;transform:scaleY(1)}}
    @keyframes hatch-light-burst{0%{opacity:0;transform:scale(0.5)}50%{opacity:1;transform:scale(1.5)}100%{opacity:0;transform:scale(3)}}
    @keyframes hatch-shell-fly{0%{opacity:1;transform:translate(0,0) rotate(0deg)}100%{opacity:0;transform:translate(var(--fly-x),var(--fly-y)) rotate(var(--fly-rot))}}
    @keyframes hatch-creature-pop{0%{opacity:0;transform:scale(0) translateY(50px)}60%{opacity:1;transform:scale(1.2) translateY(-20px)}80%{transform:scale(0.9) translateY(5px)}100%{transform:scale(1) translateY(0)}}
    @keyframes hatch-confetti{0%{opacity:1;transform:translateY(0) rotate(0deg)}100%{opacity:0;transform:translateY(200px) rotate(720deg)}}
    @keyframes hatch-glow-pulse{0%,100%{box-shadow:0 0 30px rgba(251,191,36,0.5),0 0 60px rgba(251,191,36,0.3)}50%{box-shadow:0 0 50px rgba(251,191,36,0.8),0 0 100px rgba(251,191,36,0.5)}}
    @keyframes hatch-text-pop{0%{opacity:0;transform:scale(0.5) translateY(20px)}50%{transform:scale(1.1) translateY(-5px)}100%{opacity:1;transform:scale(1) translateY(0)}}
    .hatch-shake{animation:hatch-shake 1.5s ease-in-out infinite}
    .hatch-creature-pop{animation:hatch-creature-pop 0.8s ease-out forwards}
    .hatch-text-pop{animation:hatch-text-pop 0.6s ease-out forwards}

    /* Evolution burst animations */
    @keyframes evo-spin-fast{0%{transform:rotate(0deg) scale(1)}25%{transform:rotate(180deg) scale(1.05)}50%{transform:rotate(360deg) scale(0.95)}75%{transform:rotate(540deg) scale(1.1)}100%{transform:rotate(720deg) scale(1)}}
    @keyframes evo-shake-intense{0%,100%{transform:translateX(0) translateY(0)}10%{transform:translateX(-8px) translateY(-3px)}20%{transform:translateX(8px) translateY(3px)}30%{transform:translateX(-6px) translateY(-5px)}40%{transform:translateX(6px) translateY(5px)}50%{transform:translateX(-10px) translateY(-2px)}60%{transform:translateX(10px) translateY(2px)}70%{transform:translateX(-5px) translateY(-4px)}80%{transform:translateX(5px) translateY(4px)}90%{transform:translateX(-3px) translateY(-1px)}}
    @keyframes evo-glow-buildup{0%{box-shadow:0 0 10px rgba(251,191,36,0.3)}50%{box-shadow:0 0 40px rgba(251,191,36,0.6),0 0 80px rgba(168,85,247,0.4)}100%{box-shadow:0 0 80px rgba(251,191,36,1),0 0 120px rgba(168,85,247,0.8),0 0 160px rgba(236,72,153,0.6)}}
    @keyframes evo-smoke-burst{0%{opacity:0;transform:scale(0.3)}30%{opacity:0.8;transform:scale(1.2)}100%{opacity:0;transform:scale(2.5)}}
    @keyframes evo-lightning{0%,100%{opacity:0}10%,30%{opacity:1}20%,40%{opacity:0}50%{opacity:1}60%,80%{opacity:0}70%,90%{opacity:1}}
    @keyframes evo-star-explode{0%{opacity:1;transform:translate(0,0) scale(1) rotate(0deg)}100%{opacity:0;transform:translate(var(--ex),var(--ey)) scale(0.3) rotate(360deg)}}
    @keyframes evo-ring-expand{0%{opacity:0.8;transform:translate(-50%,-50%) scale(0.5)}100%{opacity:0;transform:translate(-50%,-50%) scale(3)}}
    @keyframes evo-flash{0%{opacity:0}50%{opacity:1}100%{opacity:0}}
    .evo-spin-buildup{animation:evo-spin-fast 0.4s linear infinite,evo-shake-intense 0.15s linear infinite,evo-glow-buildup 2s ease-in forwards;border-radius:50%}

    /* 3D Floating Buddy Card */
    @keyframes buddy-levitate{
      0%,100%{transform:translateY(0) rotateX(2deg) rotateY(-1deg)}
      25%{transform:translateY(-8px) rotateX(1deg) rotateY(1deg)}
      50%{transform:translateY(-12px) rotateX(-1deg) rotateY(2deg)}
      75%{transform:translateY(-6px) rotateX(0deg) rotateY(-2deg)}
    }
    @keyframes shadow-float{
      0%,100%{transform:translateX(-50%) scale(1);opacity:0.3}
      25%{transform:translateX(-50%) scale(0.92);opacity:0.25}
      50%{transform:translateX(-50%) scale(0.85);opacity:0.2}
      75%{transform:translateX(-50%) scale(0.9);opacity:0.22}
    }
    @keyframes aura-pulse{
      0%,100%{transform:translate(-50%,-50%) scale(1);opacity:0.15}
      50%{transform:translate(-50%,-50%) scale(1.1);opacity:0.25}
    }
    .buddy-stage-3d{
      perspective:800px;
      transform-style:preserve-3d;
    }
    .buddy-float-container{
      animation:buddy-levitate 6s ease-in-out infinite;
      transform-style:preserve-3d;
      position:relative;
    }
    .buddy-shadow{
      position:absolute;
      bottom:-30px;
      left:50%;
      width:120px;
      height:30px;
      background:radial-gradient(ellipse,rgba(139,92,246,0.4),transparent 70%);
      border-radius:50%;
      animation:shadow-float 6s ease-in-out infinite;
      filter:blur(8px);
      z-index:-1;
    }
    .buddy-aura{
      position:absolute;
      top:50%;
      left:50%;
      width:200px;
      height:200px;
      background:radial-gradient(circle,rgba(236,72,153,0.15),rgba(168,85,247,0.1),transparent 60%);
      border-radius:50%;
      animation:aura-pulse 4s ease-in-out infinite;
      z-index:-2;
      pointer-events:none;
    }

    /* Egg type varieties */
    .egg-white{filter:none}
    .egg-brown{filter:sepia(0.4) brightness(0.9) saturate(1.3)}
    .egg-spotted{background:radial-gradient(circle at 30% 40%, rgba(139,69,19,0.3) 2px, transparent 3px),
                  radial-gradient(circle at 70% 30%, rgba(139,69,19,0.3) 2px, transparent 3px),
                  radial-gradient(circle at 50% 70%, rgba(139,69,19,0.3) 1.5px, transparent 2.5px),
                  radial-gradient(circle at 35% 65%, rgba(139,69,19,0.3) 2px, transparent 3px);
                  border-radius:50%;padding:5px}
    .egg-speckled{background:radial-gradient(circle at 25% 35%, rgba(101,67,33,0.4) 1px, transparent 2px),
                   radial-gradient(circle at 60% 25%, rgba(101,67,33,0.4) 1px, transparent 2px),
                   radial-gradient(circle at 75% 55%, rgba(101,67,33,0.4) 1px, transparent 2px),
                   radial-gradient(circle at 40% 75%, rgba(101,67,33,0.4) 1px, transparent 2px),
                   radial-gradient(circle at 55% 80%, rgba(101,67,33,0.4) 1px, transparent 2px);
                   border-radius:50%;padding:5px}
    .egg-blue{filter:hue-rotate(180deg) saturate(0.8) brightness(1.1)}
    .egg-large{transform:scale(1.15)}
    .egg-small{transform:scale(0.85)}

    /* Bird animations (child, teen, adult) */
    @keyframes bird-hop{
      0%,100%{transform:translateY(0)}
      50%{transform:translateY(-12px)}
    }
    .bird-hop{animation:bird-hop 1.8s ease-in-out infinite;display:inline-block}

    /* Happiness visual effects */
    .happiness-very-happy{animation:bounce-slow 1.5s ease-in-out infinite,sparkle 1.5s ease-in-out infinite}
    .happiness-happy{animation:bounce-slow 2s ease-in-out infinite}
    .happiness-sad{filter:grayscale(0.3) brightness(0.9)}
    .happiness-very-sad{filter:grayscale(0.6) brightness(0.8)}

    /* Health visual effects */
    .health-sick{filter:saturate(0.7) brightness(0.95)}
    .health-very-sick{filter:saturate(0.4) brightness(0.9)}

    /* Combined state effects */
    .buddy-thriving{animation:bounce-slow 1.2s ease-in-out infinite,sparkle 1.2s ease-in-out infinite;filter:drop-shadow(0 0 10px rgba(236,72,153,0.6))}
    .buddy-crisis{filter:grayscale(0.8) brightness(0.7);opacity:0.85}

    /* Status overlays */
    .status-overlay{position:absolute;top:-15px;right:-15px;font-size:32px;animation:float-indicator 2s ease-in-out infinite;z-index:15}
    .status-overlay-left{position:absolute;top:-15px;left:-15px;font-size:32px;animation:float-indicator 2s ease-in-out infinite;animation-delay:0.5s;z-index:15}

    /* Mood indicator */
    .mood-indicator{position:absolute;top:-10px;right:-10px;font-size:24px;animation:float-indicator 2s ease-in-out infinite}
    @keyframes float-indicator{0%,100%{transform:translateY(0px)}50%{transform:translateY(-5px)}}

    /* Pause all animations when happiness is very low */
    .paused-animation,.paused-animation *{animation-play-state:paused!important}

    /* Accessory positioning */
    .buddy-scene-wrapper{position:relative;display:flex;align-items:center;justify-content:center;flex:1;width:100%}
    .static-furniture-layer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none}
    .static-furniture-layer .furniture-item{position:absolute;pointer-events:none;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2))}
    .buddy-float-container{position:relative;z-index:1}
    .stats-bar-container{position:relative;z-index:50;width:100%;max-width:420px;margin:0 auto;padding-bottom:0.5rem;pointer-events:auto}
    .buddy-card-container{position:relative;display:inline-block}
    .buddy-with-accessories{position:relative;display:inline-block}
    .customize-mode .static-furniture-layer{pointer-events:auto}
    .customize-mode .static-furniture-layer .furniture-item{pointer-events:auto;cursor:move}
    .accessory-hat{position:absolute;top:-15%;left:50%;transform:translateX(-50%);font-size:0.6em;z-index:10}
    .accessory-eyes{position:absolute;top:30%;left:50%;transform:translateX(-50%);font-size:0.4em;z-index:5}
    .accessory-held{position:absolute;bottom:10%;right:-10%;font-size:0.5em;z-index:5}
    .accessory-back{position:absolute;top:20%;left:-15%;font-size:0.7em;z-index:1}
    .accessory-effect{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.2em;z-index:0;opacity:0.8}
    .furniture-item{position:absolute;z-index:1;pointer-events:auto;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2))}

    /* Feeding animation */
    .feeding-container{position:relative;display:inline-block}
    .feeding-food{position:absolute;bottom:0;left:50%;transform:translateX(-50%);font-size:4rem;z-index:20;animation:food-fly 1s ease-out forwards}
    .feeding-message{animation:message-slide 0.5s ease-out forwards;animation-delay:1.2s;opacity:0}

    /* Buddy reaction animations */
    .buddy-happy-bounce{animation:happy-bounce 0.4s ease-in-out 3;animation-delay:0.8s}
    .buddy-reject-shake{animation:reject-shake 0.5s ease-in-out 2;animation-delay:0.8s}
    @keyframes happy-bounce{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-15px) scale(1.05)}}
    @keyframes reject-shake{0%,100%{transform:translateX(0) rotate(0deg)}10%{transform:translateX(-8px) rotate(-3deg)}30%{transform:translateX(8px) rotate(3deg)}50%{transform:translateX(-6px) rotate(-2deg)}70%{transform:translateX(6px) rotate(2deg)}90%{transform:translateX(-3px) rotate(-1deg)}}
    @keyframes snake-wave{0%,100%{transform:translateY(0)}25%{transform:translateY(-3px)}75%{transform:translateY(3px)}}
    @keyframes rattle-shake{0%,100%{transform:rotate(0deg)}10%{transform:rotate(-8deg)}30%{transform:rotate(8deg)}50%{transform:rotate(-6deg)}70%{transform:rotate(6deg)}90%{transform:rotate(-4deg)}}
    @keyframes tongue-flick{0%,100%{transform:translateY(0) scaleY(0.3)}15%{transform:translateY(0) scaleY(1)}30%,70%{transform:translateY(0) scaleY(1)}85%{transform:translateY(0) scaleY(0.3)}}
    @keyframes ear-wiggle-l{0%,90%,100%{transform:rotate(-25deg)}92%{transform:rotate(-35deg)}94%{transform:rotate(-20deg)}96%{transform:rotate(-30deg)}}
    @keyframes ear-wiggle-r{0%,92%,100%{transform:rotate(25deg)}94%{transform:rotate(35deg)}96%{transform:rotate(15deg)}98%{transform:rotate(30deg)}}
    @keyframes tail-swish{0%,100%{transform:rotate(-15deg)}50%{transform:rotate(0deg)}}
    @keyframes fox-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    @keyframes fox-blink-l{0%,90%,100%{transform:rotate(-12deg) scaleY(1)}93%,97%{transform:rotate(-12deg) scaleY(0.1)}}
    @keyframes fox-blink-r{0%,90%,100%{transform:scaleX(-1) rotate(-12deg) scaleY(1)}93%,97%{transform:scaleX(-1) rotate(-12deg) scaleY(0.1)}}
    /* Horse animations */
    @keyframes horse-bounce{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-12px) rotate(1deg)}}
    @keyframes horse-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes horse-tail-swish{0%,100%{transform:rotate(10deg)}50%{transform:rotate(-25deg)}}
    @keyframes horse-leg-kick{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes horse-ear-twitch{0%,85%,100%{transform:rotate(-15deg)}90%{transform:rotate(-5deg)}}
    @keyframes cow-graze{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-8px) rotate(-1deg)}}
    @keyframes cow-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes cow-tail-swish{0%,100%{transform:rotate(5deg)}50%{transform:rotate(-20deg)}}
    @keyframes cow-chew{0%,8%{transform:translateX(0)}10%{transform:translateX(4px)}14%{transform:translateX(-2px)}18%{transform:translateX(3px)}22%,30%{transform:translateX(0)}33%{transform:translateX(-4px)}37%{transform:translateX(2px)}41%{transform:translateX(-3px)}45%,55%{transform:translateX(0)}58%{transform:translateX(3px)}62%{transform:translateX(-4px)}66%{transform:translateX(2px)}70%,80%{transform:translateX(0)}83%{transform:translateX(-3px)}87%{transform:translateX(4px)}91%{transform:translateX(-2px)}95%,100%{transform:translateX(0)}}
    @keyframes grass-wiggle{0%,100%{transform:rotate(-5deg)}25%{transform:rotate(8deg)}50%{transform:rotate(-3deg)}75%{transform:rotate(10deg)}}
    @keyframes hand-wave-l{0%,100%{transform:rotate(-35deg)}50%{transform:rotate(5deg) translateY(-2px)}}
    @keyframes hand-wave-r{0%,100%{transform:rotate(35deg)}50%{transform:rotate(-5deg) translateY(-2px)}}
    @keyframes bunny-hop{0%,100%{transform:translateY(0)}50%{transform:translateY(-15px)}}
    @keyframes egg-wobble{0%,100%{transform:rotate(-3deg)}50%{transform:rotate(3deg)}}
    @keyframes egg-pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}
    @keyframes egg-glow{0%,100%{filter:brightness(1)}50%{filter:brightness(1.1)}}
    @keyframes egg-float{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
    @keyframes lava-pulse{0%,100%{opacity:0.7;filter:blur(4px)}50%{opacity:1;filter:blur(6px)}}
    @keyframes sparkle-twinkle{0%,100%{opacity:0.5;transform:scale(0.8)}50%{opacity:1;transform:scale(1.2)}}
    @keyframes card-shine{0%{left:-100%}50%{left:150%}100%{left:150%}}
    @keyframes alien-glow{0%,100%{box-shadow:0 0 15px rgba(34,211,238,0.4)}50%{box-shadow:0 0 25px rgba(34,211,238,0.7)}}
    @keyframes bunny-blink{0%,90%,100%{transform:scaleY(1)}95%{transform:scaleY(0)}}
    @keyframes bunny-ear-wiggle{0%,100%{transform:rotate(-10deg)}50%{transform:rotate(-20deg)}}
    @keyframes tail-wiggle{0%,100%{transform:scale(1)}50%{transform:scale(1.1) rotate(5deg)}}
    @keyframes kitty-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes kitty-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    @keyframes paw-step{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
    @keyframes koala-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes koala-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes koala-ear-wiggle-l{0%,90%,100%{transform:rotate(0deg)}92%{transform:rotate(-10deg)}95%{transform:rotate(5deg)}}
    @keyframes koala-ear-wiggle-r{0%,92%,100%{transform:rotate(0deg)}94%{transform:rotate(10deg)}97%{transform:rotate(-5deg)}}
    @keyframes sniff{0%,100%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.05)}}
    @keyframes joyful-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
    @keyframes tail-wag{0%,100%{transform:rotate(-8deg)}50%{transform:rotate(8deg)}}
    @keyframes tail-wag-diagonal{0%,100%{transform:rotate(-35deg)}50%{transform:rotate(-15deg)}}
    @keyframes puppy-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes puppy-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes panting{0%,100%{height:12px}50%{height:18px}}
    @keyframes puppy-ear-l{0%,100%{transform:rotate(20deg)}50%{transform:rotate(10deg)}}
    @keyframes puppy-ear-r{0%,100%{transform:rotate(-20deg)}50%{transform:rotate(-10deg)}}
    @keyframes mouse-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes raccoon-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    @keyframes raccoon-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes red-panda-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes red-panda-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes sloth-hang{0%,100%{transform:translateY(0) rotate(-0.5deg)}50%{transform:translateY(-12px) rotate(0.5deg)}}
    @keyframes sloth-blink{0%,95%,100%{transform:scaleY(1)}97%{transform:scaleY(0.1)}}
    @keyframes arm-sway-l{0%,100%{transform:rotate(30deg)}50%{transform:rotate(38deg)}}
    @keyframes arm-sway-r{0%,100%{transform:rotate(-30deg)}50%{transform:rotate(-38deg)}}
    @keyframes leg-wiggle-bl{0%,100%{transform:rotate(-6deg)}50%{transform:rotate(-10deg)}}
    @keyframes leg-wiggle-br{0%,100%{transform:rotate(6deg)}50%{transform:rotate(10deg)}}
    @keyframes hand-wave-l-horiz{0%,100%{transform:rotate(-90deg)}50%{transform:rotate(-75deg)}}
    @keyframes hand-wave-r-horiz{0%,100%{transform:rotate(90deg)}50%{transform:rotate(75deg)}}
    @keyframes panda-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    @keyframes panda-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes arm-wave{0%,100%{transform:rotate(80deg)}50%{transform:rotate(20deg)}}
    @keyframes squirrel-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    @keyframes bear-bounce{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-8px) rotate(1deg)}}
    @keyframes bear-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes bear-wave-l{0%,100%{transform:rotate(15deg)}50%{transform:rotate(25deg)}}
    @keyframes bear-wave-r{0%,100%{transform:rotate(-15deg)}50%{transform:rotate(-25deg)}}
    @keyframes bear-tail-wiggle{0%,100%{transform:rotate(0deg)}50%{transform:rotate(8deg)}}
    @keyframes bear-ear-l{0%,100%{transform:rotate(0deg)}30%{transform:rotate(-8deg)}60%{transform:rotate(3deg)}}
    @keyframes bear-ear-r{0%,100%{transform:rotate(0deg)}30%{transform:rotate(8deg)}60%{transform:rotate(-3deg)}}
    @keyframes bear-paw-l{0%,100%{transform:rotate(-8deg)}25%{transform:rotate(-12deg)}50%{transform:rotate(-5deg)}75%{transform:rotate(-10deg)}}
    @keyframes bear-paw-r{0%,100%{transform:rotate(8deg)}25%{transform:rotate(12deg)}50%{transform:rotate(5deg)}75%{transform:rotate(10deg)}}
    @keyframes squirrel-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes squirrel-tail-swish{0%,100%{transform:rotate(-5deg)}50%{transform:rotate(5deg)}}
    @keyframes squirrel-ear-l{0%,100%{transform:rotate(-15deg)}50%{transform:rotate(-25deg)}}
    @keyframes squirrel-ear-r{0%,100%{transform:rotate(15deg)}50%{transform:rotate(25deg)}}
    @keyframes fairy-float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
    @keyframes fairy-wing-left{0%,100%{transform:rotate(-15deg)}50%{transform:rotate(-30deg)}}
    @keyframes fairy-wing-right{0%,100%{transform:rotate(15deg)}50%{transform:rotate(30deg)}}
    @keyframes fairy-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes star-rise{0%{transform:translateY(0);opacity:0}20%{opacity:1}80%{opacity:1}100%{transform:translateY(-120px);opacity:0}}
    /* Unicorn animations */
    @keyframes unicorn-float{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-14px) rotate(0.5deg)}}
    @keyframes unicorn-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes horn-glow{0%,100%{box-shadow:0 0 15px rgba(255,215,0,0.5),0 0 30px rgba(255,215,0,0.3)}50%{box-shadow:0 0 25px rgba(255,215,0,0.8),0 0 50px rgba(255,215,0,0.5),0 0 70px rgba(255,215,0,0.3)}}
    @keyframes ear-twitch-l{0%,85%,100%{transform:rotate(-15deg)}88%{transform:rotate(-22deg)}91%{transform:rotate(-12deg)}94%{transform:rotate(-18deg)}}
    @keyframes ear-twitch-r{0%,80%,100%{transform:rotate(15deg)}83%{transform:rotate(22deg)}86%{transform:rotate(10deg)}89%{transform:rotate(20deg)}}
    @keyframes eye-sparkle{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.7;transform:scale(1.2)}}
    @keyframes eye-look{0%,40%,100%{transform:translateX(0)}45%,55%{transform:translateX(2px)}60%,70%{transform:translateX(-1px)}}
    @keyframes iridescent-shimmer{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    @keyframes mane-flow{0%,100%{transform:translateX(0) skewX(0deg)}50%{transform:translateX(2px) skewX(-2deg)}}
    @keyframes horn-sparkle-orbit{0%{transform:rotate(0deg) translateX(20px) rotate(0deg);opacity:0}20%{opacity:1}80%{opacity:1}100%{transform:rotate(360deg) translateX(20px) rotate(-360deg);opacity:0}}
    @keyframes unicorn-tail-swish{0%,100%{transform:rotate(10deg)}50%{transform:rotate(-25deg)}}
    @keyframes unicorn-leg-kick{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes horn-tip-starburst{0%,100%{transform:scale(1) rotate(0deg);opacity:0.9}25%{transform:scale(1.3) rotate(90deg);opacity:1}50%{transform:scale(1) rotate(180deg);opacity:0.9}75%{transform:scale(1.3) rotate(270deg);opacity:1}}
    @keyframes horn-tip-pulse{0%,100%{transform:scale(0.8);opacity:0.6}50%{transform:scale(1.2);opacity:1}}
    @keyframes horn-tip-rays{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    /* Pegasus animations */
    @keyframes pegasus-float{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-8px) rotate(-0.3deg)}50%{transform:translateY(-16px) rotate(0deg)}75%{transform:translateY(-8px) rotate(0.3deg)}}
    @keyframes pegasus-wing-left{0%,100%{transform:rotate(-5deg) translateY(0)}25%{transform:rotate(-35deg) translateY(-15px)}50%{transform:rotate(-15deg) translateY(-5px)}75%{transform:rotate(-40deg) translateY(-20px)}}
    @keyframes pegasus-wing-right{0%,100%{transform:rotate(5deg) translateY(0)}25%{transform:rotate(35deg) translateY(-15px)}50%{transform:rotate(15deg) translateY(-5px)}75%{transform:rotate(40deg) translateY(-20px)}}
    @keyframes pegasus-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes pegasus-tail-flow{0%,100%{transform:rotate(8deg) skewX(0deg)}33%{transform:rotate(-15deg) skewX(3deg)}66%{transform:rotate(12deg) skewX(-2deg)}}
    @keyframes pegasus-prance-left{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-10px) rotate(-5deg)}}
    @keyframes pegasus-prance-right{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-6px) rotate(3deg)}}
    @keyframes cloud-drift{0%,100%{transform:translateX(0) scale(1);opacity:0.8}50%{transform:translateX(5px) scale(1.05);opacity:1}}
    /* Dinosaur animations */
    @keyframes trex-stomp{0%,100%{transform:translateY(0) rotate(0deg)}20%{transform:translateY(-15px) rotate(-2deg)}40%{transform:translateY(0) rotate(0deg)}60%{transform:translateY(-12px) rotate(2deg)}80%{transform:translateY(0) rotate(0deg)}}
    @keyframes trex-roar{0%,70%,100%{transform:translateY(0) rotate(0deg)}75%,85%{transform:translateY(8px) rotate(3deg)}80%{transform:translateY(2px) rotate(1deg)}}
    @keyframes trex-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes trex-eye-look{0%,100%{transform:translate(0,0)}15%{transform:translate(4px,0)}30%{transform:translate(4px,3px)}45%{transform:translate(-2px,2px)}60%{transform:translate(-3px,-2px)}75%{transform:translate(2px,-2px)}90%{transform:translate(0,0)}}
    @keyframes trex-arm-wave{0%{transform:rotate(15deg)}100%{transform:rotate(50deg)}}
    @keyframes trex-arm-wave-reverse{0%{transform:rotate(-15deg)}100%{transform:rotate(-50deg)}}
    @keyframes trex-tail-sway{0%,100%{transform:rotate(5deg)}50%{transform:rotate(-12deg)}}
    @keyframes bronto-float{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-8px) rotate(-1deg)}50%{transform:translateY(-15px) rotate(0deg)}75%{transform:translateY(-8px) rotate(1deg)}}
    @keyframes bronto-neck{0%,100%{transform:rotate(0deg)}50%{transform:rotate(8deg)}}
    @keyframes bronto-tail-sway{0%,100%{transform:rotate(10deg)}50%{transform:rotate(-15deg)}}
    @keyframes bronto-neck-peer{0%,100%{transform:rotate(0deg)}50%{transform:rotate(8deg)}}
    @keyframes bronto-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes stego-stomp{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    @keyframes stego-tail{0%,100%{transform:rotate(0deg)}50%{transform:rotate(12deg)}}
    @keyframes stego-tail-sway{0%,100%{transform:rotate(0deg)}50%{transform:rotate(12deg)}}
    @keyframes stego-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes liltrex-stomp{0%,100%{transform:translateY(0) scaleY(1) rotate(0deg)}15%{transform:translateY(-15px) scaleY(0.95) rotate(-2deg)}30%{transform:translateY(0) scaleY(1.02) rotate(0deg)}45%{transform:translateY(-12px) scaleY(0.96) rotate(2deg)}60%{transform:translateY(0) scaleY(1) rotate(0deg)}}
    @keyframes liltrex-tail-sway{0%,100%{transform:rotate(5deg)}50%{transform:rotate(-12deg)}}
    @keyframes liltrex-arm-left{from{transform:rotate(15deg)}to{transform:rotate(50deg)}}
    @keyframes liltrex-arm-right{from{transform:rotate(-15deg)}to{transform:rotate(-50deg)}}
    @keyframes liltrex-blink{0%,90%,100%{transform:scaleY(1)}93%,97%{transform:scaleY(0.1)}}
    @keyframes liltrex-eye-look{0%,100%{transform:translate(0,0)}15%{transform:translate(10px,-2px)}30%{transform:translate(10px,5px)}45%{transform:translate(-8px,3px)}60%{transform:translate(-8px,-3px)}75%{transform:translate(5px,0)}90%{transform:translate(0,4px)}}
    @keyframes liltrex-chomp{0%,50%,100%{transform:translateY(0) rotate(0deg)}60%{transform:translateY(6px) rotate(2deg)}65%{transform:translateY(0) rotate(0deg)}75%{transform:translateY(8px) rotate(-2deg)}80%{transform:translateY(0) rotate(0deg)}90%{transform:translateY(10px) rotate(3deg)}95%{transform:translateY(0) rotate(0deg)}}
    @keyframes trex-breathe{0%,100%{transform:scaleY(1) scaleX(1)}50%{transform:scaleY(1.08) scaleX(1.03)}}
    @keyframes trex-head-bob{0%,100%{transform:rotate(0deg) translateY(0)}25%{transform:rotate(-3deg) translateY(-5px)}50%{transform:rotate(2deg) translateY(3px)}75%{transform:rotate(-2deg) translateY(-3px)}}
    @keyframes bronto-graze{0%,20%,100%{transform:rotate(0deg)}30%{transform:rotate(25deg)}40%{transform:rotate(20deg)}50%{transform:rotate(28deg)}60%{transform:rotate(22deg)}70%{transform:rotate(0deg)}}
    @keyframes bronto-body-sway{0%,100%{transform:rotate(-1deg)}50%{transform:rotate(2deg)}}
    @keyframes bronto-munch{0%,40%,45%,50%,55%,100%{transform:scaleY(1)}42%,52%{transform:scaleY(0.92)}}
    @keyframes stego-head-scan{0%,100%{transform:rotate(0deg) translateX(0)}20%{transform:rotate(-20deg) translateX(-8px)}40%{transform:rotate(-15deg) translateX(-5px)}60%{transform:rotate(20deg) translateX(8px)}80%{transform:rotate(15deg) translateX(5px)}}
    @keyframes stego-plate-glow{0%,100%{filter:brightness(1) drop-shadow(0 0 2px #fbbf24)}25%{filter:brightness(1.4) drop-shadow(0 0 12px #fbbf24)}50%{filter:brightness(1.1) drop-shadow(0 0 4px #fbbf24)}75%{filter:brightness(1.5) drop-shadow(0 0 15px #fbbf24)}}
    @keyframes stego-happy-stomp{0%,100%{transform:translateY(0)}10%{transform:translateY(-8px)}20%{transform:translateY(0)}30%{transform:translateY(-6px)}40%{transform:translateY(0)}}
    @keyframes stego-leg-stomp{0%,45%,55%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
    /* Leg walking animations */
    @keyframes trex-leg-left{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-12px) rotate(-15deg)}50%{transform:translateY(0) rotate(5deg)}75%{transform:translateY(0) rotate(0deg)}}
    @keyframes trex-leg-right{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(0) rotate(5deg)}75%{transform:translateY(-12px) rotate(-15deg)}}
    @keyframes bronto-leg-front-left{0%,100%{transform:translateY(0) rotate(0deg)}30%{transform:translateY(-8px) rotate(-8deg)}60%{transform:translateY(0) rotate(3deg)}}
    @keyframes bronto-leg-front-right{0%,100%{transform:translateY(0) rotate(0deg)}15%{transform:translateY(0) rotate(3deg)}45%{transform:translateY(-8px) rotate(-8deg)}75%{transform:translateY(0) rotate(0deg)}}
    @keyframes bronto-leg-back-left{0%,100%{transform:translateY(0) rotate(0deg)}20%{transform:translateY(0) rotate(2deg)}50%{transform:translateY(-6px) rotate(-6deg)}80%{transform:translateY(0) rotate(0deg)}}
    @keyframes bronto-leg-back-right{0%,100%{transform:translateY(0) rotate(0deg)}35%{transform:translateY(-6px) rotate(-6deg)}65%{transform:translateY(0) rotate(2deg)}}
    @keyframes stego-leg-front-left{0%,100%{transform:translateY(0) rotate(0deg)}20%{transform:translateY(-10px) rotate(-12deg)}40%{transform:translateY(0) rotate(4deg)}60%{transform:translateY(0) rotate(0deg)}}
    @keyframes stego-leg-front-right{0%,100%{transform:translateY(0) rotate(0deg)}40%{transform:translateY(0) rotate(0deg)}60%{transform:translateY(-10px) rotate(-12deg)}80%{transform:translateY(0) rotate(4deg)}}
    @keyframes stego-leg-back-left{0%,100%{transform:translateY(0) rotate(0deg)}30%{transform:translateY(-8px) rotate(-10deg)}50%{transform:translateY(0) rotate(3deg)}70%{transform:translateY(0) rotate(0deg)}}
    @keyframes stego-leg-back-right{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(0) rotate(0deg)}70%{transform:translateY(-8px) rotate(-10deg)}90%{transform:translateY(0) rotate(3deg)}}
    @keyframes liltrex-leg-left{0%,100%{transform:translateY(0) rotate(0deg)}20%{transform:translateY(-15px) rotate(-20deg)}40%{transform:translateY(0) rotate(8deg)}60%{transform:translateY(0) rotate(0deg)}}
    @keyframes liltrex-leg-right{0%,100%{transform:translateY(0) rotate(0deg)}40%{transform:translateY(0) rotate(0deg)}60%{transform:translateY(-15px) rotate(-20deg)}80%{transform:translateY(0) rotate(8deg)}}
    /* Chimera Alien animations */
    @keyframes chimera-hover{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
    @keyframes chimera-wing-left{0%,100%{transform:rotate(-5deg) scaleY(1)}50%{transform:rotate(-25deg) scaleY(0.9)}}
    @keyframes chimera-wing-right{0%,100%{transform:rotate(5deg) scaleY(1)}50%{transform:rotate(25deg) scaleY(0.9)}}
    @keyframes chimera-mantis-left{0%,70%,100%{transform:rotate(20deg)}80%{transform:rotate(-30deg)}85%{transform:rotate(-20deg)}90%{transform:rotate(-35deg)}}
    @keyframes chimera-mantis-right{0%,70%,100%{transform:rotate(-20deg)}80%{transform:rotate(30deg)}85%{transform:rotate(20deg)}90%{transform:rotate(35deg)}}
    @keyframes chimera-tail{0%,100%{transform:rotate(-5deg)}30%{transform:rotate(15deg)}60%{transform:rotate(-10deg)}80%{transform:rotate(8deg)}}
    @keyframes chimera-rattle{0%,60%,100%{transform:rotate(0deg)}65%{transform:rotate(15deg)}70%{transform:rotate(-15deg)}75%{transform:rotate(12deg)}80%{transform:rotate(-12deg)}85%{transform:rotate(8deg)}90%{transform:rotate(-8deg)}}
    @keyframes chimera-antenna{0%,100%{transform:rotate(-15deg)}50%{transform:rotate(15deg)}}
    @keyframes chimera-eye-scan{0%,100%{transform:translate(0,0)}25%{transform:translate(3px,-2px)}50%{transform:translate(-2px,2px)}75%{transform:translate(2px,1px)}}
    @keyframes chimera-shell-shimmer{0%,100%{filter:hue-rotate(0deg) brightness(1)}50%{filter:hue-rotate(30deg) brightness(1.2)}}
    @keyframes chimera-leg-walk{0%,100%{transform:rotate(0deg)}25%{transform:rotate(-20deg)}75%{transform:rotate(20deg)}}
    /* Phoenix animations */
    @keyframes phoenix-hover{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-15px) rotate(-1deg)}50%{transform:translateY(-8px) rotate(0deg)}75%{transform:translateY(-12px) rotate(1deg)}}
    @keyframes phoenix-wing-left{0%,100%{transform:rotate(10deg) scaleY(1)}50%{transform:rotate(-20deg) scaleY(0.95)}}
    @keyframes phoenix-wing-right{0%,100%{transform:rotate(-10deg) scaleY(1)}50%{transform:rotate(20deg) scaleY(0.95)}}
    @keyframes phoenix-tail-flow{0%,100%{transform:rotate(0deg) scaleX(1)}25%{transform:rotate(8deg) scaleX(1.02)}50%{transform:rotate(0deg) scaleX(0.98)}75%{transform:rotate(-8deg) scaleX(1.02)}}
    @keyframes phoenix-flame-flicker{0%,100%{opacity:0.8;transform:scaleY(1) translateY(0)}25%{opacity:1;transform:scaleY(1.1) translateY(-3px)}50%{opacity:0.9;transform:scaleY(0.95) translateY(0)}75%{opacity:1;transform:scaleY(1.05) translateY(-2px)}}
    @keyframes phoenix-glow-pulse{0%,100%{filter:brightness(1) drop-shadow(0 0 10px #f97316)}50%{filter:brightness(1.2) drop-shadow(0 0 25px #fbbf24)}}
    @keyframes phoenix-ember-rise{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-80px) scale(0.3);opacity:0}}
    @keyframes phoenix-crest-wave{0%,100%{transform:rotate(-5deg)}50%{transform:rotate(5deg)}}
    @keyframes phoenix-eye-glow{0%,100%{box-shadow:0 0 8px #fef3c7}50%{box-shadow:0 0 15px #fbbf24,0 0 25px #f97316}}
    @keyframes phoenix-eye-blink{0%,45%,55%,100%{transform:scaleY(1)}50%{transform:scaleY(0.1)}}
    @keyframes phoenix-eye-look{0%,100%{transform:translate(-50%,-50%)}25%{transform:translate(-60%,-50%)}75%{transform:translate(-40%,-50%)}}
    @keyframes phoenix-leg-flame{0%,100%{transform:scaleY(1) translateY(0);opacity:0.8}50%{transform:scaleY(1.3) translateY(-3px);opacity:1}}

    /* ========================================
       CREATURE STYLES MOVED TO creatures.css

       All creature CSS is now in: creatures.css
       This keeps index.html clean and fast!

       TO ADD NEW CREATURES:
       User: "Add [filename].html"
       Me: "Which category?"
       I auto-assign next variant & update everything!

       Categories support 100+ variants each!
       ======================================== */
  </style>
  <link rel="stylesheet" href="creatures.css">
</head>
<body class="bg-gradient-to-br from-violet-500 via-purple-500 to-fuchsia-500 min-h-screen">
<div id="app"></div>
<script src="js/creatures/mystical.js?v=8"></script>
<script src="js/creatures/mammals.js?v=1"></script>
<script src="js/creatures/birds.js?v=36"></script>
<script src="js/creatures/reptiles.js"></script>
<script src="js/creatures/prehistoric.js?v=10"></script>
<script src="js/creatures/aquatic.js?v=2"></script>
<script src="js/creatures/insects.js?v=39"></script>
<script src="js/creatures/aliens.js?v=5"></script>
<script src="js/creatures/eggs.js"></script>
<script src="js/creatures/babies.js"></script>
<script src="js/creatures/teens.js"></script>
<script src="js/creatures/game.js"></script>
<script>
const TAGS=['Faith','Hope','Charity','Courage','Prayer','Repentance','Gratitude','Family','Service','Obedience','Worship','Jesus Christ','Trials','Peace','Wisdom','Love','Patience'];

// LDS Doctrine Mastery / Scripture Mastery verses (100 passages for Seminary)
const LDS_DOCTRINE_MASTERY=[
  // Old Testament (25 verses)
  {b:'Moses',c:1,v:'39',t:'For behold, this is my work and my gloryâ€”to bring to pass the immortality and eternal life of man.',dm:true},
  {b:'Moses',c:7,v:'18',t:'And the Lord called his people Zion, because they were of one heart and one mind, and dwelt in righteousness; and there was no poor among them.',dm:true},
  {b:'Abraham',c:3,v:'22-23',t:'Now the Lord had shown unto me, Abraham, the intelligences that were organized before the world was... And God saw these souls that they were good.',dm:true},
  {b:'Genesis',c:1,v:'26-27',t:'And God said, Let us make man in our image, after our likeness... So God created man in his own image.',dm:true},
  {b:'Genesis',c:2,v:'24',t:'Therefore shall a man leave his father and his mother, and shall cleave unto his wife: and they shall be one flesh.',dm:true},
  {b:'Genesis',c:39,v:'9',t:'How then can I do this great wickedness, and sin against God?',dm:true},
  {b:'Exodus',c:20,v:'3-17',t:'Thou shalt have no other gods before me... Thou shalt not kill. Thou shalt not commit adultery. Thou shalt not steal.',dm:true},
  {b:'Exodus',c:33,v:'11',t:'And the Lord spake unto Moses face to face, as a man speaketh unto his friend.',dm:true},
  {b:'Leviticus',c:19,v:'18',t:'Thou shalt love thy neighbour as thyself: I am the Lord.',dm:true},
  {b:'Joshua',c:1,v:'8',t:'This book of the law shall not depart out of thy mouth; but thou shalt meditate therein day and night.',dm:true},
  {b:'Joshua',c:24,v:'15',t:'Choose you this day whom ye will serve... but as for me and my house, we will serve the Lord.',dm:true},
  {b:'1 Samuel',c:16,v:'7',t:'The Lord seeth not as man seeth; for man looketh on the outward appearance, but the Lord looketh on the heart.',dm:true},
  {b:'Job',c:19,v:'25-26',t:'For I know that my redeemer liveth, and that he shall stand at the latter day upon the earth.',dm:true},
  {b:'Psalm',c:24,v:'3-4',t:'Who shall ascend into the hill of the Lord? He that hath clean hands, and a pure heart.',dm:true},
  {b:'Psalm',c:119,v:'105',t:'Thy word is a lamp unto my feet, and a light unto my path.',dm:true},
  {b:'Proverbs',c:3,v:'5-6',t:'Trust in the Lord with all thine heart; and lean not unto thine own understanding. In all thy ways acknowledge him, and he shall direct thy paths.',dm:true},
  {b:'Isaiah',c:1,v:'18',t:'Come now, and let us reason together, saith the Lord: though your sins be as scarlet, they shall be as white as snow.',dm:true},
  {b:'Isaiah',c:29,v:'13-14',t:'This people draw near me with their mouth... therefore I will proceed to do a marvellous work among this people.',dm:true},
  {b:'Isaiah',c:53,v:'3-5',t:'He is despised and rejected of men; a man of sorrows... he was wounded for our transgressions.',dm:true},
  {b:'Isaiah',c:55,v:'8-9',t:'For my thoughts are not your thoughts, neither are your ways my ways, saith the Lord.',dm:true},
  {b:'Jeremiah',c:1,v:'4-5',t:'Before I formed thee in the belly I knew thee; and before thou camest forth out of the womb I sanctified thee.',dm:true},
  {b:'Ezekiel',c:37,v:'15-17',t:'Take thee one stick, and write upon it, For Judah... then take another stick, and write upon it, For Joseph.',dm:true},
  {b:'Amos',c:3,v:'7',t:'Surely the Lord God will do nothing, but he revealeth his secret unto his servants the prophets.',dm:true},
  {b:'Malachi',c:3,v:'8-10',t:'Will a man rob God? Yet ye have robbed me. But ye say, Wherein have we robbed thee? In tithes and offerings.',dm:true},
  {b:'Malachi',c:4,v:'5-6',t:'Behold, I will send you Elijah the prophet before the coming of the great and dreadful day of the Lord.',dm:true},
  // New Testament (25 verses)
  {b:'Matthew',c:5,v:'14-16',t:'Ye are the light of the world. A city that is set on an hill cannot be hid... Let your light so shine before men.',dm:true},
  {b:'Matthew',c:6,v:'24',t:'No man can serve two masters... Ye cannot serve God and mammon.',dm:true},
  {b:'Matthew',c:11,v:'28-30',t:'Come unto me, all ye that labour and are heavy laden, and I will give you rest. Take my yoke upon you.',dm:true},
  {b:'Matthew',c:16,v:'15-19',t:'He saith unto them, But whom say ye that I am? And Simon Peter answered... Thou art the Christ.',dm:true},
  {b:'Matthew',c:25,v:'40',t:'Inasmuch as ye have done it unto one of the least of these my brethren, ye have done it unto me.',dm:true},
  {b:'Matthew',c:28,v:'19-20',t:'Go ye therefore, and teach all nations, baptizing them in the name of the Father, and of the Son, and of the Holy Ghost.',dm:true},
  {b:'Luke',c:2,v:'40',t:'And the child grew, and waxed strong in spirit, filled with wisdom: and the grace of God was upon him.',dm:true},
  {b:'Luke',c:22,v:'39-46',t:'And he came out, and went, as he was wont, to the mount of Olives... And being in an agony he prayed more earnestly.',dm:true},
  {b:'John',c:3,v:'5',t:'Except a man be born of water and of the Spirit, he cannot enter into the kingdom of God.',dm:true},
  {b:'John',c:7,v:'17',t:'If any man will do his will, he shall know of the doctrine, whether it be of God.',dm:true},
  {b:'John',c:10,v:'16',t:'And other sheep I have, which are not of this fold: them also I must bring... and there shall be one fold, and one shepherd.',dm:true},
  {b:'John',c:14,v:'6',t:'I am the way, the truth, and the life: no man cometh unto the Father, but by me.',dm:true},
  {b:'John',c:14,v:'15',t:'If ye love me, keep my commandments.',dm:true},
  {b:'John',c:15,v:'16',t:'Ye have not chosen me, but I have chosen you, and ordained you, that ye should go and bring forth fruit.',dm:true},
  {b:'John',c:17,v:'3',t:'And this is life eternal, that they might know thee the only true God, and Jesus Christ, whom thou hast sent.',dm:true},
  {b:'Acts',c:2,v:'36-38',t:'Therefore let all the house of Israel know assuredly, that God hath made that same Jesus... both Lord and Christ.',dm:true},
  {b:'Romans',c:1,v:'16',t:'For I am not ashamed of the gospel of Christ: for it is the power of God unto salvation.',dm:true},
  {b:'1 Corinthians',c:6,v:'19-20',t:'Know ye not that your body is the temple of the Holy Ghost which is in you?',dm:true},
  {b:'1 Corinthians',c:15,v:'20-22',t:'But now is Christ risen from the dead, and become the firstfruits of them that slept.',dm:true},
  {b:'1 Corinthians',c:15,v:'40-42',t:'There are also celestial bodies, and bodies terrestrial... So also is the resurrection of the dead.',dm:true},
  {b:'Ephesians',c:4,v:'11-14',t:'And he gave some, apostles; and some, prophets; and some, evangelists; and some, pastors and teachers.',dm:true},
  {b:'2 Timothy',c:3,v:'15-17',t:'And that from a child thou hast known the holy scriptures, which are able to make thee wise unto salvation.',dm:true},
  {b:'Hebrews',c:5,v:'4',t:'And no man taketh this honour unto himself, but he that is called of God, as was Aaron.',dm:true},
  {b:'James',c:1,v:'5-6',t:'If any of you lack wisdom, let him ask of God, that giveth to all men liberally... and it shall be given him.',dm:true},
  {b:'James',c:2,v:'17-18',t:'Even so faith, if it hath not works, is dead, being alone.',dm:true},
  // Book of Mormon (25 verses)
  {b:'1 Nephi',c:3,v:'7',t:'I will go and do the things which the Lord hath commanded, for I know that the Lord giveth no commandments unto the children of men, save he shall prepare a way.',dm:true},
  {b:'1 Nephi',c:19,v:'23',t:'I did liken all scriptures unto us, that it might be for our profit and learning.',dm:true},
  {b:'2 Nephi',c:2,v:'25',t:'Adam fell that men might be; and men are, that they might have joy.',dm:true},
  {b:'2 Nephi',c:2,v:'27',t:'Wherefore, men are free according to the flesh... they are free to choose liberty and eternal life, through the great Mediator.',dm:true},
  {b:'2 Nephi',c:9,v:'28-29',t:'O that cunning plan of the evil one! O the vainness, and the frailties, and the foolishness of men!',dm:true},
  {b:'2 Nephi',c:28,v:'7-9',t:'Yea, and there shall be many which shall say: Eat, drink, and be merry... for tomorrow we die.',dm:true},
  {b:'2 Nephi',c:31,v:'19-20',t:'After ye have gotten into this strait and narrow path, I would ask if all is done? Behold, I say unto you, Nay.',dm:true},
  {b:'2 Nephi',c:32,v:'3',t:'Feast upon the words of Christ; for behold, the words of Christ will tell you all things what ye should do.',dm:true},
  {b:'2 Nephi',c:32,v:'8-9',t:'And now, my beloved brethren, I perceive that ye ponder still in your hearts... ye must pray always.',dm:true},
  {b:'Jacob',c:2,v:'18-19',t:'But before ye seek for riches, seek ye for the kingdom of God.',dm:true},
  {b:'Mosiah',c:2,v:'17',t:'When ye are in the service of your fellow beings ye are only in the service of your God.',dm:true},
  {b:'Mosiah',c:3,v:'19',t:'For the natural man is an enemy to God, and has been from the fall of Adam, and will be, forever and ever, unless he yields to the enticings of the Holy Spirit.',dm:true},
  {b:'Mosiah',c:4,v:'30',t:'But this much I can tell you, that if ye do not watch yourselves, and your thoughts, and your words, and your deeds, and observe the commandments of God.',dm:true},
  {b:'Alma',c:7,v:'11-13',t:'And he shall go forth, suffering pains and afflictions and temptations of every kind... that he may know according to the flesh how to succor his people.',dm:true},
  {b:'Alma',c:32,v:'21',t:'Faith is not to have a perfect knowledge of things; therefore if ye have faith ye hope for things which are not seen, which are true.',dm:true},
  {b:'Alma',c:34,v:'32-34',t:'This life is the time for men to prepare to meet God; yea, behold the day of this life is the day for men to perform their labors.',dm:true},
  {b:'Alma',c:37,v:'6-7',t:'Now ye may suppose that this is foolishness in me; but behold I say unto you, that by small and simple things are great things brought to pass.',dm:true},
  {b:'Alma',c:37,v:'35',t:'O, remember, my son, and learn wisdom in thy youth; yea, learn in thy youth to keep the commandments of God.',dm:true},
  {b:'Alma',c:41,v:'10',t:'Wickedness never was happiness.',dm:true},
  {b:'Helaman',c:5,v:'12',t:'And now, my sons, remember, remember that it is upon the rock of our Redeemer, who is Christ, the Son of God, that ye must build your foundation.',dm:true},
  {b:'3 Nephi',c:11,v:'29',t:'For verily, verily I say unto you, he that hath the spirit of contention is not of me, but is of the devil.',dm:true},
  {b:'3 Nephi',c:12,v:'48',t:'Therefore I would that ye should be perfect even as I, or your Father who is in heaven is perfect.',dm:true},
  {b:'3 Nephi',c:27,v:'27',t:'Therefore, what manner of men ought ye to be? Verily I say unto you, even as I am.',dm:true},
  {b:'Ether',c:12,v:'6',t:'Faith is things which are hoped for and not seen; wherefore, dispute not because ye see not, for ye receive no witness until after the trial of your faith.',dm:true},
  {b:'Ether',c:12,v:'27',t:'If men come unto me I will show unto them their weakness... for if they humble themselves before me, and have faith in me, then will I make weak things become strong.',dm:true},
  {b:'Moroni',c:7,v:'16-17',t:'For behold, the Spirit of Christ is given to every man, that he may know good from evil.',dm:true},
  {b:'Moroni',c:7,v:'45',t:'And charity suffereth long, and is kind, and envieth not, and is not puffed up.',dm:true},
  {b:'Moroni',c:10,v:'4-5',t:'And when ye shall receive these things, I would exhort you that ye would ask God, the Eternal Father, in the name of Christ, if these things are not true.',dm:true},
  // Doctrine and Covenants (25 verses)
  {b:'D&C',c:1,v:'37-38',t:'Search these commandments, for they are true and faithful, and the prophecies and promises which are in them shall all be fulfilled.',dm:true},
  {b:'D&C',c:6,v:'36',t:'Look unto me in every thought; doubt not, fear not.',dm:true},
  {b:'D&C',c:8,v:'2-3',t:'Yea, behold, I will tell you in your mind and in your heart, by the Holy Ghost, which shall come upon you and which shall dwell in your heart.',dm:true},
  {b:'D&C',c:10,v:'5',t:'Pray always, that you may come off conqueror; yea, that you may conquer Satan, and that you may escape the hands of the servants of Satan.',dm:true},
  {b:'D&C',c:13,v:'1',t:'Upon you my fellow servants, in the name of Messiah I confer the Priesthood of Aaron, which holds the keys of the ministering of angels.',dm:true},
  {b:'D&C',c:14,v:'7',t:'And, if you keep my commandments and endure to the end you shall have eternal life, which gift is the greatest of all the gifts of God.',dm:true},
  {b:'D&C',c:18,v:'10-11',t:'Remember the worth of souls is great in the sight of God.',dm:true},
  {b:'D&C',c:18,v:'15-16',t:'And if it so be that you should labor all your days in crying repentance unto this people, and bring, save it be one soul unto me, how great shall be your joy.',dm:true},
  {b:'D&C',c:19,v:'16-19',t:'For behold, I, God, have suffered these things for all, that they might not suffer if they would repent.',dm:true},
  {b:'D&C',c:25,v:'13',t:'Wherefore, lift up thy heart and rejoice, and cleave unto the covenants which thou hast made.',dm:true},
  {b:'D&C',c:46,v:'33',t:'And ye must practice virtue and holiness before me continually.',dm:true},
  {b:'D&C',c:58,v:'26-27',t:'For behold, it is not meet that I should command in all things; for he that is compelled in all things, the same is a slothful and not a wise servant.',dm:true},
  {b:'D&C',c:58,v:'42-43',t:'Behold, he who has repented of his sins, the same is forgiven, and I, the Lord, remember them no more.',dm:true},
  {b:'D&C',c:64,v:'9-11',t:'Wherefore, I say unto you, that ye ought to forgive one another; for he that forgiveth not his brother his trespasses standeth condemned.',dm:true},
  {b:'D&C',c:76,v:'22-24',t:'And now, after the many testimonies which have been given of him, this is the testimony, last of all, which we give of him: That he lives!',dm:true},
  {b:'D&C',c:78,v:'19',t:'And he who receiveth all things with thankfulness shall be made glorious; and the things of this earth shall be added unto him.',dm:true},
  {b:'D&C',c:82,v:'10',t:'I, the Lord, am bound when ye do what I say; but when ye do not what I say, ye have no promise.',dm:true},
  {b:'D&C',c:84,v:'33-39',t:'For whoso is faithful unto the obtaining these two priesthoods of which I have spoken, and the magnifying their calling... they become the sons of Moses and of Aaron.',dm:true},
  {b:'D&C',c:88,v:'124',t:'Cease to be idle; cease to be unclean; cease to find fault one with another; cease to sleep longer than is needful.',dm:true},
  {b:'D&C',c:89,v:'18-21',t:'And all saints who remember to keep and do these sayings, walking in obedience to the commandments, shall receive health in their navel.',dm:true},
  {b:'D&C',c:121,v:'34-36',t:'Behold, there are many called, but few are chosen... because their hearts are set so much upon the things of this world.',dm:true},
  {b:'D&C',c:121,v:'41-42',t:'No power or influence can or ought to be maintained by virtue of the priesthood, only by persuasion, by long-suffering, by gentleness and meekness.',dm:true},
  {b:'D&C',c:130,v:'18-19',t:'Whatever principle of intelligence we attain unto in this life, it will rise with us in the resurrection.',dm:true},
  {b:'D&C',c:130,v:'22-23',t:'The Father has a body of flesh and bones as tangible as man\'s; the Son also; but the Holy Ghost has not a body of flesh and bones.',dm:true},
  {b:'D&C',c:131,v:'1-4',t:'In the celestial glory there are three heavens or degrees; And in order to obtain the highest, a man must enter into this order of the priesthood.',dm:true}
];

const STARTER=[
  {t:'scripture',r:'Proverbs 3:5-6',x:'Trust in the Lord with all thine heart; and lean not unto thine own understanding. In all thy ways acknowledge him, and he shall direct thy paths.',g:['Faith','Wisdom']},
  {t:'scripture',r:'Philippians 4:13',x:'I can do all things through Christ which strengtheneth me.',g:['Courage','Faith']},
  {t:'scripture',r:'Joshua 1:9',x:'Be strong and of a good courage; be not afraid, neither be thou dismayed: for the Lord thy God is with thee.',g:['Courage','Faith']},
  {t:'scripture',r:'Jeremiah 29:11',x:'For I know the thoughts that I think toward you, saith the Lord, thoughts of peace, and not of evil, to give you an expected end.',g:['Hope','Peace']},
  {t:'scripture',r:'Romans 8:28',x:'And we know that all things work together for good to them that love God, to them who are the called according to his purpose.',g:['Faith','Trials']},
  {t:'scripture',r:'Isaiah 41:10',x:'Fear thou not; for I am with thee: be not dismayed; for I am thy God: I will strengthen thee; yea, I will help thee.',g:['Courage','Faith']},
  {t:'scripture',r:'Psalm 23:1',x:'The Lord is my shepherd; I shall not want.',g:['Peace','Faith']},
  {t:'scripture',r:'John 3:16',x:'For God so loved the world, that he gave his only begotten Son, that whosoever believeth in him should not perish, but have everlasting life.',g:['Love','Jesus Christ']},
  {t:'scripture',r:'Matthew 11:28',x:'Come unto me, all ye that labour and are heavy laden, and I will give you rest.',g:['Peace','Jesus Christ']},
  {t:'quote',r:'C.S. Lewis',x:'You can never get a cup of tea large enough or a book long enough to suit me.',g:['Wisdom','Peace']},
  {t:'quote',r:'Mother Teresa',x:'If you judge people, you have no time to love them.',g:['Love','Charity']},
  {t:'quote',r:'Billy Graham',x:'God has given us two hands, one to receive with and the other to give with.',g:['Service','Charity']},
];

// Rarity tiers with spawn probabilities (must sum to 100)
const RARITY_WEIGHTS={
  'Common':44,      // 44% chance
  'Uncommon':28,    // 28% chance
  'Rare':15,        // 15% chance
  'Epic':8,         // 8% chance
  'Legendary':3,    // 3% chance
  'Mythic':2        // 2% chance (1 in 50) - extremely rare!
};

// Rarity display colors for UI
const RARITY_COLORS={
  'Common':'from-gray-400 to-gray-500',
  'Uncommon':'from-green-400 to-emerald-500',
  'Rare':'from-blue-400 to-indigo-500',
  'Epic':'from-purple-400 to-violet-600',
  'Legendary':'from-yellow-400 to-orange-500',
  'Mythic':'from-pink-400 via-rose-500 to-red-500'
};

// Rarity card frame styles (border and glow effects)
const RARITY_FRAMES={
  'Common':{border:'#9ca3af',glow:'none',shine:false,sparkles:0},
  'Uncommon':{border:'#22c55e',glow:'0 0 10px rgba(34,197,94,0.3)',shine:false,sparkles:0},
  'Rare':{border:'#3b82f6',glow:'0 0 15px rgba(59,130,246,0.4)',shine:true,sparkles:3},
  'Epic':{border:'#a855f7',glow:'0 0 20px rgba(168,85,247,0.5)',shine:true,sparkles:5},
  'Legendary':{border:'#f59e0b',glow:'0 0 25px rgba(245,158,11,0.6),0 0 40px rgba(245,158,11,0.3)',shine:true,sparkles:8},
  'Mythic':{border:'linear-gradient(135deg,#ec4899,#f59e0b,#22c55e,#3b82f6,#a855f7)',glow:'0 0 30px rgba(236,72,153,0.5),0 0 50px rgba(168,85,247,0.3)',shine:true,sparkles:12,rainbow:true}
};

// Category background themes for cards
const CATEGORY_CARD_THEMES={
  birds:{bg:'linear-gradient(180deg,#bae6fd,#7dd3fc,#38bdf8)',accent:'#0ea5e9',particles:'clouds'},
  reptiles:{bg:'linear-gradient(180deg,#bbf7d0,#86efac,#4ade80)',accent:'#22c55e',particles:'leaves'},
  mammals:{bg:'linear-gradient(180deg,#fed7aa,#fdba74,#fb923c)',accent:'#f97316',particles:'hearts'},
  mystical:{bg:'linear-gradient(180deg,#f5d0fe,#e879f9,#d946ef)',accent:'#a855f7',particles:'stars'},
  aquatic:{bg:'linear-gradient(180deg,#a5f3fc,#67e8f9,#22d3ee)',accent:'#06b6d4',particles:'bubbles'},
  insects:{bg:'linear-gradient(180deg,#fef08a,#fde047,#facc15)',accent:'#eab308',particles:'sparkles'},
  prehistoric:{bg:'linear-gradient(180deg,#d6d3d1,#a8a29e,#78716c)',accent:'#57534e',particles:'dust'},
  alien:{bg:'linear-gradient(180deg,#c4b5fd,#a78bfa,#8b5cf6)',accent:'#7c3aed',particles:'energy'}
};

// Generate particle HTML for card backgrounds
function generateCardParticles(type,count=6){
  const particles=[];
  for(let i=0;i<count;i++){
    const left=10+Math.random()*80;
    const top=10+Math.random()*80;
    const delay=(Math.random()*2).toFixed(1);
    const size=3+Math.random()*4;
    let emoji='âœ¨';
    let extraStyle='';
    if(type==='bubbles'){emoji='â—‹';extraStyle='color:rgba(255,255,255,0.5);';}
    else if(type==='stars'){emoji='âœ¦';extraStyle='color:rgba(255,255,255,0.8);';}
    else if(type==='clouds'){emoji='â˜';extraStyle='color:rgba(255,255,255,0.4);font-size:'+(size+4)+'px;';}
    else if(type==='hearts'){emoji='â™¥';extraStyle='color:rgba(255,200,200,0.5);';}
    else if(type==='embers'){emoji='â—';extraStyle='color:rgba(255,180,50,0.6);';}
    else if(type==='leaves'){emoji='ðŸƒ';extraStyle='font-size:'+(size+2)+'px;opacity:0.4;';}
    else if(type==='dust'){emoji='â€¢';extraStyle='color:rgba(120,113,108,0.4);';}
    else if(type==='energy'){emoji='âš¡';extraStyle='color:rgba(167,139,250,0.5);font-size:'+(size+2)+'px;';}
    else if(type==='magic'){emoji='âœ§';extraStyle='color:rgba(255,255,255,0.7);';}
    particles.push(`<div style="position:absolute;left:${left}%;top:${top}%;font-size:${size}px;animation:sparkle-twinkle ${1.5+Math.random()}s ease-in-out infinite;animation-delay:${delay}s;pointer-events:none;${extraStyle}">${emoji}</div>`);
  }
  return particles.join('');
}

// Generate sparkle effects for rare+ cards
function generateRaritySparkles(count){
  if(count<=0)return'';
  const sparkles=[];
  for(let i=0;i<count;i++){
    const left=5+Math.random()*90;
    const top=5+Math.random()*90;
    const delay=(Math.random()*3).toFixed(1);
    const size=4+Math.random()*6;
    sparkles.push(`<div style="position:absolute;left:${left}%;top:${top}%;width:${size}px;height:${size}px;background:#fff;border-radius:50%;box-shadow:0 0 ${size*2}px #fef08a,0 0 ${size*3}px #fbbf24;animation:sparkle-twinkle ${1+Math.random()}s ease-in-out infinite;animation-delay:${delay}s;pointer-events:none;z-index:100;"></div>`);
  }
  return sparkles.join('');
}

// Select a random variant index based on rarity weights
function selectVariantByRarity(category){
  const rarities=category.adultRarities;
  if(!rarities||!rarities.length)return Math.floor(Math.random()*category.adultVariants.length);

  // Build weighted pool
  const pool=[];
  rarities.forEach((rarity,idx)=>{
    const weight=RARITY_WEIGHTS[rarity]||RARITY_WEIGHTS['Common'];
    for(let i=0;i<weight;i++)pool.push(idx);
  });

  // Random selection from pool
  return pool[Math.floor(Math.random()*pool.length)];
}

// 9 Creature Categories - Each with unique evolution path
const CREATURE_CATEGORIES={
  birds:{
    eggType:'white',
    blobEmoji:'blob',  // Uses renderBlob() - cute creature with eyes
    babyEmoji:'baby',   // Uses renderBaby() - cute baby chick ðŸ¥
    teenEmoji:'teen',   // Uses renderTeen() - 3 progressive designs
    teenVariants:['ðŸ¤','ðŸ¤','ðŸ¤','ðŸ¤','ðŸ¤','ðŸ¤','ðŸ¤','ðŸ¤','ðŸ¤','ðŸ¤','ðŸ¤'],  // Young birds (for reference)
    teenNames:['Fledgling I','Fledgling II','Fledgling III','Fledgling IV','Fledgling V','Fledgling VI','Fledgling VII','Fledgling VIII','Fledgling IX','Fledgling X','Fledgling XI'],
    adultVariants:['ðŸ¦š','ðŸ¦œ','ðŸ¦¢','ðŸ¦©','ðŸ¦¢','ðŸ§','ðŸ¦†','ðŸ“','ðŸ¦œ','ðŸ¦©','ðŸ¦‰','ðŸ¦œ'],  // Mature birds - full body
    adultNames:['Peacock','Scarlet Macaw','Swan','Flamingo','Royal Swan','Penguin','Quacky','Rooster','Toucan','Golden Flamingo','Great Horned Owl','Lovebird'],
    adultRarities:['Epic','Uncommon','Rare','Legendary','Mythic','Rare','Common','Uncommon','Epic','Legendary','Epic','Rare']
  },
  aquatic:{
    eggType:'blue',
    blobEmoji:'blob',  // Uses renderBlob() - cute creature with eyes
    babyEmoji:'baby',   // Uses renderBaby() - cute baby fish ðŸ 
    teenEmoji:'teen',   // Uses renderTeen() - 3 progressive designs
    teenVariants:['ðŸŸ','ðŸ ','ðŸ¡','ðŸ¡','ðŸ™','ðŸ¦‘','ðŸ¦ž','ðŸ¦€','ðŸš','ðŸª¼'],  // Smaller sea creatures (for reference)
    teenNames:['Swimmer I','Swimmer II','Swimmer III','Swimmer IV','Swimmer V','Swimmer VI','Swimmer VII','Swimmer VIII','Swimmer IX','Swimmer X'],
    adultVariants:['ðŸ¦Ž','ðŸ¦„','ðŸª¼','ðŸ™'],  // CSS-rendered aquatic creatures
    adultNames:['Axolotl','Narwhal','Jellyfish','Octopus'],
    adultRarities:['Legendary','Mythic','Rare','Epic']
  },
  reptiles:{
    eggType:'spotted',
    blobEmoji:'blob',  // Uses renderBlob() - cute creature with eyes
    babyEmoji:'baby',   // Uses renderBaby() - cute baby lizard ðŸ¦Ž
    teenEmoji:'teen',   // Uses renderTeen() - 3 progressive designs
    teenVariants:['ðŸ¦Ž','ðŸ¦Ž','ðŸ¢','ðŸ','ðŸ¢','ðŸ','ðŸ¸','ðŸ¸','ðŸ¦Ž','ðŸ¢','ðŸ','ðŸ','ðŸ','ðŸ¦Ž'],  // Young reptiles (for reference)
    teenNames:['Scaleling I','Scaleling II','Scaleling III','Scaleling IV','Scaleling V','Scaleling VI','Scaleling VII','Scaleling VIII','Scaleling IX','Scaleling X','Scaleling XI','Scaleling XII','Scaleling XIII','Scaleling XIV'],
    adultVariants:['ðŸ¦Ž','ðŸ¸','ðŸ¢','ðŸ','ðŸ','ðŸ','ðŸ','ðŸ','ðŸ','ðŸ','ðŸ','ðŸ','ðŸ','ðŸ¦Ž'],  // Adult reptiles - full body (14 variants)
    adultNames:['Gecko','Frog','Turtle','Cobra','Emerald Python','Purple Snake','Pygmy Rattlesnake','Coiled Rattlesnake','Rainbow Snake','Purple Cobra','Flaming Cobra','Ice Cobra','King Cobra','Golden Gecko'],
    adultRarities:['Common','Common','Common','Uncommon','Rare','Uncommon','Common','Common','Epic','Rare','Legendary','Legendary','Epic','Mythic']
  },
  insects:{
    eggType:'small',
    blobEmoji:'blob',  // Uses renderBlob() - cute creature with eyes
    babyEmoji:'baby',   // Uses renderBaby() - cute caterpillar ðŸ›
    teenEmoji:'teen',   // Uses renderTeen() - 3 progressive designs
    teenVariants:['ðŸ›','ðŸ›','ðŸ','ðŸž','ðŸ¦—','ðŸª°','ðŸª²','ðŸ¦Ÿ','ðŸª³','ðŸ•·ï¸'],  // Larva/young bugs (for reference)
    teenNames:['Larva I','Larva II','Larva III','Larva IV','Larva V','Larva VI','Larva VII','Larva VIII','Larva IX','Larva X'],
    adultVariants:['ðŸž','ðŸª°','ðŸª°','ðŸª²','ðŸª²','ðŸ','ðŸª²'],  // Adult insects - full CSS designs 0-6
    adultNames:['Busy Ladybug','Neon Dragonfly','Buzzy Housefly','Stag Beetle','Metallic Green Stag Beetle','Bumblebee','Lightning Bug'],
    adultRarities:['Epic','Epic','Uncommon','Rare','Mythic','Epic','Legendary']
  },
  mammals:{
    eggType:'brown',
    blobEmoji:'blob',  // Uses renderBlob() - cute creature with eyes
    babyEmoji:'baby',   // Uses renderBaby() - cute baby bear ðŸ»
    teenEmoji:'teen',   // Uses renderTeen() - 3 progressive designs
    teenVariants:['ðŸ¶','ðŸ±','ðŸ­','ðŸ¹','ðŸ°','ðŸ¦Š','ðŸ»','ðŸ¼','ðŸ¨','ðŸ¦'],  // Baby mammals (for reference)
    teenNames:['Fuzzy I','Fuzzy II','Fuzzy III','Fuzzy IV','Fuzzy V','Fuzzy VI','Fuzzy VII','Fuzzy VIII','Fuzzy IX','Fuzzy X'],
    adultVariants:['ðŸ•','ðŸˆ','ðŸŽ','ðŸ—','ðŸ†','ðŸ…','ðŸ¦¬','ðŸ˜','ðŸ¦','ðŸ¦›','ðŸ¦Š','ðŸ¿ï¸','ðŸ»','ðŸ´','ðŸ„','ðŸ¦'],  // Adult mammals - full body (16 variants: 0-15)
    adultNames:['Bunny','Kitty','Koala','Fox','Mouse','Trash Panda','Red Panda','Sloth','Fox In Sox','Panda','Puppy','Squirrel','Bear','Horse','Cow','Golden Raccoon'],
    adultRarities:['Common','Common','Uncommon','Uncommon','Common','Rare','Epic','Rare','Mythic','Legendary','Common','Common','Uncommon','Common','Common','Legendary']
  },
  prehistoric:{
    eggType:'large',
    blobEmoji:'blob',  // Uses renderBlob() - cute creature with eyes
    babyEmoji:'baby',   // Uses renderBaby() - cute baby dino
    teenEmoji:'teen',   // Uses renderTeen() - 3 progressive designs
    teenVariants:['ðŸ¦–','ðŸ¦•','ðŸ¦–'],  // Young prehistoric (for reference)
    teenNames:['Triceratops','Velociraptor','T-Rex'],
    adultVariants:['ðŸ¦–','ðŸ¦•','ðŸ¦–','ðŸ¦–','ðŸ§”'],  // Adult prehistoric (renders used instead)
    adultNames:['T-Rex','Bronto','Stego','Lil T-Rex','Caveman'],
    adultRarities:['Uncommon','Common','Rare','Mythic','Epic']
  },
  alien:{
    eggType:'blue',
    blobEmoji:'blob',  // Uses renderBlob() - cute creature with eyes
    babyEmoji:'baby',   // Uses renderBaby() - cute baby alien ðŸ‘½
    teenEmoji:'teen',   // Uses renderTeen() - 3 progressive designs
    teenVariants:['ðŸ‘¾','ðŸ¤–','ðŸ‘½','ðŸ›¸','ðŸ’«','â­','âœ¨','ðŸŒŸ','ðŸ’¥','ðŸ”®','ðŸ‘ï¸'],  // Young aliens (for reference)
    teenNames:['Cosmic I','Cosmic II','Cosmic III','Cosmic IV','Cosmic V','Cosmic VI','Cosmic VII','Cosmic VIII','Cosmic IX','Cosmic X','Cosmic XI'],
    adultVariants:['ðŸ‘½','ðŸ‘ï¸','ðŸ¦Ž'],  // CSS-rendered aliens
    adultNames:['Cosmic Friend','Flying Eye','Chimera'],
    adultRarities:['Rare','Legendary','Legendary']
  },
  mystical:{
    eggType:'speckled',
    blobEmoji:'blob',  // Uses renderBlob() - cute creature with eyes
    babyEmoji:'baby',   // Uses renderBaby() - cute crystal ball ðŸ”®
    teenEmoji:'teen',   // Uses renderTeen() - 5 progressive designs (spirit, celestial, divine, unicorn, phoenix)
    teenVariants:['ðŸ§™','ðŸ§š','ðŸ§›','ðŸ§œ','ðŸ§ž','ðŸ§','ðŸ¦„','ðŸ¦„'],  // Young mystical (for reference)
    teenNames:['Spirit I','Spirit II','Celestial I','Celestial II','Divine I','Divine II','Unicorn I','Unicorn II'],
    adultVariants:['ðŸ¦„','ðŸ¦„','ðŸ¦Š','ðŸ±','ðŸ¦'],  // Ancient mystical - full body
    adultNames:['Unicorn','Flaming Unicorn','Kitsune','Maneki-neko','Tanuki'],
    adultRarities:['Mythic','Legendary','Legendary','Rare','Epic']
  }
};

// Array of category keys for random selection
const CATEGORY_KEYS=Object.keys(CREATURE_CATEGORIES);

// Cute creature blurbs for trading cards (PokÃ©dex-style descriptions)
const CREATURE_BLURBS={
  // Stage-based blurbs (shared across categories)
  stages:{
    egg:'A mysterious egg filled with potential! What adorable creature waits inside?',
    blob:'A freshly hatched blob of pure cuteness! Still learning about the world with those big curious eyes.',
    baby:'Growing stronger every day! This little one loves to explore and make new friends.',
    teen:'Almost fully grown! Developing unique traits and showing off its personality.',
    adult:'A magnificent fully-grown Scribby! Raised with love and scripture practice.'
  },
  // Category-specific adult blurbs by variant index
  birds:{
    0:'This friendly duck loves splashing in puddles and making everyone smile with its cheerful quacks!',
    1:'A gentle dove that brings peace wherever it flies. Known for its soft cooing and kind nature.',
    2:'A majestic eagle with sharp eyes and a brave heart. Loves soaring high above the clouds!',
    3:'This colorful mallard is always ready for adventure, especially if there are breadcrumbs involved.',
    4:'A wise owl who stays up late reading and shares knowledge with anyone who asks.',
    5:'This stunning peacock loves to show off its beautiful feathers at every opportunity!',
    6:'A chatty parrot that can learn any phrase! Loves crackers and making silly jokes.',
    7:'An elegant swan gliding gracefully across calm waters. Known for its beauty and poise.',
    8:'This fabulous flamingo stands on one leg for hours, perfecting its balance and grace.',
    14:'A legendary golden flamingo that shimmers in the sunlight! So rare that some say it brings good fortune to all who meet it.',
    default:'A beautiful feathered friend raised with love and dedication!'
  },
  aquatic:{
    0:'A gentle giant of the sea! This whale sings beautiful songs that echo across the ocean.',
    1:'A playful dolphin that loves doing tricks and making new friends. Always smiling!',
    2:'A cuddly seal that enjoys basking in the sun and clapping for snacks.',
    3:'A misunderstood shark who is actually very friendly. Just wants to give hugs!',
    4:'This clever octopus can solve puzzles and open jars. Has eight arms for eight hugs!',
    5:'A graceful squid that changes colors with its mood. Loves deep-sea exploration!',
    default:'A wonderful sea creature from the depths of the ocean!'
  },
  reptiles:{
    0:'A speedy gecko that can climb any wall! Loves catching bugs and doing parkour.',
    1:'A cheerful frog that sings the best songs on rainy days. Ribbiting personality!',
    2:'A wise turtle taking life one slow step at a time. Carries its home everywhere!',
    3:'A sleek cobra with hypnotic eyes. Actually quite friendly once you get to know it!',
    default:'A cool-blooded friend with scales and a warm heart!'
  },
  mammals:{
    0:'A fluffy bunny with the softest fur! Loves nibbling on carrots and hopping around.',
    1:'An adorable kitty that purrs like a tiny motor. Expert at finding sunny spots.',
    2:'A cuddly koala that gives the best hugs and loves eucalyptus-flavored everything.',
    3:'A clever fox with a bushy tail. Known for being both smart and friendly!',
    4:'A tiny mouse with big dreams! Can squeeze into the smallest spaces.',
    5:'A mischievous raccoon that collects shiny things. Has the cutest little hands!',
    6:'A red panda with the fluffiest tail! Loves bamboo and afternoon naps.',
    7:'A sleepy sloth that takes everything nice and slow. Champion napper!',
    default:'A furry friend with four paws and a heart of gold!'
  },
  mystical:{
    0:'A majestic unicorn with a rainbow mane and a magical golden horn. Its magic brings hope and wonder to all!',
    1:'A legendary flaming unicorn engulfed in eternal fire! Its flames never burn, only warm the hearts of those nearby.',
    2:'A mystical nine-tailed fox spirit with magical blue flames. Wise, playful, and full of ancient secrets!',
    3:'A lucky beckoning cat that brings fortune and prosperity! Its waving paw attracts good luck to all nearby.',
    4:'A magical tanuki with a leaf on its head for shapeshifting! Loves drumming on its belly and playing tricks.',
    default:'A creature of legend and wonder, straight from fairy tales!'
  },
  prehistoric:{
    0:'A fearsome T-Rex with tiny arms but a huge heart! Loves giving high-fives.',
    1:'A gentle Bronto munching on treetops. The friendliest giant around!',
    2:'A Stego with cool back plates that change color with its mood!',
    3:'A tiny but fierce T-Rex! Small in size, huge in attitude and roar!',
    4:'A friendly caveman with a trusty club! Inventor of fire, wheels, and really bad jokes.',
    default:'A prehistoric pal from millions of years ago!'
  },
  alien:{
    0:'A cosmic friend from a distant galaxy! Communicates through colorful light patterns.',
    1:'A biblical Ophanim - a celestial being of interlocking golden rings covered in watchful eyes. It sees all and radiates divine light!',
    default:'An out-of-this-world friend from beyond the stars!'
  },
  insects:{
    default:'A tiny but mighty bug friend with the biggest personality!'
  }
};

// Get creature blurb based on category, stage, and variant
function getCreatureBlurb(categoryKey,stage,variantIdx=0){
  if(stage!=='adult'){
    return CREATURE_BLURBS.stages[stage]||CREATURE_BLURBS.stages.blob;
  }
  const categoryBlurbs=CREATURE_BLURBS[categoryKey];
  if(!categoryBlurbs)return CREATURE_BLURBS.stages.adult;
  return categoryBlurbs[variantIdx]||categoryBlurbs.default||CREATURE_BLURBS.stages.adult;
}

// Categories with fully designed CSS creatures (egg â†’ adult)
// All categories now enabled for testing/development
const FULLY_DESIGNED_CATEGORIES=['birds','aquatic','reptiles','insects','mammals','prehistoric','alien','mystical'];

// Initialize state with random creature category for first egg (only fully designed ones)
const initialCategory=FULLY_DESIGNED_CATEGORIES[Math.floor(Math.random()*FULLY_DESIGNED_CATEGORIES.length)];
let S=JSON.parse(localStorage.getItem('sb')||'null')||{xp:0,streak:0,lastLogin:null,todayCount:0,todayDate:null,milestones:[],verses:STARTER.map((v,i)=>({id:i+1,type:v.t,ref:v.r,text:v.x,tags:v.g,mastery:0,modeUsage:{predict:0,blanks:0,jumble:0,first:0,recall:0},lastPracticed:null})),nextId:STARTER.length+1,careMode:'relaxed',buddyStage:'egg',growthXP:0,eggXP:0,creatureCategory:initialCategory,creatureVariant:null,happiness:100,health:100,lastFed:null,lastHappinessUpdate:null,lastHealthUpdate:null,buddyName:null,hatchDate:null,inventory:[],equipped:{hat:null,eyes:null,held:null,back:null,effect:null},foodInventory:[],graduatedBuddies:[]};

// Ensure new properties exist for existing saves
if(!S.inventory)S.inventory=[];
if(!S.equipped)S.equipped={hat:null,eyes:null,held:null,back:null,effect:null};
if(!S.foodInventory)S.foodInventory=[];
if(!S.accessoryPositions)S.accessoryPositions={}; // Per-stage accessory positions {egg:{hat:{x,y},...}, blob:{...}, ...}
if(!S.placedFurniture)S.placedFurniture=[]; // Array of placed furniture {idx, position:{x,y}}
if(!S.furniturePositions)S.furniturePositions={}; // Per-stage furniture positions
if(!S.graduatedBuddies)S.graduatedBuddies=[]; // Array of graduated buddies
// Migrate old graduated buddies that lack creatureCategory/creatureVariant
let buddyMigrated=false;
S.graduatedBuddies.forEach(buddy=>{
  if(!buddy.creatureCategory||buddy.creatureVariant===undefined||buddy.creatureVariant===null){
    buddyMigrated=true;
    // Try to infer from old field names
    if(buddy.category){
      buddy.creatureCategory=buddy.category;
    }else if(buddy.creatureType){
      // Map old creature type names to categories
      const typeMap={'bird':'birds','reptile':'reptiles','mammal':'mammals','aquatic':'aquatic','insect':'insects'};
      buddy.creatureCategory=typeMap[buddy.creatureType?.toLowerCase()]||'birds';
    }else{
      // Default to birds if no info available
      buddy.creatureCategory='birds';
    }
    // Assign variant if missing
    if(buddy.creatureVariant===undefined||buddy.creatureVariant===null){
      if(buddy.variant!==undefined){
        buddy.creatureVariant=buddy.variant;
      }else{
        // Assign variant based on rarity
        const cat=CREATURE_CATEGORIES[buddy.creatureCategory];
        buddy.creatureVariant=cat?selectVariantByRarity(cat):Math.floor(Math.random()*10);
      }
    }
    console.log('Migrated graduated buddy:',buddy.name,'to category:',buddy.creatureCategory,'variant:',buddy.creatureVariant);
  }
});
if(buddyMigrated){
  localStorage.setItem('sb',JSON.stringify(S));
  console.log('Saved migrated graduated buddies');
}
if(S.eggXP===undefined)S.eggXP=S.buddyStage==='egg'?0:0; // Fresh start with 0 for new eggs
if(S.hatchDate===undefined)S.hatchDate=S.buddyStage!=='egg'?new Date().toISOString():null; // Migrate existing non-egg buddies
// Migrate to new creature category system
if(S.creatureCategory===undefined||S.creatureCategory===null){
  // Assign random category from fully designed ones only
  S.creatureCategory=FULLY_DESIGNED_CATEGORIES[Math.floor(Math.random()*FULLY_DESIGNED_CATEGORIES.length)];

  // For existing hatched buddies, also assign variant based on rarity
  if(S.buddyStage!=='egg'){
    const cat=CREATURE_CATEGORIES[S.creatureCategory];
    S.creatureVariant=cat?selectVariantByRarity(cat):Math.floor(Math.random()*10);
  }else{
    // Eggs get variant assigned at hatching
    S.creatureVariant=null;
  }
}
// Migrate users stuck with incomplete category designs to fully designed ones
if(!FULLY_DESIGNED_CATEGORIES.includes(S.creatureCategory)){
  S.creatureCategory=FULLY_DESIGNED_CATEGORIES[Math.floor(Math.random()*FULLY_DESIGNED_CATEGORIES.length)];
  console.log('Migrated to fully designed category:',S.creatureCategory);
  localStorage.setItem('sb',JSON.stringify(S));
}
if(S.snacksFed!==undefined){
  S.growthXP=Math.min(S.snacksFed*25,99); // Migrate old saves, cap at 99 to prevent overflow
  delete S.snacksFed;
}
if(S.health===undefined)S.health=75;
if(S.lastDecayCheck===undefined)S.lastDecayCheck=Date.now();

// Apply stat decay based on real time passed (whether in app or not)
function applyStatDecay(){
  const now=Date.now();
  const lastCheck=S.lastDecayCheck||now;
  const hoursPassed=Math.floor((now-lastCheck)/(1000*60*60));

  if(hoursPassed>=1){
    // Decay rates: lose 2% happiness per hour, 1% health per hour
    // Minimum floors so Scribby doesn't die completely
    const happinessLoss=Math.min(hoursPassed*2,S.happiness-10);
    const healthLoss=Math.min(hoursPassed*1,S.health-20);

    if(happinessLoss>0){
      S.happiness=Math.max(10,S.happiness-happinessLoss);
    }
    if(healthLoss>0){
      S.health=Math.max(20,S.health-healthLoss);
    }

    // Update the decay check timestamp
    S.lastDecayCheck=now;
    save();
  }
}

// Apply any accumulated decay on app load
applyStatDecay();

// Check for decay every hour while app is open
setInterval(()=>{
  applyStatDecay();
  render(); // Update UI to show new stats
},60*60*1000); // Every hour

// Neglect tracking - timestamps for when stats first hit critical levels
if(S.zeroHappinessSince===undefined)S.zeroHappinessSince=null;
if(S.zeroHealthSince===undefined)S.zeroHealthSince=null;
if(S.criticalWarningShown===undefined)S.criticalWarningShown={happiness:false,health:false};
// Fix overflow from old migration
if(S.growthXP>100&&S.buddyStage!=='egg'&&S.buddyStage!=='adult'){
  S.growthXP=99;
  save();
}
// Migrate verses to have status field (active vs saved-for-later)
S.verses.forEach(v=>{if(v.status===undefined)v.status='active';});
// Owner email - only this account can see the Guide button
const OWNER_EMAIL = 'adgoodwin82@gmail.com';

let screen='home',modal=null,editV=null,form={type:'scripture',ref:'',text:'',tags:[],startPracticing:true};
let pMode=null,pVerse=null,pState={},selectedVerse=null,filterTag=null;
let onboardingSelections={}; // Track selected packs during onboarding
let feedingState=null; // {food: foodObj, accepted: bool, growing: bool}
let feedTab='buy'; // 'buy' or 'myFood'
let downloadProgress=null; // {current: n, total: n, status: 'downloading'|'processing'|'complete'}
let tutorialStep=0; // Current tutorial step (0 = not showing)
let foodPopup=null; // {foodIdx: number, qty: number} - food detail popup state
let verseFilter='active'; // 'active' or 'saved' - which verses to show on practice screen
let practiceReaction=null; // {type: 'correct'|'wrong'|'celebrate', emojis: ['ðŸ’š'], timestamp: Date.now()}
let practiceStreak=0; // Track correct answers in a row
let predictOptions=[]; // Store predict phrase options to avoid onclick escaping issues

// Trigger a practice reaction animation
function triggerReaction(type){
  // Simple emojis: heart for correct/streak/celebrate, sad for wrong
  let emoji='â¤ï¸';
  if(type==='wrong')emoji='ðŸ˜¢';
  practiceReaction={type,emojis:[emoji],timestamp:Date.now()};
  // Clear reaction after animation
  setTimeout(()=>{practiceReaction=null;render()},type==='celebrate'?800:500);
  render();
}

// Get mini scribby HTML for practice screens
function getMiniScribby(){
  const anim=practiceReaction?
    (practiceReaction.type==='wrong'?'practice-sad':
     practiceReaction.type==='celebrate'?'practice-celebrate':'practice-bounce'):'';
  const reactionEmojis=practiceReaction?practiceReaction.emojis.map((e,i)=>
    `<span style="position:absolute;left:${60+i*15}%;top:10px;font-size:32px;animation:float-up-hearts 0.6s ease-out forwards;animation-delay:${i*0.1}s">${e}</span>`
  ).join(''):'';
  return`<div class="relative" style="width:120px;height:130px;overflow:visible;">
    <div class="${anim}" style="transform-origin:center center;">
      <div style="transform:scale(0.5);transform-origin:top left;">
        ${renderBuddyVisual()}
      </div>
    </div>
    ${reactionEmojis}
  </div>`;
}

// Toggle verse status between active and saved
function toggleVerseStatus(verseId){
  const verse=S.verses.find(v=>v.id===verseId);
  if(verse){
    verse.status=verse.status==='active'?'saved':'active';
    save();
    render();
  }
}

// Open food detail popup
function openFoodPopup(foodIdx){
  foodPopup={foodIdx,qty:1};
  render();
}

// Close food detail popup
function closeFoodPopup(){
  foodPopup=null;
  render();
}

// Update quantity in food popup (direct DOM update to avoid flicker)
function setFoodQty(qty){
  if(!foodPopup)return;
  const food=FOODS[foodPopup.foodIdx];
  const maxQty=Math.floor(S.xp/food.cost);
  foodPopup.qty=Math.max(1,Math.min(qty,maxQty));

  // Update DOM elements directly to avoid popup flicker
  const qtyDisplay=document.getElementById('foodPopupQty');
  const totalDisplay=document.getElementById('foodPopupTotal');
  const buyBtn=document.getElementById('foodPopupBuyBtn');
  const minusBtn=document.getElementById('foodPopupMinus');
  const plusBtn=document.getElementById('foodPopupPlus');

  if(qtyDisplay&&totalDisplay&&buyBtn){
    const totalCost=food.cost*foodPopup.qty;
    const canBuy=S.xp>=totalCost&&maxQty>=1;
    qtyDisplay.textContent=foodPopup.qty;
    totalDisplay.textContent=`Buy ${foodPopup.qty} for ${totalCost} XP`;
    buyBtn.disabled=!canBuy;
    buyBtn.className=`w-full py-4 rounded-2xl ${canBuy?'bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white':'bg-gray-200 text-gray-500'} font-bold text-lg`;
    if(minusBtn)minusBtn.disabled=foodPopup.qty<=1;
    if(plusBtn)plusBtn.disabled=foodPopup.qty>=maxQty;
  }
}

// Buy food with quantity
function buyFoodQty(){
  if(!foodPopup)return;
  const food=FOODS[foodPopup.foodIdx];
  const totalCost=food.cost*foodPopup.qty;
  if(S.xp<totalCost)return;

  // Add to foodInventory (stores food indexes)
  for(let i=0;i<foodPopup.qty;i++){
    S.foodInventory.push(foodPopup.foodIdx);
  }
  S.xp-=totalCost;
  save();
  closeFoodPopup();
}

// Get scribby preference info for a food
function getScribbyFoodPreference(food){
  if(food.cat==='yummy'){
    return{icon:'ðŸ˜‹',text:'All Scribbies love this!',color:'text-green-600'};
  }else if(food.cat==='premium'){
    return{icon:'ðŸ‘‘',text:'Premium treat - everyone loves it!',color:'text-yellow-600'};
  }else if(food.cat==='healthy'){
    const rate=food.acceptRate||50;
    if(rate>=70)return{icon:'ðŸ™‚',text:`Most Scribbies like this (${rate}% accept)`,color:'text-green-600'};
    if(rate>=40)return{icon:'ðŸ˜',text:`Some Scribbies are picky (${rate}% accept)`,color:'text-yellow-600'};
    if(rate>=20)return{icon:'ðŸ˜¬',text:`Many Scribbies refuse this (${rate}% accept)`,color:'text-orange-600'};
    return{icon:'ðŸ¤¢',text:`Most Scribbies hate this! (${rate}% accept)`,color:'text-red-600'};
  }
  return{icon:'ðŸ½ï¸',text:'Standard food',color:'text-purple-600'};
}

// Tutorial steps shown after onboarding
const TUTORIAL_STEPS=[
  {title:'Meet Your Scribby!',text:'This is your new friend! They start as an egg and grow as you learn scriptures together.',icon:'ðŸ¥š',highlight:'buddy'},
  {title:'Practice Scriptures',text:'Tap "Practice" to start learning! Your Scribby earns XP when you practice, which helps them grow.',icon:'ðŸ“–',highlight:'practice'},
  {title:'Feed & Play',text:'Keep your Scribby happy by feeding them treats and playing games. Happy Scribbies grow faster!',icon:'ðŸŽ',highlight:'happiness'},
  {title:'Watch Them Evolve!',text:'As your Scribby grows, they\'ll transform into unique creatures. Collect different variants in your Album!',icon:'âœ¨',highlight:'album'},
  {title:'Trade With Friends!',text:'Connect with friends to trade Scribbies and items! Complete your collection by swapping rare variants.',icon:'ðŸ¤',highlight:'social'}
];

// Verse management tutorial (shown after initial tutorial, on practice screen)
const VERSE_TUTORIAL_STEPS=[
  {title:'Your Verses Are Stored!',text:'We\'ve added starter verses to your "Stored" section. These are saved for later - you\'ll need to move some to "Practice Now" to start learning!',icon:'ðŸ“š'},
  {title:'Find Your Stored Verses',text:'Tap the "Stored" tab to see all your saved verses. You can store verses you want to learn later.',icon:'ðŸ“‚',action:'showStored'},
  {title:'Move to Practice',text:'Tap any stored verse, then tap "Practice Now" to move it to your active practice list!',icon:'â–¶ï¸',action:'highlightVerse'},
  {title:'Add More Anytime',text:'Want more verses? Tap the + button to browse the full library and add scriptures or quotes that inspire you!',icon:'âž•',action:'highlightAdd'},
  {title:'You\'re Ready!',text:'Now go pick some verses to practice! Your Scribby is excited to start learning with you!',icon:'ðŸŽ‰'}
];

let verseTutorialStep=0;

function showTutorial(){
  tutorialStep=1;
  render();
}

function nextTutorial(){
  tutorialStep++;
  if(tutorialStep>TUTORIAL_STEPS.length){
    tutorialStep=0;
    localStorage.setItem('tutorialComplete','true');
    // Start verse management tutorial
    startVerseTutorial();
  }
  render();
}

function skipTutorial(){
  tutorialStep=0;
  localStorage.setItem('tutorialComplete','true');
  // Start verse management tutorial
  startVerseTutorial();
  render();
}

function startVerseTutorial(){
  if(!localStorage.getItem('verseTutorialComplete')){
    verseTutorialStep=1;
    screen='practice';
    verseFilter='saved'; // Show stored tab
  }
}

function nextVerseTutorial(){
  const currentStep=VERSE_TUTORIAL_STEPS[verseTutorialStep-1];
  // Handle actions for each step
  if(currentStep?.action==='showStored'){
    verseFilter='saved';
  }else if(currentStep?.action==='highlightAdd'){
    // Stay on practice screen
  }

  verseTutorialStep++;
  if(verseTutorialStep>VERSE_TUTORIAL_STEPS.length){
    verseTutorialStep=0;
    localStorage.setItem('verseTutorialComplete','true');
    verseFilter='active'; // Switch back to active tab
  }
  render();
}

function skipVerseTutorial(){
  verseTutorialStep=0;
  localStorage.setItem('verseTutorialComplete','true');
  verseFilter='active';
  render();
}

// Milestone confetti burst
const MILESTONES=[25,50,75,90];
let lastMilestone=0; // Track last crossed milestone to avoid repeat bursts

function triggerConfetti(){
  const colors=['#ff6b6b','#feca57','#48dbfb','#ff9ff3','#54a0ff','#5f27cd','#00d2d3','#1dd1a1'];
  const container=document.createElement('div');
  container.className='confetti-container';
  document.body.appendChild(container);

  // Create 50 confetti pieces
  for(let i=0;i<50;i++){
    const confetti=document.createElement('div');
    confetti.className='confetti';
    confetti.style.left=Math.random()*100+'%';
    confetti.style.top='-20px';
    confetti.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
    confetti.style.animationDelay=Math.random()*0.5+'s';
    confetti.style.transform=`rotate(${Math.random()*360}deg)`;
    // All circles with varied sizes
    const size=6+Math.random()*10;
    confetti.style.width=size+'px';
    confetti.style.height=size+'px';
    confetti.style.borderRadius='50%';
    container.appendChild(confetti);
  }

  // Remove container after animation
  setTimeout(()=>container.remove(),3500);
}

function checkMilestone(oldPct,newPct){
  for(const milestone of MILESTONES){
    if(oldPct<milestone&&newPct>=milestone){
      // Crossed a milestone!
      triggerConfetti();
      return milestone;
    }
  }
  return null;
}

let libraryView={collection:null,book:null,chapter:null}; // Track library navigation (4 levels: collections -> books -> chapters -> verses)
let searchQuery=''; // Library search
let addTab='library'; // 'library' or 'custom'
let customizeMode=false; // Accessory positioning mode
let dragState=null; // {type:'hat', startX, startY, currentX, currentY}
let graduationCeremony=false; // Track if showing graduation ceremony
let neglectConsequence=null; // {type:'ranAway'|'hospital', scribbyName: string} - tracks if showing consequence popup

function save(){localStorage.setItem('sb',JSON.stringify(S))}

// Default accessory positions (fallback if not customized)
const DEFAULT_POSITIONS={
  hat:{x:50,y:-15},
  eyes:{x:50,y:30},
  held:{x:85,y:70},
  back:{x:15,y:20},
  effect:{x:50,y:50}
};

// Default furniture positions (around the edges/corners)
const FURNITURE_DEFAULT_POSITIONS=[
  {x:10,y:85},   // Bottom left
  {x:90,y:85},   // Bottom right
  {x:10,y:10},   // Top left
  {x:90,y:10},   // Top right
  {x:50,y:90},   // Bottom center
  {x:10,y:50},   // Left center
  {x:90,y:50},   // Right center
];

// Furniture sizes (scribby is ~160-180px)
// Large items: 4x base (~320px) - bigger than scribby
// Medium items: 2x base (~100px) - about half scribby size
// Small items: ~70px
const FURNITURE_SIZES={
  'ðŸ›‹ï¸':320,  // Comfy Couch - large
  'ðŸ›ï¸':340,  // Cozy Bed - large
  'ðŸ“š':280,  // Bookshelf - large/tall
  'ðŸŽª':360,  // Play Tent - large
  'ðŸ§¸':260,  // Giant Teddy - large
  'ðŸªŸ':110,  // Window - medium
  'ðŸ–¼ï¸':96,   // Picture Frame - medium
  'ðŸŒˆ':100,  // Rainbow Poster - medium
  'ðŸª´':84,   // Potted Plant - medium
  'â­':76,   // Star Mobile - small
  'ðŸ®':70,   // Paper Lantern - small
  'ðŸŽµ':64,   // Music Box - small
  'ðŸª”':120,  // Floor Lamp - medium/tall
  'ðŸ§º':100,  // Bean Bag - medium
  'ðŸ•°ï¸':70,   // Wall Clock - small
  'ðŸ ':110,  // Fish Tank - medium
  'ðŸªž':90,   // Mirror - medium
  'ðŸŽ€':130,  // Curtains - medium/tall
};
const DEFAULT_FURNITURE_SIZE=90; // Fallback size

// Drag handlers for accessory positioning
function startDrag(type,e){
  if(!customizeMode)return;
  e.preventDefault();
  const touch=e.touches?e.touches[0]:e;

  // Calculate offset from click point to current element center
  const element=e.currentTarget;
  const rect=element.getBoundingClientRect();
  const elementCenterX=rect.left+rect.width/2;
  const elementCenterY=rect.top+rect.height/2;

  dragState={
    type,
    startX:touch.clientX,
    startY:touch.clientY,
    offsetX:touch.clientX-elementCenterX,
    offsetY:touch.clientY-elementCenterY
  };
}

function onDrag(e){
  if(!dragState)return;
  e.preventDefault();
  const touch=e.touches?e.touches[0]:e;
  dragState.currentX=touch.clientX;
  dragState.currentY=touch.clientY;
  render();
}

function endDrag(e){
  if(!dragState)return;
  e.preventDefault();
  const stage=S.buddyStage||'egg';

  // Use buddy-scene-wrapper for furniture, buddy-with-accessories for regular accessories
  const isFurniture=dragState.type.startsWith('furniture_');
  const container=document.querySelector(isFurniture?'.buddy-scene-wrapper':'.buddy-with-accessories');
  if(!container)return;

  const rect=container.getBoundingClientRect();
  const touch=e.changedTouches?e.changedTouches[0]:e;
  // Subtract the offset to save center position
  const adjustedX=touch.clientX-dragState.offsetX;
  const adjustedY=touch.clientY-dragState.offsetY;
  const x=((adjustedX-rect.left)/rect.width)*100;
  const y=((adjustedY-rect.top)/rect.height)*100;

  // Check if this is a furniture item (type starts with "furniture_")
  if(isFurniture){
    const furnitureIndex=parseInt(dragState.type.split('_')[1]);
    if(!S.furniturePositions[stage])S.furniturePositions[stage]={};
    S.furniturePositions[stage][furnitureIndex]={x:Math.round(x),y:Math.round(y)};
  }else{
    // Regular accessory
    if(!S.accessoryPositions[stage])S.accessoryPositions[stage]={};
    S.accessoryPositions[stage][dragState.type]={x:Math.round(x),y:Math.round(y)};
  }

  dragState=null;
  save();
  render();
}

// Track active input for focus preservation
let activeInputId=null;
let cursorPos=null;

// Debounced search for mobile keyboard fix
let searchDebounceTimer=null;
function debouncedSearchRender(value){
  searchQuery=value;
  clearTimeout(searchDebounceTimer);
  searchDebounceTimer=setTimeout(()=>{
    activeInputId='library-search';
    const input=document.getElementById('library-search');
    if(input)cursorPos=input.selectionStart;
    render();
  },500);
}
// Manual search trigger (for button/Enter key)
function triggerLibrarySearch(e){
  if(e)e.preventDefault();
  const input=document.getElementById('library-search');
  if(input){
    searchQuery=input.value;
    cursorPos=input.selectionStart;
    activeInputId='library-search';
  }
  clearTimeout(searchDebounceTimer);
  render();
}

// XP multiplier based on mode usage
function getModeMultiplier(verse,mode){
  if(!verse.modeUsage)verse.modeUsage={predict:0,blanks:0,jumble:0,first:0,recall:0};
  const uses=verse.modeUsage[mode]||0;
  if(uses===0)return 1.0;
  if(uses===1)return 0.75;
  if(uses===2)return 0.5;
  return 0.25;
}

// Review bonus based on days since last practice
function getReviewBonus(verse){
  if(!verse.lastPracticed)return 0;
  const daysSince=Math.floor((Date.now()-new Date(verse.lastPracticed).getTime())/(1000*60*60*24));
  if(daysSince<3)return 2;
  if(daysSince<7)return 5;
  if(daysSince<14)return 10;
  if(daysSince<30)return 15;
  return 20;
}

// Check if verse needs review (7+ days) - for mastered verses
function needsReview(verse){
  if(!verse.lastPracticed||verse.mastery<5)return false;
  const daysSince=Math.floor((Date.now()-new Date(verse.lastPracticed).getTime())/(1000*60*60*24));
  return daysSince>=7;
}

// Smart Review: Check if verse is due for review based on spaced repetition
function isDueForReview(verse){
  if(verse.status!=='active')return false;
  if(!verse.nextReview)return true; // Never practiced = always due
  return Date.now()>=verse.nextReview;
}

// Smart Review: Get all verses due for review, sorted by urgency
function getDueVerses(){
  const active=S.verses.filter(v=>v.status==='active');
  const due=active.filter(v=>isDueForReview(v));
  // Sort by most overdue first, then by lowest mastery
  return due.sort((a,b)=>{
    const aOverdue=a.nextReview?(Date.now()-a.nextReview):999999999;
    const bOverdue=b.nextReview?(Date.now()-b.nextReview):999999999;
    if(Math.abs(aOverdue-bOverdue)>3600000)return bOverdue-aOverdue; // >1hr difference
    return a.mastery-b.mastery; // Lower mastery first
  });
}

// Smart Review: Get time until next review in human-readable format
function getReviewTimeText(verse){
  if(!verse.nextReview)return'Now';
  const diff=verse.nextReview-Date.now();
  if(diff<=0)return'Now';
  const hours=Math.floor(diff/(1000*60*60));
  const days=Math.floor(hours/24);
  if(days>0)return`${days}d`;
  if(hours>0)return`${hours}h`;
  return'<1h';
}

// Smart recommendations
function getRecommendations(){
  // Only consider active verses (not saved-for-later)
  const activeVerses=S.verses.filter(v=>v.status==='active');
  if(!activeVerses.length)return{verses:[],modes:{}};

  // Score verses based on multiple factors
  const scored=activeVerses.map(v=>{
    let score=0;
    const daysSince=v.lastPracticed?Math.floor((Date.now()-new Date(v.lastPracticed).getTime())/(1000*60*60*24)):999;

    // Prioritize verses that need review
    if(needsReview(v))score+=100;

    // Prioritize low mastery
    score+=(5-v.mastery)*20;

    // Prioritize not recently practiced
    score+=Math.min(daysSince*2,50);

    // Small penalty for never practiced (to encourage starting new ones)
    if(!v.lastPracticed)score+=10;

    return{verse:v,score};
  });

  // Get top 3 recommended verses
  const topVerses=scored.sort((a,b)=>b.score-a.score).slice(0,3).map(s=>s.verse);

  // For each verse, recommend least-used modes
  const modeRecommendations={};
  topVerses.forEach(v=>{
    const usage=v.modeUsage||{predict:0,blanks:0,jumble:0,first:0,recall:0,hangman:0};
    const modes=[
      {id:'predict',uses:usage.predict},
      {id:'blanks',uses:usage.blanks},
      {id:'hangman',uses:usage.hangman},
      {id:'jumble',uses:usage.jumble},
      {id:'first',uses:usage.first},
      {id:'recall',uses:usage.recall}
    ];
    // Recommend least used modes (max 2)
    modeRecommendations[v.id]=modes.sort((a,b)=>a.uses-b.uses).slice(0,2).map(m=>m.id);
  });

  return{verses:topVerses,modes:modeRecommendations};
}

// Buddy growth system - progressive XP curve (quick early wins, big finale)
// Total ~450 XP = ~9 days at 50 XP/day
const STAGES={
  egg:{emoji:'ðŸ¥š',name:'Egg',hatchXP:50},      // ~1 day - quick hook!
  blob:{name:'Blob',growthNeeded:75},           // ~1.5 days - building momentum
  child:{emoji:'ðŸ¥',name:'Chick',growthNeeded:125},  // ~2.5 days - invested now
  teen:{emoji:'ðŸ¤',name:'Young Bird',growthNeeded:200}, // ~4 days - big reveal earned!
  adult:{emoji:'ðŸ¦œ',name:'Parrot'}
};

const FOODS=[
  // Yummy Foods - Always accepted, high happiness but may reduce health (sorted by cost)
  {emoji:'ðŸ§ƒ',name:'Juice Box',cost:10,cat:'yummy',happiness:18,health:-4},
  {emoji:'ðŸŸ©',name:'Jello',cost:12,cat:'yummy',happiness:14,health:-1},
  {emoji:'ðŸ­',name:'Lollipop',cost:12,cat:'yummy',happiness:20,health:-5},
  {emoji:'ðŸ¥¤',name:'Soda',cost:15,cat:'yummy',happiness:22,health:-8},
  {emoji:'ðŸ§',name:'Popsicle',cost:15,cat:'yummy',happiness:16,health:-2},
  {emoji:'ðŸ¬',name:'Gummy Bears',cost:15,cat:'yummy',happiness:23,health:-6},
  {emoji:'ðŸ¬',name:'Fruit Snacks',cost:18,cat:'yummy',happiness:16,health:-4},
  {emoji:'ðŸ¡',name:'Cotton Candy',cost:18,cat:'yummy',happiness:24,health:-7},
  {emoji:'ðŸ¥£',name:'Cereal',cost:20,cat:'yummy',happiness:15,health:1},
  {emoji:'ðŸ®',name:'Pudding',cost:20,cat:'yummy',happiness:16,health:-2},
  {emoji:'ðŸ«',name:'Candy Bar',cost:20,cat:'yummy',happiness:25,health:-5},
  {emoji:'ðŸ¥œ',name:'PB&J Sandwich',cost:22,cat:'yummy',happiness:16,health:2},
  {emoji:'ðŸª',name:'Sugar Cookies',cost:22,cat:'yummy',happiness:24,health:-6},
  {emoji:'ðŸ¥”',name:'Tater Tots',cost:24,cat:'yummy',happiness:16,health:-3},
  {emoji:'ðŸª',name:'Cookie',cost:25,cat:'yummy',happiness:15,health:0},
  {emoji:'ðŸŸ',name:'Fries',cost:25,cat:'yummy',happiness:16,health:-3},
  {emoji:'ðŸ¿',name:'Popcorn',cost:25,cat:'yummy',happiness:15,health:2},
  {emoji:'ðŸŒ­',name:'Hot Dog',cost:25,cat:'yummy',happiness:16,health:-2},
  {emoji:'âš¡',name:'Energy Drink',cost:25,cat:'yummy',happiness:25,health:-10},
  {emoji:'ðŸ¥ª',name:'Grilled Cheese',cost:26,cat:'yummy',happiness:16,health:2},
  {emoji:'ðŸŸ',name:'Fish Sticks',cost:26,cat:'yummy',happiness:15,health:0},
  {emoji:'ðŸ§€',name:'Mac & Cheese',cost:28,cat:'yummy',happiness:18,health:2},
  {emoji:'ðŸŒ­',name:'Corn Dog',cost:28,cat:'yummy',happiness:17,health:-3},
  {emoji:'ðŸ•',name:'Pizza',cost:30,cat:'yummy',happiness:16,health:3},
  {emoji:'ðŸŒ®',name:'Taco',cost:30,cat:'yummy',happiness:16,health:5},
  {emoji:'ðŸ«“',name:'Quesadilla',cost:30,cat:'yummy',happiness:17,health:3},
  {emoji:'ðŸ—',name:'Chicken Nuggets',cost:30,cat:'yummy',happiness:19,health:-2},
  {emoji:'ðŸŒ®',name:'Nachos',cost:30,cat:'yummy',happiness:18,health:-2},
  {emoji:'ðŸ©',name:'Donut',cost:30,cat:'yummy',happiness:18,health:-4},
  {emoji:'ðŸ§',name:'Cupcake',cost:30,cat:'yummy',happiness:18,health:-4},
  {emoji:'ðŸ«',name:'Chocolate',cost:30,cat:'yummy',happiness:18,health:-3},
  {emoji:'ðŸž',name:'French Toast',cost:32,cat:'yummy',happiness:17,health:0},
  {emoji:'ðŸ',name:'Spaghetti',cost:32,cat:'yummy',happiness:17,health:3},
  {emoji:'ðŸ§€',name:'Mozzarella Sticks',cost:32,cat:'yummy',happiness:18,health:-3},
  {emoji:'ðŸ”',name:'Hamburger',cost:35,cat:'yummy',happiness:17,health:3},
  {emoji:'ðŸ¥ž',name:'Pancakes',cost:35,cat:'yummy',happiness:16,health:0},
  {emoji:'ðŸ§‡',name:'Waffle',cost:35,cat:'yummy',happiness:17,health:0},
  {emoji:'ðŸ¦',name:'Ice Cream',cost:35,cat:'yummy',happiness:19,health:-3},
  {emoji:'ðŸ¥¤',name:'Boba Drink',cost:35,cat:'yummy',happiness:18,health:-3},
  {emoji:'ðŸ£',name:'Sushi',cost:40,cat:'yummy',happiness:18,health:8},
  {emoji:'ðŸ°',name:'Cake',cost:40,cat:'yummy',happiness:19,health:-4},
  // Healthy Foods - Can be rejected, great for health but may hurt happiness (sorted by cost)
  {emoji:'ðŸ¥’',name:'Pickles',cost:1,cat:'healthy',acceptRate:15,happiness:10,happinessPenalty:25,health:20},
  {emoji:'ðŸ¥«',name:'Canned Peas',cost:1,cat:'healthy',acceptRate:18,happiness:10,happinessPenalty:25,health:20},
  {emoji:'ðŸ«›',name:'Lima Beans',cost:1,cat:'healthy',acceptRate:8,happiness:10,happinessPenalty:25,health:20},
  {emoji:'ðŸ„',name:'Mushrooms',cost:2,cat:'healthy',acceptRate:10,happiness:10,happinessPenalty:25,health:20},
  {emoji:'ðŸ§„',name:'Garlic',cost:2,cat:'healthy',acceptRate:5,happiness:10,happinessPenalty:25,health:20},
  {emoji:'ðŸ§…',name:'Onions',cost:2,cat:'healthy',acceptRate:8,happiness:10,happinessPenalty:25,health:20},
  {emoji:'ðŸƒ',name:'Spinach',cost:2,cat:'healthy',acceptRate:10,happiness:10,happinessPenalty:25,health:20},
  {emoji:'ðŸ¦—',name:'Crickets',cost:2,cat:'healthy',acceptRate:8,happiness:10,happinessPenalty:25,health:20},
  {emoji:'ðŸ¥š',name:'Hard Boiled Egg',cost:3,cat:'healthy',acceptRate:12,happiness:10,happinessPenalty:25,health:20},
  {emoji:'ðŸª±',name:'Fried Worms',cost:3,cat:'healthy',acceptRate:10,happiness:10,happinessPenalty:25,health:20},
  {emoji:'ðŸ«˜',name:'Brussels Sprouts',cost:5,cat:'healthy',acceptRate:10,happiness:10,happinessPenalty:20,health:20},
  {emoji:'ðŸ¥©',name:'Liver',cost:5,cat:'healthy',acceptRate:5,happiness:10,happinessPenalty:20,health:20},
  {emoji:'ðŸ¥£',name:'Plain Oatmeal',cost:5,cat:'healthy',acceptRate:25,happiness:10,happinessPenalty:20,health:20},
  {emoji:'ðŸ¥¬',name:'Kale',cost:5,cat:'healthy',acceptRate:15,happiness:10,happinessPenalty:20,health:20},
  {emoji:'ðŸ¥š',name:'Century Egg',cost:5,cat:'healthy',acceptRate:5,happiness:10,happinessPenalty:25,health:20},
  {emoji:'ðŸŸ',name:'Anchovies',cost:8,cat:'healthy',acceptRate:15,happiness:10,happinessPenalty:20,health:20},
  {emoji:'ðŸ¬',name:'Black Licorice',cost:8,cat:'healthy',acceptRate:20,happiness:10,happinessPenalty:20,health:20},
  {emoji:'ðŸ«‘',name:'Green Pepper',cost:8,cat:'healthy',acceptRate:30,happiness:10,happinessPenalty:20,health:20},
  {emoji:'ðŸ¸',name:'Frog Legs',cost:8,cat:'healthy',acceptRate:12,happiness:10,happinessPenalty:20,health:20},
  {emoji:'ðŸ§€',name:'Cottage Cheese',cost:10,cat:'healthy',acceptRate:20,happiness:10,happinessPenalty:20,health:20},
  {emoji:'ðŸ¦ª',name:'Raw Oysters',cost:10,cat:'healthy',acceptRate:18,happiness:10,happinessPenalty:20,health:20},
  {emoji:'ðŸ¦‘',name:'Octopus',cost:12,cat:'healthy',acceptRate:15,happiness:10,happinessPenalty:20,health:20},
  {emoji:'ðŸ™',name:'Squid Ink Pasta',cost:14,cat:'healthy',acceptRate:22,happiness:10,happinessPenalty:20,health:20},
  {emoji:'ðŸ¥¦',name:'Broccoli',cost:15,cat:'healthy',acceptRate:40,happiness:10,happinessPenalty:15,health:20},
  {emoji:'ðŸ¥•',name:'Carrot',cost:15,cat:'healthy',acceptRate:60,happiness:10,happinessPenalty:15,health:20},
  {emoji:'ðŸ¥—',name:'Salad',cost:15,cat:'healthy',acceptRate:30,happiness:10,happinessPenalty:15,health:20},
  {emoji:'ðŸŒ',name:'Escargot',cost:15,cat:'healthy',acceptRate:20,happiness:10,happinessPenalty:20,health:20},
  {emoji:'ðŸŽ',name:'Apple',cost:20,cat:'healthy',acceptRate:80,happiness:10,happinessPenalty:15,health:20},
  {emoji:'ðŸŒ',name:'Banana',cost:20,cat:'healthy',acceptRate:70,happiness:10,happinessPenalty:15,health:20},
  {emoji:'ðŸ‡',name:'Grapes',cost:20,cat:'healthy',acceptRate:75,happiness:10,happinessPenalty:15,health:20},
  // Premium Foods - Always accepted, excellent happiness AND health (sorted by cost)
  {emoji:'ðŸ±',name:'Bento Box',cost:50,cat:'premium',happiness:30,health:25},
  {emoji:'ðŸ¥©',name:'Steak',cost:60,cat:'premium',happiness:30,health:25},
  {emoji:'ðŸ¦ž',name:'Lobster',cost:75,cat:'premium',happiness:30,health:25},
  {emoji:'ðŸŽ‚',name:'Birthday Cake',cost:100,cat:'premium',happiness:30,health:25},
];

const ACCESSORIES=[
  // Hats (sorted by cost)
  {emoji:'ðŸ§¢',name:'Baseball Cap',cost:50,type:'hat',cat:'casual'},
  {emoji:'ðŸ‘’',name:'Sun Hat',cost:75,type:'hat',cat:'casual'},
  {emoji:'ðŸŽ©',name:'Top Hat',cost:100,type:'hat',cat:'fancy'},
  {emoji:'ðŸ¤ ',name:'Cowboy Hat',cost:100,type:'hat',cat:'fun'},
  {emoji:'ðŸŒ¸',name:'Flower Crown',cost:100,type:'hat',cat:'cute'},
  {emoji:'ðŸ´â€â˜ ï¸',name:'Pirate Hat',cost:150,type:'hat',cat:'fun'},
  {emoji:'ðŸŽ…',name:'Santa Hat',cost:150,type:'hat',cat:'seasonal'},
  {emoji:'ðŸ§™',name:'Wizard Hat',cost:175,type:'hat',cat:'fun'},
  {emoji:'ðŸ‘‘',name:'Crown',cost:200,type:'hat',cat:'fancy'},
  {emoji:'ðŸŽ“',name:'Graduation Cap',cost:400,type:'hat',cat:'special'},
  {emoji:'ðŸ˜‡',name:'Halo',cost:500,type:'hat',cat:'special'},
  // Eyewear (sorted by cost)
  {emoji:'ðŸ‘“',name:'Round Glasses',cost:50,type:'eyes',cat:'casual'},
  {emoji:'ðŸ•¶ï¸',name:'Sunglasses',cost:75,type:'eyes',cat:'cool'},
  {emoji:'ðŸ¥½',name:'Goggles',cost:100,type:'eyes',cat:'casual'},
  {emoji:'ðŸ©·',name:'Heart Glasses',cost:100,type:'eyes',cat:'cute'},
  {emoji:'ðŸ˜Ž',name:'Pixel Shades',cost:125,type:'eyes',cat:'cool'},
  {emoji:'â­',name:'Star Glasses',cost:150,type:'eyes',cat:'fun'},
  {emoji:'ðŸ§',name:'Monocle',cost:200,type:'eyes',cat:'fancy'},
  // Held Items (sorted by cost)
  {emoji:'ðŸŽˆ',name:'Balloon',cost:50,type:'held',cat:'cute'},
  {emoji:'ðŸŒ¸',name:'Flower',cost:75,type:'held',cat:'cute'},
  {emoji:'ðŸ“–',name:'Holy Bible',cost:100,type:'held',cat:'faith'},
  {emoji:'ðŸ§¸',name:'Teddy Bear',cost:100,type:'held',cat:'cute'},
  {emoji:'âš”ï¸',name:'Tiny Sword',cost:150,type:'held',cat:'fun'},
  {emoji:'âœï¸',name:'Cross Necklace',cost:150,type:'held',cat:'faith'},
  {emoji:'ðŸŽ¸',name:'Guitar',cost:175,type:'held',cat:'cool'},
  {emoji:'ðŸª„',name:'Magic Wand',cost:200,type:'held',cat:'fun'},
  {emoji:'ðŸ†',name:'Trophy',cost:250,type:'held',cat:'special'},
  {emoji:'ðŸ“œ',name:'Ancient Scroll',cost:500,type:'held',cat:'special'},
  // Back Items (sorted by cost)
  {emoji:'ðŸ¦¸',name:'Cape',cost:200,type:'back',cat:'cool'},
  {emoji:'ðŸ‘¼',name:'Wings',cost:500,type:'back',cat:'special'},
  // Special Effects (sorted by cost)
  {emoji:'âœ¨',name:'Sparkle Aura',cost:400,type:'effect',cat:'special'},
  {emoji:'ðŸŒˆ',name:'Rainbow Trail',cost:500,type:'effect',cat:'special'},
  {emoji:'ðŸ’«',name:'Glowing Aura',cost:750,type:'effect',cat:'special'},
  // Medicine (sorted by cost)
  {emoji:'ðŸ©¹',name:'Bandaid',cost:15,type:'medicine',cat:'health',healthBoost:10},
  {emoji:'ðŸ’Š',name:'Vitamins',cost:30,type:'medicine',cat:'health',healthBoost:20},
  {emoji:'ðŸ’‰',name:'Medicine',cost:50,type:'medicine',cat:'health',healthBoost:35},
  {emoji:'ðŸŒ¡ï¸',name:'Health Kit',cost:100,type:'medicine',cat:'health',healthBoost:50},
  // Food (sorted by cost)
  {emoji:'ðŸŽ',name:'Apple',cost:10,type:'food',cat:'food',hungerBoost:8},
  {emoji:'ðŸ¥•',name:'Carrot',cost:12,type:'food',cat:'food',hungerBoost:12},
  {emoji:'ðŸª',name:'Cookie',cost:15,type:'food',cat:'food',hungerBoost:10,happinessBoost:5},
  {emoji:'ðŸ“',name:'Strawberry',cost:18,type:'food',cat:'food',hungerBoost:10},
  {emoji:'ðŸ©',name:'Donut',cost:20,type:'food',cat:'food',hungerBoost:10,happinessBoost:12},
  {emoji:'ðŸ•',name:'Pizza Slice',cost:25,type:'food',cat:'food',hungerBoost:20,happinessBoost:8},
  {emoji:'ðŸŒ®',name:'Taco',cost:30,type:'food',cat:'food',hungerBoost:25,happinessBoost:10},
  {emoji:'ðŸ¦',name:'Ice Cream',cost:35,type:'food',cat:'food',hungerBoost:15,happinessBoost:20},
  {emoji:'ðŸ±',name:'Bento Box',cost:50,type:'food',cat:'food',hungerBoost:40,happinessBoost:15},
  {emoji:'ðŸŽ‚',name:'Birthday Cake',cost:75,type:'food',cat:'food',hungerBoost:30,happinessBoost:35},
  // Room/Furniture Items (sorted by cost)
  {emoji:'ðŸª´',name:'Potted Plant',cost:40,type:'room',cat:'furniture',desc:'Adds life to any room'},
  {emoji:'ðŸŒˆ',name:'Rainbow Poster',cost:45,type:'room',cat:'furniture',desc:'Brighten the walls'},
  {emoji:'ðŸ–¼ï¸',name:'Picture Frame',cost:50,type:'room',cat:'furniture',desc:'Display your memories'},
  {emoji:'ðŸª”',name:'Floor Lamp',cost:55,type:'room',cat:'furniture',desc:'Warm ambient light'},
  {emoji:'ðŸ®',name:'Paper Lantern',cost:60,type:'room',cat:'furniture',desc:'Soft warm glow'},
  {emoji:'ðŸ•°ï¸',name:'Wall Clock',cost:65,type:'room',cat:'furniture',desc:'Keeps perfect time'},
  {emoji:'ðŸªž',name:'Mirror',cost:70,type:'room',cat:'furniture',desc:'Check your look'},
  {emoji:'â­',name:'Star Mobile',cost:75,type:'room',cat:'furniture',desc:'Twinkle twinkle'},
  {emoji:'ðŸªŸ',name:'Window',cost:80,type:'room',cat:'furniture',desc:'Let the sunshine in'},
  {emoji:'ðŸ§º',name:'Bean Bag',cost:85,type:'room',cat:'furniture',desc:'Comfy floor seating'},
  {emoji:'ðŸŽµ',name:'Music Box',cost:90,type:'room',cat:'furniture',desc:'Plays a soothing tune'},
  {emoji:'ðŸŽ€',name:'Curtains',cost:95,type:'room',cat:'furniture',desc:'Pretty window drapes'},
  {emoji:'ðŸ›ï¸',name:'Cozy Bed',cost:100,type:'room',cat:'furniture',desc:'A comfy place to rest'},
  {emoji:'ðŸ“š',name:'Bookshelf',cost:120,type:'room',cat:'furniture',desc:'Store your scriptures'},
  {emoji:'ðŸ ',name:'Fish Tank',cost:140,type:'room',cat:'furniture',desc:'Relaxing aquarium'},
  {emoji:'ðŸ›‹ï¸',name:'Comfy Couch',cost:150,type:'room',cat:'furniture',desc:'Perfect for lounging'},
  {emoji:'ðŸ§¸',name:'Giant Teddy',cost:175,type:'room',cat:'furniture',desc:'A fluffy friend'},
  {emoji:'ðŸŽª',name:'Play Tent',cost:200,type:'room',cat:'furniture',desc:'A cozy hideaway'},
];

// Curated Scripture Library (Popular Verses)
const LIBRARY={
  curated:[], // Empty by default - users choose their scriptures on first launch
  downloadedPacks:[], // Array of pack IDs that have been downloaded
  downloaded:null // Will hold full library when downloaded
};

// Downloadable Scripture Packs
const SCRIPTURE_PACKS={
  // ===== BIBLE =====
  'old-testament':{
    id:'old-testament',
    name:'Old Testament',
    description:'Hebrew Bible / Old Testament',
    icon:'ðŸ“œ',
    verses:[
      {book:'Genesis',chapter:1,verse:1,ref:'Genesis 1:1',text:'In the beginning God created the heaven and the earth.',tags:['Faith','Creation']},
      {book:'Joshua',chapter:1,verse:9,ref:'Joshua 1:9',text:'Have not I commanded thee? Be strong and of a good courage; be not afraid, neither be thou dismayed: for the Lord thy God is with thee whithersoever thou goest.',tags:['Courage','Faith']},
      {book:'Psalms',chapter:23,verse:1,ref:'Psalm 23:1-4',text:'The Lord is my shepherd; I shall not want. He maketh me to lie down in green pastures: he leadeth me beside the still waters. He restoreth my soul.',tags:['Peace','Faith']},
      {book:'Psalms',chapter:46,verse:10,ref:'Psalm 46:10',text:'Be still, and know that I am God.',tags:['Peace','Faith']},
      {book:'Psalms',chapter:119,verse:105,ref:'Psalm 119:105',text:'Thy word is a lamp unto my feet, and a light unto my path.',tags:['Wisdom','Faith']},
      {book:'Proverbs',chapter:3,verse:5,ref:'Proverbs 3:5-6',text:'Trust in the Lord with all thine heart; and lean not unto thine own understanding. In all thy ways acknowledge him, and he shall direct thy paths.',tags:['Faith','Wisdom']},
      {book:'Proverbs',chapter:22,verse:6,ref:'Proverbs 22:6',text:'Train up a child in the way he should go: and when he is old, he will not depart from it.',tags:['Family','Wisdom']},
      {book:'Isaiah',chapter:40,verse:31,ref:'Isaiah 40:31',text:'But they that wait upon the Lord shall renew their strength; they shall mount up with wings as eagles; they shall run, and not be weary; and they shall walk, and not faint.',tags:['Faith','Patience','Trials']},
      {book:'Isaiah',chapter:41,verse:10,ref:'Isaiah 41:10',text:'Fear thou not; for I am with thee: be not dismayed; for I am thy God: I will strengthen thee; yea, I will help thee; yea, I will uphold thee with the right hand of my righteousness.',tags:['Courage','Faith']},
      {book:'Jeremiah',chapter:29,verse:11,ref:'Jeremiah 29:11',text:'For I know the thoughts that I think toward you, saith the Lord, thoughts of peace, and not of evil, to give you an expected end.',tags:['Hope','Peace','Faith']},
    ]
  },
  'new-testament':{
    id:'new-testament',
    name:'New Testament',
    description:'Christian New Testament',
    icon:'âœï¸',
    verses:[
      {book:'Matthew',chapter:5,verse:16,ref:'Matthew 5:16',text:'Let your light so shine before men, that they may see your good works, and glorify your Father which is in heaven.',tags:['Service','Love']},
      {book:'Matthew',chapter:6,verse:33,ref:'Matthew 6:33',text:'But seek ye first the kingdom of God, and his righteousness; and all these things shall be added unto you.',tags:['Faith','Obedience']},
      {book:'Matthew',chapter:7,verse:7,ref:'Matthew 7:7',text:'Ask, and it shall be given you; seek, and ye shall find; knock, and it shall be opened unto you.',tags:['Prayer','Faith']},
      {book:'Matthew',chapter:11,verse:28,ref:'Matthew 11:28-30',text:'Come unto me, all ye that labour and are heavy laden, and I will give you rest. Take my yoke upon you, and learn of me; for I am meek and lowly in heart: and ye shall find rest unto your souls.',tags:['Jesus Christ','Peace']},
      {book:'Matthew',chapter:28,verse:19,ref:'Matthew 28:19-20',text:'Go ye therefore, and teach all nations, baptizing them in the name of the Father, and of the Son, and of the Holy Ghost: Teaching them to observe all things whatsoever I have commanded you.',tags:['Service','Faith']},
      {book:'John',chapter:3,verse:16,ref:'John 3:16',text:'For God so loved the world, that he gave his only begotten Son, that whosoever believeth in him should not perish, but have everlasting life.',tags:['Love','Jesus Christ','Faith']},
      {book:'John',chapter:8,verse:32,ref:'John 8:32',text:'And ye shall know the truth, and the truth shall make you free.',tags:['Wisdom','Faith']},
      {book:'John',chapter:13,verse:35,ref:'John 13:35',text:'By this shall all men know that ye are my disciples, if ye have love one to another.',tags:['Love','Charity']},
      {book:'John',chapter:14,verse:6,ref:'John 14:6',text:'Jesus saith unto him, I am the way, the truth, and the life: no man cometh unto the Father, but by me.',tags:['Jesus Christ','Faith']},
      {book:'John',chapter:14,verse:27,ref:'John 14:27',text:'Peace I leave with you, my peace I give unto you: not as the world giveth, give I unto you. Let not your heart be troubled, neither let it be afraid.',tags:['Peace','Jesus Christ']},
      {book:'Romans',chapter:8,verse:28,ref:'Romans 8:28',text:'And we know that all things work together for good to them that love God.',tags:['Faith','Love','Trials']},
      {book:'Romans',chapter:12,verse:2,ref:'Romans 12:2',text:'And be not conformed to this world: but be ye transformed by the renewing of your mind, that ye may prove what is that good, and acceptable, and perfect, will of God.',tags:['Wisdom','Obedience']},
      {book:'1 Corinthians',chapter:13,verse:4,ref:'1 Corinthians 13:4-7',text:'Charity suffereth long, and is kind; charity envieth not; charity vaunteth not itself, is not puffed up, Doth not behave itself unseemly, seeketh not her own, is not easily provoked, thinketh no evil.',tags:['Charity','Love','Patience']},
      {book:'Galatians',chapter:5,verse:22,ref:'Galatians 5:22-23',text:'But the fruit of the Spirit is love, joy, peace, longsuffering, gentleness, goodness, faith, Meekness, temperance: against such there is no law.',tags:['Peace','Love','Faith']},
      {book:'Ephesians',chapter:6,verse:10,ref:'Ephesians 6:10-11',text:'Finally, my brethren, be strong in the Lord, and in the power of his might. Put on the whole armour of God, that ye may be able to stand against the wiles of the devil.',tags:['Courage','Faith']},
      {book:'Philippians',chapter:4,verse:6,ref:'Philippians 4:6-7',text:'Be careful for nothing; but in every thing by prayer and supplication with thanksgiving let your requests be made known unto God. And the peace of God, which passeth all understanding, shall keep your hearts and minds through Christ Jesus.',tags:['Prayer','Peace']},
      {book:'Philippians',chapter:4,verse:13,ref:'Philippians 4:13',text:'I can do all things through Christ which strengtheneth me.',tags:['Courage','Jesus Christ','Faith']},
      {book:'Hebrews',chapter:11,verse:1,ref:'Hebrews 11:1',text:'Now faith is the substance of things hoped for, the evidence of things not seen.',tags:['Faith','Hope']},
      {book:'James',chapter:1,verse:5,ref:'James 1:5',text:'If any of you lack wisdom, let him ask of God, that giveth to all men liberally, and upbraideth not; and it shall be given him.',tags:['Prayer','Wisdom']},
      {book:'1 Peter',chapter:5,verse:7,ref:'1 Peter 5:7',text:'Casting all your care upon him; for he careth for you.',tags:['Faith','Peace','Trials']},
    ]
  },
  // ===== LDS =====
  'book-of-mormon':{
    id:'book-of-mormon',
    name:'Book of Mormon',
    description:'Scripture from the Book of Mormon',
    icon:'ðŸ“˜',
    verses:[
      {book:'1 Nephi',chapter:3,verse:7,ref:'1 Nephi 3:7',text:'And it came to pass that I, Nephi, said unto my father: I will go and do the things which the Lord hath commanded, for I know that the Lord giveth no commandments unto the children of men, save he shall prepare a way for them that they may accomplish the thing which he commandeth them.',tags:['Obedience','Faith','Courage']},
      {book:'1 Nephi',chapter:19,verse:23,ref:'1 Nephi 19:23',text:'And I did read many things unto them which were written in the books of Moses; but that I might more fully persuade them to believe in the Lord their Redeemer I did read unto them that which was written by the prophet Isaiah.',tags:['Faith','Jesus Christ']},
      {book:'2 Nephi',chapter:2,verse:25,ref:'2 Nephi 2:25',text:'Adam fell that men might be; and men are, that they might have joy.',tags:['Wisdom','Peace']},
      {book:'2 Nephi',chapter:9,verse:28,ref:'2 Nephi 9:28-29',text:'O that cunning plan of the evil one! O the vainness, and the frailties, and the foolishness of men! When they are learned they think they are wise, and they hearken not unto the counsel of God, for they set it aside, supposing they know of themselves, wherefore, their wisdom is foolishness and it profiteth them not.',tags:['Wisdom','Humility']},
      {book:'2 Nephi',chapter:25,verse:26,ref:'2 Nephi 25:26',text:'And we talk of Christ, we rejoice in Christ, we preach of Christ, we prophesy of Christ, and we write according to our prophecies, that our children may know to what source they may look for a remission of their sins.',tags:['Jesus Christ','Faith']},
      {book:'2 Nephi',chapter:31,verse:20,ref:'2 Nephi 31:20',text:'Wherefore, ye must press forward with a steadfastness in Christ, having a perfect brightness of hope, and a love of God and of all men. Wherefore, if ye shall press forward, feasting upon the word of Christ, and endure to the end, behold, thus saith the Father: Ye shall have eternal life.',tags:['Hope','Love','Patience']},
      {book:'Mosiah',chapter:2,verse:17,ref:'Mosiah 2:17',text:'And behold, I tell you these things that ye may learn wisdom; that ye may learn that when ye are in the service of your fellow beings ye are only in the service of your God.',tags:['Service','Charity','Wisdom']},
      {book:'Mosiah',chapter:3,verse:19,ref:'Mosiah 3:19',text:'For the natural man is an enemy to God, and has been from the fall of Adam, and will be, forever and ever, unless he yields to the enticings of the Holy Spirit, and putteth off the natural man and becometh a saint through the atonement of Christ the Lord.',tags:['Repentance','Jesus Christ']},
      {book:'Mosiah',chapter:4,verse:30,ref:'Mosiah 4:30',text:'But this much I can tell you, that if ye do not watch yourselves, and your thoughts, and your words, and your deeds, and observe the commandments of God, and continue in the faith of what ye have heard concerning the coming of our Lord, even unto the end of your lives, ye must perish. And now, O man, remember, and perish not.',tags:['Obedience','Faith','Patience']},
      {book:'Alma',chapter:7,verse:11,ref:'Alma 7:11-12',text:'And he shall go forth, suffering pains and afflictions and temptations of every kind; and this that the word might be fulfilled which saith he will take upon him the pains and the sicknesses of his people.',tags:['Jesus Christ','Trials','Charity']},
      {book:'Alma',chapter:32,verse:21,ref:'Alma 32:21',text:'And now as I said concerning faithâ€”faith is not to have a perfect knowledge of things; therefore if ye have faith ye hope for things which are not seen, which are true.',tags:['Faith','Hope']},
      {book:'Alma',chapter:34,verse:32,ref:'Alma 34:32',text:'For behold, this life is the time for men to prepare to meet God; yea, behold the day of this life is the day for men to perform their labors.',tags:['Obedience','Wisdom']},
      {book:'Alma',chapter:37,verse:6,ref:'Alma 37:6',text:'Now ye may suppose that this is foolishness in me; but behold I say unto you, that by small and simple things are great things brought to pass; and small means in many instances doth confound the wise.',tags:['Faith','Wisdom']},
      {book:'Alma',chapter:37,verse:35,ref:'Alma 37:35',text:'O, remember, my son, and learn wisdom in thy youth; yea, learn in thy youth to keep the commandments of God.',tags:['Wisdom','Obedience']},
      {book:'Alma',chapter:41,verse:10,ref:'Alma 41:10',text:'Do not suppose, because it has been spoken concerning restoration, that ye shall be restored from sin to happiness. Behold, I say unto you, wickedness never was happiness.',tags:['Peace','Repentance']},
      {book:'Helaman',chapter:5,verse:12,ref:'Helaman 5:12',text:'And now, my sons, remember, remember that it is upon the rock of our Redeemer, who is Christ, the Son of God, that ye must build your foundation.',tags:['Jesus Christ','Faith']},
      {book:'3 Nephi',chapter:11,verse:29,ref:'3 Nephi 11:29',text:'For verily, verily I say unto you, he that hath the spirit of contention is not of me, but is of the devil, who is the father of contention, and he stirreth up the hearts of men to contend with anger, one with another.',tags:['Peace','Love']},
      {book:'3 Nephi',chapter:27,verse:27,ref:'3 Nephi 27:27',text:'Therefore, what manner of men ought ye to be? Verily I say unto you, even as I am.',tags:['Jesus Christ','Obedience']},
      {book:'Ether',chapter:12,verse:6,ref:'Ether 12:6',text:'And now, I, Moroni, would speak somewhat concerning these things; I would show unto the world that faith is things which are hoped for and not seen; wherefore, dispute not because ye see not, for ye receive no witness until after the trial of your faith.',tags:['Faith','Trials','Hope']},
      {book:'Ether',chapter:12,verse:27,ref:'Ether 12:27',text:'And if men come unto me I will show unto them their weakness. I give unto men weakness that they may be humble; and my grace is sufficient for all men that humble themselves before me.',tags:['Trials','Faith','Humility']},
      {book:'Moroni',chapter:7,verse:45,ref:'Moroni 7:45',text:'And charity suffereth long, and is kind, and envieth not, and is not puffed up, seeketh not her own, is not easily provoked, thinketh no evil, and rejoiceth not in iniquity but rejoiceth in the truth, beareth all things, believeth all things, hopeth all things, endureth all things.',tags:['Charity','Love','Patience']},
      {book:'Moroni',chapter:7,verse:47,ref:'Moroni 7:47',text:'But charity is the pure love of Christ, and it endureth forever; and whoso is found possessed of it at the last day, it shall be well with him.',tags:['Charity','Love','Jesus Christ']},
      {book:'Moroni',chapter:10,verse:4,ref:'Moroni 10:4-5',text:'And when ye shall receive these things, I would exhort you that ye would ask God, the Eternal Father, in the name of Christ, if these things are not true; and if ye shall ask with a sincere heart, with real intent, having faith in Christ, he will manifest the truth of it unto you, by the power of the Holy Ghost.',tags:['Prayer','Faith','Hope']},
      {book:'Moroni',chapter:10,verse:32,ref:'Moroni 10:32',text:'Yea, come unto Christ, and be perfected in him, and deny yourselves of all ungodliness; and if ye shall deny yourselves of all ungodliness, and love God with all your might, mind and strength, then is his grace sufficient for you.',tags:['Jesus Christ','Love','Faith']},
    ]
  },
  'doctrine-covenants':{
    id:'doctrine-covenants',
    name:'Doctrine & Covenants',
    description:'Latter-day revelations',
    icon:'ðŸ“™',
    verses:[
      {book:'D&C',chapter:4,verse:2,ref:'D&C 4:2',text:'Therefore, O ye that embark in the service of God, see that ye serve him with all your heart, might, mind and strength, that ye may stand blameless before God at the last day.',tags:['Service','Obedience']},
      {book:'D&C',chapter:6,verse:36,ref:'D&C 6:36',text:'Look unto me in every thought; doubt not, fear not.',tags:['Faith','Courage','Jesus Christ']},
      {book:'D&C',chapter:18,verse:10,ref:'D&C 18:10',text:'Remember the worth of souls is great in the sight of God.',tags:['Love','Service']},
      {book:'D&C',chapter:58,verse:27,ref:'D&C 58:27',text:'Verily I say, men should be anxiously engaged in a good cause, and do many things of their own free will, and bring to pass much righteousness.',tags:['Service','Obedience']},
      {book:'D&C',chapter:58,verse:42,ref:'D&C 58:42',text:'Behold, he who has repented of his sins, the same is forgiven, and I, the Lord, remember them no more.',tags:['Repentance','Peace']},
      {book:'D&C',chapter:64,verse:33,ref:'D&C 64:33',text:'Wherefore, be not weary in well-doing, for ye are laying the foundation of a great work. And out of small things proceedeth that which is great.',tags:['Patience','Service','Wisdom']},
      {book:'D&C',chapter:82,verse:10,ref:'D&C 82:10',text:'I, the Lord, am bound when ye do what I say; but when ye do not what I say, ye have no promise.',tags:['Obedience','Faith']},
      {book:'D&C',chapter:88,verse:63,ref:'D&C 88:63',text:'Draw near unto me and I will draw near unto you; seek me diligently and ye shall find me; ask, and ye shall receive; knock, and it shall be opened unto you.',tags:['Prayer','Faith','Jesus Christ']},
      {book:'D&C',chapter:121,verse:45,ref:'D&C 121:45-46',text:'Let thy bowels also be full of charity towards all men, and to the household of faith, and let virtue garnish thy thoughts unceasingly; then shall thy confidence wax strong in the presence of God.',tags:['Charity','Love','Virtue']},
    ]
  },
  'pearl-great-price':{
    id:'pearl-great-price',
    name:'Pearl of Great Price',
    description:'Selections from the Pearl of Great Price',
    icon:'ðŸ’Ž',
    verses:[
      {book:'Moses',chapter:1,verse:39,ref:'Moses 1:39',text:'For behold, this is my work and my gloryâ€”to bring to pass the immortality and eternal life of man.',tags:['Faith','Hope']},
      {book:'Moses',chapter:7,verse:18,ref:'Moses 7:18',text:'And the Lord called his people Zion, because they were of one heart and one mind, and dwelt in righteousness; and there was no poor among them.',tags:['Charity','Love']},
      {book:'Abraham',chapter:3,verse:22,ref:'Abraham 3:22-23',text:'Now the Lord had shown unto me, Abraham, the intelligences that were organized before the world was; and among all these there were many of the noble and great ones.',tags:['Faith','Wisdom']},
      {book:'Abraham',chapter:3,verse:25,ref:'Abraham 3:25',text:'And we will prove them herewith, to see if they will do all things whatsoever the Lord their God shall command them.',tags:['Obedience','Trials']},
      {book:'Joseph Smithâ€”Matthew',chapter:1,verse:37,ref:'JSâ€”Matthew 1:37',text:'And whoso treasureth up my word, shall not be deceived.',tags:['Faith','Wisdom']},
      {book:'Joseph Smithâ€”History',chapter:1,verse:17,ref:'JSâ€”History 1:17',text:'I saw a pillar of light exactly over my head, above the brightness of the sun, which descended gradually until it fell upon me.',tags:['Faith','Prayer']},
      {book:'Joseph Smithâ€”History',chapter:1,verse:19,ref:'JSâ€”History 1:19',text:'I was answered that I must join none of them, for they were all wrong.',tags:['Faith','Wisdom']},
    ]
  },
  // ===== DOCTRINE MASTERY (Seminary Scripture Mastery) =====
  'dm-old-testament':{
    id:'dm-old-testament',
    name:'Doctrine Mastery: Old Testament',
    description:'25 Old Testament Seminary Scripture Mastery verses',
    icon:'ðŸ“–',
    verses:LDS_DOCTRINE_MASTERY.slice(0,25).map(v=>({book:v.b,chapter:v.c,verse:v.v,ref:`${v.b} ${v.c}:${v.v}`,text:v.t,tags:['Doctrine Mastery','Old Testament']}))
  },
  'dm-new-testament':{
    id:'dm-new-testament',
    name:'Doctrine Mastery: New Testament',
    description:'25 New Testament Seminary Scripture Mastery verses',
    icon:'ðŸ“–',
    verses:LDS_DOCTRINE_MASTERY.slice(25,50).map(v=>({book:v.b,chapter:v.c,verse:v.v,ref:`${v.b} ${v.c}:${v.v}`,text:v.t,tags:['Doctrine Mastery','New Testament']}))
  },
  'dm-book-of-mormon':{
    id:'dm-book-of-mormon',
    name:'Doctrine Mastery: Book of Mormon',
    description:'25 Book of Mormon Seminary Scripture Mastery verses',
    icon:'ðŸ“–',
    verses:LDS_DOCTRINE_MASTERY.slice(50,75).map(v=>({book:v.b,chapter:v.c,verse:v.v,ref:`${v.b} ${v.c}:${v.v}`,text:v.t,tags:['Doctrine Mastery','Book of Mormon']}))
  },
  'dm-doctrine-covenants':{
    id:'dm-doctrine-covenants',
    name:'Doctrine Mastery: D&C',
    description:'25 Doctrine & Covenants Seminary Scripture Mastery verses',
    icon:'ðŸ“–',
    verses:LDS_DOCTRINE_MASTERY.slice(75,100).map(v=>({book:v.b,chapter:v.c,verse:v.v,ref:`${v.b} ${v.c}:${v.v}`,text:v.t,tags:['Doctrine Mastery','D&C']}))
  },
  'articles-of-faith':{
    id:'articles-of-faith',
    name:'Articles of Faith',
    description:'The 13 Articles of Faith',
    icon:'ðŸ“œ',
    verses:[
      {book:'Articles of Faith',chapter:1,verse:1,ref:'Articles of Faith 1:1',text:'We believe in God, the Eternal Father, and in His Son, Jesus Christ, and in the Holy Ghost.',tags:['Faith','Jesus Christ']},
      {book:'Articles of Faith',chapter:1,verse:2,ref:'Articles of Faith 1:2',text:'We believe that men will be punished for their own sins, and not for Adam\'s transgression.',tags:['Wisdom','Faith']},
      {book:'Articles of Faith',chapter:1,verse:3,ref:'Articles of Faith 1:3',text:'We believe that through the Atonement of Christ, all mankind may be saved, by obedience to the laws and ordinances of the Gospel.',tags:['Jesus Christ','Faith']},
      {book:'Articles of Faith',chapter:1,verse:4,ref:'Articles of Faith 1:4',text:'We believe that the first principles and ordinances of the Gospel are: first, Faith in the Lord Jesus Christ; second, Repentance; third, Baptism by immersion for the remission of sins; fourth, Laying on of hands for the gift of the Holy Ghost.',tags:['Faith','Repentance']},
      {book:'Articles of Faith',chapter:1,verse:5,ref:'Articles of Faith 1:5',text:'We believe that a man must be called of God, by prophecy, and by the laying on of hands by those who are in authority, to preach the Gospel and administer in the ordinances thereof.',tags:['Faith','Service']},
      {book:'Articles of Faith',chapter:1,verse:6,ref:'Articles of Faith 1:6',text:'We believe in the same organization that existed in the Primitive Church, namely, apostles, prophets, pastors, teachers, evangelists, and so forth.',tags:['Faith','Wisdom']},
      {book:'Articles of Faith',chapter:1,verse:7,ref:'Articles of Faith 1:7',text:'We believe in the gift of tongues, prophecy, revelation, visions, healing, interpretation of tongues, and so forth.',tags:['Faith','Hope']},
      {book:'Articles of Faith',chapter:1,verse:8,ref:'Articles of Faith 1:8',text:'We believe the Bible to be the word of God as far as it is translated correctly; we also believe the Book of Mormon to be the word of God.',tags:['Faith','Wisdom']},
      {book:'Articles of Faith',chapter:1,verse:9,ref:'Articles of Faith 1:9',text:'We believe all that God has revealed, all that He does now reveal, and we believe that He will yet reveal many great and important things pertaining to the Kingdom of God.',tags:['Faith','Hope']},
      {book:'Articles of Faith',chapter:1,verse:10,ref:'Articles of Faith 1:10',text:'We believe in the literal gathering of Israel and in the restoration of the Ten Tribes; that Zion (the New Jerusalem) will be built upon the American continent; that Christ will reign personally upon the earth; and, that the earth will be renewed and receive its paradisiacal glory.',tags:['Hope','Jesus Christ']},
      {book:'Articles of Faith',chapter:1,verse:11,ref:'Articles of Faith 1:11',text:'We claim the privilege of worshiping Almighty God according to the dictates of our own conscience, and allow all men the same privilege, let them worship how, where, or what they may.',tags:['Worship','Faith']},
      {book:'Articles of Faith',chapter:1,verse:12,ref:'Articles of Faith 1:12',text:'We believe in being subject to kings, presidents, rulers, and magistrates, in obeying, honoring, and sustaining the law.',tags:['Obedience','Wisdom']},
      {book:'Articles of Faith',chapter:1,verse:13,ref:'Articles of Faith 1:13',text:'We believe in being honest, true, chaste, benevolent, virtuous, and in doing good to all men; indeed, we may say that we follow the admonition of Paulâ€”We believe all things, we hope all things, we have endured many things, and hope to be able to endure all things. If there is anything virtuous, lovely, or of good report or praiseworthy, we seek after these things.',tags:['Virtue','Hope','Love']},
    ]
  },
  'lds-quotes':{
    id:'lds-quotes',
    name:'LDS Leader Quotes',
    description:'Quotes from Church leaders',
    icon:'ðŸŽ¤',
    quotes:[
      // President Russell M. Nelson
      {ref:'President Nelson (2024)',text:'Think celestial! When you are tempted to give up, think celestial. When your faith is being tested, think celestial. When life or loved ones disappoint you, think celestial.',tags:['Faith','Hope'],speaker:'President Russell M. Nelson'},
      {ref:'President Nelson (2023)',text:'The Lord loves effort. The Lord loves consistency. The Lord loves diligence.',tags:['Faith','Love'],speaker:'President Russell M. Nelson'},
      {ref:'President Nelson (2022)',text:'You can always trust the Lord. He will always keep His promises to you.',tags:['Faith','Hope'],speaker:'President Russell M. Nelson'},
      {ref:'President Nelson',text:'The joy we feel has little to do with the circumstances of our lives and everything to do with the focus of our lives.',tags:['Joy','Faith'],speaker:'President Russell M. Nelson'},
      {ref:'President Nelson',text:'In coming days, it will not be possible to survive spiritually without the guiding, directing, comforting, and constant influence of the Holy Ghost.',tags:['Holy Ghost','Faith'],speaker:'President Russell M. Nelson'},
      {ref:'President Nelson',text:'When we choose to repent, we choose to change! We allow the Savior to transform us into the best version of ourselves.',tags:['Repentance','Jesus Christ'],speaker:'President Russell M. Nelson'},
      {ref:'President Nelson',text:'Nothing opens the heavens quite like the combination of increased purity, exact obedience, earnest seeking, daily feasting on the words of Christ in the Book of Mormon, and regular time committed to temple and family history work.',tags:['Faith','Temple'],speaker:'President Russell M. Nelson'},
      {ref:'President Nelson',text:'My dear brothers and sisters, the Restoration is a process, not an event, and it will continue until the Lord comes again.',tags:['Faith','Hope'],speaker:'President Russell M. Nelson'},
      {ref:'President Nelson',text:'Let virtue garnish thy thoughts unceasingly; then shall thy confidence wax strong in the presence of God. Personal purity is the key to true confidence.',tags:['Virtue','Faith'],speaker:'President Russell M. Nelson'},
      // President Thomas S. Monson
      {ref:'President Monson',text:'May we ever choose the harder right instead of the easier wrong.',tags:['Courage','Wisdom'],speaker:'President Thomas S. Monson'},
      {ref:'President Monson',text:'We can\'t direct the wind, but we can adjust the sails.',tags:['Faith','Wisdom'],speaker:'President Thomas S. Monson'},
      {ref:'President Monson',text:'Find someone who is having a hard time and do something for them.',tags:['Service','Charity'],speaker:'President Thomas S. Monson'},
      {ref:'President Monson',text:'The past is behind, learn from it. The future is ahead, prepare for it. The present is here, live it.',tags:['Wisdom','Faith'],speaker:'President Thomas S. Monson'},
      {ref:'President Monson',text:'There is no better time than now to rededicate our lives to doing what is right.',tags:['Repentance','Faith'],speaker:'President Thomas S. Monson'},
      {ref:'President Monson',text:'Never let a problem to be solved become more important than a person to be loved.',tags:['Love','Family'],speaker:'President Thomas S. Monson'},
      {ref:'President Monson',text:'The Lord expects our thinking. He expects our action. He expects our labors.',tags:['Service','Faith'],speaker:'President Thomas S. Monson'},
      {ref:'President Monson',text:'Decisions determine destiny.',tags:['Wisdom','Faith'],speaker:'President Thomas S. Monson'},
      // President Gordon B. Hinckley
      {ref:'President Hinckley',text:'Be believing. Be happy. Don\'t get discouraged. Things will work out.',tags:['Hope','Faith'],speaker:'President Gordon B. Hinckley'},
      {ref:'President Hinckley',text:'Try a little harder to be a little better.',tags:['Faith','Wisdom'],speaker:'President Gordon B. Hinckley'},
      {ref:'President Hinckley',text:'You have not failed until you quit trying.',tags:['Perseverance','Hope'],speaker:'President Gordon B. Hinckley'},
      {ref:'President Hinckley',text:'Life is to be enjoyed, not just endured.',tags:['Joy','Faith'],speaker:'President Gordon B. Hinckley'},
      {ref:'President Hinckley',text:'Believe in yourself. Believe in your capacity to do great and good things.',tags:['Faith','Hope'],speaker:'President Gordon B. Hinckley'},
      {ref:'President Hinckley',text:'The best antidote I know for worry is work. The best cure for weariness is the challenge of helping someone who is even more tired.',tags:['Service','Peace'],speaker:'President Gordon B. Hinckley'},
      {ref:'President Hinckley',text:'Love is the very essence of the gospel, and Jesus Christ is our Exemplar.',tags:['Love','Jesus Christ'],speaker:'President Gordon B. Hinckley'},
      {ref:'President Hinckley',text:'Our whole strength rests on the validity of that vision. It either occurred or it did not occur. If it did not, then this work is a fraud.',tags:['Faith','Joseph Smith'],speaker:'President Gordon B. Hinckley'},
      {ref:'President Hinckley',text:'Without hard work, nothing grows but weeds.',tags:['Service','Wisdom'],speaker:'President Gordon B. Hinckley'},
      // President Ezra Taft Benson
      {ref:'President Benson',text:'The Lord works from the inside out. The world works from the outside in.',tags:['Faith','Wisdom'],speaker:'President Ezra Taft Benson'},
      {ref:'President Benson',text:'When obedience ceases to be an irritant and becomes our quest, in that moment God will endow us with power.',tags:['Obedience','Faith'],speaker:'President Ezra Taft Benson'},
      {ref:'President Benson',text:'Pride is the universal sin, the great vice.',tags:['Humility','Wisdom'],speaker:'President Ezra Taft Benson'},
      {ref:'President Benson',text:'The Book of Mormon is the keystone of our religion.',tags:['Faith','Book of Mormon'],speaker:'President Ezra Taft Benson'},
      {ref:'President Benson',text:'There is a power in the Book of Mormon which will begin to flow into your lives the moment you begin a serious study of the book.',tags:['Book of Mormon','Faith'],speaker:'President Ezra Taft Benson'},
      {ref:'President Benson',text:'If we do not feel like praying, then we should pray until we do feel like praying.',tags:['Prayer','Faith'],speaker:'President Ezra Taft Benson'},
      // President Spencer W. Kimball
      {ref:'President Kimball',text:'Do it. Do it right. Do it right now.',tags:['Faith','Wisdom'],speaker:'President Spencer W. Kimball'},
      {ref:'President Kimball',text:'Faith is not to have a perfect knowledge of things; therefore if ye have faith ye hope for things which are not seen, which are true.',tags:['Faith','Hope'],speaker:'President Spencer W. Kimball'},
      {ref:'President Kimball',text:'God does notice us, and he watches over us. But it is usually through another person that he meets our needs.',tags:['Service','Love'],speaker:'President Spencer W. Kimball'},
      {ref:'President Kimball',text:'The time to prepare is not after the emergency has come.',tags:['Wisdom','Faith'],speaker:'President Spencer W. Kimball'},
      {ref:'President Kimball',text:'Lengthen your stride.',tags:['Service','Faith'],speaker:'President Spencer W. Kimball'},
      // President David O. McKay
      {ref:'President McKay',text:'No success can compensate for failure in the home.',tags:['Family','Wisdom'],speaker:'President David O. McKay'},
      {ref:'President McKay',text:'The greatest battles of life are fought out daily in the silent chambers of the soul.',tags:['Faith','Courage'],speaker:'President David O. McKay'},
      {ref:'President McKay',text:'Let us realize that the privilege to work is a gift, the power to work is a blessing, the love of work is success.',tags:['Service','Gratitude'],speaker:'President David O. McKay'},
      {ref:'President McKay',text:'True Christianity is love in action.',tags:['Love','Service'],speaker:'President David O. McKay'},
      // Elder Jeffrey R. Holland
      {ref:'Elder Holland',text:'Don\'t you quit. You keep walking. You keep trying. There is help and happiness ahead.',tags:['Hope','Courage'],speaker:'Elder Jeffrey R. Holland'},
      {ref:'Elder Holland',text:'The size of your faith or the degree of your knowledge is not the issueâ€”it is the integrity you demonstrate toward the faith you do have.',tags:['Faith','Integrity'],speaker:'Elder Jeffrey R. Holland'},
      {ref:'Elder Holland',text:'Some blessings come soon, some come late, and some don\'t come until heaven; but for those who embrace the gospel of Jesus Christ, they come.',tags:['Faith','Hope'],speaker:'Elder Jeffrey R. Holland'},
      {ref:'Elder Holland',text:'I am not asking you to pretend to faith you do not have. I am asking you to be true to the faith you do have.',tags:['Faith','Integrity'],speaker:'Elder Jeffrey R. Holland'},
      {ref:'Elder Holland',text:'When those moments come and issues surface, the resolution of which is not immediately forthcoming, hold fast to what you already know and stand strong until additional knowledge comes.',tags:['Faith','Patience'],speaker:'Elder Jeffrey R. Holland'},
      {ref:'Elder Holland',text:'God is eagerly waiting for the chance to answer your prayers and fulfill your dreams, just as He always has.',tags:['Faith','Prayer'],speaker:'Elder Jeffrey R. Holland'},
      {ref:'Elder Holland',text:'Angels are still sent to help us.',tags:['Faith','Hope'],speaker:'Elder Jeffrey R. Holland'},
      {ref:'Elder Holland',text:'However late you think you are, however many chances you think you have missed, however many mistakes you feel you have made... you have not traveled beyond the reach of divine love.',tags:['Repentance','Love'],speaker:'Elder Jeffrey R. Holland'},
      {ref:'Elder Holland',text:'Broken minds can be healed just the way broken bones and broken hearts are healed.',tags:['Hope','Healing'],speaker:'Elder Jeffrey R. Holland'},
      // Elder Dieter F. Uchtdorf
      {ref:'Elder Uchtdorf',text:'The Lord compensates the faithful for every loss. That which is taken away from those who love the Lord will be added unto them in His own way.',tags:['Faith','Love'],speaker:'Elder Dieter F. Uchtdorf'},
      {ref:'Elder Uchtdorf',text:'Doubt your doubts before you doubt your faith.',tags:['Faith','Wisdom'],speaker:'Elder Dieter F. Uchtdorf'},
      {ref:'Elder Uchtdorf',text:'God sees you not only as a mortal being on a small planet who lives for a brief seasonâ€”He sees you as His child.',tags:['Love','Faith'],speaker:'Elder Dieter F. Uchtdorf'},
      {ref:'Elder Uchtdorf',text:'Stop it! If you have ever been hurt by others, don\'t carry that burden. Don\'t pick up rocks to throw back.',tags:['Forgiveness','Peace'],speaker:'Elder Dieter F. Uchtdorf'},
      {ref:'Elder Uchtdorf',text:'The desire to create is one of the deepest yearnings of the human soul.',tags:['Wisdom','Faith'],speaker:'Elder Dieter F. Uchtdorf'},
      {ref:'Elder Uchtdorf',text:'This is a paradox of man: compared to God, man is nothing; yet we are everything to God.',tags:['Love','Faith'],speaker:'Elder Dieter F. Uchtdorf'},
      {ref:'Elder Uchtdorf',text:'God\'s grace is sufficient for all of us. Because of Jesus Christ, our failures do not have to define us.',tags:['Grace','Jesus Christ'],speaker:'Elder Dieter F. Uchtdorf'},
      {ref:'Elder Uchtdorf',text:'The things we hope for lead us to faith, while the things we hope in lead us to charity.',tags:['Hope','Charity'],speaker:'Elder Dieter F. Uchtdorf'},
      // President Henry B. Eyring
      {ref:'President Eyring',text:'The Comforter, which is the Holy Ghost, gives us the peace and assurance that our course is right.',tags:['Peace','Faith'],speaker:'President Henry B. Eyring'},
      {ref:'President Eyring',text:'Today I will seek evidence of what God has done in the lives of those around me.',tags:['Gratitude','Faith'],speaker:'President Henry B. Eyring'},
      {ref:'President Eyring',text:'The Lord knows both what He will need you to do and what you will need to know.',tags:['Faith','Trust'],speaker:'President Henry B. Eyring'},
      {ref:'President Eyring',text:'When we put God\'s purposes first, He will give us miracles.',tags:['Faith','Miracles'],speaker:'President Henry B. Eyring'},
      {ref:'President Eyring',text:'You are loved. You are dear to your Heavenly Father.',tags:['Love','Faith'],speaker:'President Henry B. Eyring'},
      // President Dallin H. Oaks
      {ref:'President Oaks',text:'What is most important almost always involves the people around us. Feelings of closeness and love are born in sharing service, joy, and hardship.',tags:['Love','Service','Family'],speaker:'President Dallin H. Oaks'},
      {ref:'President Oaks',text:'Desires dictate our priorities, priorities shape our choices, and choices determine our actions.',tags:['Wisdom','Faith'],speaker:'President Dallin H. Oaks'},
      {ref:'President Oaks',text:'The Final Judgment is not just an evaluation of a sum total of good and evil actsâ€”what we have done. It is an acknowledgment of the final effect of our acts and thoughtsâ€”what we have become.',tags:['Wisdom','Faith'],speaker:'President Dallin H. Oaks'},
      {ref:'President Oaks',text:'Love is the most powerful force in the world.',tags:['Love','Faith'],speaker:'President Dallin H. Oaks'},
      // Elder David A. Bednar
      {ref:'Elder Bednar',text:'Faith is to hope for things which are not seen but which are true and then to act on that belief.',tags:['Faith','Hope'],speaker:'Elder David A. Bednar'},
      {ref:'Elder Bednar',text:'The tender mercies of the Lord are real and that they do not occur randomly or merely by coincidence.',tags:['Faith','Grace'],speaker:'Elder David A. Bednar'},
      {ref:'Elder Bednar',text:'We become what we want to be by consistently being what we want to become each day.',tags:['Faith','Wisdom'],speaker:'Elder David A. Bednar'},
      {ref:'Elder Bednar',text:'Obedience brings the blessings we want. Obedience brings the blessings we need.',tags:['Obedience','Faith'],speaker:'Elder David A. Bednar'},
      {ref:'Elder Bednar',text:'There is no physical pain, no anguish of soul, no suffering, no infirmity, no weakness you or I ever experience during our mortal journey that the Savior did not experience first.',tags:['Jesus Christ','Trials'],speaker:'Elder David A. Bednar'},
      // Elder Neil L. Andersen
      {ref:'Elder Andersen',text:'Faith is not only a feeling; it is a decision.',tags:['Faith','Courage'],speaker:'Elder Neil L. Andersen'},
      {ref:'Elder Andersen',text:'Your faith will not grow by chance; it will grow by choice.',tags:['Faith','Wisdom'],speaker:'Elder Neil L. Andersen'},
      {ref:'Elder Andersen',text:'When you spiritually stretch beyond anything you have ever done before, you discover He has been preparing you all along.',tags:['Faith','Trust'],speaker:'Elder Neil L. Andersen'},
      // Elder Quentin L. Cook
      {ref:'Elder Cook',text:'Our conduct in mortality will determine what we become in the eternities.',tags:['Wisdom','Faith'],speaker:'Elder Quentin L. Cook'},
      {ref:'Elder Cook',text:'The most important thing we can do is to live worthily and build faith and testimony.',tags:['Faith','Wisdom'],speaker:'Elder Quentin L. Cook'},
      // Elder D. Todd Christofferson
      {ref:'Elder Christofferson',text:'Moral agency is essential to the gospel plan.',tags:['Faith','Wisdom'],speaker:'Elder D. Todd Christofferson'},
      {ref:'Elder Christofferson',text:'In the gospel of Jesus Christ, you have help from both sides of the veil.',tags:['Faith','Hope'],speaker:'Elder D. Todd Christofferson'},
      // Elder Ronald A. Rasband
      {ref:'Elder Rasband',text:'The Lord knows us. He has chosen each of us for the important work of building His Church.',tags:['Faith','Service'],speaker:'Elder Ronald A. Rasband'},
      // Elder Gary E. Stevenson
      {ref:'Elder Stevenson',text:'The Lord does not ask us to run faster than we have strength.',tags:['Faith','Peace'],speaker:'Elder Gary E. Stevenson'},
      // Elder Dale G. Renlund
      {ref:'Elder Renlund',text:'God will always give us what we need when we need it.',tags:['Faith','Trust'],speaker:'Elder Dale G. Renlund'},
      {ref:'Elder Renlund',text:'Our Heavenly Father\'s goal has never been to have His children dwell with Him. His goal has been for His children to become like Him.',tags:['Faith','Wisdom'],speaker:'Elder Dale G. Renlund'},
      // Elder Gerrit W. Gong
      {ref:'Elder Gong',text:'Covenant belonging gives us a place to come home to.',tags:['Faith','Family'],speaker:'Elder Gerrit W. Gong'},
      // Elder Ulisses Soares
      {ref:'Elder Soares',text:'As disciples of Jesus Christ, we have a responsibility to support one another.',tags:['Love','Service'],speaker:'Elder Ulisses Soares'},
      // Joseph Smith
      {ref:'Joseph Smith',text:'A man filled with the love of God is not content with blessing his family alone, but ranges through the whole world, anxious to bless the whole human race.',tags:['Love','Service'],speaker:'Joseph Smith'},
      {ref:'Joseph Smith',text:'Happiness is the object and design of our existence.',tags:['Joy','Wisdom'],speaker:'Joseph Smith'},
      {ref:'Joseph Smith',text:'No man can be saved in ignorance.',tags:['Wisdom','Faith'],speaker:'Joseph Smith'},
      {ref:'Joseph Smith',text:'We have learned by sad experience that it is the nature and disposition of almost all men, as soon as they get a little authority, they will immediately begin to exercise unrighteous dominion.',tags:['Wisdom','Humility'],speaker:'Joseph Smith'},
      {ref:'Joseph Smith',text:'I teach them correct principles and they govern themselves.',tags:['Wisdom','Faith'],speaker:'Joseph Smith'},
      {ref:'Joseph Smith',text:'The Standard of Truth has been erected; no unhallowed hand can stop the work from progressing.',tags:['Faith','Hope'],speaker:'Joseph Smith'},
      // Brigham Young
      {ref:'Brigham Young',text:'He who takes offense when no offense is intended is a fool, and he who takes offense when offense is intended is a greater fool.',tags:['Wisdom','Peace'],speaker:'Brigham Young'},
      {ref:'Brigham Young',text:'If you wish to get rich, save what you get. A fool can earn money; but it takes a wise man to save and dispose of it to his own advantage.',tags:['Wisdom','Stewardship'],speaker:'Brigham Young'},
      {ref:'Brigham Young',text:'Don\'t try to tear down other people\'s religion about their ears. Build up your own perfect structure of truth.',tags:['Wisdom','Love'],speaker:'Brigham Young'},
      // Sister Missionaries & Female Leaders
      {ref:'Sister Eubank',text:'Jesus specializes in the seemingly impossible.',tags:['Faith','Hope'],speaker:'Sister Sharon Eubank'},
      {ref:'Sister Cordon',text:'The Lord loves a righteous desire. He will help you become something greater than you could ever become on your own.',tags:['Faith','Hope'],speaker:'Sister Bonnie H. Cordon'},
      {ref:'Sister Bingham',text:'When we turn to Him, He will strengthen us, lift us up, and eventually consecrate our afflictions for our gain.',tags:['Faith','Trials'],speaker:'Sister Jean B. Bingham'},
      {ref:'Sister Aburto',text:'The Lord has placed in our path people who need our help.',tags:['Service','Love'],speaker:'Sister Reyna I. Aburto'},
      // Additional Classic Quotes
      {ref:'Elder Maxwell',text:'Meekness is not weakness. It is a badge of Christian courage.',tags:['Humility','Courage'],speaker:'Elder Neal A. Maxwell'},
      {ref:'Elder Maxwell',text:'Faith in God includes faith in His timing.',tags:['Faith','Patience'],speaker:'Elder Neal A. Maxwell'},
      {ref:'Elder Maxwell',text:'We should not assume that just because something is unexplainable by us, it is unexplainable.',tags:['Faith','Wisdom'],speaker:'Elder Neal A. Maxwell'},
      {ref:'Elder Packer',text:'True doctrine, understood, changes attitudes and behavior.',tags:['Faith','Wisdom'],speaker:'President Boyd K. Packer'},
      {ref:'Elder Packer',text:'The study of the doctrines of the gospel will improve behavior quicker than a study of behavior will improve behavior.',tags:['Wisdom','Faith'],speaker:'President Boyd K. Packer'},
      {ref:'Elder Scott',text:'Just when all seems to be going right, challenges often come in multiple doses applied simultaneously.',tags:['Trials','Faith'],speaker:'Elder Richard G. Scott'},
      {ref:'Elder Scott',text:'Learning to endure times of disappointment, suffering, and sorrow is part of our on-the-job training.',tags:['Trials','Patience'],speaker:'Elder Richard G. Scott'},
      {ref:'Elder Hales',text:'When we obey the commandments, obedience brings blessings and greater ability to obey.',tags:['Obedience','Faith'],speaker:'Elder Robert D. Hales'},
      {ref:'Elder Wirthlin',text:'Come what may, and love it.',tags:['Faith','Peace'],speaker:'Elder Joseph B. Wirthlin'},
      {ref:'Elder Wirthlin',text:'The Lord compensates the faithful for every loss.',tags:['Faith','Hope'],speaker:'Elder Joseph B. Wirthlin'},
    ]
  },
  // ===== JUDAISM =====
  'torah':{
    id:'torah',
    name:'Torah & Tanakh',
    description:'Sacred texts of Judaism',
    icon:'âœ¡ï¸',
    verses:[
      {book:'Torah',chapter:1,verse:1,ref:'Deuteronomy 6:5',text:'And thou shalt love the Lord thy God with all thine heart, and with all thy soul, and with all thy might.',tags:['Love','Faith']},
      {book:'Torah',chapter:1,verse:2,ref:'Leviticus 19:18',text:'Thou shalt love thy neighbour as thyself: I am the Lord.',tags:['Love','Charity']},
      {book:'Torah',chapter:1,verse:3,ref:'Micah 6:8',text:'He hath shewed thee, O man, what is good; and what doth the Lord require of thee, but to do justly, and to love mercy, and to walk humbly with thy God?',tags:['Wisdom','Humility']},
      {book:'Torah',chapter:1,verse:4,ref:'Proverbs 3:5-6 (Tanakh)',text:'Trust in the Lord with all thine heart; and lean not unto thine own understanding. In all thy ways acknowledge him, and he shall direct thy paths.',tags:['Faith','Wisdom']},
      {book:'Torah',chapter:1,verse:5,ref:'Ecclesiastes 3:1',text:'To every thing there is a season, and a time to every purpose under the heaven.',tags:['Wisdom','Peace']},
      {book:'Torah',chapter:1,verse:6,ref:'Isaiah 40:31 (Tanakh)',text:'But they that wait upon the Lord shall renew their strength; they shall mount up with wings as eagles.',tags:['Faith','Hope']},
      {book:'Torah',chapter:1,verse:7,ref:'Psalm 23:1 (Tanakh)',text:'The Lord is my shepherd; I shall not want.',tags:['Peace','Faith']},
      {book:'Torah',chapter:1,verse:8,ref:'Psalm 27:1',text:'The Lord is my light and my salvation; whom shall I fear? The Lord is the strength of my life; of whom shall I be afraid?',tags:['Courage','Faith']},
      {book:'Torah',chapter:1,verse:9,ref:'Psalm 46:10 (Tanakh)',text:'Be still, and know that I am God.',tags:['Peace','Faith']},
      {book:'Torah',chapter:1,verse:10,ref:'Psalm 118:24',text:'This is the day which the Lord hath made; we will rejoice and be glad in it.',tags:['Gratitude','Peace']},
      {book:'Torah',chapter:1,verse:11,ref:'Proverbs 16:3',text:'Commit thy works unto the Lord, and thy thoughts shall be established.',tags:['Faith','Wisdom']},
      {book:'Torah',chapter:1,verse:12,ref:'Isaiah 41:10 (Tanakh)',text:'Fear thou not; for I am with thee: be not dismayed; for I am thy God.',tags:['Courage','Faith']},
    ]
  },
  'jewish-wisdom':{
    id:'jewish-wisdom',
    name:'Jewish Wisdom',
    description:'Talmud & Rabbinic teachings',
    icon:'ðŸ“œ',
    quotes:[
      {ref:'Pirkei Avot 1:14',text:'If I am not for myself, who will be for me? But if I am only for myself, what am I? And if not now, when?',tags:['Wisdom','Service'],speaker:'Hillel'},
      {ref:'Pirkei Avot 2:4',text:'Do not judge your fellow until you have stood in his place.',tags:['Wisdom','Charity'],speaker:'Hillel'},
      {ref:'Talmud Shabbat 31a',text:'What is hateful to you, do not do to your neighbor. That is the whole Torah; the rest is commentary.',tags:['Love','Wisdom'],speaker:'Hillel'},
      {ref:'Pirkei Avot 4:1',text:'Who is wise? One who learns from every person. Who is strong? One who controls their inclinations. Who is rich? One who is happy with their lot.',tags:['Wisdom','Gratitude'],speaker:'Ben Zoma'},
      {ref:'Talmud Sanhedrin 37a',text:'Whoever saves a single life is considered to have saved the whole world.',tags:['Love','Service'],speaker:'Talmud'},
      {ref:'Pirkei Avot 1:2',text:'The world stands on three things: Torah, service of God, and acts of loving kindness.',tags:['Faith','Charity'],speaker:'Shimon HaTzaddik'},
      {ref:'Pirkei Avot 2:16',text:'It is not your duty to finish the work, but neither are you free to neglect it.',tags:['Service','Patience'],speaker:'Rabbi Tarfon'},
      {ref:'Talmud Berachot 17a',text:'The purpose of wisdom is repentance and good deeds.',tags:['Wisdom','Repentance'],speaker:'Talmud'},
    ]
  },
  // ===== ISLAM =====
  'quran':{
    id:'quran',
    name:'Quran',
    description:'Holy book of Islam',
    icon:'â˜ªï¸',
    verses:[
      {book:'Quran',chapter:1,verse:1,ref:'Surah Al-Fatiha 1:1-7',text:'In the name of Allah, the Most Gracious, the Most Merciful. Praise be to Allah, Lord of all the worlds.',tags:['Faith','Gratitude']},
      {book:'Quran',chapter:2,verse:1,ref:'Surah Al-Baqarah 2:286',text:'Allah does not burden a soul beyond that it can bear.',tags:['Trials','Faith']},
      {book:'Quran',chapter:2,verse:2,ref:'Surah Al-Baqarah 2:152',text:'Remember Me, and I will remember you. Be grateful to Me and do not deny Me.',tags:['Gratitude','Faith']},
      {book:'Quran',chapter:2,verse:3,ref:'Surah Al-Baqarah 2:155-156',text:'We will certainly test you with fear and hunger and loss of wealth and lives and fruits. But give good tidings to the patient.',tags:['Patience','Trials']},
      {book:'Quran',chapter:3,verse:1,ref:'Surah Ali Imran 3:139',text:'Do not lose heart or despairâ€” if you are true believers you have the upper hand.',tags:['Courage','Hope']},
      {book:'Quran',chapter:5,verse:1,ref:'Surah Al-Ma\'idah 5:8',text:'Be just! That is closer to righteousness.',tags:['Wisdom','Charity']},
      {book:'Quran',chapter:13,verse:1,ref:'Surah Ar-Ra\'d 13:28',text:'Verily, in the remembrance of Allah do hearts find rest.',tags:['Peace','Faith']},
      {book:'Quran',chapter:39,verse:1,ref:'Surah Az-Zumar 39:53',text:'Say: O My servants who have transgressed against themselves, do not despair of the mercy of Allah. Indeed, Allah forgives all sins.',tags:['Hope','Repentance']},
      {book:'Quran',chapter:49,verse:1,ref:'Surah Al-Hujurat 49:13',text:'O mankind, We have created you from male and female and made you peoples and tribes that you may know one another.',tags:['Love','Wisdom']},
      {book:'Quran',chapter:94,verse:1,ref:'Surah Ash-Sharh 94:5-6',text:'For indeed, with hardship comes ease. Indeed, with hardship comes ease.',tags:['Hope','Trials']},
      {book:'Quran',chapter:103,verse:1,ref:'Surah Al-Asr 103:1-3',text:'By time, indeed mankind is in loss, except for those who believe and do righteous deeds and advise each other to truth and patience.',tags:['Faith','Patience']},
    ]
  },
  'hadith':{
    id:'hadith',
    name:'Hadith',
    description:'Sayings of Prophet Muhammad',
    icon:'ðŸ•Œ',
    quotes:[
      {ref:'Sahih Bukhari',text:'The best among you are those who have the best manners and character.',tags:['Wisdom','Charity'],speaker:'Prophet Muhammad ï·º'},
      {ref:'Sahih Muslim',text:'None of you truly believes until he loves for his brother what he loves for himself.',tags:['Love','Charity'],speaker:'Prophet Muhammad ï·º'},
      {ref:'Sahih Bukhari',text:'Make things easy and do not make them difficult. Give glad tidings and do not drive people away.',tags:['Kindness','Wisdom'],speaker:'Prophet Muhammad ï·º'},
      {ref:'Sunan Ibn Majah',text:'Be kind, for whenever kindness becomes part of something, it beautifies it. Whenever it is taken from something, it leaves it tarnished.',tags:['Kindness','Love'],speaker:'Prophet Muhammad ï·º'},
      {ref:'Sahih Muslim',text:'The strong person is not the one who can wrestle someone else down. The strong person is the one who can control himself when he is angry.',tags:['Patience','Wisdom'],speaker:'Prophet Muhammad ï·º'},
      {ref:'Jami at-Tirmidhi',text:'Take advantage of five before five: your youth before your old age, your health before your illness, your wealth before your poverty, your free time before your work, and your life before your death.',tags:['Wisdom','Gratitude'],speaker:'Prophet Muhammad ï·º'},
      {ref:'Sahih Bukhari',text:'Whoever believes in Allah and the Last Day, let him speak good or remain silent.',tags:['Wisdom','Peace'],speaker:'Prophet Muhammad ï·º'},
      {ref:'Sahih Muslim',text:'A servant of Allah will remain standing on the Day of Judgment until he is questioned about his life and how he spent it.',tags:['Wisdom','Faith'],speaker:'Prophet Muhammad ï·º'},
    ]
  },
  // ===== BUDDHISM =====
  'buddhist-sutras':{
    id:'buddhist-sutras',
    name:'Buddhist Teachings',
    description:'Wisdom from Buddhist sutras',
    icon:'â˜¸ï¸',
    quotes:[
      {ref:'Dhammapada 1:1-2',text:'All that we are is the result of what we have thought. The mind is everything. What we think, we become.',tags:['Wisdom','Peace'],speaker:'Buddha'},
      {ref:'Dhammapada 17:223',text:'Conquer anger with non-anger. Conquer badness with goodness. Conquer meanness with generosity. Conquer dishonesty with truth.',tags:['Peace','Wisdom'],speaker:'Buddha'},
      {ref:'Dhammapada 1:5',text:'Hatred does not cease by hatred, but only by love; this is the eternal rule.',tags:['Love','Peace'],speaker:'Buddha'},
      {ref:'Dhammapada 24:320',text:'Better than a thousand hollow words is one word that brings peace.',tags:['Peace','Wisdom'],speaker:'Buddha'},
      {ref:'Metta Sutta',text:'May all beings be happy. May all beings be free from suffering. May all beings find joy. May all beings live in peace.',tags:['Love','Peace'],speaker:'Buddha'},
      {ref:'Dhammapada 4:50',text:'Do not look at the faults of others, but look at your own deeds, done and undone.',tags:['Wisdom','Humility'],speaker:'Buddha'},
      {ref:'Dhammapada 14:183',text:'To refrain from evil, to cultivate the good, and to purify one\'s mindâ€”this is the teaching of all the Buddhas.',tags:['Wisdom','Peace'],speaker:'Buddha'},
      {ref:'Heart Sutra',text:'Form is emptiness, emptiness is form. There is no suffering, no cause of suffering, no end to suffering, no path to follow.',tags:['Wisdom','Peace'],speaker:'Heart Sutra'},
      {ref:'Dhammapada 20:277',text:'All conditioned things are impermanent. When one sees this with wisdom, one turns away from suffering.',tags:['Wisdom','Peace'],speaker:'Buddha'},
      {ref:'Lotus Sutra',text:'Just as the soft rain falls equally on all plants, the Buddha\'s compassion falls equally on all beings.',tags:['Love','Charity'],speaker:'Lotus Sutra'},
    ]
  },
  // ===== HINDUISM =====
  'bhagavad-gita':{
    id:'bhagavad-gita',
    name:'Bhagavad Gita',
    description:'Hindu sacred scripture',
    icon:'ðŸ•‰ï¸',
    verses:[
      {book:'Gita',chapter:2,verse:47,ref:'Bhagavad Gita 2:47',text:'You have the right to work, but never to the fruit of work. You should never engage in action for the sake of reward.',tags:['Wisdom','Service']},
      {book:'Gita',chapter:2,verse:48,ref:'Bhagavad Gita 2:48',text:'Perform work in this world, established in yoga, without attachment, and be even-minded in success and failure.',tags:['Peace','Wisdom']},
      {book:'Gita',chapter:2,verse:62,ref:'Bhagavad Gita 2:62-63',text:'From attachment springs desire, and from desire comes anger. From anger arises delusion, and from delusion, loss of memory.',tags:['Wisdom','Peace']},
      {book:'Gita',chapter:3,verse:19,ref:'Bhagavad Gita 3:19',text:'Therefore, without attachment, perform always the work that has to be done, for by working without attachment, one attains the Supreme.',tags:['Service','Wisdom']},
      {book:'Gita',chapter:4,verse:7,ref:'Bhagavad Gita 4:7-8',text:'Whenever righteousness declines and unrighteousness rises, I manifest myself. For the protection of the good and destruction of evil, I am born age after age.',tags:['Faith','Hope']},
      {book:'Gita',chapter:6,verse:5,ref:'Bhagavad Gita 6:5',text:'Elevate yourself through the power of your mind, and not degrade yourself, for the mind can be the friend and also the enemy of the self.',tags:['Wisdom','Courage']},
      {book:'Gita',chapter:9,verse:22,ref:'Bhagavad Gita 9:22',text:'To those who are constantly devoted and worship Me with love, I give the understanding by which they can come to Me.',tags:['Faith','Love']},
      {book:'Gita',chapter:12,verse:13,ref:'Bhagavad Gita 12:13-14',text:'One who is free from hatred toward all beings, friendly and compassionate, free from possessiveness and ego, even-minded in pain and pleasureâ€”such a devotee is dear to Me.',tags:['Love','Peace']},
      {book:'Gita',chapter:18,verse:66,ref:'Bhagavad Gita 18:66',text:'Abandon all varieties of dharma and simply surrender unto Me. I shall deliver you from all sinful reactions; do not fear.',tags:['Faith','Peace']},
    ]
  },
  'hindu-wisdom':{
    id:'hindu-wisdom',
    name:'Hindu Wisdom',
    description:'Upanishads & Vedic teachings',
    icon:'ðŸ™',
    quotes:[
      {ref:'Isha Upanishad 1',text:'The whole universe is pervaded by the Lord. Enjoy what has been given to you; do not covet what belongs to others.',tags:['Gratitude','Peace'],speaker:'Upanishads'},
      {ref:'Mundaka Upanishad 3.1.6',text:'Truth alone triumphs, not falsehood. Through truth the divine path is spread out.',tags:['Wisdom','Faith'],speaker:'Upanishads'},
      {ref:'Katha Upanishad 1.2.23',text:'The Self cannot be known through study, nor through the intellect. It is known to those whom the Self chooses.',tags:['Faith','Wisdom'],speaker:'Upanishads'},
      {ref:'Brihadaranyaka Upanishad',text:'Lead me from the unreal to the real. Lead me from darkness to light. Lead me from death to immortality.',tags:['Hope','Faith'],speaker:'Upanishads'},
      {ref:'Chandogya Upanishad 6.2.1',text:'In the beginning, there was only Being, one without a second.',tags:['Faith','Wisdom'],speaker:'Upanishads'},
      {ref:'Taittiriya Upanishad',text:'Let your mother be a god to you. Let your father be a god to you. Let your teacher be a god to you. Let your guest be a god to you.',tags:['Family','Love'],speaker:'Upanishads'},
      {ref:'Rig Veda 1.164.46',text:'Truth is one; the wise call it by many names.',tags:['Wisdom','Peace'],speaker:'Rig Veda'},
      {ref:'Yoga Sutras 1.2',text:'Yoga is the stilling of the fluctuations of the mind.',tags:['Peace','Wisdom'],speaker:'Patanjali'},
    ]
  },
  // ===== SIKHISM =====
  'guru-granth':{
    id:'guru-granth',
    name:'Guru Granth Sahib',
    description:'Sikh sacred scripture',
    icon:'ðŸ™',
    quotes:[
      {ref:'Japji Sahib (Opening)',text:'There is One God, whose name is Truth, the Creator, without fear, without hate, timeless in form, beyond birth and death, self-existent.',tags:['Faith','Peace'],speaker:'Guru Nanak'},
      {ref:'Guru Granth Sahib, p.4',text:'Even kings and emperors with heaps of wealth and vast dominion cannot compare with an ant filled with the love of God.',tags:['Love','Faith'],speaker:'Guru Nanak'},
      {ref:'Guru Granth Sahib, p.26',text:'Through selfless service, eternal peace is obtained.',tags:['Service','Peace'],speaker:'Guru Nanak'},
      {ref:'Guru Granth Sahib, p.473',text:'Whatever kind of seed is sown in a field, prepared in due season, a plant of that same kind grows from it.',tags:['Wisdom','Faith'],speaker:'Guru Arjan'},
      {ref:'Guru Granth Sahib, p.1',text:'By His Command, all forms came into being. His Command cannot be described. By His Command, souls come into being. By His Command, honor is obtained.',tags:['Faith','Humility'],speaker:'Guru Nanak'},
      {ref:'Guru Granth Sahib, p.1384',text:'One who works for what he eats, and gives some of what he hasâ€”O Nanak, he knows the Path.',tags:['Service','Charity'],speaker:'Guru Nanak'},
      {ref:'Guru Granth Sahib, p.913',text:'First, there is oneness. Then there is the awareness of self. Out of that awareness comes understanding.',tags:['Wisdom','Faith'],speaker:'Guru Nanak'},
      {ref:'Mool Mantar',text:'God is One. His name is Truth. He is the Creator. He is without fear. He is without hate. He is timeless and without form.',tags:['Faith','Peace'],speaker:'Guru Nanak'},
    ]
  },
  // ===== CATHOLIC/ORTHODOX =====
  'catholic-prayers':{
    id:'catholic-prayers',
    name:'Catholic Prayers',
    description:'Traditional Catholic prayers',
    icon:'âœï¸',
    quotes:[
      {ref:'Hail Mary',text:'Hail Mary, full of grace, the Lord is with thee. Blessed art thou among women, and blessed is the fruit of thy womb, Jesus.',tags:['Faith','Prayer'],speaker:'Traditional'},
      {ref:'Prayer of St. Francis',text:'Lord, make me an instrument of your peace. Where there is hatred, let me sow love; where there is injury, pardon; where there is doubt, faith.',tags:['Peace','Love'],speaker:'St. Francis of Assisi'},
      {ref:'Serenity Prayer',text:'God, grant me the serenity to accept the things I cannot change, courage to change the things I can, and wisdom to know the difference.',tags:['Peace','Wisdom'],speaker:'Reinhold Niebuhr'},
      {ref:'St. Teresa of Avila',text:'Let nothing disturb you, let nothing frighten you. All things pass away; God never changes. Patience obtains all things.',tags:['Peace','Patience'],speaker:'St. Teresa of Avila'},
      {ref:'St. Augustine',text:'You have made us for yourself, O Lord, and our hearts are restless until they rest in you.',tags:['Faith','Peace'],speaker:'St. Augustine'},
      {ref:'St. Ignatius of Loyola',text:'Teach us to give and not to count the cost, to fight and not to heed the wounds, to toil and not to seek for rest, to labor and not to ask for any reward.',tags:['Service','Faith'],speaker:'St. Ignatius of Loyola'},
      {ref:'St. Thomas Aquinas',text:'To one who has faith, no explanation is necessary. To one without faith, no explanation is possible.',tags:['Faith','Wisdom'],speaker:'St. Thomas Aquinas'},
      {ref:'The Magnificat',text:'My soul magnifies the Lord, and my spirit rejoices in God my Savior, for he has looked on the humble estate of his servant.',tags:['Gratitude','Faith'],speaker:'Mary, Mother of Jesus'},
    ]
  },
  'christian-classics':{
    id:'christian-classics',
    name:'Christian Classic Quotes',
    description:'Historic Christian thinkers',
    icon:'ðŸ“š',
    quotes:[
      {ref:'C.S. Lewis',text:'I believe in Christianity as I believe that the sun has risen: not only because I see it, but because by it I see everything else.',tags:['Faith','Wisdom'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, Mere Christianity',text:'Humility is not thinking less of yourself, it\'s thinking of yourself less.',tags:['Humility','Wisdom'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, The Screwtape Letters',text:'The safest road to Hell is the gradual oneâ€”the gentle slope, soft underfoot, without sudden turnings, without milestones, without signposts.',tags:['Wisdom','Repentance'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, The Problem of Pain',text:'God whispers to us in our pleasures, speaks in our conscience, but shouts in our pains.',tags:['Trials','Faith'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, Mere Christianity',text:'To be a Christian means to forgive the inexcusable, because God has forgiven the inexcusable in you.',tags:['Forgiveness','Grace'],speaker:'C.S. Lewis'},
      {ref:'Dietrich Bonhoeffer',text:'Cheap grace is grace without discipleship. Costly grace is the gospel which must be sought again and again.',tags:['Faith','Wisdom'],speaker:'Dietrich Bonhoeffer'},
      {ref:'Dietrich Bonhoeffer, The Cost of Discipleship',text:'When Christ calls a man, he bids him come and die.',tags:['Discipleship','Faith'],speaker:'Dietrich Bonhoeffer'},
      {ref:'Martin Luther King Jr.',text:'Darkness cannot drive out darkness; only light can do that. Hate cannot drive out hate; only love can do that.',tags:['Love','Peace'],speaker:'Martin Luther King Jr.'},
      {ref:'Martin Luther King Jr.',text:'Faith is taking the first step even when you don\'t see the whole staircase.',tags:['Faith','Hope'],speaker:'Martin Luther King Jr.'},
      {ref:'Mother Teresa',text:'If you judge people, you have no time to love them.',tags:['Love','Charity'],speaker:'Mother Teresa'},
      {ref:'Mother Teresa',text:'Not all of us can do great things. But we can do small things with great love.',tags:['Love','Service'],speaker:'Mother Teresa'},
      {ref:'Mother Teresa',text:'I have found the paradox, that if you love until it hurts, there can be no more hurt, only more love.',tags:['Love','Service'],speaker:'Mother Teresa'},
      {ref:'Billy Graham',text:'God has given us two hands, one to receive with and the other to give with.',tags:['Service','Charity'],speaker:'Billy Graham'},
      {ref:'Billy Graham',text:'Courage is contagious. When a brave man takes a stand, the spines of others are often stiffened.',tags:['Courage','Faith'],speaker:'Billy Graham'},
      {ref:'Oswald Chambers',text:'Faith is deliberate confidence in the character of God whose ways you may not understand at the time.',tags:['Faith','Patience'],speaker:'Oswald Chambers'},
      {ref:'A.W. Tozer',text:'What comes into our minds when we think about God is the most important thing about us.',tags:['Faith','Wisdom'],speaker:'A.W. Tozer'},
      {ref:'A.W. Tozer, The Pursuit of God',text:'God is looking for people through whom He can do the impossible. What a pity we plan only the things we can do by ourselves.',tags:['Faith','Service'],speaker:'A.W. Tozer'},
      {ref:'Charles Spurgeon',text:'A Bible that\'s falling apart usually belongs to someone who isn\'t.',tags:['Faith','Wisdom'],speaker:'Charles Spurgeon'},
      {ref:'Charles Spurgeon',text:'By perseverance the snail reached the ark.',tags:['Patience','Perseverance'],speaker:'Charles Spurgeon'},
      {ref:'St. Augustine',text:'Thou hast made us for thyself, O Lord, and our heart is restless until it finds its rest in thee.',tags:['Faith','Peace'],speaker:'St. Augustine'},
      {ref:'St. Augustine',text:'Faith is to believe what you do not see; the reward of this faith is to see what you believe.',tags:['Faith','Hope'],speaker:'St. Augustine'},
      {ref:'St. Francis of Assisi',text:'Start by doing what is necessary; then do what is possible; and suddenly you are doing the impossible.',tags:['Faith','Service'],speaker:'St. Francis of Assisi'},
      {ref:'St. Francis of Assisi',text:'Lord, make me an instrument of your peace. Where there is hatred, let me sow love.',tags:['Peace','Love'],speaker:'St. Francis of Assisi'},
      {ref:'G.K. Chesterton',text:'The Christian ideal has not been tried and found wanting. It has been found difficult; and left untried.',tags:['Faith','Wisdom'],speaker:'G.K. Chesterton'},
      {ref:'G.K. Chesterton',text:'Joy is the gigantic secret of the Christian.',tags:['Joy','Faith'],speaker:'G.K. Chesterton'},
      {ref:'Corrie ten Boom',text:'Never be afraid to trust an unknown future to a known God.',tags:['Faith','Trust'],speaker:'Corrie ten Boom'},
      {ref:'Corrie ten Boom',text:'Forgiveness is the key that unlocks the door of resentment and the handcuffs of hatred.',tags:['Forgiveness','Peace'],speaker:'Corrie ten Boom'},
      {ref:'John Wesley',text:'Do all the good you can, by all the means you can, in all the ways you can, in all the places you can, to all the people you can, as long as ever you can.',tags:['Service','Charity'],speaker:'John Wesley'},
      {ref:'Martin Luther',text:'Even if I knew that tomorrow the world would go to pieces, I would still plant my apple tree.',tags:['Hope','Faith'],speaker:'Martin Luther'},
      {ref:'Martin Luther',text:'The Bible is alive, it speaks to me; it has feet, it runs after me; it has hands, it lays hold of me.',tags:['Faith','Wisdom'],speaker:'Martin Luther'},
      {ref:'Hudson Taylor',text:'God\'s work done in God\'s way will never lack God\'s supplies.',tags:['Faith','Service'],speaker:'Hudson Taylor'},
      {ref:'D.L. Moody',text:'Faith makes all things possible. Love makes all things easy.',tags:['Faith','Love'],speaker:'D.L. Moody'},
      {ref:'George MÃ¼ller',text:'The beginning of anxiety is the end of faith, and the beginning of true faith is the end of anxiety.',tags:['Faith','Peace'],speaker:'George MÃ¼ller'},
      {ref:'Amy Carmichael',text:'You can give without loving, but you cannot love without giving.',tags:['Love','Service'],speaker:'Amy Carmichael'},
      {ref:'Elisabeth Elliot',text:'God never withholds from His child that which His love and wisdom call good.',tags:['Faith','Trust'],speaker:'Elisabeth Elliot'},
      {ref:'Elisabeth Elliot',text:'The secret is Christ in me, not me in a different set of circumstances.',tags:['Faith','Peace'],speaker:'Elisabeth Elliot'},
      {ref:'C.S. Lewis, The Weight of Glory',text:'We are half-hearted creatures, fooling about with drink and sex and ambition when infinite joy is offered us, like an ignorant child who wants to go on making mud pies in a slum because he cannot imagine what is meant by the offer of a holiday at the sea.',tags:['Joy','Faith'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, The Four Loves',text:'To love at all is to be vulnerable.',tags:['Love','Courage'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, A Grief Observed',text:'God has not been trying an experiment on my faith or love in order to find out their quality. He knew it already. It was I who didn\'t.',tags:['Trials','Faith'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, The Problem of Pain',text:'We want not so much a Father in Heaven as a grandfather in heavenâ€”a senile benevolence who, as they say, "liked to see young people enjoying themselves," and whose plan for the universe was simply that it might be truly said at the end of each day, "a good time was had by all."',tags:['Wisdom','Faith'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, Mere Christianity',text:'If I find in myself desires which nothing in this world can satisfy, the only logical explanation is that I was made for another world.',tags:['Hope','Faith'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, Mere Christianity',text:'A proud man is always looking down on things and people; and, of course, as long as you are looking down, you cannot see something that is above you.',tags:['Humility','Wisdom'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, The Great Divorce',text:'There are only two kinds of people in the end: those who say to God, "Thy will be done," and those to whom God says, in the end, "Thy will be done."',tags:['Faith','Wisdom'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, Mere Christianity',text:'Christianity, if false, is of no importance, and if true, of infinite importance. The only thing it cannot be is moderately important.',tags:['Faith','Wisdom'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, The Abolition of Man',text:'We make men without chests and expect from them virtue and enterprise. We laugh at honor and are shocked to find traitors in our midst.',tags:['Virtue','Wisdom'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, The Weight of Glory',text:'It is a serious thing to live in a society of possible gods and goddesses, to remember that the dullest most uninteresting person you talk to may one day be a creature which, if you saw it now, you would be strongly tempted to worship.',tags:['Love','Wisdom'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, Letters to Malcolm',text:'I pray because I can\'t help myself. I pray because I\'m helpless. I pray because the need flows out of me all the time, waking and sleeping. It doesn\'t change God. It changes me.',tags:['Prayer','Faith'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, The Lion, the Witch and the Wardrobe',text:'Safe? Who said anything about safe? Course he isn\'t safe. But he\'s good. He\'s the King, I tell you.',tags:['Faith','Jesus Christ'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, Till We Have Faces',text:'I know now, Lord, why you utter no answer. You are yourself the answer. Before your face questions die away.',tags:['Faith','Prayer'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, The Screwtape Letters',text:'Indeed the safest road to Hell is the gradual oneâ€”the gentle slope, soft underfoot, without sudden turnings, without milestones, without signposts.',tags:['Repentance','Wisdom'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, Surprised by Joy',text:'I believe in Christianity as I believe that the Sun has risen, not only because I see it, but because by it I see everything else.',tags:['Faith','Wisdom'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, God in the Dock',text:'I didn\'t go to religion to make me happy. I always knew a bottle of Port would do that. If you want a religion to make you feel really comfortable, I certainly don\'t recommend Christianity.',tags:['Faith','Wisdom'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, The Problem of Pain',text:'Pain insists upon being attended to. God whispers to us in our pleasures, speaks in our consciences, but shouts in our pains. It is his megaphone to rouse a deaf world.',tags:['Trials','Faith'],speaker:'C.S. Lewis'},
      {ref:'C.S. Lewis, Mere Christianity',text:'Love is not affectionate feeling, but a steady wish for the loved person\'s ultimate good as far as it can be obtained.',tags:['Love','Wisdom'],speaker:'C.S. Lewis'},
      {ref:'Charles Spurgeon',text:'God is too good to be unkind and He is too wise to be mistaken. And when we cannot trace His hand, we must trust His heart.',tags:['Trust','Faith'],speaker:'Charles Spurgeon'},
      {ref:'Charles Spurgeon',text:'Anxiety does not empty tomorrow of its sorrows, but only empties today of its strength.',tags:['Peace','Faith'],speaker:'Charles Spurgeon'},
      {ref:'Charles Spurgeon',text:'If sinners be damned, at least let them leap to Hell over our dead bodies. And if they perish, let them perish with our arms wrapped about their knees.',tags:['Service','Charity'],speaker:'Charles Spurgeon'},
      {ref:'St. Augustine, Confessions',text:'Late have I loved you, O Beauty ever ancient, ever new, late have I loved you!',tags:['Love','Faith'],speaker:'St. Augustine'},
      {ref:'St. Augustine',text:'God loves each of us as if there were only one of us.',tags:['Love','Faith'],speaker:'St. Augustine'},
      {ref:'St. Augustine',text:'In my deepest wound I saw your glory, and it dazzled me.',tags:['Trials','Grace'],speaker:'St. Augustine'},
      {ref:'SÃ¸ren Kierkegaard',text:'Life can only be understood backwards; but it must be lived forwards.',tags:['Wisdom','Faith'],speaker:'SÃ¸ren Kierkegaard'},
      {ref:'SÃ¸ren Kierkegaard',text:'Prayer does not change God, but it changes him who prays.',tags:['Prayer','Faith'],speaker:'SÃ¸ren Kierkegaard'},
      {ref:'Brother Lawrence',text:'The time of business does not with me differ from the time of prayer; and in the noise and clatter of my kitchen, I possess God in as great tranquility as if I were upon my knees.',tags:['Prayer','Peace'],speaker:'Brother Lawrence'},
      {ref:'Thomas Ã  Kempis',text:'Be not angry that you cannot make others as you wish them to be, since you cannot make yourself as you wish to be.',tags:['Humility','Patience'],speaker:'Thomas Ã  Kempis'},
      {ref:'Thomas Ã  Kempis, The Imitation of Christ',text:'Without the Way, there is no going; without the Truth, there is no knowing; without the Life, there is no living.',tags:['Jesus Christ','Faith'],speaker:'Thomas Ã  Kempis'},
      {ref:'Blaise Pascal',text:'There is a God-shaped vacuum in the heart of each man which cannot be satisfied by any created thing but only by God the Creator.',tags:['Faith','Peace'],speaker:'Blaise Pascal'},
      {ref:'Blaise Pascal, PensÃ©es',text:'The heart has its reasons which reason knows nothing of.',tags:['Faith','Love'],speaker:'Blaise Pascal'},
      {ref:'Jonathan Edwards',text:'Resolution One: I will live for God. Resolution Two: If no one else does, I still will.',tags:['Faith','Courage'],speaker:'Jonathan Edwards'},
      {ref:'John Newton',text:'I am not what I ought to be, I am not what I want to be, I am not what I hope to be in another world; but still I am not what I once used to be, and by the grace of God I am what I am.',tags:['Grace','Faith'],speaker:'John Newton'},
      {ref:'John Bunyan, The Pilgrim\'s Progress',text:'He that is down needs fear no fall; he that is low no pride; he that is humble ever shall have God to be his guide.',tags:['Humility','Faith'],speaker:'John Bunyan'},
      {ref:'George Whitefield',text:'Take care of your life and the Lord will take care of your death.',tags:['Faith','Trust'],speaker:'George Whitefield'},
      {ref:'Andrew Murray',text:'The one who prays more in private will make more progress than the one who converses much with men.',tags:['Prayer','Faith'],speaker:'Andrew Murray'},
      {ref:'Andrew Murray',text:'Humility is the only soil in which grace roots; the lack of humility is the sufficient explanation of every defect and failure.',tags:['Humility','Grace'],speaker:'Andrew Murray'},
      {ref:'E.M. Bounds',text:'Prayer is not learned in a classroom but in the closet.',tags:['Prayer','Faith'],speaker:'E.M. Bounds'},
      {ref:'Watchman Nee',text:'Our old history ends with the Cross; our new history begins with the resurrection.',tags:['Jesus Christ','Faith'],speaker:'Watchman Nee'},
      {ref:'Jim Elliot',text:'He is no fool who gives what he cannot keep to gain that which he cannot lose.',tags:['Faith','Service'],speaker:'Jim Elliot'},
      {ref:'Francis Chan',text:'Our greatest fear should not be of failure but of succeeding at things in life that don\'t really matter.',tags:['Wisdom','Faith'],speaker:'Francis Chan'},
      {ref:'Timothy Keller',text:'The gospel is this: We are more sinful and flawed in ourselves than we ever dared believe, yet at the very same time we are more loved and accepted in Jesus Christ than we ever dared hope.',tags:['Grace','Jesus Christ'],speaker:'Timothy Keller'},
      {ref:'Max Lucado',text:'God loves you just the way you are, but He refuses to leave you that way. He wants you to be just like Jesus.',tags:['Love','Jesus Christ'],speaker:'Max Lucado'},
      {ref:'Brennan Manning',text:'To be alive is to be broken. And to be broken is to stand in need of grace.',tags:['Grace','Humility'],speaker:'Brennan Manning'},
      {ref:'Henri Nouwen',text:'The friend who can be silent with us in a moment of despair or confusion, who can stay with us in an hour of grief and bereavement... that is a friend who cares.',tags:['Love','Friendship'],speaker:'Henri Nouwen'},
      {ref:'Dallas Willard',text:'Grace is not opposed to effort, it is opposed to earning. Earning is an attitude. Effort is an action.',tags:['Grace','Faith'],speaker:'Dallas Willard'},
      {ref:'A.B. Simpson',text:'Christ is not valued at all unless He is valued above all.',tags:['Jesus Christ','Faith'],speaker:'A.B. Simpson'},
      {ref:'Richard Foster',text:'Superficiality is the curse of our age. The doctrine of instant satisfaction is a primary spiritual problem.',tags:['Wisdom','Patience'],speaker:'Richard Foster'},
      {ref:'J.I. Packer',text:'To know God is not a matter of knowing about Him, but of being known by Him.',tags:['Faith','Wisdom'],speaker:'J.I. Packer'},
      {ref:'John Stott',text:'We must allow the Word of God to confront us, to disturb our security, to undermine our complacency and to overthrow our patterns of thought and behavior.',tags:['Faith','Wisdom'],speaker:'John Stott'},
      {ref:'R.C. Sproul',text:'Everyone who is in Christ is a saint. But not everyone in Christ is behaving like a saint.',tags:['Faith','Wisdom'],speaker:'R.C. Sproul'},
      {ref:'Joni Eareckson Tada',text:'Sometimes God allows what He hates to accomplish what He loves.',tags:['Trials','Faith'],speaker:'Joni Eareckson Tada'},
      {ref:'Fanny Crosby',text:'It seemed intended by the blessed providence of God that I should be blind all my life, and I thank him for the dispensation.',tags:['Gratitude','Faith'],speaker:'Fanny Crosby'},
      {ref:'George MacDonald',text:'To be trusted is a greater compliment than being loved.',tags:['Trust','Love'],speaker:'George MacDonald'},
      {ref:'Hannah Whitall Smith',text:'The true secret of giving advice is, after you have honestly given it, to be perfectly indifferent whether it is taken or not.',tags:['Wisdom','Humility'],speaker:'Hannah Whitall Smith'},
      {ref:'Dwight L. Moody',text:'The best way to revive a church is to build a fire in the pulpit.',tags:['Faith','Service'],speaker:'D.L. Moody'},
      {ref:'Dwight L. Moody',text:'Character is what you are in the dark.',tags:['Virtue','Wisdom'],speaker:'D.L. Moody'},
      {ref:'Smith Wigglesworth',text:'Great faith is the product of great fights. Great testimonies are the outcome of great tests.',tags:['Faith','Trials'],speaker:'Smith Wigglesworth'},
      {ref:'Leonard Ravenhill',text:'The opportunity of a lifetime must be seized during the lifetime of the opportunity.',tags:['Wisdom','Service'],speaker:'Leonard Ravenhill'},
      {ref:'Vance Havner',text:'God uses broken things. Broken soil to produce a crop, broken clouds to give rain, broken grain to give bread, broken bread to give strength.',tags:['Trials','Grace'],speaker:'Vance Havner'},
      {ref:'A.W. Pink',text:'The prayer that prevails is not the work of lips and fingertips. It is the cry of a broken heart and the travail of a stricken soul.',tags:['Prayer','Faith'],speaker:'A.W. Pink'},
    ]
  },
  'inspirational-quotes':{
    id:'inspirational-quotes',
    name:'Inspirational Quotes',
    description:'Wisdom from historical leaders and thinkers',
    icon:'ðŸ’¡',
    quotes:[
      // Abraham Lincoln
      {ref:'Abraham Lincoln',text:'In the end, it\'s not the years in your life that count. It\'s the life in your years.',tags:['Wisdom','Life'],speaker:'Abraham Lincoln'},
      {ref:'Abraham Lincoln',text:'Whatever you are, be a good one.',tags:['Character','Excellence'],speaker:'Abraham Lincoln'},
      {ref:'Abraham Lincoln',text:'The best way to predict your future is to create it.',tags:['Action','Future'],speaker:'Abraham Lincoln'},
      {ref:'Abraham Lincoln',text:'I am a slow walker, but I never walk back.',tags:['Perseverance','Progress'],speaker:'Abraham Lincoln'},
      {ref:'Abraham Lincoln',text:'Character is like a tree and reputation like a shadow. The shadow is what we think of it; the tree is the real thing.',tags:['Character','Virtue'],speaker:'Abraham Lincoln'},
      // Winston Churchill
      {ref:'Winston Churchill',text:'Success is not final, failure is not fatal: it is the courage to continue that counts.',tags:['Courage','Perseverance'],speaker:'Winston Churchill'},
      {ref:'Winston Churchill',text:'We make a living by what we get, but we make a life by what we give.',tags:['Service','Generosity'],speaker:'Winston Churchill'},
      {ref:'Winston Churchill',text:'Attitude is a little thing that makes a big difference.',tags:['Attitude','Wisdom'],speaker:'Winston Churchill'},
      {ref:'Winston Churchill',text:'If you\'re going through hell, keep going.',tags:['Perseverance','Courage'],speaker:'Winston Churchill'},
      {ref:'Winston Churchill',text:'The pessimist sees difficulty in every opportunity. The optimist sees opportunity in every difficulty.',tags:['Optimism','Perspective'],speaker:'Winston Churchill'},
      // Theodore Roosevelt
      {ref:'Theodore Roosevelt',text:'Do what you can, with what you have, where you are.',tags:['Action','Resourcefulness'],speaker:'Theodore Roosevelt'},
      {ref:'Theodore Roosevelt',text:'It is not the critic who counts; not the man who points out how the strong man stumbles. The credit belongs to the man who is actually in the arena.',tags:['Courage','Action'],speaker:'Theodore Roosevelt'},
      {ref:'Theodore Roosevelt',text:'Believe you can and you\'re halfway there.',tags:['Belief','Confidence'],speaker:'Theodore Roosevelt'},
      {ref:'Theodore Roosevelt',text:'In any moment of decision, the best thing you can do is the right thing. The worst thing you can do is nothing.',tags:['Action','Decision'],speaker:'Theodore Roosevelt'},
      // Benjamin Franklin
      {ref:'Benjamin Franklin',text:'An investment in knowledge pays the best interest.',tags:['Learning','Wisdom'],speaker:'Benjamin Franklin'},
      {ref:'Benjamin Franklin',text:'Well done is better than well said.',tags:['Action','Integrity'],speaker:'Benjamin Franklin'},
      {ref:'Benjamin Franklin',text:'By failing to prepare, you are preparing to fail.',tags:['Preparation','Wisdom'],speaker:'Benjamin Franklin'},
      {ref:'Benjamin Franklin',text:'Energy and persistence conquer all things.',tags:['Perseverance','Effort'],speaker:'Benjamin Franklin'},
      // Mahatma Gandhi
      {ref:'Mahatma Gandhi',text:'Be the change that you wish to see in the world.',tags:['Action','Change'],speaker:'Mahatma Gandhi'},
      {ref:'Mahatma Gandhi',text:'The weak can never forgive. Forgiveness is the attribute of the strong.',tags:['Forgiveness','Strength'],speaker:'Mahatma Gandhi'},
      {ref:'Mahatma Gandhi',text:'Live as if you were to die tomorrow. Learn as if you were to live forever.',tags:['Learning','Life'],speaker:'Mahatma Gandhi'},
      {ref:'Mahatma Gandhi',text:'Strength does not come from physical capacity. It comes from an indomitable will.',tags:['Strength','Willpower'],speaker:'Mahatma Gandhi'},
      {ref:'Mahatma Gandhi',text:'In a gentle way, you can shake the world.',tags:['Influence','Peace'],speaker:'Mahatma Gandhi'},
      // Nelson Mandela
      {ref:'Nelson Mandela',text:'It always seems impossible until it\'s done.',tags:['Perseverance','Hope'],speaker:'Nelson Mandela'},
      {ref:'Nelson Mandela',text:'Education is the most powerful weapon which you can use to change the world.',tags:['Education','Change'],speaker:'Nelson Mandela'},
      {ref:'Nelson Mandela',text:'I learned that courage was not the absence of fear, but the triumph over it.',tags:['Courage','Fear'],speaker:'Nelson Mandela'},
      {ref:'Nelson Mandela',text:'Do not judge me by my successes, judge me by how many times I fell down and got back up again.',tags:['Resilience','Character'],speaker:'Nelson Mandela'},
      // Eleanor Roosevelt
      {ref:'Eleanor Roosevelt',text:'No one can make you feel inferior without your consent.',tags:['Self-worth','Dignity'],speaker:'Eleanor Roosevelt'},
      {ref:'Eleanor Roosevelt',text:'Do one thing every day that scares you.',tags:['Courage','Growth'],speaker:'Eleanor Roosevelt'},
      {ref:'Eleanor Roosevelt',text:'The future belongs to those who believe in the beauty of their dreams.',tags:['Dreams','Hope'],speaker:'Eleanor Roosevelt'},
      {ref:'Eleanor Roosevelt',text:'You gain strength, courage, and confidence by every experience in which you really stop to look fear in the face.',tags:['Courage','Growth'],speaker:'Eleanor Roosevelt'},
      // Ralph Waldo Emerson
      {ref:'Ralph Waldo Emerson',text:'What lies behind us and what lies before us are tiny matters compared to what lies within us.',tags:['Character','Inner Strength'],speaker:'Ralph Waldo Emerson'},
      {ref:'Ralph Waldo Emerson',text:'The only person you are destined to become is the person you decide to be.',tags:['Choice','Destiny'],speaker:'Ralph Waldo Emerson'},
      {ref:'Ralph Waldo Emerson',text:'To be yourself in a world that is constantly trying to make you something else is the greatest accomplishment.',tags:['Authenticity','Courage'],speaker:'Ralph Waldo Emerson'},
      {ref:'Ralph Waldo Emerson',text:'Life is a journey, not a destination.',tags:['Life','Perspective'],speaker:'Ralph Waldo Emerson'},
      // Marcus Aurelius
      {ref:'Marcus Aurelius, Meditations',text:'The happiness of your life depends upon the quality of your thoughts.',tags:['Wisdom','Mind'],speaker:'Marcus Aurelius'},
      {ref:'Marcus Aurelius, Meditations',text:'Waste no more time arguing about what a good man should be. Be one.',tags:['Action','Character'],speaker:'Marcus Aurelius'},
      {ref:'Marcus Aurelius, Meditations',text:'You have power over your mind - not outside events. Realize this, and you will find strength.',tags:['Mind','Strength'],speaker:'Marcus Aurelius'},
      {ref:'Marcus Aurelius, Meditations',text:'Very little is needed to make a happy life; it is all within yourself, in your way of thinking.',tags:['Happiness','Wisdom'],speaker:'Marcus Aurelius'},
      // Seneca
      {ref:'Seneca',text:'Luck is what happens when preparation meets opportunity.',tags:['Preparation','Opportunity'],speaker:'Seneca'},
      {ref:'Seneca',text:'It is not that we have a short time to live, but that we waste a lot of it.',tags:['Time','Life'],speaker:'Seneca'},
      {ref:'Seneca',text:'Difficulties strengthen the mind, as labor does the body.',tags:['Challenges','Growth'],speaker:'Seneca'},
      {ref:'Seneca',text:'We suffer more often in imagination than in reality.',tags:['Worry','Perspective'],speaker:'Seneca'},
      // Confucius
      {ref:'Confucius',text:'It does not matter how slowly you go as long as you do not stop.',tags:['Perseverance','Progress'],speaker:'Confucius'},
      {ref:'Confucius',text:'Our greatest glory is not in never falling, but in rising every time we fall.',tags:['Resilience','Glory'],speaker:'Confucius'},
      {ref:'Confucius',text:'The man who moves a mountain begins by carrying away small stones.',tags:['Patience','Progress'],speaker:'Confucius'},
      {ref:'Confucius',text:'Choose a job you love, and you will never have to work a day in your life.',tags:['Purpose','Work'],speaker:'Confucius'},
      // Helen Keller
      {ref:'Helen Keller',text:'The only thing worse than being blind is having sight but no vision.',tags:['Vision','Purpose'],speaker:'Helen Keller'},
      {ref:'Helen Keller',text:'Optimism is the faith that leads to achievement. Nothing can be done without hope and confidence.',tags:['Optimism','Achievement'],speaker:'Helen Keller'},
      {ref:'Helen Keller',text:'Life is either a daring adventure or nothing at all.',tags:['Courage','Adventure'],speaker:'Helen Keller'},
      {ref:'Helen Keller',text:'Alone we can do so little; together we can do so much.',tags:['Unity','Teamwork'],speaker:'Helen Keller'},
      // Albert Einstein
      {ref:'Albert Einstein',text:'Imagination is more important than knowledge. Knowledge is limited. Imagination encircles the world.',tags:['Imagination','Creativity'],speaker:'Albert Einstein'},
      {ref:'Albert Einstein',text:'In the middle of difficulty lies opportunity.',tags:['Opportunity','Challenges'],speaker:'Albert Einstein'},
      {ref:'Albert Einstein',text:'Try not to become a man of success, but rather try to become a man of value.',tags:['Character','Value'],speaker:'Albert Einstein'},
      {ref:'Albert Einstein',text:'Learn from yesterday, live for today, hope for tomorrow.',tags:['Life','Hope'],speaker:'Albert Einstein'},
      // Martin Luther King Jr. (secular quotes)
      {ref:'Martin Luther King Jr.',text:'The time is always right to do what is right.',tags:['Action','Integrity'],speaker:'Martin Luther King Jr.'},
      {ref:'Martin Luther King Jr.',text:'Our lives begin to end the day we become silent about things that matter.',tags:['Courage','Justice'],speaker:'Martin Luther King Jr.'},
      {ref:'Martin Luther King Jr.',text:'If you can\'t fly then run, if you can\'t run then walk, if you can\'t walk then crawl, but whatever you do you have to keep moving forward.',tags:['Perseverance','Progress'],speaker:'Martin Luther King Jr.'},
    ]
  }
};

// Canonical book order for scriptures
const BOOK_ORDER=[
  // Old Testament
  'Genesis','Exodus','Leviticus','Numbers','Deuteronomy','Joshua','Judges','Ruth','1 Samuel','2 Samuel','1 Kings','2 Kings','1 Chronicles','2 Chronicles','Ezra','Nehemiah','Esther','Job','Psalms','Proverbs','Ecclesiastes','Song of Solomon','Isaiah','Jeremiah','Lamentations','Ezekiel','Daniel','Hosea','Joel','Amos','Obadiah','Jonah','Micah','Nahum','Habakkuk','Zephaniah','Haggai','Zechariah','Malachi',
  // New Testament
  'Matthew','Mark','Luke','John','Acts','Romans','1 Corinthians','2 Corinthians','Galatians','Ephesians','Philippians','Colossians','1 Thessalonians','2 Thessalonians','1 Timothy','2 Timothy','Titus','Philemon','Hebrews','James','1 Peter','2 Peter','1 John','2 John','3 John','Jude','Revelation',
  // Book of Mormon
  '1 Nephi','2 Nephi','Jacob','Enos','Jarom','Omni','Words of Mormon','Mosiah','Alma','Helaman','3 Nephi','4 Nephi','Mormon','Ether','Moroni',
  // Doctrine and Covenants
  'D&C',
  // Pearl of Great Price
  'Moses','Abraham','Joseph Smithâ€”Matthew','Joseph Smithâ€”History','Articles of Faith',
  // LDS Leader Quotes
  'LDS Quotes'
];

// Scripture collections with their books
// downloadable: true means the collection requires a scripture pack to be downloaded first
const COLLECTIONS={
  // Bible (included by default in curated)
  'Old Testament':{books:['Genesis','Exodus','Leviticus','Numbers','Deuteronomy','Joshua','Judges','Ruth','1 Samuel','2 Samuel','1 Kings','2 Kings','1 Chronicles','2 Chronicles','Ezra','Nehemiah','Esther','Job','Psalms','Proverbs','Ecclesiastes','Song of Solomon','Isaiah','Jeremiah','Lamentations','Ezekiel','Daniel','Hosea','Joel','Amos','Obadiah','Jonah','Micah','Nahum','Habakkuk','Zephaniah','Haggai','Zechariah','Malachi']},
  'New Testament':{books:['Matthew','Mark','Luke','John','Acts','Romans','1 Corinthians','2 Corinthians','Galatians','Ephesians','Philippians','Colossians','1 Thessalonians','2 Thessalonians','1 Timothy','2 Timothy','Titus','Philemon','Hebrews','James','1 Peter','2 Peter','1 John','2 John','3 John','Jude','Revelation']},
  // LDS
  'Book of Mormon':{books:['1 Nephi','2 Nephi','Jacob','Enos','Jarom','Omni','Words of Mormon','Mosiah','Alma','Helaman','3 Nephi','4 Nephi','Mormon','Ether','Moroni'],downloadable:true,packId:'book-of-mormon'},
  'Doctrine and Covenants':{books:['D&C'],downloadable:true,packId:'doctrine-covenants'},
  'Pearl of Great Price':{books:['Moses','Abraham','Joseph Smithâ€”Matthew','Joseph Smithâ€”History'],downloadable:true,packId:'pearl-great-price'},
  'Articles of Faith':{books:['Articles of Faith'],isSpecial:true,downloadable:true,packId:'articles-of-faith'},
  'LDS Leader Quotes':{books:['LDS Quotes'],isSpecial:true,downloadable:true,packId:'lds-quotes'},
  // Judaism
  'Torah & Tanakh':{books:['Genesis','Exodus','Leviticus','Numbers','Deuteronomy','Joshua','Judges','Ruth','1 Samuel','2 Samuel','1 Kings','2 Kings','1 Chronicles','2 Chronicles','Ezra','Nehemiah','Esther','Job','Psalms','Proverbs','Ecclesiastes','Song of Solomon','Isaiah','Jeremiah','Lamentations','Ezekiel','Daniel','Hosea','Joel','Amos','Obadiah','Jonah','Micah','Nahum','Habakkuk','Zephaniah','Haggai','Zechariah','Malachi','Torah'],downloadable:true,packId:'torah'},
  'Jewish Wisdom':{books:['Jewish Wisdom'],isSpecial:true,downloadable:true,packId:'jewish-wisdom'},
  // Islam
  'Quran':{books:['Al-Faatiha','Al-Baqara','Aal-i-Imraan','An-Nisaa','Al-Maaida','Al-Anaam','Al-Araaf','Al-Anfaal','At-Tawba','Yunus','Hud','Yusuf','Ar-Rad','Ibrahim','Al-Hijr','An-Nahl','Al-Israa','Al-Kahf','Maryam','Taa-Haa','Al-Anbiyaa','Al-Hajj','Al-Muminoon','An-Noor','Al-Furqaan','Ash-Shuaraa','An-Naml','Al-Qasas','Al-Ankaboot','Ar-Room','Luqman','As-Sajda','Al-Ahzaab','Saba','Faatir','Yaseen','As-Saaffaat','Saad','Az-Zumar','Ghafir','Fussilat','Ash-Shura','Az-Zukhruf','Ad-Dukhaan','Al-Jaathiya','Al-Ahqaf','Muhammad','Al-Fath','Al-Hujuraat','Qaaf','Adh-Dhaariyat','At-Tur','An-Najm','Al-Qamar','Ar-Rahmaan','Al-Waaqia','Al-Hadid','Al-Mujaadila','Al-Hashr','Al-Mumtahana','As-Saff','Al-Jumua','Al-Munaafiqoon','At-Taghaabun','At-Talaaq','At-Tahrim','Al-Mulk','Al-Qalam','Al-Haaqqa','Al-Maarij','Nooh','Al-Jinn','Al-Muzzammil','Al-Muddaththir','Al-Qiyaama','Al-Insaan','Al-Mursalaat','An-Naba','An-Naaziat','Abasa','At-Takwir','Al-Infitaar','Al-Mutaffifin','Al-Inshiqaaq','Al-Burooj','At-Taariq','Al-Alaa','Al-Ghaashiya','Al-Fajr','Al-Balad','Ash-Shams','Al-Lail','Ad-Dhuhaa','Ash-Sharh','At-Tin','Al-Alaq','Al-Qadr','Al-Bayyina','Az-Zalzala','Al-Aadiyaat','Al-Qaaria','At-Takaathur','Al-Asr','Al-Humaza','Al-Fil','Quraish','Al-Maaun','Al-Kawthar','Al-Kaafiroon','An-Nasr','Al-Masad','Al-Ikhlaas','Al-Falaq','An-Naas','Quran'],downloadable:true,packId:'quran'},
  'Hadith':{books:['Hadith'],isSpecial:true,downloadable:true,packId:'hadith'},
  // Buddhism
  'Buddhist Teachings':{books:['Buddhist'],isSpecial:true,downloadable:true,packId:'buddhist-sutras'},
  // Hinduism
  'Bhagavad Gita':{books:['Gita'],isSpecial:true,downloadable:true,packId:'bhagavad-gita'},
  'Hindu Wisdom':{books:['Hindu Wisdom'],isSpecial:true,downloadable:true,packId:'hindu-wisdom'},
  // Sikhism
  'Guru Granth Sahib':{books:['Sikh'],isSpecial:true,downloadable:true,packId:'guru-granth'},
  // Christian
  'Catholic Prayers':{books:['Catholic'],isSpecial:true,downloadable:true,packId:'catholic-prayers'},
  'Christian Classic Quotes':{books:['Christian Classics'],isSpecial:true,downloadable:true,packId:'christian-classics'},
  // Inspirational
  'Inspirational Quotes':{books:['Inspirational'],isSpecial:true,downloadable:true,packId:'inspirational-quotes'}
};

// Check if a scripture pack is downloaded
function isPackDownloaded(packId){
  const downloadedPacks=JSON.parse(localStorage.getItem('downloadedPacks')||'[]');
  return downloadedPacks.includes(packId);
}

// Get verse count for a pack
function getPackVerseCount(packId){
  const pack=SCRIPTURE_PACKS[packId];
  if(!pack)return 0;
  return (pack.verses?pack.verses.length:0)+(pack.quotes?pack.quotes.length:0);
}

// Download/install a scripture pack
function downloadScripturePack(packId){
  const pack=SCRIPTURE_PACKS[packId];
  if(!pack){
    alert('Error: Pack not found');
    return false;
  }

  try{
    let downloadedPacks=JSON.parse(localStorage.getItem('downloadedPacks')||'[]');
    if(!downloadedPacks.includes(packId)){
      downloadedPacks.push(packId);
      localStorage.setItem('downloadedPacks',JSON.stringify(downloadedPacks));
    }

    // Verify the download was saved
    const verifyPacks=JSON.parse(localStorage.getItem('downloadedPacks')||'[]');
    if(!verifyPacks.includes(packId)){
      alert('Error: Download failed to save. Please try again.');
      return false;
    }

    const count=getPackVerseCount(packId);
    alert(`${pack.name} added! (${count} items)`);
    render();
    return true;
  }catch(e){
    alert('Error downloading pack: '+e.message);
    return false;
  }
}

// Remove a scripture pack
function removeScripturePack(packId){
  let downloadedPacks=JSON.parse(localStorage.getItem('downloadedPacks')||'[]');
  downloadedPacks=downloadedPacks.filter(p=>p!==packId);
  localStorage.setItem('downloadedPacks',JSON.stringify(downloadedPacks));
  render();
}

// Delete an entire collection (removes from localStorage)
function deleteCollection(collectionName){
  if(!confirm(`Delete all ${collectionName} verses from your library?\n\nThis will free up storage space. You can re-download anytime.`))return;

  const storageKey=COLLECTION_STORAGE_KEYS[collectionName];
  if(storageKey){
    localStorage.removeItem(storageKey);
    LIBRARY.downloaded=loadDownloadedCollections();
  }

  // Also remove the corresponding pack from downloadedPacks
  const packIdMap={'Old Testament':'old-testament','New Testament':'new-testament','Book of Mormon':'book-of-mormon','Doctrine and Covenants':'doctrine-covenants','Pearl of Great Price':'pearl-great-price','Torah & Tanakh':'torah','Quran':'quran'};
  const packId=packIdMap[collectionName];
  if(packId){
    let downloadedPacks=JSON.parse(localStorage.getItem('downloadedPacks')||'[]');
    downloadedPacks=downloadedPacks.filter(p=>p!==packId);
    localStorage.setItem('downloadedPacks',JSON.stringify(downloadedPacks));
  }

  render();
}

// Retry/refresh a scripture pack download
function retryScripturePack(packId){
  removeScripturePack(packId);
  setTimeout(()=>downloadScripturePack(packId),100);
}

// Complete onboarding and download selected packs
async function completeOnboarding(){
  // Get all selected packs
  const selectedPacks=Object.entries(onboardingSelections).filter(([id,selected])=>selected).map(([id])=>id);

  // Mark onboarding as complete first (so we don't show onboarding screen during downloads)
  localStorage.setItem('onboardingComplete','true');
  onboardingSelections={};

  // Find which packs need full collection downloads
  const collectionsToDownload=selectedPacks
    .filter(packId=>PACK_TO_COLLECTION[packId])
    .map(packId=>PACK_TO_COLLECTION[packId]);

  // Download full collections if any
  if(collectionsToDownload.length>0){
    for(const collectionName of collectionsToDownload){
      // Check if already downloaded
      const storageKey=COLLECTION_STORAGE_KEYS[collectionName];
      if(!localStorage.getItem(storageKey)){
        // Show download progress
        downloadProgress={current:0,total:1,status:'downloading',currentBook:collectionName};
        render();

        try{
          const url=COLLECTION_URLS[collectionName];
          const response=await fetch(url);
          if(!response.ok)throw new Error(`Failed to download ${collectionName}`);

          const data=await response.json();
          const verses=[];

          // Process the JSON structure
          if(data.books){
            data.books.forEach(book=>{
              if(book.chapters){
                book.chapters.forEach(chapter=>{
                  if(chapter.verses){
                    chapter.verses.forEach(verse=>{
                      verses.push({b:book.book||collectionName,c:chapter.chapter,v:verse.verse,t:verse.text});
                    });
                  }
                });
              }
            });
          }

          downloadProgress.status='processing';
          render();

          // Store the collection
          localStorage.setItem(storageKey,JSON.stringify(verses));
          LIBRARY.downloaded=loadDownloadedCollections();

        }catch(error){
          console.error('Download failed:',error);
          // Continue with other downloads even if one fails
        }
      }
    }
    downloadProgress=null;
  }

  // Also mark smaller packs as downloaded (Articles of Faith, quotes, etc.)
  let downloadedPacks=JSON.parse(localStorage.getItem('downloadedPacks')||'[]');
  for(const packId of selectedPacks){
    if(!downloadedPacks.includes(packId)){
      downloadedPacks.push(packId);
    }
  }
  localStorage.setItem('downloadedPacks',JSON.stringify(downloadedPacks));

  // Add starter verses from SCRIPTURE_PACKS (curated verses)
  const STARTER_VERSES_PER_PACK=12;
  for(const packId of selectedPacks){
    const pack=SCRIPTURE_PACKS[packId];
    if(pack){
      const packVerses=pack.verses||[];
      const packQuotes=pack.quotes||[];
      const allItems=[...packVerses,...packQuotes];
      const starterItems=allItems.slice(0,STARTER_VERSES_PER_PACK);

      for(const item of starterItems){
        const exists=S.verses.some(v=>v.ref===item.ref);
        if(!exists){
          S.verses.push({
            id:S.nextId++,
            type:item.speaker?'quote':'scripture',
            ref:item.ref,
            text:item.text,
            tags:item.tags||[],
            mastery:0,
            modeUsage:{predict:0,blanks:0,match:0,jumble:0,first:0,recall:0,hangman:0},
            lastPracticed:null,
            status:'saved' // Start in "stored" so tutorial can teach moving to active
          });
        }
      }
    }
  }

  save();
  showTutorial();
}

// Skip onboarding
function skipOnboarding(){
  localStorage.setItem('onboardingComplete','true');
  onboardingSelections={};
  render();
}

// Get all library verses including downloaded packs and full library downloads
function getAllLibraryVerses(){
  let verses=[...LIBRARY.curated];

  // Include full library downloads (Old Testament, New Testament, Book of Mormon, etc.)
  if(LIBRARY.downloaded&&LIBRARY.downloaded.length>0){
    verses=[...verses,...LIBRARY.downloaded];
  }

  const downloadedPacks=JSON.parse(localStorage.getItem('downloadedPacks')||'[]');

  // Track which collections have full downloads to avoid duplicates
  const collectionsWithFullDownload=new Set();
  for(const [collName,storageKey] of Object.entries(COLLECTION_STORAGE_KEYS)){
    if(localStorage.getItem(storageKey)){
      collectionsWithFullDownload.add(collName);
    }
  }

  // Track which book names are already in the library from full downloads
  const booksInLibrary=new Set(verses.map(v=>v.book||v.b));

  for(const packId of downloadedPacks){
    const pack=SCRIPTURE_PACKS[packId];
    if(pack){
      // Skip pack verses if we already have verses from those books (from full library download)
      // This prevents duplicates when e.g. Pearl of Great Price download includes Articles of Faith
      if(pack.verses){
        const packBooks=[...new Set(pack.verses.map(v=>v.book))];
        const alreadyHaveBooks=packBooks.some(b=>booksInLibrary.has(b));
        if(!alreadyHaveBooks){
          verses=[...verses,...pack.verses];
          packBooks.forEach(b=>booksInLibrary.add(b));
        }
      }
      if(pack.quotes){
        // Convert quotes to verse format for display
        // Map packId to the correct book name for each collection
        const packToBook={
          'lds-quotes':'LDS Quotes',
          'jewish-wisdom':'Jewish Wisdom',
          'hadith':'Hadith',
          'buddhist-sutras':'Buddhist',
          'hindu-wisdom':'Hindu Wisdom',
          'guru-granth':'Sikh',
          'catholic-prayers':'Catholic',
          'christian-classics':'Christian Classics',
          'inspirational-quotes':'Inspirational'
        };
        const bookName=packToBook[packId]||'Quotes';
        for(const q of pack.quotes){
          verses.push({
            book:bookName,
            chapter:1,
            verse:1,
            ref:q.ref,
            text:q.text,
            tags:q.tags,
            speaker:q.speaker
          });
        }
      }
    }
  }
  return verses;
}

function getBookOrder(bookName){
  const index=BOOK_ORDER.indexOf(bookName);
  return index===-1?999:index; // Unknown books go to end
}

function getBookCollection(bookName){
  // First, try to find a downloaded collection that contains this book
  // This handles cases where books overlap (e.g., Genesis is in both Old Testament and Torah & Tanakh)
  const downloadedPacks=JSON.parse(localStorage.getItem('downloadedPacks')||'[]');

  for(const [collectionName,collectionData] of Object.entries(COLLECTIONS)){
    if(collectionData.books&&collectionData.books.includes(bookName)){
      // Check if this collection has a full library download
      const storageKey=COLLECTION_STORAGE_KEYS[collectionName];
      if(storageKey&&localStorage.getItem(storageKey)){
        return collectionName;
      }
      // Check if this collection's pack is downloaded
      if(collectionData.packId&&downloadedPacks.includes(collectionData.packId)){
        return collectionName;
      }
    }
  }
  // Fallback: return first matching collection
  for(const [collectionName,collectionData] of Object.entries(COLLECTIONS)){
    if(collectionData.books&&collectionData.books.includes(bookName))return collectionName;
  }
  return null;
}

// Extract book name from verse reference (e.g., "John 3:16" -> "John", "1 Corinthians 13:4" -> "1 Corinthians")
function getBookFromRef(ref){
  if(!ref)return null;
  // Match everything before the last number:number pattern
  const match=ref.match(/^(.+?)\s+\d+:\d+/);
  return match?match[1].trim():null;
}

// Count practiced verses per collection
function getPracticedCountsByCollection(){
  const counts={};
  S.verses.forEach(v=>{
    const bookName=getBookFromRef(v.ref);
    if(bookName){
      const coll=getBookCollection(bookName);
      if(coll){
        if(!counts[coll])counts[coll]=0;
        counts[coll]++;
      }
    }
  });
  return counts;
}

function getBuddyEmoji(){
  const stage=S.buddyStage||'egg';
  if(stage==='egg'){
    return'ðŸ¥š';  // Always show egg, never hatching chick
  }

  // Use category-based creatures
  const category=CREATURE_CATEGORIES[S.creatureCategory];
  if(!category)return'ðŸ¥š'; // Fallback if no category

  const variant=S.creatureVariant||0;

  if(stage==='blob'){
    // For blob stage, return simple emoji representation (full blob rendered via renderBlob())
    return category.blobEmoji==='blob'?'ðŸ«§':category.blobEmoji;
  }else if(stage==='child'){
    // For baby stage, return simple emoji representation (full baby rendered via renderBaby())
    return category.babyEmoji==='baby'?'ðŸ‘¶':category.babyEmoji;
  }else if(stage==='teen'){
    return category.teenVariants[variant]||category.teenVariants[0];
  }else if(stage==='adult'){
    return category.adultVariants[variant]||category.adultVariants[0];
  }

  return'ðŸ¥š'; // Fallback
}

function getStageName(){
  const stage=S.buddyStage||'egg';

  if(stage==='egg')return'Egg';
  if(stage==='blob')return'Blob';

  // For child, teen, adult - show category name (capitalized)
  if(S.creatureCategory){
    // Capitalize first letter of category (e.g., "birds" -> "Birds")
    return S.creatureCategory.charAt(0).toUpperCase()+S.creatureCategory.slice(1);
  }

  // Fallback to old system
  return STAGES[stage]?.name||'Unknown';
}

function renderAccessories(){
  const stage=S.buddyStage||'egg';
  const stagePositions=S.accessoryPositions[stage]||{};

  let accessories='';

  // Helper to get position style
  const getPositionStyle=(type)=>{
    const customPos=stagePositions[type];
    const defaultPos=DEFAULT_POSITIONS[type];
    const pos=customPos||defaultPos;

    // During drag, show live preview
    if(dragState&&dragState.type===type&&dragState.currentX!==undefined){
      const container=document.querySelector('.buddy-with-accessories');
      if(container){
        const rect=container.getBoundingClientRect();
        // Subtract the offset to maintain grab point
        const adjustedX=dragState.currentX-dragState.offsetX;
        const adjustedY=dragState.currentY-dragState.offsetY;
        const x=((adjustedX-rect.left)/rect.width)*100;
        const y=((adjustedY-rect.top)/rect.height)*100;
        return `left:${x}%;top:${y}%;transform:translateX(-50%);`;
      }
    }

    return `left:${pos.x}%;top:${pos.y}%;transform:translateX(-50%);`;
  };

  // Helper to add drag handlers if in customize mode
  const dragHandlers=(type)=>customizeMode?
    `ontouchstart="startDrag('${type}',event)" onmousedown="startDrag('${type}',event)" style="cursor:move;${getPositionStyle(type)}"`:
    `style="${getPositionStyle(type)}"`;

  // Render effects first (background layer)
  if(S.equipped.effect!==null){
    const acc=ACCESSORIES[S.equipped.effect];
    if(acc)accessories+=`<div class="accessory-effect" ${dragHandlers('effect')}>${acc.emoji}</div>`;
  }
  // Render back items (cape, wings)
  if(S.equipped.back!==null){
    const acc=ACCESSORIES[S.equipped.back];
    if(acc)accessories+=`<div class="accessory-back" ${dragHandlers('back')}>${acc.emoji}</div>`;
  }
  // Render hat
  if(S.equipped.hat!==null){
    const acc=ACCESSORIES[S.equipped.hat];
    if(acc)accessories+=`<div class="accessory-hat" ${dragHandlers('hat')}>${acc.emoji}</div>`;
  }
  // Render eyes
  if(S.equipped.eyes!==null){
    const acc=ACCESSORIES[S.equipped.eyes];
    if(acc)accessories+=`<div class="accessory-eyes" ${dragHandlers('eyes')}>${acc.emoji}</div>`;
  }
  // Render held items
  if(S.equipped.held!==null){
    const acc=ACCESSORIES[S.equipped.held];
    if(acc)accessories+=`<div class="accessory-held" ${dragHandlers('held')}>${acc.emoji}</div>`;
  }

  return accessories;
}

// Custom CSS furniture designs (scale well at any size)

// ðŸ›ï¸ Cozy Bed
function renderCSSBed(size=340){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s*0.6}px;">
  <!-- Bed frame -->
  <div style="position:absolute;bottom:5%;left:5%;width:90%;height:25%;background:linear-gradient(to bottom,#a16207,#78350f);border-radius:${s*0.02}px;box-shadow:0 ${s*0.015}px ${s*0.03}px rgba(0,0,0,0.3);"></div>
  <!-- Headboard -->
  <div style="position:absolute;top:0;left:5%;width:20%;height:75%;background:linear-gradient(to right,#92400e,#a16207,#78350f);border-radius:${s*0.03}px ${s*0.03}px ${s*0.02}px ${s*0.02}px;box-shadow:inset ${s*0.01}px 0 ${s*0.02}px rgba(255,255,255,0.2);"></div>
  <!-- Mattress -->
  <div style="position:absolute;bottom:20%;left:10%;width:82%;height:35%;background:linear-gradient(to bottom,#fefce8,#fef9c3,#fef08a);border-radius:${s*0.025}px;box-shadow:inset ${s*0.01}px ${s*0.01}px ${s*0.03}px rgba(255,255,255,0.8),0 ${s*0.01}px ${s*0.02}px rgba(0,0,0,0.1);"></div>
  <!-- Blanket -->
  <div style="position:absolute;bottom:22%;left:35%;width:55%;height:30%;background:linear-gradient(135deg,#c4b5fd,#a78bfa,#8b5cf6);border-radius:${s*0.02}px;box-shadow:inset ${s*0.01}px ${s*0.01}px ${s*0.025}px rgba(255,255,255,0.4);"></div>
  <!-- Pillow -->
  <div style="position:absolute;bottom:35%;left:15%;width:22%;height:20%;background:linear-gradient(to bottom,#ffffff,#f5f5f4,#e7e5e4);border-radius:${s*0.04}px;box-shadow:inset ${s*0.008}px ${s*0.008}px ${s*0.02}px rgba(255,255,255,0.9),0 ${s*0.005}px ${s*0.01}px rgba(0,0,0,0.1);"></div>
  <!-- Bed legs -->
  <div style="position:absolute;bottom:0;left:8%;width:6%;height:8%;background:linear-gradient(to right,#451a03,#78350f,#451a03);border-radius:${s*0.01}px;"></div>
  <div style="position:absolute;bottom:0;right:8%;width:6%;height:8%;background:linear-gradient(to right,#451a03,#78350f,#451a03);border-radius:${s*0.01}px;"></div>
</div>`;
}

// ðŸ“š Bookshelf
function renderCSSBookshelf(size=280){
  const s=size;
  return`
<div style="position:relative;width:${s*0.7}px;height:${s}px;">
  <!-- Main frame -->
  <div style="position:absolute;inset:0;background:linear-gradient(to right,#a16207,#ca8a04,#a16207);border-radius:${s*0.02}px;box-shadow:inset ${s*0.01}px ${s*0.01}px ${s*0.03}px rgba(255,255,255,0.2),inset -${s*0.01}px -${s*0.01}px ${s*0.02}px rgba(0,0,0,0.2);"></div>
  <!-- Shelves -->
  <div style="position:absolute;top:22%;left:5%;width:90%;height:4%;background:linear-gradient(to bottom,#78350f,#451a03);border-radius:${s*0.005}px;"></div>
  <div style="position:absolute;top:48%;left:5%;width:90%;height:4%;background:linear-gradient(to bottom,#78350f,#451a03);border-radius:${s*0.005}px;"></div>
  <div style="position:absolute;top:74%;left:5%;width:90%;height:4%;background:linear-gradient(to bottom,#78350f,#451a03);border-radius:${s*0.005}px;"></div>
  <!-- Books row 1 -->
  <div style="position:absolute;top:5%;left:10%;width:12%;height:16%;background:linear-gradient(to right,#dc2626,#b91c1c);border-radius:${s*0.005}px;"></div>
  <div style="position:absolute;top:3%;left:24%;width:10%;height:18%;background:linear-gradient(to right,#2563eb,#1d4ed8);border-radius:${s*0.005}px;"></div>
  <div style="position:absolute;top:6%;left:36%;width:14%;height:15%;background:linear-gradient(to right,#16a34a,#15803d);border-radius:${s*0.005}px;"></div>
  <div style="position:absolute;top:4%;left:52%;width:11%;height:17%;background:linear-gradient(to right,#9333ea,#7c3aed);border-radius:${s*0.005}px;"></div>
  <div style="position:absolute;top:7%;left:65%;width:13%;height:14%;background:linear-gradient(to right,#ea580c,#c2410c);border-radius:${s*0.005}px;"></div>
  <!-- Books row 2 -->
  <div style="position:absolute;top:28%;left:12%;width:15%;height:18%;background:linear-gradient(to right,#0891b2,#0e7490);border-radius:${s*0.005}px;"></div>
  <div style="position:absolute;top:30%;left:30%;width:10%;height:16%;background:linear-gradient(to right,#be185d,#9d174d);border-radius:${s*0.005}px;"></div>
  <div style="position:absolute;top:27%;left:43%;width:18%;height:19%;background:linear-gradient(to right,#854d0e,#713f12);border-radius:${s*0.005}px;"></div>
  <div style="position:absolute;top:31%;left:64%;width:12%;height:15%;background:linear-gradient(to right,#4f46e5,#4338ca);border-radius:${s*0.005}px;"></div>
  <!-- Books row 3 -->
  <div style="position:absolute;top:54%;left:8%;width:13%;height:18%;background:linear-gradient(to right,#f59e0b,#d97706);border-radius:${s*0.005}px;"></div>
  <div style="position:absolute;top:56%;left:24%;width:16%;height:16%;background:linear-gradient(to right,#64748b,#475569);border-radius:${s*0.005}px;"></div>
  <div style="position:absolute;top:53%;left:44%;width:11%;height:19%;background:linear-gradient(to right,#059669,#047857);border-radius:${s*0.005}px;"></div>
  <div style="position:absolute;top:57%;left:58%;width:20%;height:15%;background:linear-gradient(to right,#dc2626,#991b1b);border-radius:${s*0.005}px;"></div>
  <!-- Decorative plant on top -->
  <div style="position:absolute;top:80%;left:35%;width:20%;height:15%;background:linear-gradient(to top,#78350f,#92400e);border-radius:${s*0.015}px ${s*0.015}px ${s*0.03}px ${s*0.03}px;"></div>
  <div style="position:absolute;top:70%;left:38%;width:14%;height:12%;background:radial-gradient(ellipse at bottom,#22c55e,#16a34a);border-radius:50%;"></div>
</div>`;
}

// ðŸŽª Play Tent
function renderCSSPlayTent(size=360){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s*0.85}px;">
  <!-- Tent body left -->
  <div style="position:absolute;bottom:0;left:5%;width:45%;height:85%;background:linear-gradient(135deg,#fca5a5,#f87171,#ef4444);clip-path:polygon(100% 0%,0% 100%,100% 100%);border-radius:0 0 0 ${s*0.02}px;"></div>
  <!-- Tent body right -->
  <div style="position:absolute;bottom:0;right:5%;width:45%;height:85%;background:linear-gradient(225deg,#fca5a5,#f87171,#ef4444);clip-path:polygon(0% 0%,100% 100%,0% 100%);border-radius:0 0 ${s*0.02}px 0;"></div>
  <!-- Tent front flap left -->
  <div style="position:absolute;bottom:0;left:25%;width:25%;height:70%;background:linear-gradient(135deg,#fecaca,#fca5a5);clip-path:polygon(100% 0%,30% 100%,100% 100%);"></div>
  <!-- Tent front flap right -->
  <div style="position:absolute;bottom:0;right:25%;width:25%;height:70%;background:linear-gradient(225deg,#fecaca,#fca5a5);clip-path:polygon(0% 0%,0% 100%,70% 100%);"></div>
  <!-- Pole top -->
  <div style="position:absolute;top:0;left:50%;transform:translateX(-50%);width:8%;height:12%;background:linear-gradient(to right,#78350f,#a16207,#78350f);border-radius:${s*0.02}px ${s*0.02}px 0 0;"></div>
  <!-- Flag -->
  <div style="position:absolute;top:2%;left:54%;width:15%;height:10%;background:linear-gradient(to bottom,#fbbf24,#f59e0b);clip-path:polygon(0% 0%,100% 50%,0% 100%);"></div>
  <!-- Decorative triangles -->
  <div style="position:absolute;top:12%;left:15%;width:8%;height:6%;background:#fbbf24;clip-path:polygon(50% 0%,0% 100%,100% 100%);"></div>
  <div style="position:absolute;top:12%;left:25%;width:8%;height:6%;background:#a78bfa;clip-path:polygon(50% 0%,0% 100%,100% 100%);"></div>
  <div style="position:absolute;top:12%;right:25%;width:8%;height:6%;background:#34d399;clip-path:polygon(50% 0%,0% 100%,100% 100%);"></div>
  <div style="position:absolute;top:12%;right:15%;width:8%;height:6%;background:#60a5fa;clip-path:polygon(50% 0%,0% 100%,100% 100%);"></div>
  <!-- Ground shadow -->
  <div style="position:absolute;bottom:-2%;left:10%;width:80%;height:5%;background:radial-gradient(ellipse,rgba(0,0,0,0.2),transparent);border-radius:50%;"></div>
</div>`;
}

// ðŸ§¸ Giant Teddy
function renderCSSGiantTeddy(size=260){
  const s=size;
  const fur='#a16207';
  const furLight='#ca8a04';
  const furDark='#78350f';
  return`
<div style="position:relative;width:${s*0.8}px;height:${s}px;">
  <!-- Body -->
  <div style="position:absolute;bottom:5%;left:15%;width:70%;height:55%;background:radial-gradient(ellipse at 40% 30%,${furLight},${fur},${furDark});border-radius:50%;box-shadow:inset ${s*0.02}px ${s*0.02}px ${s*0.05}px rgba(255,255,255,0.3),inset -${s*0.01}px -${s*0.01}px ${s*0.03}px rgba(0,0,0,0.2);"></div>
  <!-- Tummy patch -->
  <div style="position:absolute;bottom:15%;left:28%;width:44%;height:35%;background:radial-gradient(ellipse,#fef3c7,#fde68a);border-radius:50%;opacity:0.9;"></div>
  <!-- Head -->
  <div style="position:absolute;top:5%;left:20%;width:60%;height:45%;background:radial-gradient(ellipse at 35% 30%,${furLight},${fur},${furDark});border-radius:50%;box-shadow:inset ${s*0.015}px ${s*0.015}px ${s*0.04}px rgba(255,255,255,0.3);"></div>
  <!-- Left ear -->
  <div style="position:absolute;top:3%;left:15%;width:20%;height:18%;background:radial-gradient(ellipse,${furLight},${fur});border-radius:50%;"></div>
  <div style="position:absolute;top:6%;left:19%;width:12%;height:11%;background:radial-gradient(ellipse,#fde68a,#fbbf24);border-radius:50%;"></div>
  <!-- Right ear -->
  <div style="position:absolute;top:3%;right:15%;width:20%;height:18%;background:radial-gradient(ellipse,${furLight},${fur});border-radius:50%;"></div>
  <div style="position:absolute;top:6%;right:19%;width:12%;height:11%;background:radial-gradient(ellipse,#fde68a,#fbbf24);border-radius:50%;"></div>
  <!-- Snout -->
  <div style="position:absolute;top:28%;left:35%;width:30%;height:18%;background:radial-gradient(ellipse,#fef3c7,#fde68a);border-radius:50%;"></div>
  <!-- Nose -->
  <div style="position:absolute;top:30%;left:44%;width:12%;height:8%;background:radial-gradient(ellipse at 30% 30%,#4b5563,#1f2937);border-radius:40%;"></div>
  <!-- Eyes -->
  <div style="position:absolute;top:22%;left:30%;width:10%;height:10%;background:radial-gradient(ellipse at 30% 30%,#4b5563,#1f2937);border-radius:50%;"></div>
  <div style="position:absolute;top:22%;right:30%;width:10%;height:10%;background:radial-gradient(ellipse at 30% 30%,#4b5563,#1f2937);border-radius:50%;"></div>
  <!-- Eye shine -->
  <div style="position:absolute;top:23%;left:32%;width:4%;height:4%;background:white;border-radius:50%;"></div>
  <div style="position:absolute;top:23%;right:32%;width:4%;height:4%;background:white;border-radius:50%;"></div>
  <!-- Arms -->
  <div style="position:absolute;top:52%;left:5%;width:22%;height:25%;background:radial-gradient(ellipse at 40% 30%,${furLight},${fur});border-radius:50%;transform:rotate(30deg);"></div>
  <div style="position:absolute;top:52%;right:5%;width:22%;height:25%;background:radial-gradient(ellipse at 60% 30%,${furLight},${fur});border-radius:50%;transform:rotate(-30deg);"></div>
  <!-- Legs -->
  <div style="position:absolute;bottom:0;left:18%;width:25%;height:22%;background:radial-gradient(ellipse at 40% 30%,${furLight},${fur});border-radius:50%;"></div>
  <div style="position:absolute;bottom:0;right:18%;width:25%;height:22%;background:radial-gradient(ellipse at 60% 30%,${furLight},${fur});border-radius:50%;"></div>
  <!-- Bow -->
  <div style="position:absolute;top:42%;left:42%;width:16%;height:10%;background:linear-gradient(to bottom,#f43f5e,#e11d48);border-radius:${s*0.02}px;"></div>
  <div style="position:absolute;top:40%;left:38%;width:10%;height:14%;background:linear-gradient(135deg,#fb7185,#f43f5e);border-radius:50% 0 50% 50%;transform:rotate(-20deg);"></div>
  <div style="position:absolute;top:40%;right:38%;width:10%;height:14%;background:linear-gradient(225deg,#fb7185,#f43f5e);border-radius:0 50% 50% 50%;transform:rotate(20deg);"></div>
</div>`;
}

// ðŸªŸ Window
function renderCSSWindow(size=110){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s*1.2}px;">
  <!-- Window frame -->
  <div style="position:absolute;inset:0;background:linear-gradient(to right,#78350f,#a16207,#78350f);border-radius:${s*0.08}px;box-shadow:inset ${s*0.02}px ${s*0.02}px ${s*0.04}px rgba(255,255,255,0.2),0 ${s*0.03}px ${s*0.05}px rgba(0,0,0,0.3);"></div>
  <!-- Glass -->
  <div style="position:absolute;top:8%;left:8%;width:84%;height:84%;background:linear-gradient(135deg,#bfdbfe,#93c5fd,#60a5fa);border-radius:${s*0.04}px;box-shadow:inset ${s*0.01}px ${s*0.01}px ${s*0.03}px rgba(255,255,255,0.6);"></div>
  <!-- Cross frame vertical -->
  <div style="position:absolute;top:8%;left:47%;width:6%;height:84%;background:linear-gradient(to right,#78350f,#a16207,#78350f);"></div>
  <!-- Cross frame horizontal -->
  <div style="position:absolute;top:46%;left:8%;width:84%;height:6%;background:linear-gradient(to bottom,#78350f,#a16207,#78350f);"></div>
  <!-- Curtain left -->
  <div style="position:absolute;top:5%;left:-5%;width:20%;height:95%;background:linear-gradient(to right,#fecaca,#fca5a5);border-radius:${s*0.03}px;"></div>
  <!-- Curtain right -->
  <div style="position:absolute;top:5%;right:-5%;width:20%;height:95%;background:linear-gradient(to left,#fecaca,#fca5a5);border-radius:${s*0.03}px;"></div>
  <!-- Sun glare -->
  <div style="position:absolute;top:15%;left:15%;width:20%;height:15%;background:rgba(255,255,255,0.4);border-radius:50%;filter:blur(${s*0.02}px);"></div>
</div>`;
}

// ðŸ–¼ï¸ Picture Frame
function renderCSSPictureFrame(size=96){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s*1.1}px;">
  <!-- Frame -->
  <div style="position:absolute;inset:0;background:linear-gradient(135deg,#a16207,#ca8a04,#a16207);border-radius:${s*0.05}px;box-shadow:inset ${s*0.015}px ${s*0.015}px ${s*0.03}px rgba(255,255,255,0.3),inset -${s*0.01}px -${s*0.01}px ${s*0.02}px rgba(0,0,0,0.2),0 ${s*0.02}px ${s*0.04}px rgba(0,0,0,0.3);"></div>
  <!-- Inner frame -->
  <div style="position:absolute;top:8%;left:8%;width:84%;height:84%;background:linear-gradient(135deg,#78350f,#92400e);border-radius:${s*0.03}px;"></div>
  <!-- Picture area -->
  <div style="position:absolute;top:12%;left:12%;width:76%;height:76%;background:linear-gradient(180deg,#fef3c7 0%,#a7f3d0 50%,#6ee7b7 100%);border-radius:${s*0.02}px;overflow:hidden;">
    <!-- Simple landscape -->
    <div style="position:absolute;bottom:0;left:0;width:100%;height:40%;background:linear-gradient(to top,#22c55e,#4ade80);"></div>
    <!-- Sun -->
    <div style="position:absolute;top:15%;right:20%;width:25%;height:30%;background:radial-gradient(circle,#fbbf24,#f59e0b);border-radius:50%;"></div>
    <!-- Cloud -->
    <div style="position:absolute;top:20%;left:15%;width:30%;height:15%;background:white;border-radius:50%;"></div>
  </div>
</div>`;
}

// ðŸŒˆ Rainbow Poster
function renderCSSRainbowPoster(size=100){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s*1.3}px;">
  <!-- Poster background -->
  <div style="position:absolute;inset:0;background:linear-gradient(to bottom,#fef3c7,#fef9c3);border-radius:${s*0.04}px;box-shadow:0 ${s*0.02}px ${s*0.04}px rgba(0,0,0,0.2);"></div>
  <!-- Rainbow arcs -->
  <div style="position:absolute;bottom:25%;left:10%;width:80%;height:50%;border-radius:${s*0.5}px ${s*0.5}px 0 0;background:linear-gradient(to bottom,#ef4444 0%,#ef4444 14%,#f97316 14%,#f97316 28%,#eab308 28%,#eab308 42%,#22c55e 42%,#22c55e 57%,#3b82f6 57%,#3b82f6 71%,#8b5cf6 71%,#8b5cf6 85%,#ec4899 85%,#ec4899 100%);"></div>
  <!-- Inner cutout -->
  <div style="position:absolute;bottom:25%;left:20%;width:60%;height:35%;background:linear-gradient(to bottom,#fef3c7,#fef9c3);border-radius:${s*0.4}px ${s*0.4}px 0 0;"></div>
  <!-- Clouds -->
  <div style="position:absolute;bottom:22%;left:5%;width:25%;height:12%;background:white;border-radius:50%;box-shadow:${s*0.05}px 0 0 white,-${s*0.03}px ${s*0.02}px 0 white;"></div>
  <div style="position:absolute;bottom:22%;right:5%;width:25%;height:12%;background:white;border-radius:50%;box-shadow:-${s*0.05}px 0 0 white,${s*0.03}px ${s*0.02}px 0 white;"></div>
  <!-- Tape pieces -->
  <div style="position:absolute;top:-3%;left:35%;width:30%;height:8%;background:rgba(250,204,21,0.7);transform:rotate(-2deg);"></div>
</div>`;
}

// ðŸª´ Potted Plant
function renderCSSPottedPlant(size=84){
  const s=size;
  return`
<div style="position:relative;width:${s*0.8}px;height:${s}px;">
  <!-- Pot -->
  <div style="position:absolute;bottom:0;left:15%;width:70%;height:40%;background:linear-gradient(to right,#c2410c,#ea580c,#c2410c);border-radius:${s*0.02}px ${s*0.02}px ${s*0.08}px ${s*0.08}px;box-shadow:inset ${s*0.01}px ${s*0.01}px ${s*0.02}px rgba(255,255,255,0.2);"></div>
  <!-- Pot rim -->
  <div style="position:absolute;bottom:35%;left:10%;width:80%;height:10%;background:linear-gradient(to bottom,#ea580c,#c2410c);border-radius:${s*0.02}px;"></div>
  <!-- Soil -->
  <div style="position:absolute;bottom:38%;left:20%;width:60%;height:8%;background:linear-gradient(to bottom,#78350f,#451a03);border-radius:50%;"></div>
  <!-- Main leaves -->
  <div style="position:absolute;bottom:40%;left:35%;width:30%;height:50%;background:linear-gradient(to top,#15803d,#22c55e,#4ade80);border-radius:50% 50% 0 0;transform:rotate(-5deg);"></div>
  <div style="position:absolute;bottom:45%;left:20%;width:25%;height:40%;background:linear-gradient(to top,#15803d,#22c55e);border-radius:50% 50% 0 0;transform:rotate(-25deg);"></div>
  <div style="position:absolute;bottom:45%;right:20%;width:25%;height:40%;background:linear-gradient(to top,#15803d,#22c55e);border-radius:50% 50% 0 0;transform:rotate(25deg);"></div>
  <!-- Small leaves -->
  <div style="position:absolute;bottom:50%;left:10%;width:20%;height:30%;background:linear-gradient(to top,#16a34a,#4ade80);border-radius:50% 50% 0 0;transform:rotate(-40deg);"></div>
  <div style="position:absolute;bottom:50%;right:10%;width:20%;height:30%;background:linear-gradient(to top,#16a34a,#4ade80);border-radius:50% 50% 0 0;transform:rotate(40deg);"></div>
</div>`;
}

// â­ Star Mobile
function renderCSSStarMobile(size=76){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s*1.2}px;">
  <!-- Hanger bar -->
  <div style="position:absolute;top:0;left:20%;width:60%;height:5%;background:linear-gradient(to right,#a16207,#ca8a04,#a16207);border-radius:${s*0.02}px;"></div>
  <!-- Strings -->
  <div style="position:absolute;top:5%;left:25%;width:2%;height:25%;background:#d1d5db;"></div>
  <div style="position:absolute;top:5%;left:50%;width:2%;height:35%;background:#d1d5db;transform:translateX(-50%);"></div>
  <div style="position:absolute;top:5%;right:25%;width:2%;height:20%;background:#d1d5db;"></div>
  <!-- Stars -->
  <div style="position:absolute;top:28%;left:18%;width:18%;height:18%;background:linear-gradient(135deg,#fbbf24,#f59e0b);clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);filter:drop-shadow(0 ${s*0.01}px ${s*0.02}px rgba(0,0,0,0.2));"></div>
  <div style="position:absolute;top:38%;left:42%;width:22%;height:22%;background:linear-gradient(135deg,#fcd34d,#fbbf24);clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);filter:drop-shadow(0 ${s*0.01}px ${s*0.02}px rgba(0,0,0,0.2));transform:translateX(-50%);"></div>
  <div style="position:absolute;top:23%;right:18%;width:16%;height:16%;background:linear-gradient(135deg,#fbbf24,#f59e0b);clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);filter:drop-shadow(0 ${s*0.01}px ${s*0.02}px rgba(0,0,0,0.2));"></div>
  <!-- Moon -->
  <div style="position:absolute;bottom:15%;left:30%;width:20%;height:25%;background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:50%;box-shadow:inset -${s*0.03}px -${s*0.01}px 0 ${s*0.01}px #fbbf24;"></div>
  <!-- Small stars -->
  <div style="position:absolute;bottom:25%;right:25%;width:12%;height:12%;background:#fcd34d;clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);"></div>
</div>`;
}

// ðŸ® Paper Lantern
function renderCSSPaperLantern(size=70){
  const s=size;
  return`
<div style="position:relative;width:${s*0.7}px;height:${s}px;">
  <!-- Top cap -->
  <div style="position:absolute;top:0;left:25%;width:50%;height:8%;background:linear-gradient(to right,#b91c1c,#dc2626,#b91c1c);border-radius:${s*0.02}px;"></div>
  <!-- Hanger -->
  <div style="position:absolute;top:-10%;left:45%;width:10%;height:12%;background:linear-gradient(to right,#78350f,#a16207);border-radius:${s*0.01}px;"></div>
  <!-- Main lantern body -->
  <div style="position:absolute;top:8%;left:5%;width:90%;height:75%;background:radial-gradient(ellipse at 30% 30%,#fca5a5,#f87171,#ef4444,#dc2626);border-radius:50%;box-shadow:inset ${s*0.02}px ${s*0.02}px ${s*0.05}px rgba(255,255,255,0.3),0 0 ${s*0.1}px rgba(251,191,36,0.4);"></div>
  <!-- Lantern ribs -->
  <div style="position:absolute;top:12%;left:30%;width:3%;height:65%;background:rgba(0,0,0,0.15);border-radius:${s*0.01}px;"></div>
  <div style="position:absolute;top:12%;left:50%;width:3%;height:65%;background:rgba(0,0,0,0.15);border-radius:${s*0.01}px;transform:translateX(-50%);"></div>
  <div style="position:absolute;top:12%;right:30%;width:3%;height:65%;background:rgba(0,0,0,0.15);border-radius:${s*0.01}px;"></div>
  <!-- Bottom cap -->
  <div style="position:absolute;bottom:12%;left:25%;width:50%;height:6%;background:linear-gradient(to right,#b91c1c,#dc2626,#b91c1c);border-radius:${s*0.02}px;"></div>
  <!-- Tassel -->
  <div style="position:absolute;bottom:0;left:40%;width:20%;height:15%;background:linear-gradient(to bottom,#fbbf24,#f59e0b);border-radius:0 0 ${s*0.03}px ${s*0.03}px;"></div>
  <!-- Glow effect -->
  <div style="position:absolute;top:20%;left:20%;width:30%;height:25%;background:rgba(255,255,255,0.3);border-radius:50%;filter:blur(${s*0.03}px);"></div>
</div>`;
}

// ðŸŽµ Music Box
function renderCSSMusicBox(size=64){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s*0.8}px;">
  <!-- Box base -->
  <div style="position:absolute;bottom:0;left:0;width:100%;height:60%;background:linear-gradient(to bottom,#a16207,#78350f);border-radius:${s*0.05}px;box-shadow:inset ${s*0.01}px ${s*0.01}px ${s*0.02}px rgba(255,255,255,0.2),0 ${s*0.02}px ${s*0.03}px rgba(0,0,0,0.3);"></div>
  <!-- Box lid -->
  <div style="position:absolute;top:15%;left:0;width:100%;height:35%;background:linear-gradient(to bottom,#ca8a04,#a16207);border-radius:${s*0.05}px ${s*0.05}px 0 0;transform-origin:bottom;transform:rotateX(-20deg);box-shadow:0 -${s*0.01}px ${s*0.02}px rgba(0,0,0,0.1);"></div>
  <!-- Decorative inlay -->
  <div style="position:absolute;bottom:15%;left:15%;width:70%;height:35%;background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:${s*0.03}px;box-shadow:inset ${s*0.005}px ${s*0.005}px ${s*0.01}px rgba(0,0,0,0.1);"></div>
  <!-- Music notes -->
  <div style="position:absolute;top:0;left:20%;font-size:${s*0.2}px;color:#8b5cf6;text-shadow:0 ${s*0.01}px ${s*0.02}px rgba(0,0,0,0.2);">â™ª</div>
  <div style="position:absolute;top:-10%;right:25%;font-size:${s*0.25}px;color:#a78bfa;text-shadow:0 ${s*0.01}px ${s*0.02}px rgba(0,0,0,0.2);">â™«</div>
  <!-- Handle/crank -->
  <div style="position:absolute;bottom:25%;right:-8%;width:15%;height:20%;background:linear-gradient(to right,#d4d4d4,#a3a3a3);border-radius:${s*0.02}px;"></div>
  <div style="position:absolute;bottom:20%;right:-15%;width:12%;height:12%;background:linear-gradient(135deg,#fafafa,#d4d4d4);border-radius:50%;box-shadow:inset ${s*0.005}px ${s*0.005}px ${s*0.01}px rgba(0,0,0,0.2);"></div>
</div>`;
}

// ðŸª” Floor Lamp
function renderCSSFloorLamp(size=80){
  const s=size;
  return`
<div style="position:relative;width:${s*0.6}px;height:${s}px;">
  <!-- Shadow -->
  <div style="position:absolute;bottom:0;left:10%;width:80%;height:10%;background:rgba(0,0,0,0.15);border-radius:50%;filter:blur(${s*0.02}px);"></div>
  <!-- Base -->
  <div style="position:absolute;bottom:2%;left:20%;width:60%;height:8%;background:linear-gradient(180deg,#78350f,#451a03);border-radius:${s*0.04}px;"></div>
  <!-- Pole -->
  <div style="position:absolute;bottom:8%;left:45%;width:10%;height:65%;background:linear-gradient(90deg,#a16207,#78350f,#a16207);border-radius:${s*0.02}px;"></div>
  <!-- Lamp shade -->
  <div style="position:absolute;top:0;left:5%;width:90%;height:30%;background:linear-gradient(180deg,#fef9c3,#fde68a,#fcd34d);border-radius:${s*0.02}px ${s*0.02}px ${s*0.15}px ${s*0.15}px;border:${s*0.02}px solid #a16207;box-shadow:0 ${s*0.03}px ${s*0.06}px rgba(251,191,36,0.4),inset 0 ${s*0.02}px ${s*0.03}px rgba(255,255,255,0.5);"></div>
  <!-- Shade rim -->
  <div style="position:absolute;top:28%;left:0;width:100%;height:6%;background:linear-gradient(180deg,#b45309,#92400e);border-radius:0 0 ${s*0.08}px ${s*0.08}px;"></div>
  <!-- Light glow -->
  <div style="position:absolute;top:8%;left:20%;width:60%;height:18%;background:radial-gradient(ellipse,rgba(255,255,255,0.6),transparent);border-radius:50%;"></div>
</div>`;
}

// ðŸ§º Bean Bag
function renderCSSBeanBag(size=80){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s*0.8}px;">
  <!-- Shadow -->
  <div style="position:absolute;bottom:0;left:10%;width:80%;height:15%;background:rgba(0,0,0,0.18);border-radius:50%;filter:blur(${s*0.025}px);"></div>
  <!-- Bean bag body -->
  <div style="position:absolute;bottom:5%;left:5%;width:90%;height:85%;background:radial-gradient(ellipse at 35% 35%,#f472b6,#ec4899,#db2777);border-radius:50% 50% 45% 45% / 60% 60% 40% 40%;box-shadow:0 ${s*0.03}px ${s*0.06}px rgba(0,0,0,0.25),inset 0 ${s*0.03}px ${s*0.05}px rgba(255,255,255,0.3),inset 0 -${s*0.02}px ${s*0.04}px rgba(0,0,0,0.15);border:${s*0.025}px solid #9d174d;"></div>
  <!-- Texture lines -->
  <div style="position:absolute;top:25%;left:25%;width:50%;height:3%;background:rgba(157,23,77,0.2);border-radius:50%;transform:rotate(-5deg);"></div>
  <div style="position:absolute;top:45%;left:20%;width:55%;height:2%;background:rgba(157,23,77,0.15);border-radius:50%;transform:rotate(3deg);"></div>
  <!-- Highlight -->
  <div style="position:absolute;top:15%;left:18%;width:35%;height:25%;background:linear-gradient(145deg,rgba(255,255,255,0.35),transparent);border-radius:50%;"></div>
</div>`;
}

// ðŸ•°ï¸ Wall Clock
function renderCSSWallClock(size=80){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;">
  <!-- Clock frame -->
  <div style="position:absolute;top:5%;left:5%;width:90%;height:90%;background:linear-gradient(145deg,#78350f,#451a03);border-radius:50%;box-shadow:0 ${s*0.03}px ${s*0.06}px rgba(0,0,0,0.3),inset 0 ${s*0.01}px ${s*0.02}px rgba(255,255,255,0.15);"></div>
  <!-- Clock face -->
  <div style="position:absolute;top:12%;left:12%;width:76%;height:76%;background:radial-gradient(circle at 40% 40%,#fefce8,#fef9c3,#fef3c7);border-radius:50%;box-shadow:inset 0 ${s*0.01}px ${s*0.02}px rgba(0,0,0,0.1);"></div>
  <!-- Hour markers -->
  <div style="position:absolute;top:18%;left:48%;width:4%;height:8%;background:#78350f;border-radius:${s*0.01}px;"></div>
  <div style="position:absolute;bottom:18%;left:48%;width:4%;height:8%;background:#78350f;border-radius:${s*0.01}px;"></div>
  <div style="position:absolute;top:48%;left:18%;width:8%;height:4%;background:#78350f;border-radius:${s*0.01}px;"></div>
  <div style="position:absolute;top:48%;right:18%;width:8%;height:4%;background:#78350f;border-radius:${s*0.01}px;"></div>
  <!-- Hour hand -->
  <div style="position:absolute;top:30%;left:48%;width:4%;height:22%;background:linear-gradient(180deg,#1f2937,#111827);border-radius:${s*0.02}px;transform-origin:bottom center;transform:rotate(-30deg);"></div>
  <!-- Minute hand -->
  <div style="position:absolute;top:22%;left:49%;width:3%;height:30%;background:linear-gradient(180deg,#374151,#1f2937);border-radius:${s*0.015}px;transform-origin:bottom center;transform:rotate(60deg);"></div>
  <!-- Center dot -->
  <div style="position:absolute;top:46%;left:46%;width:8%;height:8%;background:radial-gradient(circle,#78350f,#451a03);border-radius:50%;"></div>
</div>`;
}

// ðŸ  Fish Tank
function renderCSSFishTank(size=100){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s*0.8}px;">
  <!-- Shadow -->
  <div style="position:absolute;bottom:0;left:10%;width:80%;height:10%;background:rgba(0,0,0,0.2);border-radius:50%;filter:blur(${s*0.02}px);"></div>
  <!-- Tank frame -->
  <div style="position:absolute;top:0;left:5%;width:90%;height:90%;background:linear-gradient(180deg,#64748b,#475569);border-radius:${s*0.04}px;padding:${s*0.03}px;box-shadow:0 ${s*0.02}px ${s*0.04}px rgba(0,0,0,0.25);"></div>
  <!-- Water -->
  <div style="position:absolute;top:5%;left:10%;width:80%;height:78%;background:linear-gradient(180deg,#7dd3fc 0%,#38bdf8 30%,#0ea5e9 70%,#0284c7 100%);border-radius:${s*0.03}px;overflow:hidden;box-shadow:inset 0 ${s*0.02}px ${s*0.04}px rgba(255,255,255,0.3);"></div>
  <!-- Gravel -->
  <div style="position:absolute;bottom:12%;left:10%;width:80%;height:12%;background:linear-gradient(180deg,#d4a574,#a16207);border-radius:0 0 ${s*0.02}px ${s*0.02}px;"></div>
  <!-- Plant -->
  <div style="position:absolute;bottom:22%;left:18%;width:12%;height:35%;background:linear-gradient(180deg,#22c55e,#16a34a);border-radius:${s*0.02}px ${s*0.02}px ${s*0.01}px ${s*0.01}px;transform:rotate(-8deg);"></div>
  <div style="position:absolute;bottom:25%;left:22%;width:10%;height:28%;background:linear-gradient(180deg,#4ade80,#22c55e);border-radius:${s*0.02}px ${s*0.02}px ${s*0.01}px ${s*0.01}px;transform:rotate(5deg);"></div>
  <!-- Fish 1 -->
  <div style="position:absolute;top:30%;left:35%;width:18%;height:12%;background:linear-gradient(145deg,#fb923c,#f97316);border-radius:60% 40% 40% 60% / 50% 50% 50% 50%;"></div>
  <div style="position:absolute;top:32%;left:30%;width:8%;height:8%;background:#f97316;clip-path:polygon(100% 50%, 0 0, 0 100%);"></div>
  <!-- Fish 2 -->
  <div style="position:absolute;top:50%;right:25%;width:14%;height:10%;background:linear-gradient(145deg,#c084fc,#a855f7);border-radius:60% 40% 40% 60% / 50% 50% 50% 50%;transform:scaleX(-1);"></div>
  <!-- Bubbles -->
  <div style="position:absolute;top:25%;right:30%;width:5%;height:5%;background:rgba(255,255,255,0.5);border-radius:50%;"></div>
  <div style="position:absolute;top:35%;right:35%;width:3%;height:3%;background:rgba(255,255,255,0.4);border-radius:50%;"></div>
  <!-- Water surface shine -->
  <div style="position:absolute;top:6%;left:15%;width:50%;height:8%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent);border-radius:50%;"></div>
</div>`;
}

// ðŸªž Mirror
function renderCSSMirror(size=80){
  const s=size;
  return`
<div style="position:relative;width:${s*0.8}px;height:${s}px;">
  <!-- Frame -->
  <div style="position:absolute;inset:0;background:linear-gradient(135deg,#a16207,#ca8a04,#a16207);border-radius:50% 50% 50% 50% / 45% 45% 55% 55%;box-shadow:inset ${s*0.015}px ${s*0.015}px ${s*0.03}px rgba(255,255,255,0.3),inset -${s*0.01}px -${s*0.01}px ${s*0.02}px rgba(0,0,0,0.2),0 ${s*0.02}px ${s*0.04}px rgba(0,0,0,0.25);"></div>
  <!-- Inner frame -->
  <div style="position:absolute;top:6%;left:8%;width:84%;height:88%;background:linear-gradient(135deg,#78350f,#92400e);border-radius:50% 50% 50% 50% / 45% 45% 55% 55%;"></div>
  <!-- Mirror surface -->
  <div style="position:absolute;top:10%;left:12%;width:76%;height:80%;background:linear-gradient(135deg,#e0f2fe,#bae6fd,#7dd3fc,#bae6fd);border-radius:50% 50% 50% 50% / 45% 45% 55% 55%;box-shadow:inset 0 0 ${s*0.05}px rgba(255,255,255,0.5);"></div>
  <!-- Reflection shine -->
  <div style="position:absolute;top:15%;left:18%;width:40%;height:30%;background:linear-gradient(145deg,rgba(255,255,255,0.7),transparent);border-radius:50%;"></div>
  <!-- Decorative top -->
  <div style="position:absolute;top:-5%;left:35%;width:30%;height:12%;background:radial-gradient(ellipse,#ca8a04,#a16207);border-radius:50%;border:${s*0.015}px solid #78350f;"></div>
</div>`;
}

// ðŸŽ€ Curtains
function renderCSSCurtains(size=100){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;">
  <!-- Curtain rod -->
  <div style="position:absolute;top:0;left:5%;width:90%;height:6%;background:linear-gradient(180deg,#d4a574,#a16207,#78350f);border-radius:${s*0.03}px;box-shadow:0 ${s*0.01}px ${s*0.02}px rgba(0,0,0,0.2);"></div>
  <!-- Rod finials -->
  <div style="position:absolute;top:-2%;left:0;width:8%;height:10%;background:radial-gradient(circle at 40% 40%,#d4a574,#a16207);border-radius:50%;"></div>
  <div style="position:absolute;top:-2%;right:0;width:8%;height:10%;background:radial-gradient(circle at 40% 40%,#d4a574,#a16207);border-radius:50%;"></div>
  <!-- Left curtain -->
  <div style="position:absolute;top:6%;left:5%;width:35%;height:90%;background:linear-gradient(90deg,#c084fc,#a855f7,#9333ea);border-radius:0 0 ${s*0.05}px ${s*0.02}px;box-shadow:${s*0.01}px 0 ${s*0.02}px rgba(0,0,0,0.15);"></div>
  <!-- Left curtain folds -->
  <div style="position:absolute;top:15%;left:8%;width:5%;height:75%;background:rgba(147,51,234,0.3);border-radius:${s*0.02}px;"></div>
  <div style="position:absolute;top:12%;left:18%;width:4%;height:78%;background:rgba(192,132,252,0.25);border-radius:${s*0.02}px;"></div>
  <!-- Right curtain -->
  <div style="position:absolute;top:6%;right:5%;width:35%;height:90%;background:linear-gradient(270deg,#c084fc,#a855f7,#9333ea);border-radius:0 0 ${s*0.02}px ${s*0.05}px;box-shadow:-${s*0.01}px 0 ${s*0.02}px rgba(0,0,0,0.15);"></div>
  <!-- Right curtain folds -->
  <div style="position:absolute;top:15%;right:8%;width:5%;height:75%;background:rgba(147,51,234,0.3);border-radius:${s*0.02}px;"></div>
  <div style="position:absolute;top:12%;right:18%;width:4%;height:78%;background:rgba(192,132,252,0.25);border-radius:${s*0.02}px;"></div>
  <!-- Tie-backs -->
  <div style="position:absolute;top:30%;left:32%;width:12%;height:5%;background:linear-gradient(90deg,#fbbf24,#f59e0b);border-radius:${s*0.02}px;transform:rotate(-15deg);"></div>
  <div style="position:absolute;top:30%;right:32%;width:12%;height:5%;background:linear-gradient(90deg,#fbbf24,#f59e0b);border-radius:${s*0.02}px;transform:rotate(15deg);"></div>
</div>`;
}

// Render furniture icon for room selection UI (small preview)
function renderFurnitureIcon(emoji, size=48){
  const cssRenderers={
    'ðŸ›‹ï¸':renderCSSCouch,
    'ðŸ›ï¸':renderCSSBed,
    'ðŸ“š':renderCSSBookshelf,
    'ðŸŽª':renderCSSPlayTent,
    'ðŸ§¸':renderCSSGiantTeddy,
    'ðŸªŸ':renderCSSWindow,
    'ðŸ–¼ï¸':renderCSSPictureFrame,
    'ðŸŒˆ':renderCSSRainbowPoster,
    'ðŸª´':renderCSSPottedPlant,
    'â­':renderCSSStarMobile,
    'ðŸ®':renderCSSPaperLantern,
    'ðŸŽµ':renderCSSMusicBox,
    'ðŸª”':renderCSSFloorLamp,
    'ðŸ§º':renderCSSBeanBag,
    'ðŸ•°ï¸':renderCSSWallClock,
    'ðŸ ':renderCSSFishTank,
    'ðŸªž':renderCSSMirror,
    'ðŸŽ€':renderCSSCurtains
  };

  if(cssRenderers[emoji]){
    return `<div style="transform:scale(${size/80});transform-origin:center;width:${size}px;height:${size}px;display:flex;align-items:center;justify-content:center;overflow:visible;">${cssRenderers[emoji](80)}</div>`;
  }
  return `<span style="font-size:${size*0.7}px;">${emoji}</span>`;
}

function renderCSSCouch(size=320){
  const s=size;
  const cushionColor='#6366f1'; // Indigo
  const cushionLight='#818cf8';
  const cushionDark='#4f46e5';
  const frameColor='#78350f'; // Brown wood
  const frameDark='#451a03';
  return`
<div style="position:relative;width:${s}px;height:${s*0.55}px;">
  <!-- Couch frame/base -->
  <div style="position:absolute;bottom:0;left:5%;width:90%;height:35%;background:linear-gradient(to bottom,${frameColor},${frameDark});border-radius:${s*0.03}px;box-shadow:0 ${s*0.02}px ${s*0.04}px rgba(0,0,0,0.3);"></div>
  <!-- Left armrest -->
  <div style="position:absolute;bottom:10%;left:0;width:18%;height:70%;background:linear-gradient(135deg,${cushionLight},${cushionColor},${cushionDark});border-radius:${s*0.05}px ${s*0.03}px ${s*0.03}px ${s*0.05}px;box-shadow:inset ${s*0.01}px ${s*0.01}px ${s*0.03}px rgba(255,255,255,0.3),inset -${s*0.01}px -${s*0.01}px ${s*0.02}px rgba(0,0,0,0.2);"></div>
  <!-- Right armrest -->
  <div style="position:absolute;bottom:10%;right:0;width:18%;height:70%;background:linear-gradient(225deg,${cushionLight},${cushionColor},${cushionDark});border-radius:${s*0.03}px ${s*0.05}px ${s*0.05}px ${s*0.03}px;box-shadow:inset ${s*0.01}px ${s*0.01}px ${s*0.03}px rgba(255,255,255,0.3),inset -${s*0.01}px -${s*0.01}px ${s*0.02}px rgba(0,0,0,0.2);"></div>
  <!-- Back cushion -->
  <div style="position:absolute;top:0;left:12%;width:76%;height:50%;background:linear-gradient(to bottom,${cushionLight},${cushionColor});border-radius:${s*0.04}px ${s*0.04}px ${s*0.02}px ${s*0.02}px;box-shadow:inset ${s*0.015}px ${s*0.015}px ${s*0.04}px rgba(255,255,255,0.4),inset -${s*0.01}px -${s*0.01}px ${s*0.03}px rgba(0,0,0,0.15);"></div>
  <!-- Seat cushions container -->
  <div style="position:absolute;bottom:20%;left:14%;width:72%;height:35%;display:flex;gap:0;">
    <!-- Left seat cushion -->
    <div style="flex:1;background:linear-gradient(to bottom,${cushionLight} 0%,${cushionColor} 50%,${cushionDark} 100%);border-radius:${s*0.03}px 0 0 ${s*0.03}px;box-shadow:inset ${s*0.01}px ${s*0.01}px ${s*0.025}px rgba(255,255,255,0.35),0 ${s*0.01}px ${s*0.02}px rgba(0,0,0,0.15);"></div>
    <!-- Center seam -->
    <div style="width:${s*0.008}px;background:linear-gradient(to bottom,${cushionDark},${cushionColor});"></div>
    <!-- Right seat cushion -->
    <div style="flex:1;background:linear-gradient(to bottom,${cushionLight} 0%,${cushionColor} 50%,${cushionDark} 100%);border-radius:0 ${s*0.03}px ${s*0.03}px 0;box-shadow:inset ${s*0.01}px ${s*0.01}px ${s*0.025}px rgba(255,255,255,0.35),0 ${s*0.01}px ${s*0.02}px rgba(0,0,0,0.15);"></div>
  </div>
  <!-- Decorative pillows -->
  <div style="position:absolute;top:25%;left:18%;width:15%;height:25%;background:linear-gradient(135deg,#fbbf24,#f59e0b);border-radius:${s*0.025}px;transform:rotate(-8deg);box-shadow:inset ${s*0.005}px ${s*0.005}px ${s*0.015}px rgba(255,255,255,0.4);"></div>
  <div style="position:absolute;top:25%;right:18%;width:15%;height:25%;background:linear-gradient(225deg,#fb7185,#e11d48);border-radius:${s*0.025}px;transform:rotate(8deg);box-shadow:inset ${s*0.005}px ${s*0.005}px ${s*0.015}px rgba(255,255,255,0.4);"></div>
  <!-- Wooden legs -->
  <div style="position:absolute;bottom:-5%;left:8%;width:8%;height:12%;background:linear-gradient(to right,${frameDark},${frameColor},${frameDark});border-radius:${s*0.01}px;"></div>
  <div style="position:absolute;bottom:-5%;right:8%;width:8%;height:12%;background:linear-gradient(to right,${frameDark},${frameColor},${frameDark});border-radius:${s*0.01}px;"></div>
</div>`;
}

// Render furniture items separately (static, doesn't move with buddy)
function renderFurniture(){
  const stage=S.buddyStage||'egg';
  const furniturePositions=S.furniturePositions[stage]||{};
  let furnitureHTML='';

  (S.placedFurniture||[]).forEach((furnitureIdx,i)=>{
    const furniture=ACCESSORIES[furnitureIdx];
    if(!furniture)return;

    // Get position - check custom, then default
    const getFurniturePosition=(index)=>{
      const customPos=furniturePositions[index];
      const defaultPos=FURNITURE_DEFAULT_POSITIONS[index%FURNITURE_DEFAULT_POSITIONS.length];
      const pos=customPos||defaultPos;

      // During drag, show live preview
      const dragType=`furniture_${index}`;
      if(dragState&&dragState.type===dragType&&dragState.currentX!==undefined){
        const container=document.querySelector('.buddy-scene-wrapper');
        if(container){
          const rect=container.getBoundingClientRect();
          const adjustedX=dragState.currentX-dragState.offsetX;
          const adjustedY=dragState.currentY-dragState.offsetY;
          const x=((adjustedX-rect.left)/rect.width)*100;
          const y=((adjustedY-rect.top)/rect.height)*100;
          return `left:${x}%;top:${y}%;transform:translate(-50%,-50%);`;
        }
      }
      return `left:${pos.x}%;top:${pos.y}%;transform:translate(-50%,-50%);`;
    };

    const dragType=`furniture_${i}`;
    const furnitureSize=FURNITURE_SIZES[furniture.emoji]||DEFAULT_FURNITURE_SIZE;

    // Check if this furniture has a custom CSS design
    let furnitureContent;
    const cssRenderers={
      'ðŸ›‹ï¸':renderCSSCouch,
      'ðŸ›ï¸':renderCSSBed,
      'ðŸ“š':renderCSSBookshelf,
      'ðŸŽª':renderCSSPlayTent,
      'ðŸ§¸':renderCSSGiantTeddy,
      'ðŸªŸ':renderCSSWindow,
      'ðŸ–¼ï¸':renderCSSPictureFrame,
      'ðŸŒˆ':renderCSSRainbowPoster,
      'ðŸª´':renderCSSPottedPlant,
      'â­':renderCSSStarMobile,
      'ðŸ®':renderCSSPaperLantern,
      'ðŸŽµ':renderCSSMusicBox,
      'ðŸª”':renderCSSFloorLamp,
      'ðŸ§º':renderCSSBeanBag,
      'ðŸ•°ï¸':renderCSSWallClock,
      'ðŸ ':renderCSSFishTank,
      'ðŸªž':renderCSSMirror,
      'ðŸŽ€':renderCSSCurtains
    };

    const isCustomCSS=!!cssRenderers[furniture.emoji];
    if(isCustomCSS){
      furnitureContent=cssRenderers[furniture.emoji](furnitureSize);
    }else{
      furnitureContent=furniture.emoji;
    }

    const furnitureDragHandlers=customizeMode?
      `ontouchstart="startDrag('${dragType}',event)" onmousedown="startDrag('${dragType}',event)" style="cursor:move;${isCustomCSS?'':'font-size:'+furnitureSize+'px;'}${getFurniturePosition(i)}"`:
      `style="${isCustomCSS?'':'font-size:'+furnitureSize+'px;'}${getFurniturePosition(i)}"`;

    furnitureHTML+=`<div class="furniture-item" ${furnitureDragHandlers}>${furnitureContent}</div>`;
  });

  return furnitureHTML;
}

// Render Scribby-style icon with consistent design language
function renderScribbyIcon(emoji, size=28, colors={bg:'#c4b5fd',border:'#7c3aed',gradient:'#a78bfa'}){
  const s=size;
  return`<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,${colors.gradient},${colors.bg});border:2px solid ${colors.border};border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.3);display:flex;align-items:center;justify-content:center;">
    <span style="font-size:${s*0.55}px;filter:drop-shadow(0 1px 1px rgba(0,0,0,0.1));">${emoji}</span>
  </div>`;
}

// Preset icon styles matching Scribby design
const ICON_STYLES={
  feed:{bg:'#fed7aa',border:'#ea580c',gradient:'#fdba74'},      // Orange
  album:{bg:'#c4b5fd',border:'#7c3aed',gradient:'#a78bfa'},     // Purple
  closet:{bg:'#fbcfe8',border:'#db2777',gradient:'#f9a8d4'},    // Pink
  items:{bg:'#fde047',border:'#ca8a04',gradient:'#fef08a'},     // Yellow
  room:{bg:'#93c5fd',border:'#2563eb',gradient:'#bfdbfe'},      // Blue
  guide:{bg:'#86efac',border:'#16a34a',gradient:'#bbf7d0'},     // Green
  settings:{bg:'#d1d5db',border:'#6b7280',gradient:'#e5e7eb'},  // Gray
  customize:{bg:'#c4b5fd',border:'#7c3aed',gradient:'#a78bfa'}, // Purple
  xp:{bg:'#ffffff',border:'#ca8a04',gradient:'#fffbeb'},        // White with gold border
  streak:{bg:'#fca5a5',border:'#dc2626',gradient:'#fecaca'},    // Red
};

// Render feed icon - cute bowl with steam
function renderFoodIcon(size=26){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fed7aa,#fdba74);border:2px solid #c2410c;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.75}" height="${s*0.75}" viewBox="0 0 24 24">
    <!-- Bowl -->
    <ellipse cx="12" cy="18" rx="9" ry="4" fill="#fef3c7" stroke="#92400e" stroke-width="1.5"/>
    <path d="M3 16 Q3 20, 12 22 Q21 20, 21 16 L21 18 Q21 22, 12 24 Q3 22, 3 18 Z" fill="#fde68a" stroke="#92400e" stroke-width="1"/>
    <!-- Food pile -->
    <ellipse cx="12" cy="14" rx="7" ry="3" fill="#f97316" stroke="#c2410c" stroke-width="1"/>
    <!-- Steam wisps -->
    <path d="M8 10 Q7 8, 8 6" stroke="#fff" stroke-width="1.5" fill="none" stroke-linecap="round" opacity="0.8"/>
    <path d="M12 9 Q11 7, 12 5" stroke="#fff" stroke-width="1.5" fill="none" stroke-linecap="round" opacity="0.9"/>
    <path d="M16 10 Q15 8, 16 6" stroke="#fff" stroke-width="1.5" fill="none" stroke-linecap="round" opacity="0.8"/>
    <!-- Bowl rim highlight -->
    <ellipse cx="12" cy="16" rx="7" ry="2.5" fill="none" stroke="#fff" stroke-width="0.8" opacity="0.4"/>
  </svg>
</div>`;
}

// Render wear/closet icon - cute t-shirt
function renderWearIcon(size=26){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fbcfe8,#f9a8d4);border:2px solid #db2777;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.8}" height="${s*0.75}" viewBox="0 0 26 24">
    <!-- T-shirt shape -->
    <path d="M8 4 L4 4 L1 8 L4 10 L4 22 L22 22 L22 10 L25 8 L22 4 L18 4 L18 6 Q18 9, 13 9 Q8 9, 8 6 Z"
          fill="url(#shirtGrad${s})" stroke="#be185d" stroke-width="1.5" stroke-linejoin="round"/>
    <!-- Collar -->
    <ellipse cx="13" cy="6" rx="4" ry="2.5" fill="#fbcfe8" stroke="#ec4899" stroke-width="1"/>
    <!-- Neck opening -->
    <ellipse cx="13" cy="5.5" rx="2.5" ry="1.5" fill="#db2777"/>
    <!-- Sleeve cuffs -->
    <path d="M1 8 L4 10" stroke="#be185d" stroke-width="1.5" stroke-linecap="round"/>
    <path d="M25 8 L22 10" stroke="#be185d" stroke-width="1.5" stroke-linecap="round"/>
    <!-- Bottom hem -->
    <path d="M4 22 L22 22" stroke="#be185d" stroke-width="1.5"/>
    <!-- Highlight -->
    <path d="M6 12 L6 18" stroke="#fff" stroke-width="1" opacity="0.4" stroke-linecap="round"/>
    <defs>
      <linearGradient id="shirtGrad${s}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#fdf2f8"/>
        <stop offset="50%" style="stop-color:#fce7f3"/>
        <stop offset="100%" style="stop-color:#fbcfe8"/>
      </linearGradient>
    </defs>
  </svg>
</div>`;
}

// Render items/gift icon - cute gift box with bow
function renderItemsIcon(size=26){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fef08a,#fde047);border:2px solid #ca8a04;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.3);overflow:hidden;">
  <!-- Box bottom -->
  <div style="position:absolute;bottom:${s*0.1}px;left:${s*0.12}px;right:${s*0.12}px;height:${s*0.45}px;background:linear-gradient(180deg,#fbbf24,#f59e0b);border:1.5px solid #b45309;border-radius:${s*0.06}px;"></div>
  <!-- Box lid -->
  <div style="position:absolute;top:${s*0.22}px;left:${s*0.08}px;right:${s*0.08}px;height:${s*0.18}px;background:linear-gradient(180deg,#fcd34d,#fbbf24);border:1.5px solid #b45309;border-radius:${s*0.04}px;"></div>
  <!-- Vertical ribbon -->
  <div style="position:absolute;top:${s*0.22}px;left:50%;transform:translateX(-50%);width:${s*0.12}px;height:${s*0.68}px;background:#ec4899;"></div>
  <!-- Bow left -->
  <div style="position:absolute;top:${s*0.08}px;left:${s*0.22}px;width:${s*0.18}px;height:${s*0.14}px;background:#ec4899;border-radius:50%;border:1px solid #be185d;"></div>
  <!-- Bow right -->
  <div style="position:absolute;top:${s*0.08}px;right:${s*0.22}px;width:${s*0.18}px;height:${s*0.14}px;background:#ec4899;border-radius:50%;border:1px solid #be185d;"></div>
  <!-- Bow center -->
  <div style="position:absolute;top:${s*0.1}px;left:50%;transform:translateX(-50%);width:${s*0.1}px;height:${s*0.1}px;background:#db2777;border-radius:50%;"></div>
</div>`;
}

// Render room icon - cute armchair
function renderRoomIcon(size=26){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#bfdbfe,#93c5fd);border:2px solid #2563eb;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.3);overflow:hidden;">
  <!-- Chair back -->
  <div style="position:absolute;top:${s*0.12}px;left:${s*0.2}px;right:${s*0.2}px;height:${s*0.38}px;background:linear-gradient(180deg,#8b5cf6,#7c3aed);border:2px solid #5b21b6;border-radius:${s*0.12}px ${s*0.12}px ${s*0.04}px ${s*0.04}px;"></div>
  <!-- Chair seat -->
  <div style="position:absolute;top:${s*0.45}px;left:${s*0.12}px;right:${s*0.12}px;height:${s*0.22}px;background:linear-gradient(180deg,#a78bfa,#8b5cf6);border:2px solid #5b21b6;border-radius:${s*0.06}px;"></div>
  <!-- Left armrest -->
  <div style="position:absolute;top:${s*0.32}px;left:${s*0.08}px;width:${s*0.12}px;height:${s*0.35}px;background:linear-gradient(180deg,#8b5cf6,#7c3aed);border:2px solid #5b21b6;border-radius:${s*0.06}px;"></div>
  <!-- Right armrest -->
  <div style="position:absolute;top:${s*0.32}px;right:${s*0.08}px;width:${s*0.12}px;height:${s*0.35}px;background:linear-gradient(180deg,#8b5cf6,#7c3aed);border:2px solid #5b21b6;border-radius:${s*0.06}px;"></div>
  <!-- Left leg -->
  <div style="position:absolute;bottom:${s*0.08}px;left:${s*0.18}px;width:${s*0.1}px;height:${s*0.15}px;background:linear-gradient(180deg,#78350f,#451a03);border-radius:${s*0.03}px;"></div>
  <!-- Right leg -->
  <div style="position:absolute;bottom:${s*0.08}px;right:${s*0.18}px;width:${s*0.1}px;height:${s*0.15}px;background:linear-gradient(180deg,#78350f,#451a03);border-radius:${s*0.03}px;"></div>
  <!-- Cushion highlight -->
  <div style="position:absolute;top:${s*0.18}px;left:50%;transform:translateX(-50%);width:${s*0.25}px;height:${s*0.08}px;background:rgba(255,255,255,0.3);border-radius:${s*0.04}px;"></div>
</div>`;
}

// Render quick practice icon - lightning bolt
function renderQuickPracticeIcon(size=32){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fde047,#facc15);border:3px solid #ca8a04;border-radius:${s*0.28}px;box-shadow:0 3px 8px rgba(0,0,0,0.2),inset 0 2px 4px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <!-- Lightning bolt shape -->
  <svg width="${s*0.55}" height="${s*0.7}" viewBox="0 0 24 32" fill="none" style="filter:drop-shadow(0 1px 2px rgba(0,0,0,0.2));">
    <path d="M14 2L4 18h7l-3 12 12-16h-8l4-12z" fill="#f97316" stroke="#c2410c" stroke-width="1.5" stroke-linejoin="round"/>
  </svg>
</div>`;
}

// Render match game icon - cards connecting (orange themed)
function renderMatchIcon(size=32){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fdba74,#fb923c);border:3px solid #c2410c;border-radius:${s*0.28}px;box-shadow:0 3px 8px rgba(0,0,0,0.2),inset 0 2px 4px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.75}" height="${s*0.7}" viewBox="0 0 28 24" fill="none">
    <!-- Left card -->
    <rect x="1" y="3" width="10" height="14" rx="2" fill="#fef3c7" stroke="#ea580c" stroke-width="1.5"/>
    <circle cx="6" cy="10" r="2.5" fill="#ea580c"/>
    <!-- Right card -->
    <rect x="17" y="7" width="10" height="14" rx="2" fill="#fef3c7" stroke="#ea580c" stroke-width="1.5"/>
    <circle cx="22" cy="14" r="2.5" fill="#ea580c"/>
    <!-- Connecting line with sparkle -->
    <path d="M11 10 Q14 8 17 14" stroke="#c2410c" stroke-width="2" stroke-linecap="round" fill="none" stroke-dasharray="2 2"/>
    <circle cx="14" cy="10" r="2" fill="#fde047" stroke="#ca8a04" stroke-width="1"/>
  </svg>
</div>`;
}

// Render choose practice icon - target/bullseye for practice
function renderChoosePracticeIcon(size=32){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fed7aa,#fdba74);border:3px solid #c2410c;border-radius:${s*0.28}px;box-shadow:0 3px 8px rgba(0,0,0,0.2),inset 0 2px 4px rgba(255,255,255,0.4);overflow:hidden;display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.7}" height="${s*0.7}" viewBox="0 0 24 24">
    <!-- Outer ring -->
    <circle cx="12" cy="12" r="10" fill="none" stroke="#dc2626" stroke-width="2.5"/>
    <!-- Middle ring -->
    <circle cx="12" cy="12" r="6.5" fill="none" stroke="#f97316" stroke-width="2"/>
    <!-- Center dot -->
    <circle cx="12" cy="12" r="3" fill="#eab308" stroke="#ca8a04" stroke-width="1"/>
    <!-- Arrow hitting target -->
    <path d="M18 3 L12 9 M18 3 L15 4 M18 3 L17 6" stroke="#7c3aed" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
  </svg>
</div>`;
}

// Render guide icon - open book (orange themed)
function renderGuideIcon(size=26){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fed7aa,#fdba74);border:2px solid #c2410c;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.3);overflow:hidden;">
  <!-- Book spine -->
  <div style="position:absolute;top:${s*0.15}px;left:50%;transform:translateX(-50%);width:${s*0.08}px;height:${s*0.7}px;background:#c2410c;border-radius:${s*0.02}px;"></div>
  <!-- Left page -->
  <div style="position:absolute;top:${s*0.12}px;left:${s*0.1}px;width:${s*0.35}px;height:${s*0.72}px;background:linear-gradient(90deg,#fff,#fef3c7);border:1.5px solid #b45309;border-radius:${s*0.04}px 0 0 ${s*0.04}px;transform:rotate(-3deg);"></div>
  <!-- Right page -->
  <div style="position:absolute;top:${s*0.12}px;right:${s*0.1}px;width:${s*0.35}px;height:${s*0.72}px;background:linear-gradient(270deg,#fff,#fef3c7);border:1.5px solid #b45309;border-radius:0 ${s*0.04}px ${s*0.04}px 0;transform:rotate(3deg);"></div>
  <!-- Text lines left -->
  <div style="position:absolute;top:${s*0.25}px;left:${s*0.16}px;width:${s*0.22}px;height:${s*0.05}px;background:#d97706;opacity:0.4;border-radius:1px;"></div>
  <div style="position:absolute;top:${s*0.36}px;left:${s*0.16}px;width:${s*0.18}px;height:${s*0.05}px;background:#d97706;opacity:0.4;border-radius:1px;"></div>
  <!-- Text lines right -->
  <div style="position:absolute;top:${s*0.25}px;right:${s*0.16}px;width:${s*0.22}px;height:${s*0.05}px;background:#d97706;opacity:0.4;border-radius:1px;"></div>
  <div style="position:absolute;top:${s*0.36}px;right:${s*0.16}px;width:${s*0.18}px;height:${s*0.05}px;background:#d97706;opacity:0.4;border-radius:1px;"></div>
</div>`;
}

// Check if a verse is a Doctrine Mastery verse
function isDoctrineMastery(verse){
  if(!verse)return false;
  // Check if dm flag is already set
  if(verse.dm)return true;
  // Check against LDS_DOCTRINE_MASTERY array by reference
  const ref=verse.ref||`${verse.b||verse.book} ${verse.c||verse.chapter}:${verse.v||verse.verse}`;
  return LDS_DOCTRINE_MASTERY.some(dm=>{
    const dmRef=`${dm.b} ${dm.c}:${dm.v}`;
    return ref.includes(dm.b)&&ref.includes(dm.c+':')&&ref.includes(dm.v);
  });
}

// Render doctrine mastery icon - open book with star (for LDS Seminary scripture mastery)
function renderDoctrineMasteryIcon(size=16){
  const s=size;
  return`<div style="display:inline-flex;align-items:center;justify-content:center;width:${s}px;height:${s}px;background:linear-gradient(145deg,#818cf8,#6366f1);border-radius:${s*0.25}px;box-shadow:0 1px 2px rgba(0,0,0,0.2);" title="Doctrine Mastery">
  <svg width="${s*0.7}" height="${s*0.7}" viewBox="0 0 16 16" fill="none">
    <!-- Open book shape -->
    <path d="M2 4 L8 3 L14 4 L14 13 L8 12 L2 13 Z" fill="#fef3c7" stroke="#eab308" stroke-width="0.8"/>
    <!-- Spine -->
    <path d="M8 3 L8 12" stroke="#ca8a04" stroke-width="1"/>
    <!-- Star on book -->
    <path d="M8 5 L8.6 6.8 L10.5 6.8 L9 7.9 L9.5 9.7 L8 8.5 L6.5 9.7 L7 7.9 L5.5 6.8 L7.4 6.8 Z" fill="#fbbf24" stroke="#d97706" stroke-width="0.3"/>
  </svg>
</div>`;
}

// Render menu icon - gear/settings with 3D effect
function renderMenuIcon(size=26){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#e2e8f0,#cbd5e1);border:2px solid #64748b;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.7}" height="${s*0.7}" viewBox="0 0 24 24">
    <!-- Gear outer shape with teeth -->
    <path d="M12 0 L14 3 L17 2 L17 5 L20 6 L18 9 L21 12 L18 15 L20 18 L17 19 L17 22 L14 21 L12 24 L10 21 L7 22 L7 19 L4 18 L6 15 L3 12 L6 9 L4 6 L7 5 L7 2 L10 3 Z"
          fill="url(#gearGrad${s})" stroke="#475569" stroke-width="1.2" stroke-linejoin="round"/>
    <!-- Center circle -->
    <circle cx="12" cy="12" r="5" fill="#94a3b8" stroke="#475569" stroke-width="1.2"/>
    <!-- Inner circle (hole) -->
    <circle cx="12" cy="12" r="2.5" fill="#cbd5e1" stroke="#64748b" stroke-width="0.8"/>
    <!-- Highlight -->
    <path d="M8 8 Q10 6, 12 7" stroke="#fff" stroke-width="1" fill="none" opacity="0.5" stroke-linecap="round"/>
    <defs>
      <linearGradient id="gearGrad${s}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#94a3b8"/>
        <stop offset="50%" style="stop-color:#64748b"/>
        <stop offset="100%" style="stop-color:#475569"/>
      </linearGradient>
    </defs>
  </svg>
</div>`;
}

// Render growth icon - purple background with mini stage preview
function renderGrowthIcon(size=18, stage='blob', category='mammals'){
  const s=size;
  // Get a mini representation of the current stage
  let stageIcon='';
  const cat=CREATURE_CATEGORIES[category]||CREATURE_CATEGORIES.mammals;
  if(stage==='blob'){
    // Mini blob - pink fluffy ball with eyes
    stageIcon=`<div style="width:${s*0.65}px;height:${s*0.65}px;background:radial-gradient(circle at 35% 35%,#fff,#ec4899,#a855f7);border-radius:50%;position:relative;box-shadow:0 1px 2px rgba(0,0,0,0.2);">
      <div style="position:absolute;top:35%;left:25%;width:${s*0.12}px;height:${s*0.12}px;background:#000;border-radius:50%;"></div>
      <div style="position:absolute;top:35%;right:25%;width:${s*0.12}px;height:${s*0.12}px;background:#000;border-radius:50%;"></div>
    </div>`;
  }else if(stage==='baby'){
    // Mini baby - rounder body with small arms
    stageIcon=`<div style="width:${s*0.6}px;height:${s*0.7}px;position:relative;">
      <div style="width:100%;height:${s*0.45}px;background:radial-gradient(circle at 40% 30%,#fff,#ec4899,#a855f7);border-radius:50%;position:absolute;top:0;box-shadow:0 1px 2px rgba(0,0,0,0.2);">
        <div style="position:absolute;top:35%;left:22%;width:${s*0.1}px;height:${s*0.1}px;background:#000;border-radius:50%;"></div>
        <div style="position:absolute;top:35%;right:22%;width:${s*0.1}px;height:${s*0.1}px;background:#000;border-radius:50%;"></div>
      </div>
      <div style="width:${s*0.5}px;height:${s*0.35}px;background:linear-gradient(180deg,#ec4899,#a855f7);border-radius:40% 40% 50% 50%;position:absolute;bottom:0;left:50%;transform:translateX(-50%);"></div>
    </div>`;
  }else if(stage==='teen'){
    // Mini teen - taller with more defined shape
    stageIcon=`<div style="width:${s*0.55}px;height:${s*0.75}px;position:relative;">
      <div style="width:${s*0.4}px;height:${s*0.35}px;background:radial-gradient(circle at 40% 30%,#fff,#a855f7,#7c3aed);border-radius:45%;position:absolute;top:0;left:50%;transform:translateX(-50%);box-shadow:0 1px 2px rgba(0,0,0,0.2);">
        <div style="position:absolute;top:40%;left:25%;width:${s*0.08}px;height:${s*0.08}px;background:#000;border-radius:50%;"></div>
        <div style="position:absolute;top:40%;right:25%;width:${s*0.08}px;height:${s*0.08}px;background:#000;border-radius:50%;"></div>
      </div>
      <div style="width:${s*0.45}px;height:${s*0.45}px;background:linear-gradient(180deg,#a855f7,#7c3aed);border-radius:35% 35% 45% 45%;position:absolute;bottom:0;left:50%;transform:translateX(-50%);"></div>
    </div>`;
  }else{
    // Adult - fully formed creature silhouette
    stageIcon=`<div style="width:${s*0.55}px;height:${s*0.7}px;position:relative;">
      <div style="width:${s*0.38}px;height:${s*0.32}px;background:radial-gradient(circle at 40% 30%,#fff,#7c3aed,#5b21b6);border-radius:45%;position:absolute;top:0;left:50%;transform:translateX(-50%);box-shadow:0 1px 2px rgba(0,0,0,0.2);">
        <div style="position:absolute;top:38%;left:25%;width:${s*0.07}px;height:${s*0.07}px;background:#000;border-radius:50%;"></div>
        <div style="position:absolute;top:38%;right:25%;width:${s*0.07}px;height:${s*0.07}px;background:#000;border-radius:50%;"></div>
      </div>
      <div style="width:${s*0.5}px;height:${s*0.45}px;background:linear-gradient(180deg,#7c3aed,#5b21b6);border-radius:30% 30% 45% 45%;position:absolute;bottom:0;left:50%;transform:translateX(-50%);"></div>
    </div>`;
  }
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#c4b5fd,#a78bfa);border:2px solid #7c3aed;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;overflow:hidden;">
  ${stageIcon}
</div>`;
}

// Render health icon - cute heart with gradient and shine
function renderHealthIcon(size=18){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fecaca,#fca5a5);border:2px solid #dc2626;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.7}" height="${s*0.7}" viewBox="0 0 24 24">
    <!-- Heart shape -->
    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
          fill="url(#heartGrad${s})" stroke="#b91c1c" stroke-width="1.2"/>
    <!-- Shine highlight -->
    <ellipse cx="8" cy="8" rx="2.5" ry="2" fill="#fff" opacity="0.5" transform="rotate(-30 8 8)"/>
    <defs>
      <linearGradient id="heartGrad${s}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#f87171"/>
        <stop offset="50%" style="stop-color:#ef4444"/>
        <stop offset="100%" style="stop-color:#dc2626"/>
      </linearGradient>
    </defs>
  </svg>
</div>`;
}

// Render happiness icon - cute smiley face with rosy cheeks
function renderHappinessIcon(size=18){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fef08a,#fde047);border:2px solid #ca8a04;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.75}" height="${s*0.75}" viewBox="0 0 24 24">
    <!-- Face circle -->
    <circle cx="12" cy="12" r="10" fill="url(#faceGrad${s})" stroke="#d97706" stroke-width="1.2"/>
    <!-- Left eye -->
    <ellipse cx="8" cy="10" rx="1.8" ry="2.2" fill="#1a1a1a"/>
    <circle cx="7.5" cy="9.5" r="0.6" fill="#fff"/>
    <!-- Right eye -->
    <ellipse cx="16" cy="10" rx="1.8" ry="2.2" fill="#1a1a1a"/>
    <circle cx="15.5" cy="9.5" r="0.6" fill="#fff"/>
    <!-- Rosy cheeks -->
    <ellipse cx="5.5" cy="14" rx="2" ry="1.2" fill="#fda4af" opacity="0.6"/>
    <ellipse cx="18.5" cy="14" rx="2" ry="1.2" fill="#fda4af" opacity="0.6"/>
    <!-- Smile -->
    <path d="M7 15 Q12 20, 17 15" stroke="#92400e" stroke-width="1.8" fill="none" stroke-linecap="round"/>
    <defs>
      <linearGradient id="faceGrad${s}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#fef9c3"/>
        <stop offset="50%" style="stop-color:#fde047"/>
        <stop offset="100%" style="stop-color:#facc15"/>
      </linearGradient>
    </defs>
  </svg>
</div>`;
}

// Render XP icon - sparkle star with shine
function renderXPIcon(size=24){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fef9c3,#fde047);border:2px solid #ca8a04;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.7}" height="${s*0.7}" viewBox="0 0 24 24">
    <!-- 4-pointed star -->
    <path d="M12 2 L14 9 L21 9 L15.5 13.5 L17.5 21 L12 16.5 L6.5 21 L8.5 13.5 L3 9 L10 9 Z"
          fill="url(#xpGrad${s})" stroke="#b45309" stroke-width="1"/>
    <!-- Inner sparkle -->
    <circle cx="12" cy="11" r="2.5" fill="#fef9c3" opacity="0.8"/>
    <!-- Shine dots -->
    <circle cx="9" cy="7" r="1" fill="#fff" opacity="0.7"/>
    <circle cx="15" cy="13" r="0.8" fill="#fff" opacity="0.5"/>
    <defs>
      <linearGradient id="xpGrad${s}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#fef08a"/>
        <stop offset="50%" style="stop-color:#fbbf24"/>
        <stop offset="100%" style="stop-color:#f59e0b"/>
      </linearGradient>
    </defs>
  </svg>
</div>`;
}

// Render streak icon - flame with warm glow
function renderStreakIcon(size=24){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fed7aa,#fdba74);border:2px solid #ea580c;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.65}" height="${s*0.75}" viewBox="0 0 20 24">
    <!-- Outer flame -->
    <path d="M10 2 C10 2 4 8 4 14 C4 18 6.5 21 10 21 C13.5 21 16 18 16 14 C16 8 10 2 10 2 Z"
          fill="url(#flameGrad${s})" stroke="#c2410c" stroke-width="1"/>
    <!-- Inner flame -->
    <path d="M10 8 C10 8 7 12 7 15 C7 17 8.5 18.5 10 18.5 C11.5 18.5 13 17 13 15 C13 12 10 8 10 8 Z"
          fill="url(#innerFlameGrad${s})"/>
    <!-- Highlight -->
    <ellipse cx="8" cy="12" rx="1.5" ry="2" fill="#fef3c7" opacity="0.6"/>
    <defs>
      <linearGradient id="flameGrad${s}" x1="50%" y1="100%" x2="50%" y2="0%">
        <stop offset="0%" style="stop-color:#dc2626"/>
        <stop offset="40%" style="stop-color:#f97316"/>
        <stop offset="100%" style="stop-color:#fbbf24"/>
      </linearGradient>
      <linearGradient id="innerFlameGrad${s}" x1="50%" y1="100%" x2="50%" y2="0%">
        <stop offset="0%" style="stop-color:#f97316"/>
        <stop offset="100%" style="stop-color:#fef08a"/>
      </linearGradient>
    </defs>
  </svg>
</div>`;
}

// Render egg progress icon - cute egg with sparkle
function renderEggProgressIcon(size=18){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#c4b5fd,#a78bfa);border:2px solid #7c3aed;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.75}" height="${s*0.85}" viewBox="0 0 20 24">
    <!-- Egg shape -->
    <ellipse cx="10" cy="13" rx="8" ry="10" fill="url(#eggGrad${s})" stroke="#6d28d9" stroke-width="1.2"/>
    <!-- Egg highlight -->
    <ellipse cx="7" cy="10" rx="2.5" ry="3" fill="#fff" opacity="0.4" transform="rotate(-15 7 10)"/>
    <!-- Sparkle -->
    <path d="M15 4 L16 6 L18 5 L16 7 L17 9 L15 7 L13 8 L14 6 Z" fill="#fbbf24" stroke="#ca8a04" stroke-width="0.5"/>
    <defs>
      <linearGradient id="eggGrad${s}" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#f5f3ff"/>
        <stop offset="40%" style="stop-color:#ede9fe"/>
        <stop offset="100%" style="stop-color:#ddd6fe"/>
      </linearGradient>
    </defs>
  </svg>
</div>`;
}

// Render album icon - cute photo album/scrapbook
function renderAlbumIcon(size=26){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#c4b5fd,#a78bfa);border:2px solid #7c3aed;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.75}" height="${s*0.7}" viewBox="0 0 24 22">
    <!-- Book cover back -->
    <rect x="4" y="2" width="17" height="18" rx="2" fill="#6d28d9" stroke="#5b21b6" stroke-width="1"/>
    <!-- Book spine -->
    <rect x="2" y="2" width="4" height="18" rx="1" fill="#5b21b6" stroke="#4c1d95" stroke-width="1"/>
    <!-- Spine rings -->
    <circle cx="4" cy="5" r="1" fill="#fbbf24" stroke="#d97706" stroke-width="0.5"/>
    <circle cx="4" cy="11" r="1" fill="#fbbf24" stroke="#d97706" stroke-width="0.5"/>
    <circle cx="4" cy="17" r="1" fill="#fbbf24" stroke="#d97706" stroke-width="0.5"/>
    <!-- Book pages -->
    <rect x="6" y="4" width="13" height="14" rx="1" fill="#fefce8" stroke="#d4d4d4" stroke-width="0.5"/>
    <!-- Photo 1 -->
    <rect x="8" y="6" width="5" height="4" rx="0.5" fill="#bfdbfe" stroke="#3b82f6" stroke-width="0.8"/>
    <!-- Photo 2 -->
    <rect x="14" y="6" width="4" height="4" rx="0.5" fill="#bbf7d0" stroke="#22c55e" stroke-width="0.8"/>
    <!-- Photo 3 -->
    <rect x="8" y="11" width="4" height="5" rx="0.5" fill="#fecaca" stroke="#ef4444" stroke-width="0.8"/>
    <!-- Photo 4 -->
    <rect x="13" y="11" width="5" height="5" rx="0.5" fill="#fef08a" stroke="#eab308" stroke-width="0.8"/>
    <!-- Little heart on one photo -->
    <path d="M15 13 Q14.5 12.5, 15 12.2 Q15.5 12.5, 15 13 Z" fill="#ec4899"/>
  </svg>
</div>`;
}

// Render move icon - 4-direction cross arrow for customizing positions
function renderMoveIcon(size=20){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#c4b5fd,#a78bfa);border:2px solid #7c3aed;border-radius:${s*0.3}px;box-shadow:0 2px 4px rgba(0,0,0,0.15);display:flex;align-items:center;justify-content:center;">
  <!-- Cross arrows using SVG -->
  <svg width="${s*0.7}" height="${s*0.7}" viewBox="0 0 24 24" fill="none">
    <!-- Vertical arrow -->
    <path d="M12 2L8 6h3v4h2V6h3L12 2z" fill="white"/>
    <path d="M12 22L16 18h-3v-4h-2v4H8L12 22z" fill="white"/>
    <!-- Horizontal arrow -->
    <path d="M2 12L6 8v3h4v2H6v3L2 12z" fill="white"/>
    <path d="M22 12L18 16v-3h-4v-2h4V8L22 12z" fill="white"/>
  </svg>
</div>`;
}

// Trade section icons - matching home screen design language

// Pending trades icon - hourglass/timer
function renderPendingIcon(size=28){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fef08a,#fde047);border:2px solid #ca8a04;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.6}" height="${s*0.7}" viewBox="0 0 20 24">
    <!-- Top bulb -->
    <path d="M4 2 L16 2 L16 4 Q16 8, 10 12 Q4 8, 4 4 Z" fill="#fbbf24" stroke="#92400e" stroke-width="1.5"/>
    <!-- Bottom bulb -->
    <path d="M4 22 L16 22 L16 20 Q16 16, 10 12 Q4 16, 4 20 Z" fill="#fbbf24" stroke="#92400e" stroke-width="1.5"/>
    <!-- Sand in bottom -->
    <path d="M6 22 L14 22 L14 19 Q14 17, 10 15 Q6 17, 6 19 Z" fill="#d97706"/>
    <!-- Top/bottom caps -->
    <rect x="3" y="0" width="14" height="2" rx="1" fill="#92400e"/>
    <rect x="3" y="22" width="14" height="2" rx="1" fill="#92400e"/>
  </svg>
</div>`;
}

// Receive/get icon - open hands receiving
function renderReceiveIcon(size=28){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#c4b5fd,#a78bfa);border:2px solid #7c3aed;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.7}" height="${s*0.6}" viewBox="0 0 24 20">
    <!-- Left hand -->
    <path d="M2 14 Q2 10, 6 10 L8 10 Q10 10, 10 12 L10 16 Q10 18, 8 18 L4 18 Q2 18, 2 16 Z" fill="#fef3c7" stroke="#7c3aed" stroke-width="1.2"/>
    <!-- Right hand -->
    <path d="M22 14 Q22 10, 18 10 L16 10 Q14 10, 14 12 L14 16 Q14 18, 16 18 L20 18 Q22 18, 22 16 Z" fill="#fef3c7" stroke="#7c3aed" stroke-width="1.2"/>
    <!-- Gift/item being received -->
    <rect x="9" y="4" width="6" height="6" rx="1" fill="#ec4899" stroke="#be185d" stroke-width="1"/>
    <line x1="12" y1="4" x2="12" y2="10" stroke="#be185d" stroke-width="0.8"/>
    <line x1="9" y1="7" x2="15" y2="7" stroke="#be185d" stroke-width="0.8"/>
    <!-- Sparkles -->
    <circle cx="6" cy="6" r="1" fill="#fbbf24"/>
    <circle cx="18" cy="6" r="1" fill="#fbbf24"/>
  </svg>
</div>`;
}

// Give Scribby icon - cute paw
function renderGiveScribbyIcon(size=28){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#c4b5fd,#a78bfa);border:2px solid #7c3aed;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.65}" height="${s*0.65}" viewBox="0 0 24 24">
    <!-- Main pad -->
    <ellipse cx="12" cy="16" rx="7" ry="5" fill="#fef3c7" stroke="#7c3aed" stroke-width="1.5"/>
    <!-- Toe beans -->
    <ellipse cx="6" cy="9" rx="2.5" ry="3" fill="#fef3c7" stroke="#7c3aed" stroke-width="1.2"/>
    <ellipse cx="11" cy="6" rx="2.5" ry="3" fill="#fef3c7" stroke="#7c3aed" stroke-width="1.2"/>
    <ellipse cx="17" cy="7" rx="2.5" ry="3" fill="#fef3c7" stroke="#7c3aed" stroke-width="1.2"/>
    <ellipse cx="20" cy="11" rx="2" ry="2.5" fill="#fef3c7" stroke="#7c3aed" stroke-width="1.2"/>
    <!-- Heart in center -->
    <path d="M12 18 C10 16, 9 15, 9 14 C9 13, 10 12, 11 12 C11.5 12, 12 12.5, 12 13 C12 12.5, 12.5 12, 13 12 C14 12, 15 13, 15 14 C15 15, 14 16, 12 18 Z" fill="#ec4899"/>
  </svg>
</div>`;
}

// Give Food icon - apple with leaf
function renderGiveFoodIcon(size=28){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fed7aa,#fdba74);border:2px solid #c2410c;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.6}" height="${s*0.7}" viewBox="0 0 20 24">
    <!-- Apple body -->
    <path d="M10 8 C4 8, 2 14, 2 17 C2 21, 5 23, 10 23 C15 23, 18 21, 18 17 C18 14, 16 8, 10 8 Z" fill="#ef4444" stroke="#b91c1c" stroke-width="1.5"/>
    <!-- Apple highlight -->
    <ellipse cx="7" cy="14" rx="2" ry="3" fill="#fca5a5" opacity="0.6"/>
    <!-- Stem -->
    <path d="M10 8 Q10 5, 11 3" stroke="#78350f" stroke-width="2" fill="none" stroke-linecap="round"/>
    <!-- Leaf -->
    <path d="M11 4 Q14 2, 16 4 Q14 6, 11 5 Z" fill="#22c55e" stroke="#15803d" stroke-width="0.8"/>
  </svg>
</div>`;
}

// Give Accessories icon - party hat
function renderGiveAccessoriesIcon(size=28){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fbcfe8,#f9a8d4);border:2px solid #db2777;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.6}" height="${s*0.7}" viewBox="0 0 20 24">
    <!-- Hat body -->
    <path d="M10 2 L3 20 L17 20 Z" fill="#ec4899" stroke="#be185d" stroke-width="1.5"/>
    <!-- Stripes -->
    <path d="M7 12 L13 12" stroke="#fbbf24" stroke-width="2"/>
    <path d="M5.5 16 L14.5 16" stroke="#fbbf24" stroke-width="2"/>
    <!-- Pom pom -->
    <circle cx="10" cy="2" r="2.5" fill="#fbbf24" stroke="#d97706" stroke-width="1"/>
    <!-- Brim -->
    <ellipse cx="10" cy="20" rx="8" ry="2" fill="#db2777" stroke="#be185d" stroke-width="1"/>
  </svg>
</div>`;
}

// Give Room Items icon - cozy armchair
function renderGiveRoomIcon(size=28){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#bfdbfe,#93c5fd);border:2px solid #2563eb;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.7}" height="${s*0.65}" viewBox="0 0 24 22">
    <!-- Chair back -->
    <path d="M6 4 L18 4 Q20 4, 20 6 L20 12 L4 12 L4 6 Q4 4, 6 4 Z" fill="#8b5cf6" stroke="#5b21b6" stroke-width="1.5"/>
    <!-- Seat cushion -->
    <rect x="4" y="12" width="16" height="5" rx="2" fill="#a78bfa" stroke="#5b21b6" stroke-width="1.2"/>
    <!-- Left armrest -->
    <rect x="2" y="8" width="3" height="9" rx="1.5" fill="#8b5cf6" stroke="#5b21b6" stroke-width="1"/>
    <!-- Right armrest -->
    <rect x="19" y="8" width="3" height="9" rx="1.5" fill="#8b5cf6" stroke="#5b21b6" stroke-width="1"/>
    <!-- Legs -->
    <rect x="6" y="17" width="2" height="4" rx="0.5" fill="#78350f"/>
    <rect x="16" y="17" width="2" height="4" rx="0.5" fill="#78350f"/>
  </svg>
</div>`;
}

// How it works icon - lightbulb
function renderHowItWorksIcon(size=28){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;background:linear-gradient(145deg,#fef08a,#fde047);border:2px solid #ca8a04;border-radius:${s*0.32}px;box-shadow:0 2px 4px rgba(0,0,0,0.15),inset 0 1px 2px rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;">
  <svg width="${s*0.55}" height="${s*0.7}" viewBox="0 0 18 24">
    <!-- Bulb glass -->
    <path d="M9 2 C4 2, 2 6, 2 10 C2 14, 5 16, 6 18 L12 18 C13 16, 16 14, 16 10 C16 6, 14 2, 9 2 Z" fill="#fef3c7" stroke="#ca8a04" stroke-width="1.5"/>
    <!-- Filament glow -->
    <ellipse cx="9" cy="10" rx="3" ry="4" fill="#fbbf24" opacity="0.6"/>
    <!-- Base -->
    <rect x="6" y="18" width="6" height="2" fill="#9ca3af" stroke="#6b7280" stroke-width="0.8"/>
    <rect x="6" y="20" width="6" height="2" rx="1" fill="#6b7280"/>
    <!-- Light rays -->
    <line x1="9" y1="0" x2="9" y2="-1" stroke="#fbbf24" stroke-width="1.5" stroke-linecap="round" transform="translate(0,2)"/>
    <line x1="3" y1="5" x2="1" y2="4" stroke="#fbbf24" stroke-width="1.5" stroke-linecap="round"/>
    <line x1="15" y1="5" x2="17" y2="4" stroke="#fbbf24" stroke-width="1.5" stroke-linecap="round"/>
  </svg>
</div>`;
}

// Render cute trading cards icon in Scribby style
function renderTradeIcon(size=40){
  const s=size;
  const cardW=s*0.42;
  const cardH=s*0.65;
  return`
<div style="position:relative;width:${s}px;height:${s}px;">
  <!-- Left card -->
  <div style="position:absolute;left:0;top:${s*0.14}px;width:${cardW}px;height:${cardH}px;background:linear-gradient(145deg,#c4b5fd,#8b5cf6);border:3px solid #6d28d9;border-radius:${s*0.1}px;box-shadow:0 3px 8px rgba(0,0,0,0.25);">
    <div style="position:absolute;top:${s*0.08}px;left:50%;transform:translateX(-50%);width:${s*0.28}px;height:${s*0.26}px;background:white;border-radius:${s*0.06}px;display:flex;align-items:center;justify-content:center;">
      <div style="font-size:${s*0.2}px;">ðŸ¾</div>
    </div>
    <div style="position:absolute;bottom:${s*0.05}px;left:50%;transform:translateX(-50%);width:${s*0.26}px;height:${s*0.03}px;background:rgba(255,255,255,0.6);border-radius:2px;"></div>
  </div>
  <!-- Right card (yellow/gold) -->
  <div style="position:absolute;right:0;top:${s*0.14}px;width:${cardW}px;height:${cardH}px;background:linear-gradient(145deg,#fde047,#f59e0b);border:3px solid #b45309;border-radius:${s*0.1}px;box-shadow:0 3px 8px rgba(0,0,0,0.25);">
    <div style="position:absolute;top:${s*0.08}px;left:50%;transform:translateX(-50%);width:${s*0.28}px;height:${s*0.26}px;background:white;border-radius:${s*0.06}px;display:flex;align-items:center;justify-content:center;">
      <div style="font-size:${s*0.2}px;">âœ¨</div>
    </div>
    <div style="position:absolute;bottom:${s*0.05}px;left:50%;transform:translateX(-50%);width:${s*0.26}px;height:${s*0.03}px;background:rgba(255,255,255,0.6);border-radius:2px;"></div>
  </div>
  <!-- Bidirectional arrow in center -->
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.95);border-radius:50%;width:${s*0.32}px;height:${s*0.32}px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.25);border:2px solid #7c3aed;">
    <span style="color:#7c3aed;font-size:${s*0.22}px;font-weight:bold;">â‡„</span>
  </div>
</div>`;
}

// Render verses/scripture icon - detailed scroll with decorative elements
function renderVersesIcon(size=40){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;">
  <!-- Shadow layer -->
  <div style="position:absolute;left:${s*0.12}px;top:${s*0.14}px;width:${s*0.8}px;height:${s*0.78}px;background:rgba(0,0,0,0.15);border-radius:${s*0.08}px;filter:blur(2px);"></div>
  <!-- Main scroll parchment -->
  <div style="position:absolute;left:${s*0.08}px;top:${s*0.12}px;width:${s*0.84}px;height:${s*0.76}px;background:linear-gradient(135deg,#fefce8 0%,#fef3c7 50%,#fde68a 100%);border:3px solid #92400e;border-radius:${s*0.06}px;box-shadow:inset 0 2px 4px rgba(255,255,255,0.5),inset 0 -2px 4px rgba(0,0,0,0.1);">
    <!-- Parchment texture overlay -->
    <div style="position:absolute;inset:0;background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,0.3) 50%,transparent 100%);border-radius:${s*0.04}px;"></div>
    <!-- Text lines with varying lengths -->
    <div style="position:absolute;top:${s*0.22}px;left:${s*0.1}px;width:${s*0.55}px;height:${s*0.055}px;background:linear-gradient(90deg,#78350f,#92400e);border-radius:2px;opacity:0.6;"></div>
    <div style="position:absolute;top:${s*0.32}px;left:${s*0.1}px;width:${s*0.48}px;height:${s*0.055}px;background:linear-gradient(90deg,#78350f,#92400e);border-radius:2px;opacity:0.5;"></div>
    <div style="position:absolute;top:${s*0.42}px;left:${s*0.1}px;width:${s*0.58}px;height:${s*0.055}px;background:linear-gradient(90deg,#78350f,#92400e);border-radius:2px;opacity:0.6;"></div>
    <div style="position:absolute;top:${s*0.52}px;left:${s*0.1}px;width:${s*0.4}px;height:${s*0.055}px;background:linear-gradient(90deg,#78350f,#92400e);border-radius:2px;opacity:0.5;"></div>
  </div>
  <!-- Top scroll roll with wood texture -->
  <div style="position:absolute;left:${s*0.02}px;top:${s*0.02}px;width:${s*0.96}px;height:${s*0.18}px;background:linear-gradient(180deg,#fbbf24 0%,#f59e0b 30%,#d97706 70%,#b45309 100%);border:3px solid #78350f;border-radius:${s*0.09}px;box-shadow:0 3px 6px rgba(0,0,0,0.25),inset 0 2px 3px rgba(255,255,255,0.3);">
    <!-- Wood grain lines -->
    <div style="position:absolute;top:${s*0.04}px;left:${s*0.08}px;right:${s*0.08}px;height:1px;background:rgba(120,53,15,0.3);"></div>
    <div style="position:absolute;top:${s*0.08}px;left:${s*0.06}px;right:${s*0.06}px;height:1px;background:rgba(120,53,15,0.2);"></div>
    <!-- End caps -->
    <div style="position:absolute;left:0;top:0;bottom:0;width:${s*0.08}px;background:linear-gradient(90deg,#b45309,#d97706);border-radius:${s*0.09}px 0 0 ${s*0.09}px;"></div>
    <div style="position:absolute;right:0;top:0;bottom:0;width:${s*0.08}px;background:linear-gradient(270deg,#b45309,#d97706);border-radius:0 ${s*0.09}px ${s*0.09}px 0;"></div>
  </div>
  <!-- Bottom scroll roll -->
  <div style="position:absolute;left:${s*0.02}px;bottom:${s*0.02}px;width:${s*0.96}px;height:${s*0.18}px;background:linear-gradient(0deg,#fbbf24 0%,#f59e0b 30%,#d97706 70%,#b45309 100%);border:3px solid #78350f;border-radius:${s*0.09}px;box-shadow:0 3px 6px rgba(0,0,0,0.25),inset 0 -2px 3px rgba(255,255,255,0.3);">
    <!-- End caps -->
    <div style="position:absolute;left:0;top:0;bottom:0;width:${s*0.08}px;background:linear-gradient(90deg,#b45309,#d97706);border-radius:${s*0.09}px 0 0 ${s*0.09}px;"></div>
    <div style="position:absolute;right:0;top:0;bottom:0;width:${s*0.08}px;background:linear-gradient(270deg,#b45309,#d97706);border-radius:0 ${s*0.09}px ${s*0.09}px 0;"></div>
  </div>
  <!-- Decorative sparkle -->
  <div style="position:absolute;top:0;right:0;font-size:${s*0.25}px;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.2));">âœ¨</div>
</div>`;
}

// Render library icon - detailed stacked books with pages and decorations
function renderLibraryIcon(size=40){
  const s=size;
  return`
<div style="position:relative;width:${s}px;height:${s}px;">
  <!-- Shadow layer -->
  <div style="position:absolute;left:${s*0.1}px;bottom:${s*0.04}px;width:${s*0.85}px;height:${s*0.7}px;background:rgba(0,0,0,0.15);border-radius:${s*0.06}px;filter:blur(2px);"></div>

  <!-- Bottom book (blue) -->
  <div style="position:absolute;left:${s*0.04}px;bottom:${s*0.06}px;width:${s*0.92}px;height:${s*0.26}px;background:linear-gradient(145deg,#60a5fa,#2563eb);border:3px solid #1d4ed8;border-radius:${s*0.04}px ${s*0.08}px ${s*0.08}px ${s*0.04}px;box-shadow:0 3px 6px rgba(0,0,0,0.2),inset 0 1px 2px rgba(255,255,255,0.3);">
    <!-- Page edges -->
    <div style="position:absolute;left:${s*0.06}px;top:${s*0.03}px;bottom:${s*0.03}px;width:${s*0.04}px;background:linear-gradient(90deg,#f5f5f4,#e7e5e4);border-radius:1px;"></div>
    <!-- Spine detail -->
    <div style="position:absolute;right:${s*0.08}px;top:50%;transform:translateY(-50%);width:${s*0.5}px;height:${s*0.05}px;background:rgba(255,255,255,0.25);border-radius:2px;"></div>
  </div>

  <!-- Middle book (orange/gold) -->
  <div style="position:absolute;left:${s*0.08}px;bottom:${s*0.28}px;width:${s*0.84}px;height:${s*0.26}px;background:linear-gradient(145deg,#fbbf24,#d97706);border:3px solid #b45309;border-radius:${s*0.04}px ${s*0.08}px ${s*0.08}px ${s*0.04}px;box-shadow:0 3px 6px rgba(0,0,0,0.2),inset 0 1px 2px rgba(255,255,255,0.3);">
    <!-- Page edges -->
    <div style="position:absolute;left:${s*0.06}px;top:${s*0.03}px;bottom:${s*0.03}px;width:${s*0.04}px;background:linear-gradient(90deg,#fefce8,#fef3c7);border-radius:1px;"></div>
    <!-- Spine detail -->
    <div style="position:absolute;right:${s*0.1}px;top:50%;transform:translateY(-50%);width:${s*0.4}px;height:${s*0.05}px;background:rgba(255,255,255,0.3);border-radius:2px;"></div>
  </div>

  <!-- Top book (purple) -->
  <div style="position:absolute;left:${s*0.02}px;bottom:${s*0.5}px;width:${s*0.96}px;height:${s*0.28}px;background:linear-gradient(145deg,#a78bfa,#7c3aed);border:3px solid #5b21b6;border-radius:${s*0.04}px ${s*0.08}px ${s*0.08}px ${s*0.04}px;box-shadow:0 3px 6px rgba(0,0,0,0.25),inset 0 1px 2px rgba(255,255,255,0.3);">
    <!-- Page edges -->
    <div style="position:absolute;left:${s*0.06}px;top:${s*0.03}px;bottom:${s*0.03}px;width:${s*0.05}px;background:linear-gradient(90deg,#f5f5f4,#e7e5e4);border-radius:1px;"></div>
    <!-- Decorative title bar -->
    <div style="position:absolute;right:${s*0.12}px;top:50%;transform:translateY(-50%);width:${s*0.45}px;height:${s*0.08}px;background:linear-gradient(90deg,rgba(255,255,255,0.4),rgba(255,255,255,0.2));border-radius:2px;border:1px solid rgba(255,255,255,0.3);"></div>
    <!-- Small star decoration -->
    <div style="position:absolute;right:${s*0.62}px;top:50%;transform:translateY(-50%);font-size:${s*0.12}px;">â­</div>
  </div>

  <!-- Bookmark ribbon -->
  <div style="position:absolute;right:${s*0.2}px;top:${s*0.12}px;width:${s*0.1}px;height:${s*0.36}px;background:linear-gradient(180deg,#f43f5e,#e11d48);border:1px solid #be123c;border-radius:0 0 ${s*0.03}px ${s*0.03}px;box-shadow:0 2px 4px rgba(0,0,0,0.2);">
    <!-- Ribbon notch -->
    <div style="position:absolute;bottom:0;left:0;right:0;height:${s*0.06}px;background:linear-gradient(135deg,transparent 40%,#f43f5e 40%,#f43f5e 60%,transparent 60%);"></div>
  </div>
</div>`;
}

function renderBuddyVisual(){
  const stage=S.buddyStage||'egg';
  let buddyHTML='';

  // Determine XP state based on growth percentage
  let xpState=''; // sleeping, drowsy, awake, happy, excited, ready-evolve
  let growthPct=0;

  if(stage==='egg'){
    growthPct=(S.eggXP||0)/STAGES.egg.hatchXP*100;
  }else if(stage!=='adult'){
    const stageData=STAGES[stage];
    growthPct=(S.growthXP||0)/stageData.growthNeeded*100;
  }else{
    growthPct=100; // Adults are always "complete"
  }

  // Assign state based on percentage thresholds
  if(growthPct<10){
    xpState='sleeping';
  }else if(growthPct<25){
    xpState='drowsy';
  }else if(growthPct<50){
    xpState='awake';
  }else if(growthPct<75){
    xpState='happy';
  }else if(growthPct<90){
    xpState='excited';
  }else if(stage!=='adult'){
    xpState='ready-evolve'; // 90%+ and not adult = ready to evolve
  }else{
    xpState=''; // Adult - no special state
  }

  if(stage==='egg'){
    const xp=S.eggXP||0;

    // Animation classes based on hatching progress (like Tamagotchi!)
    let animClass='';
    if(xp>=75){
      animClass='egg-hatch-wiggle sparkle';  // Intense shaking + sparkles
    }else if(xp>=50){
      animClass='egg-wiggle';  // Vigorous wiggling
    }else if(xp>=25){
      animClass='egg-rock';  // Gentle rocking
    }else{
      animClass='';  // Completely still at the start
    }

    buddyHTML=`<div class="egg-container ${animClass}" style="position:relative;">${renderEggParticles(xp, S.creatureCategory)}${renderEgg(S.creatureCategory)}</div>`;
  }else if(stage==='blob'){
    buddyHTML=renderBlob(S.creatureCategory);
  }else if(stage==='child'){
    buddyHTML=renderBaby(S.creatureCategory);
  }else if(stage==='teen'){
    buddyHTML=renderTeen(S.creatureCategory,S.creatureVariant);
  }else if(stage==='adult'){
    // Adult stage - custom detailed designs per category
    // Add new categories here as render functions are created
    if(S.creatureCategory==='birds'){
      buddyHTML=renderAdultBird(S.creatureVariant);
    }else if(S.creatureCategory==='reptiles'){
      buddyHTML=renderAdultReptile(S.creatureVariant);
    }else if(S.creatureCategory==='mammals'){
      buddyHTML=renderAdultMammal(S.creatureVariant);
    }else if(S.creatureCategory==='mystical'){
      buddyHTML=renderAdultMystical(S.creatureVariant);
    }else if(S.creatureCategory==='prehistoric'){
      buddyHTML=renderAdultPrehistoric(S.creatureVariant);
    }else if(S.creatureCategory==='aquatic'){
      buddyHTML=renderAdultAquatic(S.creatureVariant);
    }else if(S.creatureCategory==='alien'){
      buddyHTML=renderAdultAlien(S.creatureVariant);
    }else if(S.creatureCategory==='insects'){
      buddyHTML=renderAdultInsect(S.creatureVariant);
    }else{
      // Fallback to emoji for categories without render functions yet
      buddyHTML=getBuddyEmoji();
    }
  }else{
    // Fallback
    buddyHTML=getBuddyEmoji();
  }
  // Wrap buddy with accessories (furniture is rendered separately to stay static)
  const customizeClass=customizeMode?' customize-mode':'';
  const stateClass=xpState?' '+xpState:'';

  // Generate state-specific decorations
  let stateDecorations='';
  if(xpState==='sleeping'){
    stateDecorations='<div class="sleeping-zs"><span class="sleeping-z">z</span><span class="sleeping-z">Z</span><span class="sleeping-z">z</span></div>';
  }else if(xpState==='excited'){
    stateDecorations='<div class="excited-particles"><span>â­</span><span>ðŸ’«</span><span>âœ¨</span></div>';
  }else if(xpState==='ready-evolve'){
    stateDecorations='<div class="ready-sparkles"><span>ðŸŒŸ</span><span>âœ¨</span><span>ðŸ’«</span><span>â­</span></div>';
  }

  return`<div class="buddy-card-container${customizeClass}"><div class="buddy-with-accessories${stateClass}">${stateDecorations}${renderAccessories()}${buddyHTML}</div></div>`;
}

// Large practice header - prominent Scribby centered with XP bar beside it
function getPracticeStatusBar(){
  const stage=S.buddyStage||'egg';
  let xpCurrent, xpMax, xpPercent;
  if(stage==='egg'){
    xpCurrent=S.eggXP||0;
    xpMax=STAGES.egg.hatchXP;
    xpPercent=Math.min(xpCurrent/xpMax*100,100);
  }else if(stage==='adult'){
    xpCurrent=xpMax=100;
    xpPercent=100;
  }else{
    xpCurrent=S.growthXP||0;
    xpMax=STAGES[stage].growthNeeded;
    xpPercent=Math.min(xpCurrent/xpMax*100,100);
  }

  const anim=practiceReaction?
    (practiceReaction.type==='wrong'?'practice-sad':
     practiceReaction.type==='celebrate'?'practice-celebrate':'practice-bounce'):'';
  const reactionEmojis=practiceReaction?practiceReaction.emojis.map((e,i)=>
    `<span style="position:absolute;left:50%;top:-15px;font-size:36px;animation:float-up-hearts 0.7s ease-out forwards;z-index:100;">${e}</span>`
  ).join(''):'';

  // Much larger Scribby - 200px container with scale 0.8
  return`<div class="bg-white/10 rounded-2xl p-5 mb-3 overflow-hidden">
    <div class="flex items-center justify-center gap-6">
      <div class="relative flex-shrink-0" style="width:200px;height:200px;overflow:hidden;">
        <div class="${anim}" style="transform-origin:center center;width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
          <div style="transform:scale(0.83);transform-origin:center center;">
            ${renderBuddyVisual()}
          </div>
        </div>
        ${reactionEmojis}
      </div>
      <div class="flex-1 max-w-xs">
        <p class="text-white font-bold text-2xl mb-2">${S.buddyName||'Buddy'}${practiceStreak>=3?` <span class="text-orange-300 text-lg">ðŸ”¥${practiceStreak}</span>`:''}</p>
        <div class="flex items-center gap-2 mb-2">
          <span class="text-yellow-300">âœ¨</span>
          <span class="text-white font-semibold">${stage==='adult'?'Max Level':`${xpCurrent}/${xpMax} XP`}</span>
        </div>
        <div class="h-4 bg-white/20 rounded-full overflow-hidden">
          <div class="h-full bg-gradient-to-r from-yellow-400 to-orange-400 rounded-full transition-all duration-300" style="width:${xpPercent}%"></div>
        </div>
      </div>
    </div>
  </div>`;
}

// Generate progressive particle effects for eggs based on hatching progress
function renderEggParticles(eggXP, category){
  const progress = (eggXP || 0) / 50; // 0 to 1 (50 is hatch threshold)
  let particles = '';

  // Category-specific particle configurations
  const categoryEffects = {
    birds: {
      colors: ['#fbbf24', '#f59e0b', '#fcd34d'], // Golden stars
      symbols: ['âœ¨', 'â­', 'ðŸŒŸ', 'âœ§'],
      smokeColor: 'rgba(255,255,255,0.3)'
    },
    aquatic: {
      colors: ['#22d3ee', '#06b6d4', '#67e8f9'], // Teal bubbles
      symbols: ['ðŸ’«', 'âœ¨', 'ðŸ«§', 'â—‹'],
      smokeColor: 'rgba(34,211,238,0.25)'
    },
    reptiles: {
      colors: ['#fbbf24', '#f97316', '#fcd34d'], // Amber sparks
      symbols: ['âœ¦', 'âš¡', 'âœ§', 'â˜…'],
      smokeColor: 'rgba(251,191,36,0.2)'
    },
    insects: {
      colors: ['#fbbf24', '#84cc16', '#a3e635'], // Honey/nature
      symbols: ['âœ¨', 'ðŸŽµ', 'â™ª', 'âœ§'],
      smokeColor: 'rgba(251,191,36,0.2)'
    }
  };

  const effects = categoryEffects[category] || categoryEffects.birds;

  // Stage 1 (10-25%): Subtle mystical aura
  if(progress >= 0.1){
    particles += `<div class="egg-particle" style="position:absolute;width:180px;height:180px;top:50%;left:50%;transform:translate(-50%,-50%);background:radial-gradient(circle,${effects.colors[0]}22,transparent 70%);border-radius:50%;animation:energy-pulse 3s ease-in-out infinite;"></div>`;
  }

  // Stage 2 (25-50%): Small sparkles appear
  if(progress >= 0.25){
    const sparkleCount = Math.floor(progress * 6);
    for(let i=0; i<sparkleCount; i++){
      const x = 20 + Math.random() * 120;
      const y = 10 + Math.random() * 80;
      const size = 8 + Math.random() * 8;
      const delay = Math.random() * 2;
      particles += `<div class="egg-particle" style="left:${x}px;top:${y}px;font-size:${size}px;animation:star-float 2.5s ease-in-out infinite ${delay}s;color:${effects.colors[i%3]};">${effects.symbols[i%4]}</div>`;
    }
  }

  // Stage 3 (50-75%): More particles + subtle smoke/mist
  if(progress >= 0.5){
    // Add mystical mist
    particles += `<div class="egg-particle" style="position:absolute;width:100px;height:60px;bottom:20px;left:30px;background:${effects.smokeColor};border-radius:50%;filter:blur(15px);animation:smoke-rise 4s ease-in-out infinite;"></div>`;
    particles += `<div class="egg-particle" style="position:absolute;width:80px;height:50px;bottom:30px;right:20px;background:${effects.smokeColor};border-radius:50%;filter:blur(12px);animation:smoke-rise 5s ease-in-out infinite 1s;"></div>`;

    // Music notes for some categories
    if(category === 'birds' || category === 'insects'){
      particles += `<div class="egg-particle" style="left:10px;top:30px;font-size:14px;animation:music-float 3s ease-in-out infinite;color:${effects.colors[1]};">â™ª</div>`;
      particles += `<div class="egg-particle" style="right:15px;top:40px;font-size:12px;animation:music-float 3.5s ease-in-out infinite 0.5s;color:${effects.colors[2]};">â™«</div>`;
    }
  }

  // Stage 4 (75-90%): Intense effects - hearts, more sparkles, cracks glowing
  if(progress >= 0.75){
    // Hearts popping out
    particles += `<div class="egg-particle" style="left:50%;top:20px;font-size:16px;animation:heart-pop 2s ease-out infinite;color:#f472b6;">ðŸ’•</div>`;
    particles += `<div class="egg-particle" style="left:30%;top:40px;font-size:12px;animation:heart-pop 2.5s ease-out infinite 0.5s;color:#fb7185;">ðŸ’—</div>`;
    particles += `<div class="egg-particle" style="right:25%;top:35px;font-size:14px;animation:heart-pop 2.2s ease-out infinite 1s;color:#f472b6;">ðŸ’–</div>`;

    // Intense sparkle burst
    for(let i=0; i<4; i++){
      const angle = (i * 90) * Math.PI / 180;
      const x = 80 + Math.cos(angle) * 60;
      const y = 100 + Math.sin(angle) * 50;
      particles += `<div class="egg-particle" style="left:${x}px;top:${y}px;width:10px;height:10px;background:${effects.colors[i%3]};border-radius:50%;animation:spark-burst 1.5s ease-out infinite ${i*0.3}s;box-shadow:0 0 10px ${effects.colors[i%3]};"></div>`;
    }

    // Glowing crack lines
    particles += `<div class="egg-particle" style="position:absolute;width:3px;height:40px;left:45%;top:30%;background:linear-gradient(to bottom,transparent,${effects.colors[0]},transparent);animation:crack-glow 1.5s ease-in-out infinite;border-radius:2px;"></div>`;
    particles += `<div class="egg-particle" style="position:absolute;width:3px;height:30px;left:55%;top:50%;background:linear-gradient(to bottom,transparent,${effects.colors[1]},transparent);animation:crack-glow 1.8s ease-in-out infinite 0.3s;border-radius:2px;transform:rotate(15deg);"></div>`;
  }

  // Stage 5 (90%+): Maximum intensity - ready to hatch!
  if(progress >= 0.9){
    // Swirling mystical energy
    particles += `<div class="egg-particle" style="position:absolute;width:200px;height:200px;top:50%;left:50%;transform:translate(-50%,-50%);border:3px dashed ${effects.colors[0]}44;border-radius:50%;animation:mystical-swirl 4s linear infinite;"></div>`;
    particles += `<div class="egg-particle" style="position:absolute;width:160px;height:160px;top:50%;left:50%;transform:translate(-50%,-50%);border:2px dashed ${effects.colors[1]}33;border-radius:50%;animation:mystical-swirl 3s linear infinite reverse;"></div>`;

    // Explosion of stars
    for(let i=0; i<8; i++){
      const angle = (i * 45) * Math.PI / 180;
      const x = 80 + Math.cos(angle) * 80;
      const y = 100 + Math.sin(angle) * 70;
      particles += `<div class="egg-particle" style="left:${x}px;top:${y}px;font-size:${12+Math.random()*8}px;animation:star-float 1.5s ease-out infinite ${i*0.2}s;color:${effects.colors[i%3]};">âœ¨</div>`;
    }

    // "Ready!" sparkle aura
    particles += `<div class="egg-particle" style="position:absolute;width:220px;height:220px;top:50%;left:50%;transform:translate(-50%,-50%);background:radial-gradient(circle,${effects.colors[0]}33,${effects.colors[1]}22,transparent 70%);border-radius:50%;animation:energy-pulse 1s ease-in-out infinite;"></div>`;
  }

  return particles ? `<div class="egg-particles">${particles}</div>` : '';
}

function renderBuddyWithExpression(){
  // Just render normal buddy - animation will be on the container
  return renderBuddyVisual();
}


function checkLogin(){
  const today=new Date().toDateString();
  if(S.lastLogin!==today){
    const yest=new Date(Date.now()-864e5).toDateString();
    S.streak=S.lastLogin===yest?S.streak+1:1;
    S.xp+=10;S.lastLogin=today;S.todayDate=today;S.todayCount=0;
    if(S.streak>=3){
      S.happiness=Math.min(100,S.happiness+7);
    }else{
      S.happiness=Math.min(100,S.happiness+5);
    }
    if(S.streak>=7&&!S.milestones.includes('s7')){S.milestones.push('s7');S.xp+=50}
    if(S.streak>=30&&!S.milestones.includes('s30')){S.milestones.push('s30');S.xp+=200}
    save();
  }
  if(S.todayDate!==today){S.todayDate=today;S.todayCount=0;save()}
  updateHappiness();
  updateHealth();
}
checkLogin();
loadCustomRarities(); // Load any saved rarity customizations

const setScreen=s=>{screen=s;pMode=null;feedingState=null;if(s!=='practice')selectedVerse=null;render()};
const openModal=(m,v)=>{modal=m;editV=v||null;form=v?{type:v.type,ref:v.ref,text:v.text,tags:v.tags.slice(),startPracticing:true}:{type:'scripture',ref:'',text:'',tags:[],startPracticing:true};if(m==='feed')feedTab='buy';if(m==='add'){addTab='library';libraryView={collection:null,book:null,chapter:null};searchQuery='';}render()};
const closeModal=()=>{modal=null;editV=null;render()};
const toggleTag=t=>{const i=form.tags.indexOf(t);if(i>=0)form.tags.splice(i,1);else if(form.tags.length<3)form.tags.push(t);render()};
const saveVerse=()=>{
  // Grab values directly from DOM in case oninput didn't fire
  const refInput=document.querySelector('input[placeholder*="Reference"],input[placeholder*="Author"]');
  const textInput=document.querySelector('textarea[placeholder="Text..."]');
  if(refInput)form.ref=refInput.value;
  if(textInput)form.text=textInput.value;

  if(!form.text.trim()||!form.ref.trim()){
    alert('Please enter both a reference and text');
    return;
  }
  if(editV){const v=S.verses.find(x=>x.id===editV.id);if(v){v.type=form.type;v.ref=form.ref;v.text=form.text;v.tags=form.tags.slice()}}
  else{S.verses.push({id:S.nextId++,type:form.type,ref:form.ref,text:form.text,tags:form.tags.slice(),mastery:0,userAdded:true,status:form.startPracticing?'active':'saved'});S.xp+=5}
  save();closeModal();
};
const deleteVerse=id=>{S.verses=S.verses.filter(v=>v.id!==id);save();closeModal()};
const addLibraryVerse=idx=>{
  const libVerse=LIBRARY.curated[idx];
  if(!libVerse)return;
  // Check if already added
  if(S.verses.find(v=>v.ref===libVerse.ref)){
    alert('You already have this verse!');
    return;
  }
  // Add to user's collection
  S.verses.push({
    id:S.nextId++,
    type:'scripture',
    ref:libVerse.ref,
    text:libVerse.text,
    tags:libVerse.tags.slice(),
    mastery:0,
    modeUsage:{predict:0,blanks:0,match:0,jumble:0,first:0,recall:0,hangman:0},
    lastPracticed:null,
    status:'active'
  });
  S.xp+=5; // Reward for adding a verse
  save();
  render();
};
const addLibraryVerseByRef=(ref,verseObj)=>{
  // Check if already added
  if(S.verses.find(v=>v.ref===ref)){
    alert('You already have this verse!');
    return;
  }
  // Add to user's collection
  S.verses.push({
    id:S.nextId++,
    type:'scripture',
    ref:verseObj.ref,
    text:verseObj.text,
    tags:verseObj.tags&&verseObj.tags.length?verseObj.tags.slice():['Faith'],
    mastery:0,
    modeUsage:{predict:0,blanks:0,match:0,jumble:0,first:0,recall:0,hangman:0},
    lastPracticed:null,
    status:'active'
  });
  S.xp+=5; // Reward for adding a verse
  save();
  render();
};

// Map collection names to storage keys
const COLLECTION_STORAGE_KEYS={
  'Old Testament':'lib-ot',
  'New Testament':'lib-nt',
  'Book of Mormon':'lib-bom',
  'Doctrine and Covenants':'lib-dc',
  'Pearl of Great Price':'lib-pogp',
  'Quran':'lib-quran',
  'Torah & Tanakh':'lib-torah',
  'LDS Doctrine Mastery':'lib-dm'
};

const COLLECTION_URLS={
  'Old Testament':'https://raw.githubusercontent.com/bcbooks/scriptures-json/master/old-testament.json',
  'New Testament':'https://raw.githubusercontent.com/bcbooks/scriptures-json/master/new-testament.json',
  'Book of Mormon':'https://raw.githubusercontent.com/bcbooks/scriptures-json/master/book-of-mormon.json',
  'Doctrine and Covenants':'https://raw.githubusercontent.com/bcbooks/scriptures-json/master/doctrine-and-covenants.json',
  'Pearl of Great Price':'https://raw.githubusercontent.com/bcbooks/scriptures-json/master/pearl-of-great-price.json',
  'Quran':'https://api.alquran.cloud/v1/quran/en.yusufali',
  'Torah & Tanakh':'https://bolls.life/static/translations/YLT.json',
  'LDS Doctrine Mastery':'embedded' // Special: uses embedded LDS_DOCTRINE_MASTERY array
};

// Map onboarding pack IDs to collection names for full download
const PACK_TO_COLLECTION={
  'old-testament':'Old Testament',
  'new-testament':'New Testament',
  'book-of-mormon':'Book of Mormon',
  'doctrine-covenants':'Doctrine and Covenants',
  'pearl-great-price':'Pearl of Great Price',
  'quran':'Quran',
  'torah':'Torah & Tanakh'
};

// Check which collections are downloaded
function getDownloadedCollections(){
  const downloaded=[];
  for(const [collName,key] of Object.entries(COLLECTION_STORAGE_KEYS)){
    if(localStorage.getItem(key)){
      downloaded.push(collName);
    }
  }
  return downloaded;
}

// Load all downloaded collections
function loadDownloadedCollections(){
  const allVerses=[];
  for(const [collName,key] of Object.entries(COLLECTION_STORAGE_KEYS)){
    try{
      const cached=localStorage.getItem(key);
      if(cached){
        const compact=JSON.parse(cached);
        // Expand compact format to full format
        const expanded=compact.map(v=>({
          book:v.b||v.book,
          chapter:v.c||v.chapter,
          verse:v.v||v.verse,
          ref:v.ref||(v.b||v.book)+' '+(v.c||v.chapter)+':'+(v.v||v.verse),
          text:v.t||v.text,
          tags:v.tags||guessTagsFromText(v.t||v.text)
        }));
        allVerses.push(...expanded);
      }
    }catch(e){
      console.error(`Failed to load ${collName}:`,e);
    }
  }
  return allVerses.length?allVerses:null;
}

// Download a single collection
const downloadCollection=async(collectionName)=>{
  if(downloadProgress){
    alert('Download already in progress!');
    return;
  }

  const url=COLLECTION_URLS[collectionName];
  if(!url){
    alert('Collection not found!');
    return;
  }

  // Special case: LDS Doctrine Mastery is embedded, no download needed
  if(url==='embedded'&&collectionName==='LDS Doctrine Mastery'){
    downloadProgress={current:0,total:1,status:'downloading',currentBook:collectionName};
    render();
    // Small delay to show progress
    await new Promise(r=>setTimeout(r,300));
    // Save the embedded verses directly
    const storageKey=COLLECTION_STORAGE_KEYS[collectionName];
    localStorage.setItem(storageKey,JSON.stringify(LDS_DOCTRINE_MASTERY));
    downloadProgress=null;
    alert(`Downloaded ${LDS_DOCTRINE_MASTERY.length} Doctrine Mastery verses!`);
    render();
    return;
  }

  downloadProgress={current:0,total:1,status:'downloading',currentBook:collectionName};
  render();

  try{
    const response=await fetch(url);
    if(!response.ok)throw new Error(`Failed to download ${collectionName}`);

    const data=await response.json();
    const verses=[];

    // Process the JSON structure - handle different formats
    if(data.books){
      // Standard format: books > chapters > verses (OT, NT, BoM)
      data.books.forEach(book=>{
        if(book.chapters){
          book.chapters.forEach(chapter=>{
            if(chapter.verses){
              chapter.verses.forEach(verse=>{
                verses.push({
                  b:book.book||collectionName,
                  c:chapter.chapter,
                  v:verse.verse,
                  t:verse.text
                });
              });
            }
          });
        }
      });
    }else if(data.sections){
      // D&C format: sections > verses (no chapters)
      data.sections.forEach(section=>{
        if(section.verses){
          section.verses.forEach(verse=>{
            verses.push({
              b:'D&C',
              c:section.section,
              v:verse.verse,
              t:verse.text
            });
          });
        }
      });
    }else if(data.data&&data.data.surahs){
      // Quran format from AlQuran.cloud API: data.surahs[].ayahs[]
      data.data.surahs.forEach(surah=>{
        const surahName=surah.englishName||('Surah '+surah.number);
        surah.ayahs.forEach(ayah=>{
          verses.push({
            b:surahName,
            c:surah.number,
            v:ayah.numberInSurah,
            t:ayah.text
          });
        });
      });
    }else if(Array.isArray(data)){
      // Bolls Bible API format: flat array with book_id, chapter, verse, text
      // Book ID mapping for Torah/Tanakh (first 39 books = Old Testament)
      const torahBooks={1:'Genesis',2:'Exodus',3:'Leviticus',4:'Numbers',5:'Deuteronomy',6:'Joshua',7:'Judges',8:'Ruth',9:'1 Samuel',10:'2 Samuel',11:'1 Kings',12:'2 Kings',13:'1 Chronicles',14:'2 Chronicles',15:'Ezra',16:'Nehemiah',17:'Esther',18:'Job',19:'Psalms',20:'Proverbs',21:'Ecclesiastes',22:'Song of Solomon',23:'Isaiah',24:'Jeremiah',25:'Lamentations',26:'Ezekiel',27:'Daniel',28:'Hosea',29:'Joel',30:'Amos',31:'Obadiah',32:'Jonah',33:'Micah',34:'Nahum',35:'Habakkuk',36:'Zephaniah',37:'Haggai',38:'Zechariah',39:'Malachi'};
      data.forEach(v=>{
        // Only include Torah/Tanakh books (1-39) for Torah collection
        if(collectionName==='Torah & Tanakh'&&v.book>39)return;
        const bookName=torahBooks[v.book]||('Book '+v.book);
        verses.push({
          b:bookName,
          c:v.chapter,
          v:v.verse,
          t:v.text
        });
      });
    }

    downloadProgress.status='processing';
    render();

    // Store this collection
    try{
      const storageKey=COLLECTION_STORAGE_KEYS[collectionName];
      localStorage.setItem(storageKey,JSON.stringify(verses));

      // Reload all downloaded collections
      LIBRARY.downloaded=loadDownloadedCollections();

      downloadProgress.status='complete';
      setTimeout(()=>{
        downloadProgress=null;
        render();
      },1500);

    }catch(storageError){
      console.error('Storage failed:',storageError);
      if(storageError.name==='QuotaExceededError'){
        alert(`Download successful, but storage space is limited.\n\n${collectionName} is too large to store. It will work during this session but won't be saved.`);
      }
      downloadProgress=null;
      render();
    }

  }catch(error){
    console.error('Download failed:',error);
    alert(`Download failed: ${error.message}\n\nPlease check your internet connection and try again.`);
    downloadProgress=null;
    render();
  }
};

// Guess tags based on verse content (simple keyword matching)
function guessTagsFromText(text){
  const tags=[];
  const lower=text.toLowerCase();

  if(/(faith|believe|trust)/i.test(lower))tags.push('Faith');
  if(/(hope|optimis)/i.test(lower))tags.push('Hope');
  if(/(char|love|kind|compassion)/i.test(lower))tags.push('Charity');
  if(/(coura|brave|fear not|strong)/i.test(lower))tags.push('Courage');
  if(/(pray|ask|seek)/i.test(lower))tags.push('Prayer');
  if(/(repent|forgiv)/i.test(lower))tags.push('Repentance');
  if(/(grat|thank)/i.test(lower))tags.push('Gratitude');
  if(/(serv|help)/i.test(lower))tags.push('Service');
  if(/(obey|command|keep)/i.test(lower))tags.push('Obedience');
  if(/(christ|savior|lord|jesus)/i.test(lower))tags.push('Jesus Christ');
  if(/(trial|afflict|suffer)/i.test(lower))tags.push('Trials');
  if(/(peace|rest|comfort)/i.test(lower))tags.push('Peace');
  if(/(wisd|learn|know)/i.test(lower))tags.push('Wisdom');
  if(/(patienc|endur)/i.test(lower))tags.push('Patience');

  return tags.slice(0,3); // Limit to 3 tags
}

const selectFood=idx=>{
  const food=FOODS[idx];
  if(!food||S.xp<food.cost)return;
  // Check if healthy food is refused
  if(food.cat==='healthy'&&food.acceptRate){
    const roll=Math.random()*100;
    if(roll>food.acceptRate){
      alert(`${S.buddyName||'Buddy'} refused the ${food.name}! "Bleh!" ðŸ™…`);
      closeModal();
      return;
    }
  }
  const result=feedBuddy(food);
  closeModal();
  if(result==='hatched'){
    if(!S.buddyName){
      const name=prompt('ðŸŽ‰ Your buddy hatched! What will you name them?');
      if(name&&name.trim()){S.buddyName=name.trim();save();render()}
    }else{
      alert('ðŸŽ‰ Your buddy hatched!');
    }
  }else if(result==='grew'){
    alert('âœ¨ Your buddy grew!');
  }else if(result){
    alert(`${S.buddyName||'Buddy'} enjoyed the ${food.name}! ðŸ˜Š`);
  }
  render();
};
const buyFood=idx=>{
  const food=FOODS[idx];
  if(!food||S.xp<food.cost)return;
  S.xp-=food.cost;
  S.foodInventory.push(idx);
  save();
  alert(`Bought ${food.emoji} ${food.name}!`);
  render();
};
const feedFromInventory=invIdx=>{
  if(invIdx<0||invIdx>=S.foodInventory.length)return;
  const foodIdx=S.foodInventory[invIdx];
  const food=FOODS[foodIdx];
  if(!food)return;

  // Capture stats BEFORE feeding
  const beforeStats={health:S.health,happiness:S.happiness,growthXP:S.growthXP||0};

  // Start feeding animation
  feedingState={food:food,foodIdx:foodIdx,invIdx:invIdx,accepted:null,growing:null,statChanges:null};
  closeModal();

  // Check if healthy food is refused
  if(food.cat==='healthy'&&food.acceptRate){
    const roll=Math.random()*100;
    if(roll>food.acceptRate){
      feedingState.accepted=false;
      feedingState.growing=false;
      // Apply happiness penalty for rejection
      S.happiness=Math.max(0,S.happiness-(food.happinessPenalty||15));
      feedingState.statChanges={
        health:0,
        happiness:S.happiness-beforeStats.happiness,
        growth:0
      };
      save();
    }else{
      feedingState.accepted=true;
      // Feed with cost:0 since user already paid when buying, but use growthBase for growth calculation
      const result=feedBuddy({...food,cost:0,growthBase:food.cost});
      feedingState.growing=result==='hatched'||result==='grew';
      feedingState.statChanges={
        health:S.health-beforeStats.health,
        happiness:S.happiness-beforeStats.happiness,
        growth:(S.growthXP||0)-beforeStats.growthXP
      };
      S.foodInventory.splice(invIdx,1); // Remove from inventory
      save();
    }
  }else{
    // Always accept yummy, special, premium foods
    feedingState.accepted=true;
    // Feed with cost:0 since user already paid when buying, but use growthBase for growth calculation
    const result=feedBuddy({...food,cost:0,growthBase:food.cost});
    feedingState.growing=result==='hatched'||result==='grew';
    feedingState.statChanges={
      health:S.health-beforeStats.health,
      happiness:S.happiness-beforeStats.happiness,
      growth:(S.growthXP||0)-beforeStats.growthXP
    };
    S.foodInventory.splice(invIdx,1); // Remove from inventory
    save();
  }

  render();
};
const buyAccessory=idx=>{
  const acc=ACCESSORIES[idx];
  if(!acc||S.xp<acc.cost)return;

  // Medicine and toys are used immediately (consumable)
  if(acc.type==='medicine'||acc.type==='toy'){
    S.xp-=acc.cost;
    if(acc.type==='medicine'){
      S.health=Math.min(100,S.health+(acc.healthBoost||0));
      alert(`Used ${acc.name}! Health +${acc.healthBoost} â¤ï¸`);
    }else if(acc.type==='toy'){
      S.happiness=Math.min(100,S.happiness+(acc.happinessBoost||0));
      alert(`${S.buddyName||'Buddy'} played with ${acc.name}! Happiness +${acc.happinessBoost} ðŸ˜Š`);
    }
    save();
    render();
    return;
  }

  // Food can be bought multiple times (consumable)
  // Other accessories can only be owned once
  if(acc.type!=='food'&&S.inventory.includes(idx)){alert('You already own this!');return}
  S.xp-=acc.cost;
  S.inventory.push(idx);
  save();
  alert(`You bought ${acc.name}! ðŸŽ‰`);
  render();
};

// Place furniture on buddy card
const placeFurniture=idx=>{
  if(!S.placedFurniture)S.placedFurniture=[];
  if(!S.placedFurniture.includes(idx)){
    S.placedFurniture.push(idx);
    save();
    render();
  }
};

// Remove furniture from buddy card
const unplaceFurniture=idx=>{
  if(!S.placedFurniture)return;
  const index=S.placedFurniture.indexOf(idx);
  if(index>-1){
    S.placedFurniture.splice(index,1);
    // Also remove position data for this furniture
    const stage=S.buddyStage||'egg';
    if(S.furniturePositions&&S.furniturePositions[stage]){
      delete S.furniturePositions[stage][index];
    }
    save();
    render();
  }
};

// Use food from inventory to feed buddy
const useFood=idx=>{
  const acc=ACCESSORIES[idx];
  if(!acc||acc.type!=='food')return;
  if(!S.inventory.includes(idx)){alert('You don\'t have this food!');return}

  // Remove from inventory (consumed)
  const invIdx=S.inventory.indexOf(idx);
  if(invIdx>-1)S.inventory.splice(invIdx,1);

  // Apply boosts
  let msg=`${S.buddyName||'Buddy'} ate ${acc.name}! `;
  if(acc.hungerBoost){
    S.hunger=Math.min(100,(S.hunger||50)+(acc.hungerBoost||0));
    msg+=`Hunger +${acc.hungerBoost} `;
  }
  if(acc.happinessBoost){
    S.happiness=Math.min(100,S.happiness+(acc.happinessBoost||0));
    msg+=`Happiness +${acc.happinessBoost} `;
  }
  msg+='ðŸ˜‹';

  save();
  alert(msg);
  render();
};

const equipAccessory=idx=>{
  const acc=ACCESSORIES[idx];
  if(!acc||!S.inventory.includes(idx))return;
  // Unequip current item in that slot
  if(S.equipped[acc.type]!==null){
    S.equipped[acc.type]=null;
  }
  S.equipped[acc.type]=idx;
  save();
  render();
};
const unequipAccessory=type=>{
  S.equipped[type]=null;
  save();
  render();
};
const mColor=m=>['bg-gray-400','bg-red-400','bg-orange-400','bg-yellow-400','bg-lime-400','bg-green-500'][m]||'bg-gray-400';
const mName=m=>['New','Learning','Familiar','Practicing','Almost','Mastered'][m]||'New';
const getStars=m=>{
  const level=Math.floor(m);
  const filled='â­'.repeat(level);
  const empty='â˜†'.repeat(5-level);
  return filled+empty;
};
const getWords=t=>t.split(/\s+/).filter(w=>w);
const clean=w=>w.toLowerCase().replace(/[^a-z]/g,'');
const shuffle=a=>{const b=a.slice();for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b};
const getDecoys=(cw,txt)=>{
  let pool=getWords(txt).filter(w=>clean(w)!==clean(cw)&&w.length>2);
  if(pool.length<2)pool=S.verses.flatMap(v=>getWords(v.text)).filter(w=>clean(w)!==clean(cw)&&w.length>2);
  const uniq=[],seen=new Set();
  for(const w of shuffle(pool)){const c=clean(w);if(!seen.has(c)){seen.add(c);uniq.push(w)}if(uniq.length>=2)break}
  while(uniq.length<2)uniq.push('word');
  return uniq;
};

const selectVerse=v=>{selectedVerse=v;render()};
const collectXP=()=>{
  // Create sparkle container
  let container=document.getElementById('xp-sparkles');
  if(!container){
    container=document.createElement('div');
    container.id='xp-sparkles';
    document.body.appendChild(container);
  }

  // Get button position
  const btn=event.target;
  const rect=btn.getBoundingClientRect();
  const centerX=rect.left+rect.width/2;
  const centerY=rect.top+rect.height/2;

  // Create multiple sparkles
  for(let i=0;i<8;i++){
    const sparkle=document.createElement('div');
    sparkle.className='xp-sparkle';
    sparkle.textContent='âœ¨';
    sparkle.style.left=centerX+'px';
    sparkle.style.top=centerY+'px';
    sparkle.style.animationDelay=(i*0.05)+'s';
    container.appendChild(sparkle);

    // Remove after animation
    setTimeout(()=>sparkle.remove(),1000);
  }

  // Navigate after animation
  setTimeout(()=>{
    pState.celebration=false;
    pMode=null;
    pVerse=null;
    selectedVerse=null;
    render();
  },800);
};
const quickPractice=()=>{
  // Smart Review: prioritize verses due for review first
  const dueVerses=getDueVerses();
  if(dueVerses.length){
    const v=dueVerses[0]; // Most urgent verse
    selectedVerse=v.id;
    // Pick a mode based on mastery level
    const modeOpts=v.mastery<2?['predict','blanks']:v.mastery<4?['blanks','chunk','jumble']:['first','recall','chunk'];
    startPractice(modeOpts[Math.floor(Math.random()*modeOpts.length)]);
    return;
  }
  // Fallback to recommendations if nothing due
  const recs=getRecommendations();
  if(recs.verses.length){
    const v=recs.verses[0];
    const modes=recs.modes[v.id];
    if(modes&&modes.length){
      selectedVerse=v.id;
      startPractice(modes[0]);
    }else{
      selectedVerse=v.id;
      const modeOpts=['predict','blanks','jumble','first','recall'];
      startPractice(modeOpts[Math.floor(Math.random()*modeOpts.length)]);
    }
  }else{
    selectedVerse='random';
    setScreen('practice');
  }
};

// Continue practicing after completing a verse - picks different verse or different mode
const continuePracticing=()=>{
  pState.celebration=false;
  const justCompletedId=pState.completedVerse?.id;
  const justCompletedMode=pState.completedMode;
  const modeOpts=['predict','blanks','jumble','first','recall','hangman'];

  // Try to get a different verse
  const recs=getRecommendations();
  const otherVerses=recs.verses.filter(v=>v.id!==justCompletedId);

  if(otherVerses.length>0){
    // Practice a different verse
    const v=otherVerses[Math.floor(Math.random()*otherVerses.length)];
    selectedVerse=v.id;
    const modes=recs.modes[v.id];
    if(modes&&modes.length){
      startPractice(modes[0]);
    }else{
      startPractice(modeOpts[Math.floor(Math.random()*modeOpts.length)]);
    }
  }else if(recs.verses.length>0){
    // Only one verse, try a different mode
    const v=recs.verses[0];
    selectedVerse=v.id;
    const otherModes=modeOpts.filter(m=>m!==justCompletedMode);
    startPractice(otherModes[Math.floor(Math.random()*otherModes.length)]);
  }else{
    // Fallback to random
    selectedVerse='random';
    const otherModes=modeOpts.filter(m=>m!==justCompletedMode);
    startPractice(otherModes[Math.floor(Math.random()*otherModes.length)]);
  }
};

const startPractice=mode=>{
  if(!S.verses.length)return;
  practiceStreak=0; // Reset streak at start of practice
  practiceReaction=null; // Clear any pending reactions

  // Check if buddy might refuse to practice (only for non-egg stages)
  if(S.buddyStage!=='egg'&&mightRefusePractice()){
    pMode='refused';
    render();
    return;
  }

  if(selectedVerse==='random'||!selectedVerse){
    const sorted=S.verses.slice().sort((a,b)=>a.mastery-b.mastery);
    pVerse=sorted[Math.floor(Math.random()*Math.min(5,sorted.length))];
  }else if(selectedVerse==='review'){
    const reviewVerses=S.verses.filter(needsReview);
    if(!reviewVerses.length)return;
    pVerse=reviewVerses[Math.floor(Math.random()*reviewVerses.length)];
  }else if(selectedVerse==='smartreview'){
    // Smart Review: pick most overdue verse using spaced repetition
    const dueVerses=getDueVerses();
    if(!dueVerses.length)return;
    // Pick the most urgent one (first in sorted list)
    pVerse=dueVerses[0];
  }else{
    pVerse=S.verses.find(v=>v.id===selectedVerse);
    if(!pVerse)return;
  }
  pMode=mode;
  const W=getWords(pVerse.text);
  if(mode==='predict'){
    // Progressive difficulty: Round 1=easy (every 4th, full context, first letter hint)
    // Round 2=medium (every 3rd, full context, letter count hint)
    // Round 3=hard (every 2nd, last 5 words, no hint)
    // Round 4=master (every word, last 2 words, no hint)
    const round=1;
    const predictPattern=4; // Predict every Nth word
    const contextLimit=null; // null=show all, or number of words to show
    const hintType='firstLetter'; // 'firstLetter', 'letterCount', 'none'
    // Find indices of words to predict this round
    const predictIndices=W.map((w,i)=>i>0&&i%predictPattern===0?i:-1).filter(i=>i>=0);
    pState={W,cur:0,rev:[W[0]],correct:0,total:predictIndices.length,predictIndices,currentPredictIdx:0,wrong:false,wrongCount:0,done:false,round,predictPattern,contextLimit,hintType,inp:'',roundComplete:false,totalXP:0,hintsUsed:0};
  }
  else if(mode==='blanks'){
    // Progressive difficulty: 6 rounds from every 6th word to all words
    const round=1;
    const blankPattern=6; // Start with every 6th word
    const bl=W.map((w,i)=>(i+1)%blankPattern===0?'':w);
    const mi=W.filter((w,i)=>(i+1)%blankPattern===0);
    const missingIndices=W.map((w,i)=>(i+1)%blankPattern===0?i:-1).filter(i=>i>=0);
    pState={W,blanks:bl,missing:mi,missingIndices,cBlank:0,inp:'',wrong:false,wrongAnswer:'',wrongCount:0,done:false,round,blankPattern,filledIndices:[]}
  }
  else if(mode==='jumble')pState={W,shuf:shuffle(W),sel:[],wrong:false,wrongCount:0,done:false};
  else if(mode==='first'){const h=W.map(w=>w[0]+'_'.repeat(w.length-1));pState={W,hints:h,cWord:0,inp:'',wrong:false,wrongCount:0,done:false}}
  else if(mode==='recall')pState={W,inp:'',checked:false,score:0,wrongCount:0,done:false};
  else if(mode==='hangman'){
    pState={W,guessed:[],wrong:0,maxWrong:8,wrongCount:0,done:false,won:false};
  }
  else if(mode==='chunk'){
    // Split verse into chunks for easier memorization
    const text=pVerse.text;
    // Split by punctuation or into ~5-7 word chunks
    let chunks=text.split(/(?<=[.!?,;:])\s+/).filter(c=>c.trim());
    // If no natural breaks or chunks too big, split by word count
    if(chunks.length<2||chunks.some(c=>getWords(c).length>10)){
      const words=getWords(text);
      const chunkSize=Math.ceil(words.length/Math.ceil(words.length/6));
      chunks=[];
      for(let i=0;i<words.length;i+=chunkSize){
        chunks.push(words.slice(i,i+chunkSize).join(' '));
      }
    }
    // Build practice phases: each chunk alone, then cumulative combinations
    const phases=[];
    for(let i=0;i<chunks.length;i++){
      // Practice this chunk alone
      phases.push({type:'single',chunkIdx:i,text:chunks[i]});
      // After first chunk, add combination phases
      if(i>0){
        phases.push({type:'combine',upTo:i,text:chunks.slice(0,i+1).join(' ')});
      }
    }
    pState={
      chunks,
      phases,
      currentPhase:0,
      inp:'',
      wrong:false,
      wrongAnswer:'',
      wrongCount:0,
      hintsUsed:0,
      done:false,
      phaseComplete:false
    };
  }
  else if(mode==='match'){
    // Get 4 random verses from user's collection for matching
    const activeVerses=S.verses.filter(v=>v.status==='active'&&v.text&&v.ref);
    const shuffled=[...activeVerses].sort(()=>Math.random()-0.5);
    const matchVerses=shuffled.slice(0,Math.min(4,shuffled.length));
    const refs=matchVerses.map(v=>({ref:v.ref,matched:false})).sort(()=>Math.random()-0.5);
    pState={
      verses:matchVerses.map(v=>({id:v.id,ref:v.ref,text:v.text,matched:false})),
      refs,
      selectedText:null,
      selectedRef:null,
      wrongCount:0,
      done:false,
      matchedCount:0
    };
  }
  render();
};

function selectPredictByIndex(idx){
  if(idx>=0&&idx<predictOptions.length){
    selectPredict(predictOptions[idx]);
  }
}

function selectPredict(w){
  const targetIdx=pState.predictIndices[pState.currentPredictIdx];
  const startIdx=pState.rev.length;
  // Get the correct phrase from current position to checkpoint
  const phraseWords=pState.W.slice(startIdx,targetIdx+1);
  const correctPhrase=phraseWords.join(' ');
  // Add all words up to and including the target to revealed
  while(pState.rev.length<=targetIdx){
    pState.rev.push(pState.W[pState.rev.length]);
  }
  if(clean(w)===clean(correctPhrase)){
    pState.correct++;
    pState.wrong=false;
    practiceStreak++;
    triggerReaction(practiceStreak>=3?'streak':'correct');
  }else{
    pState.wrong=true;
    pState.wrongCount++;
    practiceStreak=0;
    triggerReaction('wrong');
  }
  pState.currentPredictIdx++;
  pState.cur=targetIdx;

  if(pState.currentPredictIdx>=pState.predictIndices.length){
    // Round complete!
    pState.roundComplete=true;
    const accuracy=pState.total>0?pState.correct/pState.total:0;
    pState.roundXP=Math.max(0.5,Math.round(accuracy*2*10)/10); // 0.5-2 XP per round based on accuracy
    pState.totalXP=(pState.totalXP||0)+pState.roundXP;
    if(pState.round>=4){
      pState.done=true;
      triggerReaction('celebrate');
    }
  }
  render();
}

function advancePredictRound(){
  pState.round++;
  const patterns=[4,3,2,1]; // every 4th, 3rd, 2nd, every word
  const contexts=[null,null,5,2]; // full, full, last 5, last 2
  const hints=['firstLetter','letterCount','none','none'];

  pState.predictPattern=patterns[pState.round-1]||1;
  pState.contextLimit=contexts[pState.round-1];
  pState.hintType=hints[pState.round-1]||'none';

  // Recalculate predict indices for new pattern
  const W=pState.W;
  if(pState.predictPattern===1){
    pState.predictIndices=W.map((w,i)=>i>0?i:-1).filter(i=>i>=0);
  }else{
    pState.predictIndices=W.map((w,i)=>i>0&&i%pState.predictPattern===0?i:-1).filter(i=>i>=0);
  }

  pState.rev=[W[0]];
  pState.cur=0;
  pState.currentPredictIdx=0;
  pState.correct=0;
  pState.total=pState.predictIndices.length;
  pState.roundComplete=false;
  pState.wrong=false;
  render();
}

function exitPredictEarly(){
  pState.done=true;
  completePractice();
}
const checkBlanks=()=>{
  const exp=pState.missing[pState.cBlank];
  if(clean(pState.inp)===clean(exp)){
    // Correct! Fill in the blank
    const blankIdx=pState.blanks.indexOf('');
    pState.blanks[blankIdx]=exp;
    pState.filledIndices.push(pState.missingIndices[pState.cBlank]);
    pState.cBlank++;
    pState.inp='';
    pState.wrong=false;
    pState.wrongAnswer='';
    pState.hintLevel=0; // Reset hint level for next word
    practiceStreak++;
    triggerReaction(practiceStreak>=3?'streak':'correct');

    if(pState.cBlank>=pState.missing.length){
      // Round complete! Show reward screen
      pState.roundComplete=true;
      // Calculate XP: 2 base, minus 0.25 for each hint used (min 0.5)
      const hintPenalty=Math.min(1.5,(pState.hintsUsed||0)*0.25);
      pState.roundXP=Math.max(0.5,2-hintPenalty);
      pState.totalXP=(pState.totalXP||0)+pState.roundXP;
      if(pState.round>=6){
        // All rounds done!
        pState.done=true;
        triggerReaction('celebrate');
      }
    }
  }else{
    pState.wrong=true;
    pState.wrongAnswer=pState.inp;
    pState.wrongCount++;
    pState.hintLevel=(pState.hintLevel||0)+1;
    pState.hintsUsed=(pState.hintsUsed||0)+1;
    practiceStreak=0;
    triggerReaction('wrong');

    // After 4 wrong attempts, reveal the word
    if(pState.hintLevel>=4){
      pState.revealed=true;
    }
  }
  render();
};

const skipBlankWord=()=>{
  // User chose to skip after seeing the revealed answer
  const exp=pState.missing[pState.cBlank];
  const blankIdx=pState.blanks.indexOf('');
  pState.blanks[blankIdx]=exp;
  pState.filledIndices.push(pState.missingIndices[pState.cBlank]);
  pState.cBlank++;
  pState.inp='';
  pState.wrong=false;
  pState.wrongAnswer='';
  pState.hintLevel=0;
  pState.revealed=false;
  pState.hintsUsed=(pState.hintsUsed||0)+1; // Extra penalty for skipping

  if(pState.cBlank>=pState.missing.length){
    pState.roundComplete=true;
    const hintPenalty=Math.min(1.5,(pState.hintsUsed||0)*0.25);
    pState.roundXP=Math.max(0.5,2-hintPenalty);
    pState.totalXP=(pState.totalXP||0)+pState.roundXP;
    if(pState.round>=6){
      pState.done=true;
    }
  }
  render();
};

const advanceBlankRound=()=>{
  pState.round++;
  const patterns=[6,5,4,3,2,1]; // every 6th, 5th, 4th, 3rd, 2nd, all
  pState.blankPattern=patterns[pState.round-1]||1;
  const W=pState.W;
  pState.blanks=W.map((w,i)=>pState.blankPattern===1||(i+1)%pState.blankPattern===0?'':w);
  pState.missing=W.filter((w,i)=>pState.blankPattern===1||(i+1)%pState.blankPattern===0);
  pState.missingIndices=W.map((w,i)=>pState.blankPattern===1||(i+1)%pState.blankPattern===0?i:-1).filter(x=>x>=0);
  pState.cBlank=0;
  pState.filledIndices=[];
  pState.roundComplete=false;
  pState.hintLevel=0;
  pState.hintsUsed=0; // Reset hints for new round
  pState.revealed=false;
  render();
};

const exitBlanksEarly=()=>{
  // Give partial XP based on rounds completed
  pState.done=true;
  completePractice();
};

// Chunk Master functions
const checkChunk=()=>{
  const phase=pState.phases[pState.currentPhase];
  const expected=phase.text;
  const userWords=getWords(pState.inp);
  const expectedWords=getWords(expected);

  // Calculate similarity (allow minor typos)
  let correct=0;
  expectedWords.forEach((w,i)=>{
    if(userWords[i]&&clean(userWords[i])===clean(w))correct++;
  });
  const accuracy=expectedWords.length>0?correct/expectedWords.length:0;

  if(accuracy>=0.9){
    // Phase complete!
    pState.phaseComplete=true;
    pState.phaseAccuracy=Math.round(accuracy*100);
    pState.wrong=false;
    practiceStreak++;
    triggerReaction(practiceStreak>=3?'streak':'correct');
  }else{
    pState.wrong=true;
    pState.wrongCount++;
    pState.hintsUsed++;
    practiceStreak=0;
    triggerReaction('wrong');
    // Show what was wrong
    pState.comparison=expectedWords.map((w,i)=>{
      const userWord=userWords[i];
      if(userWord&&clean(userWord)===clean(w))return{type:'correct',word:w};
      if(userWord)return{type:'wrong',expected:w,actual:userWord};
      return{type:'missing',word:w};
    });
  }
  render();
};

const advanceChunkPhase=()=>{
  pState.currentPhase++;
  pState.inp='';
  pState.wrong=false;
  pState.wrongAnswer='';
  pState.phaseComplete=false;
  pState.comparison=null;

  if(pState.currentPhase>=pState.phases.length){
    pState.done=true;
    completePractice();
  }else{
    render();
  }
};

const showChunkHint=()=>{
  // Show the expected text as a hint
  pState.showingHint=true;
  pState.hintsUsed++;
  render();
};

const hideChunkHint=()=>{
  pState.showingHint=false;
  render();
};
const selectJumble=i=>{const w=pState.shuf[i],exp=pState.W[pState.sel.length];if(clean(w)===clean(exp)){pState.sel.push(w);pState.shuf.splice(i,1);pState.wrong=false;practiceStreak++;triggerReaction(practiceStreak>=3?'streak':'correct');if(pState.sel.length>=pState.W.length){pState.done=true;triggerReaction('celebrate');setTimeout(()=>completePractice(),800)}}else{pState.wrong=true;pState.wrongCount++;practiceStreak=0;triggerReaction('wrong')}render()};
const checkFirst=()=>{const exp=pState.W[pState.cWord];if(clean(pState.inp)===clean(exp)){pState.hints[pState.cWord]=exp;pState.cWord++;pState.inp='';pState.wrong=false;practiceStreak++;triggerReaction(practiceStreak>=3?'streak':'correct');if(pState.cWord>=pState.W.length){pState.done=true;triggerReaction('celebrate');setTimeout(()=>completePractice(),800)}}else{pState.wrong=true;pState.wrongCount++;practiceStreak=0;triggerReaction('wrong')}render()};
const checkRecall=()=>{
  const iw=getWords(pState.inp);
  let c=0;
  // Build detailed comparison for display
  const comparison=[];
  const maxLen=Math.max(pState.W.length,iw.length);
  for(let i=0;i<maxLen;i++){
    const expected=pState.W[i]||null;
    const actual=iw[i]||null;
    if(expected&&actual&&clean(actual)===clean(expected)){
      // Correct word
      comparison.push({type:'correct',expected,actual});
      c++;
    }else if(expected&&actual){
      // Wrong word (typed something different)
      comparison.push({type:'wrong',expected,actual});
    }else if(expected&&!actual){
      // Missing word (didn't type enough)
      comparison.push({type:'missing',expected,actual:null});
    }else if(!expected&&actual){
      // Extra word (typed too much)
      comparison.push({type:'extra',expected:null,actual});
    }
  }
  pState.comparison=comparison;
  pState.userWords=iw;
  pState.score=Math.round(c/pState.W.length*100);
  pState.checked=true;
  pState.done=pState.score>=80;
  if(pState.done){
    triggerReaction('celebrate');
    setTimeout(()=>completePractice(),800);
  }else{
    triggerReaction('wrong');
  }
  render();
};
const selectMatchText=idx=>{
  if(pState.verses[idx].matched)return;
  pState.selectedText=idx;
  pState.wrong=false;
  // If ref already selected, check for match
  if(pState.selectedRef!==null)checkMatch();
  else render();
};
const selectMatchRef=idx=>{
  if(pState.refs[idx].matched)return;
  pState.selectedRef=idx;
  pState.wrong=false;
  // If text already selected, check for match
  if(pState.selectedText!==null)checkMatch();
  else render();
};
const checkMatch=()=>{
  const verse=pState.verses[pState.selectedText];
  const ref=pState.refs[pState.selectedRef];
  if(verse.ref===ref.ref){
    // Correct match!
    verse.matched=true;
    ref.matched=true;
    pState.matchedCount++;
    pState.selectedText=null;
    pState.selectedRef=null;
    pState.wrong=false;
    practiceStreak++;
    triggerReaction(practiceStreak>=3?'streak':'correct');
    if(pState.matchedCount>=pState.verses.length){
      pState.done=true;
      triggerReaction('celebrate');
      setTimeout(()=>completePractice(),800);
    }
  }else{
    // Wrong match
    pState.wrong=true;
    pState.wrongCount++;
    pState.selectedText=null;
    pState.selectedRef=null;
    practiceStreak=0;
    triggerReaction('wrong');
  }
  render();
};
const guessLetter=l=>{
  if(pState.guessed.includes(l))return;
  pState.guessed.push(l);

  // Check if letter exists in the verse
  const verseLetters=pState.W.join(' ').toLowerCase().replace(/[^a-z]/g,'');
  const isCorrect=verseLetters.includes(l.toLowerCase());

  if(!isCorrect){
    pState.wrong++;
    pState.wrongCount++;
    practiceStreak=0;
    triggerReaction('wrong');
    if(pState.wrong>=pState.maxWrong){
      // Game over - failed
      pState.done=true;
      pState.won=false;
      setTimeout(()=>completePractice(),1000);
    }
  }else{
    practiceStreak++;
    triggerReaction(practiceStreak>=3?'streak':'correct');
    // Check if entire verse is revealed
    const allRevealed=pState.W.every(word=>
      clean(word).split('').every(c=>pState.guessed.includes(c)||!/[a-z]/.test(c))
    );
    if(allRevealed){
      // Won - entire verse completed
      pState.done=true;
      pState.won=true;
      triggerReaction('celebrate');
      setTimeout(()=>completePractice(),1000);
    }
  }
  render();
};
const completePractice=()=>{
  // Prevent duplicate completions
  if(pState.completed)return;
  pState.completed=true;

  const v=S.verses.find(x=>x.id===pVerse.id);
  if(!v)return;

  // Ensure modeUsage exists
  if(!v.modeUsage)v.modeUsage={predict:0,blanks:0,chunk:0,match:0,jumble:0,first:0,recall:0,hangman:0};

  // Base XP calculation
  let baseXP=0;
  if(pMode==='predict')baseXP=pState.totalXP||2;
  else if(pMode==='blanks')baseXP=pState.totalXP||2; // 2 XP per round completed
  else if(pMode==='match')baseXP=6;
  else if(pMode==='jumble')baseXP=7;
  else if(pMode==='first')baseXP=8;
  else if(pMode==='hangman')baseXP=pState.won?6:3;
  else if(pMode==='recall')baseXP=pState.score===100?15:10;
  else if(pMode==='chunk'){const hintPenalty=Math.min(3,(pState.hintsUsed||0)*0.5);baseXP=Math.max(3,6-hintPenalty)}

  // Apply mode multiplier
  const multiplier=getModeMultiplier(v,pMode);
  let xp=Math.round(baseXP*multiplier);

  // Apply wrong answer penalty - 5% reduction per wrong answer, min 50%
  const wrongPenalty=Math.max(0.5,1-(pState.wrongCount||0)*0.05);
  xp=Math.round(xp*wrongPenalty);

  // Length bonus based on word count (not for match game since it tests multiple verses)
  let lengthBonus=0;
  let lengthMultiplier=1.0;
  if(pMode!=='match'){
    const wordCount=getWords(v.text).length;
    if(wordCount>=40){
      lengthMultiplier=2.0;
      lengthBonus=Math.round(baseXP);
    }else if(wordCount>=25){
      lengthMultiplier=1.5;
      lengthBonus=Math.round(baseXP*0.5);
    }else if(wordCount>=15){
      lengthMultiplier=1.2;
      lengthBonus=Math.round(baseXP*0.2);
    }
    xp+=lengthBonus;
  }

  // Add review bonus if mastered
  const reviewBonus=v.mastery>=5?getReviewBonus(v):0;
  xp+=reviewBonus;

  // First practice of day bonus
  if(S.todayCount===0)xp+=15;

  // Apply happiness multiplier to final XP
  const happinessMult=getHappinessXPMultiplier();
  const preHappinessXP=xp;
  xp=Math.round(xp*happinessMult);
  const happinessBonus=xp-preHappinessXP;

  // Update counts and XP
  S.todayCount++;
  S.xp+=xp;

  // Also add to stage growth progress (with milestone confetti!)
  if(S.buddyStage==='egg'){
    const oldEggXP=S.eggXP||0;
    const oldPct=oldEggXP/STAGES.egg.hatchXP*100;
    S.eggXP=oldEggXP+xp;
    const newPct=S.eggXP/STAGES.egg.hatchXP*100;
    checkMilestone(oldPct,newPct);
  }else if(S.buddyStage!=='adult'){
    // Blob, child, and teen stages grow from practice too!
    // Practice gives growth at 100% rate (1:1 with XP) - clear and intuitive
    const stageData=STAGES[S.buddyStage];
    const oldGrowth=S.growthXP||0;
    const oldPct=oldGrowth/stageData.growthNeeded*100;
    const practiceGrowth=Math.round(xp*1.0);
    S.growthXP=oldGrowth+practiceGrowth;
    const newPct=S.growthXP/stageData.growthNeeded*100;
    checkMilestone(oldPct,newPct);
  }

  // Update verse stats
  v.modeUsage[pMode]=(v.modeUsage[pMode]||0)+1;
  v.lastPracticed=new Date().toISOString();

  // Mastery increase (with requirements)
  const oldMastery=v.mastery;
  let masteryGain=0;
  if(v.mastery<5){
    if(pMode==='predict')masteryGain=0.2;
    else if(pMode==='blanks')masteryGain=0.5;
    else if(pMode==='chunk')masteryGain=0.8; // Good for learning long verses
    else if(pMode==='match')masteryGain=0.3; // Lower since it tests multiple verses
    else if(pMode==='jumble')masteryGain=0.7;
    else if(pMode==='first')masteryGain=1.0;
    else if(pMode==='hangman')masteryGain=pState.won?0.6:0.3;
    else if(pMode==='recall'&&pState.score>=80)masteryGain=pState.score===100?2.0:1.5;

    v.mastery=Math.min(5,v.mastery+masteryGain);
    if(v.mastery>=5){v.mastery=5;S.xp+=50}
  }

  // Smart Review: Update spaced repetition data
  v.lastPracticed=Date.now();
  // Calculate next review interval based on mastery (in hours)
  const reviewIntervals={0:4,1:24,2:72,3:168,4:336,5:720}; // 4h, 1d, 3d, 7d, 14d, 30d
  const masteryLevel=Math.floor(v.mastery);
  const hoursUntilReview=reviewIntervals[masteryLevel]||4;
  v.nextReview=Date.now()+(hoursUntilReview*60*60*1000);

  // Capture stage BEFORE growth check for evolution animation
  const prevStage=S.buddyStage;
  const growth=checkBuddyGrowth();
  S.happiness=Math.min(100,S.happiness+3);

  // Reset interaction timers (practicing counts as interaction)
  S.lastHappinessUpdate=Date.now();

  save();

  // Store XP breakdown and show celebration screen
  pState.xpEarned=xp;
  pState.baseXP=baseXP;
  pState.multiplier=multiplier;
  pState.lengthBonus=lengthBonus;
  pState.lengthMultiplier=lengthMultiplier;
  pState.wordCount=wordCount;
  pState.reviewBonus=reviewBonus;
  pState.firstPracticeBonus=S.todayCount===1?15:0;
  pState.happinessBonus=happinessBonus;
  pState.happinessMult=happinessMult;
  pState.oldMastery=oldMastery;
  pState.newMastery=v.mastery;
  pState.completedMode=pMode;
  pState.completedVerse=pVerse;

  // Check if evolution happened - show evolution celebration!
  if(growth==='hatched'||growth==='grew'){
    pState.evolving=true;
    pState.evolvePhase='collect'; // collect -> burst -> reveal -> (naming if hatched)
    pState.evolveType=growth; // 'hatched' or 'grew'
    pState.prevStage=prevStage;
    pState.celebration=false;
  }else{
    pState.celebration=true;
    pState.evolving=false;
  }

  render();
};

function render(){
  // Clean up any expired pending trades
  if(typeof cleanupExpiredTrades==='function')cleanupExpiredTrades();

  const $=document.getElementById('app'),M=S.verses.filter(v=>v.mastery>=5).length,goal=3,prog=Math.min(S.todayCount/goal*100,100);
  let h='';

  // Check for neglect consequences before anything else (except if already set)
  if(!neglectConsequence && !graduationCeremony){
    const consequence=checkNeglectConsequences();
    if(consequence){
      neglectConsequence=consequence;
    }
  }

  // Graduation ceremony screen (priority override)
  if(graduationCeremony){
    const buddyName=S.buddyName||'Buddy';
    h=`<div class="p-5 min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 via-pink-600 to-fuchsia-600">
      <div class="bg-white/95 rounded-3xl p-6 text-center max-w-md w-full">
        <div class="text-6xl mb-4 sparkle glow">${getBuddyEmoji()}</div>
        <h2 class="text-3xl font-bold text-purple-800 mb-2">ðŸŽ“ Congratulations!</h2>
        <p class="text-xl text-purple-600 mb-6">${buddyName} has graduated!</p>

        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-4 mb-4 text-left">
          <p class="text-purple-700 font-semibold mb-3">Journey Stats:</p>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-purple-600">Stage:</span>
              <span class="text-purple-800 font-semibold">${getStageName()}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-purple-600">Final Happiness:</span>
              <span class="text-purple-800 font-semibold">${S.happiness}/100</span>
            </div>
            <div class="flex justify-between">
              <span class="text-purple-600">Final Health:</span>
              <span class="text-purple-800 font-semibold">${S.health}/100</span>
            </div>
            <div class="flex justify-between">
              <span class="text-purple-600">Days Together:</span>
              <span class="text-purple-800 font-semibold">${Math.max(1,Math.floor((Date.now()-new Date(S.lastLogin).getTime())/(1000*60*60*24)))}</span>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-2xl p-4 mb-6">
          <p class="text-2xl font-bold text-orange-600 mb-1">+100 XP Bonus!</p>
          <p class="text-sm text-purple-600">Graduation reward</p>
        </div>

        <div class="bg-purple-50 rounded-xl p-4 mb-6 text-left">
          <p class="text-purple-700 text-sm mb-2">ðŸ’¡ What happens next:</p>
          <ul class="text-purple-600 text-xs space-y-1">
            <li>â€¢ ${buddyName} moves to your Collection</li>
            <li>â€¢ You'll get a new egg to raise</li>
            <li>â€¢ Your accessories and XP are kept</li>
            <li>â€¢ Start a new journey together!</li>
          </ul>
        </div>

        <button onclick="graduateBuddy();graduationCeremony=false;render()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-4 rounded-2xl mb-2">
          Add to Collection
        </button>
        <button onclick="graduationCeremony=false;render()" class="w-full bg-purple-100 text-purple-700 font-semibold py-3 rounded-2xl">
          Not Yet
        </button>
      </div>
    </div>`;
  }

  // First-time onboarding screen
  else if(!localStorage.getItem('onboardingComplete')){
    // Define pack categories for onboarding
    const onboardingPacks=[
      {category:'Christian',packs:[
        {id:'old-testament',name:'Old Testament',icon:'ðŸ“œ',desc:'Genesis, Psalms, Proverbs...'},
        {id:'new-testament',name:'New Testament',icon:'âœï¸',desc:'Matthew, John, Romans...'},
        {id:'book-of-mormon',name:'Book of Mormon',icon:'ðŸ“˜',desc:'1 Nephi, Alma, Moroni...'},
        {id:'doctrine-covenants',name:'Doctrine & Covenants',icon:'ðŸ“™',desc:'Modern revelations'},
        {id:'pearl-great-price',name:'Pearl of Great Price',icon:'ðŸ’Ž',desc:'Moses, Abraham, JS-History'},
        {id:'dm-old-testament',name:'Doctrine Mastery: OT',icon:'ðŸ“–',desc:'25 Old Testament seminary verses'},
        {id:'dm-new-testament',name:'Doctrine Mastery: NT',icon:'ðŸ“–',desc:'25 New Testament seminary verses'},
        {id:'dm-book-of-mormon',name:'Doctrine Mastery: BoM',icon:'ðŸ“–',desc:'25 Book of Mormon seminary verses'},
        {id:'dm-doctrine-covenants',name:'Doctrine Mastery: D&C',icon:'ðŸ“–',desc:'25 D&C seminary verses'},
        {id:'articles-of-faith',name:'Articles of Faith',icon:'ðŸ“œ',desc:'13 core beliefs'},
        {id:'lds-quotes',name:'LDS Leader Quotes',icon:'ðŸŽ¤',desc:'Prophet teachings'},
        {id:'catholic-prayers',name:'Catholic Prayers',icon:'ðŸ™',desc:'Traditional prayers'},
        {id:'christian-classics',name:'Christian Classic Quotes',icon:'ðŸ“š',desc:'C.S. Lewis, Spurgeon, etc.'}
      ]},
      {category:'Judaism',packs:[
        {id:'torah',name:'Torah & Tanakh',icon:'âœ¡ï¸',desc:'Hebrew scriptures'},
        {id:'jewish-wisdom',name:'Jewish Wisdom',icon:'ðŸ“–',desc:'Talmud & teachings'}
      ]},
      {category:'Islam',packs:[
        {id:'quran',name:'Quran',icon:'â˜ªï¸',desc:'Holy Quran verses'},
        {id:'hadith',name:'Hadith',icon:'ðŸ“¿',desc:'Prophet Muhammad teachings'}
      ]},
      {category:'Buddhism',packs:[
        {id:'buddhist-sutras',name:'Buddhist Teachings',icon:'â˜¸ï¸',desc:'Sutras & wisdom'}
      ]},
      {category:'Hinduism',packs:[
        {id:'bhagavad-gita',name:'Bhagavad Gita',icon:'ðŸ•‰ï¸',desc:'Sacred dialogue'},
        {id:'hindu-wisdom',name:'Hindu Wisdom',icon:'ðŸ“¿',desc:'Vedic teachings'}
      ]},
      {category:'Sikhism',packs:[
        {id:'guru-granth',name:'Guru Granth Sahib',icon:'ðŸ™',desc:'Sikh scripture'}
      ]},
      {category:'Inspiration',packs:[
        {id:'inspirational-quotes',name:'Inspirational Quotes',icon:'ðŸ’¡',desc:'Lincoln, Churchill, Gandhi...'}
      ]}
    ];

    h=`<div class="p-5 min-h-screen flex items-center justify-center">
      <div class="bg-white/95 rounded-3xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="text-center mb-6">
          <div class="text-5xl mb-2">ðŸ¥šðŸ“–âœ¨</div>
          <h2 class="text-2xl font-bold text-purple-800 mb-1">Welcome to Scribbies!</h2>
          <p class="text-purple-600 text-sm mb-3">Raise adorable creatures by learning scriptures!</p>
          <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-3 text-xs text-left space-y-1">
            <p class="text-purple-700"><span class="font-bold">ðŸ“– Select your scriptures</span> below</p>
            <p class="text-purple-600">âœ… Get <b>starter verses</b> to begin practicing</p>
            <p class="text-purple-600">ðŸ“š Full library unlocked to add or remove verses</p>
            <p class="text-purple-500 italic text-[11px]">You can customize your verse list anytime!</p>
          </div>
        </div>

        <div class="space-y-4 mb-6">
          ${onboardingPacks.map(cat=>`
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-3">
              <p class="font-bold text-purple-800 mb-2">${cat.category}</p>
              <div class="space-y-2">
                ${cat.packs.map(pack=>`
                  <label class="flex items-center gap-3 bg-white rounded-lg p-2 cursor-pointer hover:bg-purple-50 transition-colors">
                    <input type="checkbox" id="ob-${pack.id}" onchange="onboardingSelections['${pack.id}']=this.checked" class="w-5 h-5 accent-purple-600 rounded">
                    <span class="text-xl">${pack.icon}</span>
                    <div class="flex-1">
                      <p class="font-semibold text-purple-800 text-sm">${pack.name}</p>
                      <p class="text-purple-500 text-xs">${pack.desc}</p>
                    </div>
                  </label>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>

        <button onclick="completeOnboarding()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-4 rounded-2xl mb-2">
          Start My Journey!
        </button>
        <p class="text-center text-purple-400 text-xs">Selecting a pack gives you starter verses + full library access</p>
        <button onclick="skipOnboarding()" class="w-full text-purple-500 font-medium py-2 text-sm">
          Skip for now
        </button>
      </div>
    </div>`;
  }

  // Check for neglect consequences at start of render
  else if(neglectConsequence){
    const nc=neglectConsequence;
    if(nc.type==='ranAway'){
      h=`<div class="p-5 min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-600 via-gray-700 to-slate-800">
        <div class="bg-white/95 rounded-3xl p-6 text-center max-w-md w-full">
          <div class="text-7xl mb-4">ðŸ’”</div>
          <h2 class="text-2xl font-bold text-gray-800 mb-3">${nc.scribbyName} Ran Away...</h2>
          <div class="bg-gray-100 rounded-2xl p-4 mb-4 text-left">
            <p class="text-gray-600 mb-3">${nc.scribbyName} was feeling unloved and unhappy for too long. Without any attention or play time, they decided to find a new home where they could be happier.</p>
            <p class="text-gray-500 text-sm italic">"I hope you'll take better care of your next friend..."</p>
          </div>
          <div class="bg-purple-50 rounded-xl p-3 mb-6">
            <p class="text-purple-600 text-sm">ðŸ’¡ Tip: Keep your Scribby happy by playing with them and practicing scriptures together!</p>
          </div>
          <button onclick="resetAfterConsequence()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 rounded-2xl">
            ðŸ¥š Get a New Egg
          </button>
        </div>
      </div>`;
    }else if(nc.type==='hospital'){
      h=`<div class="p-5 min-h-screen flex items-center justify-center bg-gradient-to-br from-red-400 via-rose-500 to-red-600">
        <div class="bg-white/95 rounded-3xl p-6 text-center max-w-md w-full">
          <div class="text-7xl mb-4">ðŸ¥</div>
          <h2 class="text-2xl font-bold text-red-700 mb-3">${nc.scribbyName} Is in the Hospital</h2>
          <div class="bg-red-50 rounded-2xl p-4 mb-4 text-left">
            <p class="text-gray-600 mb-3">${nc.scribbyName}'s health declined too much without proper care. A kind veterinarian has taken them in to help them recover, but they won't be returning home.</p>
            <p class="text-gray-500 text-sm italic">"Remember to feed your friends and keep them healthy..."</p>
          </div>
          <div class="bg-purple-50 rounded-xl p-3 mb-6">
            <p class="text-purple-600 text-sm">ðŸ’¡ Tip: Feed your Scribby regularly to keep their health up!</p>
          </div>
          <button onclick="resetAfterConsequence()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 rounded-2xl">
            ðŸ¥š Get a New Egg
          </button>
        </div>
      </div>`;
    }else if(nc.type==='warningHappiness'){
      h=`<div class="p-5 min-h-screen flex items-center justify-center bg-gradient-to-br from-orange-400 via-amber-500 to-yellow-500">
        <div class="bg-white/95 rounded-3xl p-6 text-center max-w-md w-full">
          <div class="text-7xl mb-4">âš ï¸ðŸ˜¢</div>
          <h2 class="text-2xl font-bold text-orange-700 mb-3">${nc.scribbyName} Is Very Unhappy!</h2>
          <div class="bg-orange-50 rounded-2xl p-4 mb-4 text-left">
            <p class="text-gray-600 mb-3">${nc.scribbyName} has been at 0 happiness for a while now. They're considering running away to find a new home...</p>
            <p class="text-orange-600 font-semibold">â° You have about ${nc.hoursLeft} hours to make them happy again!</p>
          </div>
          <div class="bg-purple-50 rounded-xl p-3 mb-6">
            <p class="text-purple-600 text-sm">ðŸ’¡ Quick! Practice some scriptures or play with ${nc.scribbyName} to boost their happiness!</p>
          </div>
          <button onclick="neglectConsequence=null;render()" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold py-4 rounded-2xl">
            I'll Take Better Care! ðŸ’š
          </button>
        </div>
      </div>`;
    }else if(nc.type==='warningHealth'){
      h=`<div class="p-5 min-h-screen flex items-center justify-center bg-gradient-to-br from-red-400 via-rose-400 to-orange-400">
        <div class="bg-white/95 rounded-3xl p-6 text-center max-w-md w-full">
          <div class="text-7xl mb-4">âš ï¸ðŸ¤’</div>
          <h2 class="text-2xl font-bold text-red-600 mb-3">${nc.scribbyName} Is Very Sick!</h2>
          <div class="bg-red-50 rounded-2xl p-4 mb-4 text-left">
            <p class="text-gray-600 mb-3">${nc.scribbyName} has been at 0 health for too long. If they don't get better soon, they'll need to go to the hospital...</p>
            <p class="text-red-600 font-semibold">â° You have about ${nc.hoursLeft} hours to restore their health!</p>
          </div>
          <div class="bg-purple-50 rounded-xl p-3 mb-6">
            <p class="text-purple-600 text-sm">ðŸ’¡ Feed ${nc.scribbyName} immediately to restore their health!</p>
          </div>
          <button onclick="neglectConsequence=null;render()" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold py-4 rounded-2xl">
            I'll Feed Them Now! ðŸ’š
          </button>
        </div>
      </div>`;
    }
  }

  else if(screen==='home'&&!pMode){
    const stage=S.buddyStage||'egg';
    const canFeed=stage!=='egg'&&stage!=='adult';
    h=`<div class="p-5 pb-6">
      <div class="bg-white/95 rounded-3xl overflow-hidden mb-4 min-h-[70vh] flex flex-col">
        <div class="bg-gradient-to-r from-purple-100 to-pink-100 px-2 py-2 flex items-center justify-between border-b border-purple-200">
          <div class="flex items-center gap-2">
            <div class="flex items-center gap-1.5">
              ${renderXPIcon(24)}
              <div>
                <div class="text-purple-400 text-[9px] leading-none mb-0.5">XP</div>
                <div class="font-bold text-purple-700 text-xs">${S.xp}</div>
              </div>
            </div>
            <div class="flex items-center gap-1.5">
              ${renderStreakIcon(24)}
              <div>
                <div class="text-purple-400 text-[9px] leading-none mb-0.5">Streak</div>
                <div class="font-bold text-purple-700 text-xs">${S.streak}d</div>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-1">
            ${stage!=='egg'&&stage!=='adult'?`<button onclick="openModal('feed')" class="flex flex-col items-center gap-0.5 p-1 rounded-lg hover:bg-white/50 transition-colors" title="Feed Your Buddy">${renderFoodIcon(26)}<span class="text-[8px] text-purple-600 leading-none font-medium">Food</span></button>`:''}
            <button onclick="setScreen('closet')" class="flex flex-col items-center gap-0.5 p-1 rounded-lg hover:bg-white/50 transition-colors" title="Closet & Shop">${renderWearIcon(26)}<span class="text-[8px] text-purple-600 leading-none font-medium">Wear</span></button>
            <button onclick="setScreen('room')" class="flex flex-col items-center gap-0.5 p-1 rounded-lg hover:bg-white/50 transition-colors" title="Room & Furniture">${renderRoomIcon(26)}<span class="text-[8px] text-purple-600 leading-none font-medium">Room</span></button>
            <button onclick="setScreen('album')" class="flex flex-col items-center gap-0.5 p-1 rounded-lg hover:bg-white/50 transition-colors" title="Scribby Collection">${renderAlbumIcon(26)}<span class="text-[8px] text-purple-600 leading-none font-medium">Album</span></button>
            ${window.currentUser?.email?.toLowerCase()===OWNER_EMAIL.toLowerCase()?`<button onclick="setScreen('guide')" class="flex flex-col items-center gap-0.5 p-1 rounded-lg hover:bg-white/50 transition-colors" title="Scribby Guide">${renderGuideIcon(26)}<span class="text-[8px] text-purple-600 leading-none font-medium">Guide</span></button>`:''}
            <button onclick="setScreen('settings')" class="flex flex-col items-center gap-0.5 p-1 rounded-lg hover:bg-white/50 transition-colors" title="Settings">${renderMenuIcon(26)}<span class="text-[8px] text-purple-600 leading-none font-medium">Menu</span></button>
          </div>
        </div>
        <div class="flex-1 flex flex-col items-center p-8 text-center buddy-stage-3d">
          <div class="buddy-scene-wrapper${customizeMode?' customize-mode':''}">
            ${(S.placedFurniture&&S.placedFurniture.length>0)?`<div class="static-furniture-layer">${renderFurniture()}</div>`:''}
          <div class="buddy-float-container" style="position:relative;font-size:10rem;line-height:1;${(()=>{
            // Calculate dynamic styles based on stats
            let styles=[];

            // 1. Growth affects SIZE (scale 0.7 to 1.0)
            if(stage!=='egg'&&stage!=='adult'){
              const stageData=STAGES[stage];
              const growthPct=(S.growthXP||0)/(stageData?.growthNeeded||100);
              const scale=0.7+(growthPct*0.3); // 0.7 at 0%, 1.0 at 100%
              styles.push('transform:scale('+scale+')');
            }

            // 2. Health affects OPACITY (directly matches health %)
            const opacity=S.health/100; // 0% health = invisible, 100% health = solid
            styles.push('opacity:'+Math.max(0.1,opacity)); // Min 0.1 so it's not completely invisible

            // 3. Happiness affects ANIMATION SPEED (directly matches happiness %)
            // At 0% happiness = 5s (very slow), at 100% happiness = 0.5s (very fast)
            const animSpeed=0.5+(4.5*(1-(S.happiness/100)));
            styles.push('--anim-duration:'+animSpeed+'s');

            return styles.join(';');
          })()}" class="${(()=>{
            let classes=[];
            // Stage-specific animations (egg uses eggXP, not total XP!)
            if(stage==='egg'&&S.eggXP>=75)classes.push('egg-hatch-wiggle','sparkle');
            else if(stage==='egg'&&S.eggXP>=50)classes.push('egg-wiggle');
            else if(stage==='egg'&&S.eggXP>=25)classes.push('egg-rock');
            else if(stage==='egg'){} // No animation for fresh eggs
            else if(stage==='blob'){}  // Blob has internal animations
            else if(stage==='child'||stage==='teen'||stage==='adult')classes.push('bird-hop');
            // Combined state effects (override individual if both high or both low)
            // Don't apply these to eggs - they should stay still
            const hLvl=getHealthLevel();
            const happyLvl=getHappinessLevel();
            if(stage!=='egg'&&(S.health>=81&&S.happiness>=81)){
              classes.push('buddy-thriving');
            }else if(stage!=='egg'&&(S.health<=20||S.happiness<=20)){
              classes.push('buddy-crisis');
            }else{
              // Individual effects
              if(hLvl==='sick'||hLvl==='verySick')classes.push('health-'+hLvl.replace(/([A-Z])/g,'-$1').toLowerCase());
              classes.push('happiness-'+happyLvl);
            }
            // Pause animations when happiness is very low
            if(S.happiness<=10)classes.push('paused-animation');
            // Feeding animations
            if(feedingState){
              classes.push('feeding-container');
              classes.push(feedingState.accepted===false?'buddy-reject-shake':'buddy-happy-bounce');
            }
            classes.push('relative');
            return classes.join(' ');
          })()} ">
            ${renderBuddyVisual()}
            ${(()=>{
              // Status overlays for sick/sad states (only when not in feeding state)
              if(feedingState||stage==='egg')return'';
              const hLvl=getHealthLevel();
              const happyLvl=getHappinessLevel();
              let overlays='';
              // Health overlays (right side)
              if(hLvl==='verySick')overlays+=`<div class="status-overlay">ðŸŒ¡ï¸</div>`;
              else if(hLvl==='sick')overlays+=`<div class="status-overlay">ðŸ©¹</div>`;
              // Happiness overlays (left side)
              if(happyLvl==='verySad')overlays+=`<div class="status-overlay-left">ðŸ’”</div>`;
              else if(happyLvl==='sad')overlays+=`<div class="status-overlay-left">â˜ï¸</div>`;
              return overlays;
            })()}
            ${feedingState?`
              <div class="feeding-food">${feedingState.food.emoji}</div>
            `:''}
            <!-- 3D Floating Effects -->
            <div class="buddy-shadow"></div>
            <div class="buddy-aura"></div>
          </div>
          </div>
          <!-- Stats bar - below buddy scene -->
          <div class="stats-bar-container">
          ${feedingState?`
            <div class="feeding-message mb-4">
              <p class="text-2xl font-bold text-purple-800 mb-2">
                ${feedingState.accepted===false?`${S.buddyName||'Buddy'} refused the ${feedingState.food.name}!`:feedingState.growing?`${S.buddyName||'Buddy'} loved it and is growing!`:`${S.buddyName||'Buddy'} enjoyed the ${feedingState.food.name}!`}
              </p>
              ${feedingState.statChanges?`
                <div class="flex flex-row flex-nowrap justify-center gap-3 mb-3 text-sm font-semibold">
                  ${feedingState.statChanges.health!==0?`
                    <div class="flex items-center gap-1 whitespace-nowrap ${feedingState.statChanges.health>0?'text-green-600':'text-red-500'}">
                      <span>â¤ï¸</span>
                      <span>${feedingState.statChanges.health>0?'+':''}${feedingState.statChanges.health}</span>
                    </div>
                  `:''}
                  ${feedingState.statChanges.happiness!==0?`
                    <div class="flex items-center gap-1 whitespace-nowrap ${feedingState.statChanges.happiness>0?'text-green-600':'text-red-500'}">
                      <span>ðŸ˜Š</span>
                      <span>${feedingState.statChanges.happiness>0?'+':''}${feedingState.statChanges.happiness}</span>
                    </div>
                  `:''}
                  ${feedingState.statChanges.growth>0?`
                    <div class="flex items-center gap-1 whitespace-nowrap text-emerald-600">
                      <span>ðŸ“ˆ</span>
                      <span>+${feedingState.statChanges.growth}</span>
                    </div>
                  `:''}
                </div>
              `:''}
              ${feedingState.accepted===false?`<p class="text-sm text-purple-600 mb-3">The food stays in your inventory!</p>`:''}
              <button onclick="feedingState=null;render()" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 px-8 rounded-xl hover:scale-105 transition-transform">
                ${feedingState.accepted===false?'Try Again Later':feedingState.growing?'Amazing!':'Continue'}
              </button>
            </div>
          `:stage==='egg'?`
            <h2 class="text-3xl font-bold text-purple-700 mb-6 relative" style="z-index:20;">${STAGES[stage].name}</h2>
          `:``}
          ${customizeMode?`
            <div class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 bg-purple-100 border-2 border-purple-300 rounded-xl p-3 shadow-lg flex items-center gap-3">
              <div class="flex-1">
                <p class="text-purple-800 font-semibold text-sm">ðŸŽ¯ Customize Mode</p>
                <p class="text-purple-600 text-xs">Drag items to reposition</p>
              </div>
              <button onclick="if(confirm('Reset positions?')){delete S.accessoryPositions['${stage}'];delete S.furniturePositions['${stage}'];save();render()}" class="text-xs bg-purple-200 hover:bg-purple-300 text-purple-700 font-semibold py-2 px-3 rounded-lg">
                Reset
              </button>
              <button onclick="customizeMode=false;render()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-1 shadow">
                <span>âœ“</span> Done
              </button>
            </div>
          `:''}
          ${feedingState?'':`<div class="w-full grid grid-cols-3 gap-3">`}
            ${stage==='egg'?`
              <div class="flex items-center gap-2">
                ${renderEggProgressIcon(18)}
                <div class="flex-1">
                  <div class="h-2.5 bg-purple-100 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-green-500 to-emerald-500 rounded-full transition-all duration-500" style="width:${Math.min((S.eggXP||0)/STAGES.egg.hatchXP*100,100)}%"></div>
                  </div>
                </div>
                <span class="text-purple-600 text-xs font-bold min-w-[50px] text-right">${Math.min(S.eggXP||0,STAGES.egg.hatchXP)}/${STAGES.egg.hatchXP}</span>
              </div>
            `:stage==='adult'?`
              <div class="flex items-center gap-2">
                ${renderGrowthIcon(18,'adult',S.creatureCategory)}
                <div class="flex-1">
                  <div class="h-2.5 bg-purple-100 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-green-500 to-emerald-500 rounded-full transition-all duration-500" style="width:100%"></div>
                  </div>
                </div>
                <span class="text-purple-600 text-xs font-bold min-w-[36px] text-right">Max</span>
              </div>
            `:(() => {
              const stageData=STAGES[stage];
              const currentGrowth=Math.min(S.growthXP||0,stageData.growthNeeded);
              const pct=Math.min(currentGrowth/stageData.growthNeeded*100,100);
              return`<div class="flex items-center gap-2">
                ${renderGrowthIcon(18,stage,S.creatureCategory)}
                <div class="flex-1">
                  <div class="h-2.5 bg-purple-100 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-green-500 to-emerald-500 rounded-full transition-all duration-500" style="width:${pct}%"></div>
                  </div>
                </div>
                <span class="text-purple-600 text-xs font-bold min-w-[50px] text-right">${currentGrowth}/${stageData.growthNeeded}</span>
              </div>`;
            })()}
            <div class="flex items-center gap-2">
              ${renderHealthIcon(18)}
              <div class="flex-1">
                <div class="h-2.5 bg-purple-100 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-red-400 to-red-500 rounded-full transition-all duration-500" style="width:${S.health}%"></div>
                </div>
              </div>
              <span class="text-purple-600 text-xs font-bold min-w-[36px] text-right">${S.health}%</span>
            </div>
            <div class="flex items-center gap-2">
              ${renderHappinessIcon(18)}
              <div class="flex-1">
                <div class="h-2.5 bg-purple-100 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-full transition-all duration-500" style="width:${S.happiness}%"></div>
                </div>
              </div>
              <span class="text-purple-600 text-xs font-bold min-w-[36px] text-right">${S.happiness}%</span>
            </div>
          ${feedingState?'':`</div>`}
          ${stage!=='egg'&&!feedingState?`
            <div class="mt-2 relative" style="z-index:20;">
              ${S.buddyName?`
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl" style="background:linear-gradient(145deg,#a78bfa,#c4b5fd);border:3px solid #7c3aed;box-shadow:0 4px 12px rgba(124,58,237,0.3),inset 0 2px 4px rgba(255,255,255,0.3);">
                  <span class="text-xl font-black text-white drop-shadow-sm" style="text-shadow:1px 1px 2px rgba(0,0,0,0.2);">${S.buddyName}</span>
                  <button onclick="const n=prompt('Rename your buddy:',S.buddyName);if(n&&n.trim()){S.buddyName=n.trim();save();render()}" class="text-white/80 hover:text-white hover:scale-110 transition-all" title="Rename buddy">âœï¸</button>
                  ${!customizeMode&&(S.equipped.hat!==null||S.equipped.eyes!==null||S.equipped.held!==null||S.equipped.back!==null||S.equipped.effect!==null||(S.placedFurniture&&S.placedFurniture.length>0))?`
                    <button onclick="customizeMode=true;render()" class="hover:scale-110 transition-all" title="Move items">
                      ${renderMoveIcon(18)}
                    </button>
                  `:''}
                </div>
                <p class="text-purple-500 text-xs mt-1">${STAGES[stage].name}</p>
              `:`
                <div class="inline-flex items-center gap-2">
                  <button onclick="const n=prompt('Name your buddy:');if(n&&n.trim()){S.buddyName=n.trim();save();render()}" class="px-4 py-2 rounded-2xl text-white font-bold hover:scale-105 transition-all" style="background:linear-gradient(145deg,#a78bfa,#c4b5fd);border:3px solid #7c3aed;box-shadow:0 4px 12px rgba(124,58,237,0.3),inset 0 2px 4px rgba(255,255,255,0.3);">+ Name Your ${STAGES[stage].name}</button>
                  ${!customizeMode&&(S.equipped.hat!==null||S.equipped.eyes!==null||S.equipped.held!==null||S.equipped.back!==null||S.equipped.effect!==null||(S.placedFurniture&&S.placedFurniture.length>0))?`
                    <button onclick="customizeMode=true;render()" class="hover:scale-110 transition-all" title="Move items">
                      ${renderMoveIcon(20)}
                    </button>
                  `:''}
                </div>
              `}
            </div>
          `:''}
          </div>
        </div>
      </div>
      ${S.verses.length?`<div class="grid ${S.verses.filter(v=>v.status==='active').length>=2?'grid-cols-3':'grid-cols-2'} gap-2 mb-4">
        <button onclick="quickPractice()" class="bg-gradient-to-r from-yellow-400 to-amber-500 text-white font-bold py-3 px-2 rounded-2xl flex flex-col items-center justify-center gap-1 shadow-lg">
          ${renderQuickPracticeIcon(28)}
          <span class="text-xs">Quick Practice</span>
        </button>
        ${S.verses.filter(v=>v.status==='active').length>=2?`<button onclick="startPractice('match')" class="bg-gradient-to-r from-orange-400 to-orange-500 text-white font-bold py-3 px-2 rounded-2xl flex flex-col items-center justify-center gap-1 shadow-lg">
          ${renderMatchIcon(28)}
          <span class="text-xs">Matching Game</span>
        </button>`:''}
        <button onclick="setScreen('practice')" class="bg-gradient-to-r from-orange-400 to-orange-500 text-white font-bold py-3 px-2 rounded-2xl flex flex-col items-center justify-center gap-1 shadow-lg">
          ${renderChoosePracticeIcon(28)}
          <span class="text-xs">Choose Practice</span>
        </button>
      </div>`:''}
      ${stage==='adult'?`<div class="mb-4">
        <button onclick="graduationCeremony=true;render()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2">
          <span class="text-xl">ðŸŽ“</span>
          <span>Graduate ${S.buddyName||'Buddy'}</span>
        </button>
      </div>`:''}
      <div class="grid grid-cols-3 gap-2">
        <button onclick="setScreen('verses')" class="bg-white/15 hover:bg-white/25 rounded-xl py-3 px-2 flex flex-col items-center gap-1.5 transition-colors">
          ${renderVersesIcon(24)}
          <span class="text-white text-xs font-medium">Verses</span>
          <span class="bg-white/20 text-white text-xs font-bold px-2 py-0.5 rounded-full">${S.verses.length}</span>
        </button>
        <button onclick="openModal('mastered')" class="bg-white/15 hover:bg-white/25 rounded-xl py-3 px-2 flex flex-col items-center gap-1.5 transition-colors">
          ${renderScribbyIcon('â­',24,{bg:'#fde047',border:'#ca8a04',gradient:'#fef08a'})}
          <span class="text-white text-xs font-medium">Mastered</span>
          <span class="bg-white/20 text-white text-xs font-bold px-2 py-0.5 rounded-full">${M}</span>
        </button>
        <button onclick="setScreen('trade')" class="bg-white/15 hover:bg-white/25 rounded-xl py-3 px-2 flex flex-col items-center gap-1.5 transition-colors">
          ${renderTradeIcon(24)}
          <span class="text-white text-xs font-medium">Trade</span>
          <span class="text-white/0 text-xs px-2 py-0.5">Â·</span>
        </button>
      </div>
    </div>`;
  }

  else if(screen==='trade'&&!pMode){
    // Show sign-in message if not logged in
    if(!window.currentUser){
      h=`<div class="p-5 pb-6">
        <div class="flex items-center justify-between mb-4">
          <button onclick="setScreen('home')" class="bg-white/20 text-white font-bold w-10 h-10 rounded-xl flex items-center justify-center text-xl">â†</button>
          <div class="text-center">
            <p class="text-white text-lg font-bold">Trade with Friends</p>
          </div>
          <div class="w-10"></div>
        </div>
        <div class="bg-white rounded-3xl p-8 text-center">
          <div class="text-6xl mb-4">ðŸ¤</div>
          <h2 class="text-2xl font-bold text-purple-800 mb-3">Sign In to Trade</h2>
          <p class="text-purple-600 mb-6">Trade Scribbies and items with friends! Sign in with Google to get started.</p>
          <button onclick="signInWithGoogle()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-3 text-lg">
            <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Sign in with Google
          </button>
        </div>
      </div>`;
    } else {
    // Check for claimed trades in background (will re-render if any found)
    checkClaimedTrades();

    // Get all adult Scribbies (including pending trades - we'll style them differently)
    const allGraduated=S.graduatedBuddies||[];
    const adultScribbies=allGraduated;

    // Get tradeable items by type (exclude equipped items)
    // Note: Items are REMOVED from inventory when traded, so we just count what's in inventory
    const equippedIds=Object.values(S.equipped||{}).filter(id=>id!==null);

    // Wearable accessories (hats, eyes, held, back, effect) - count multiples
    const accessoryCounts={};
    (S.inventory||[]).forEach(idx=>{
      const acc=ACCESSORIES[idx];
      if(acc&&['hat','eyes','held','back','effect'].includes(acc.type)&&!equippedIds.includes(idx)){
        if(!accessoryCounts[idx])accessoryCounts[idx]={idx,count:0};
        accessoryCounts[idx].count++;
      }
    });
    const tradeableAccessories=Object.values(accessoryCounts);

    // Stored food items from ACCESSORIES (tradeable, count multiples)
    const foodTradeCounts={};
    (S.inventory||[]).forEach(idx=>{
      const acc=ACCESSORIES[idx];
      if(acc&&acc.type==='food'){
        if(!foodTradeCounts[idx])foodTradeCounts[idx]={...acc,idx,count:0,tradeable:true};
        foodTradeCounts[idx].count++;
      }
    });
    const tradeableFood=Object.values(foodTradeCounts);

    // Regular food from FOODS (feed inventory - NOT tradeable, but show for info)
    const regularFoodCounts={};
    (S.foodInventory||[]).forEach(foodIdx=>{
      const f=FOODS[foodIdx];
      if(f){
        if(!regularFoodCounts[foodIdx])regularFoodCounts[foodIdx]={...f,foodIdx,count:0,tradeable:false};
        regularFoodCounts[foodIdx].count++;
      }
    });
    const regularFood=Object.values(regularFoodCounts);

    // Room items (count multiples)
    const roomTradeCounts={};
    (S.inventory||[]).forEach(idx=>{
      const acc=ACCESSORIES[idx];
      if(acc&&acc.type==='room'){
        if(!roomTradeCounts[idx])roomTradeCounts[idx]={...acc,idx,count:0};
        roomTradeCounts[idx].count++;
      }
    });
    const tradeableRoom=Object.values(roomTradeCounts);

    const scribbyCards=adultScribbies.length>0?adultScribbies.map(buddy=>{
      const cat=buddy.category||buddy.creatureCategory;
      const category=CREATURE_CATEGORIES[cat];
      const varIdx=buddy.variant!==undefined?buddy.variant:buddy.creatureVariant;
      const name=buddy.name||buddy.creatureName||category?.adultNames?.[varIdx]||'Scribby';
      // Render actual Scribby visual
      let scribbyVisual='';
      if(cat==='birds'){
        scribbyVisual=renderAdultBird(varIdx);
      }else if(cat==='reptiles'){
        scribbyVisual=renderAdultReptile(varIdx);
      }else if(cat==='mammals'){
        scribbyVisual=renderAdultMammal(varIdx);
      }else if(cat==='mystical'){
        scribbyVisual=renderAdultMystical(varIdx);
      }else if(cat==='prehistoric'){
        scribbyVisual=renderAdultPrehistoric(varIdx);
      }else if(cat==='aquatic'){
        scribbyVisual=renderAdultAquatic(varIdx);
      }else if(cat==='alien'){
        scribbyVisual=renderAdultAlien(varIdx);
      }else if(cat==='insects'){
        scribbyVisual=renderAdultInsect(varIdx);
      }else{
        // For other categories, use emoji
        const emoji=category?.adultVariants?.[varIdx]||'ðŸ¾';
        scribbyVisual=`<div style="font-size:4rem;">${emoji}</div>`;
      }
      return`
        <button onclick="showTradeTerms(${buddy.id})" class="bg-white hover:bg-purple-50 rounded-2xl p-3 flex flex-col items-center transition-colors relative">
          <div class="mb-1" style="width:64px;height:64px;display:flex;align-items:center;justify-content:center;overflow:visible;">
            <div style="transform:scale(0.22);transform-origin:center center;width:120px;height:120px;display:flex;align-items:center;justify-content:center;">${scribbyVisual}</div>
          </div>
          <p class="text-purple-800 font-bold text-xs truncate w-full text-center">${name}</p>
        </button>
      `;
    }).join(''):`
      <div class="col-span-4 bg-white/50 rounded-2xl p-4 text-center">
        <p class="text-purple-700 text-sm">No adult Scribbies yet</p>
      </div>
    `;

    const accessoryCards=tradeableAccessories.length>0?tradeableAccessories.map(item=>{
      const acc=ACCESSORIES[item.idx];
      return`
        <button onclick="showAccessoryTrade(${item.idx})" class="bg-white hover:bg-pink-50 rounded-2xl p-3 flex flex-col items-center transition-colors relative">
          <div class="text-3xl mb-1">${acc.emoji}</div>
          <p class="text-pink-800 font-bold text-xs truncate w-full text-center">${acc.name}</p>
          ${item.count>1?`<div class="absolute -top-1 -right-1 bg-pink-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">Ã—${item.count}</div>`:''}
        </button>
      `;
    }).join(''):`
      <div class="col-span-4 bg-white/50 rounded-2xl p-4 text-center">
        <p class="text-pink-700 text-sm">No accessories to trade</p>
      </div>
    `;

    const foodCards=tradeableFood.length>0?`
      ${tradeableFood.map(acc=>`
        <button onclick="showAccessoryTrade(${acc.idx})" class="bg-white rounded-2xl p-3 flex flex-col items-center hover:bg-orange-50 transition-colors relative">
          <div class="text-3xl mb-1">${acc.emoji}</div>
          <p class="text-orange-800 font-bold text-xs truncate w-full text-center">${acc.name}</p>
          ${acc.count>1?`<div class="absolute -top-1 -right-1 bg-orange-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">Ã—${acc.count}</div>`:''}
        </button>
      `).join('')}
    `:`
      <div class="col-span-4 bg-white/50 rounded-2xl p-4 text-center">
        <p class="text-orange-700 text-sm">No food to trade</p>
      </div>
    `;

    const roomCards=tradeableRoom.length>0?tradeableRoom.map(item=>`
        <button onclick="showAccessoryTrade(${item.idx})" class="bg-white rounded-2xl p-3 flex flex-col items-center hover:bg-blue-50 transition-colors relative">
          <div class="mb-1">${renderFurnitureIcon(item.emoji, 40)}</div>
          <p class="text-blue-800 font-bold text-xs truncate w-full text-center">${item.name}</p>
          ${item.count>1?`<div class="absolute -top-1 -right-1 bg-blue-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">Ã—${item.count}</div>`:''}
        </button>
      `).join(''):`
      <div class="col-span-4 bg-white/50 rounded-2xl p-4 text-center">
        <p class="text-blue-700 text-sm">No room items to trade</p>
      </div>
    `;

    // Build pending trades section (trades waiting to be claimed)
    const pendingScribbies=S.pendingScribbyTrades||[];
    const pendingAccessories=S.pendingAccessoryTrades||[];
    const hasPendingTrades=pendingScribbies.length>0||pendingAccessories.length>0;

    const pendingScribbyCards=pendingScribbies.map(trade=>{
      const buddy=trade.buddy;
      const cat=buddy.category||buddy.creatureCategory;
      const category=CREATURE_CATEGORIES[cat];
      const varIdx=buddy.variant!==undefined?buddy.variant:buddy.creatureVariant;
      const name=buddy.name||buddy.creatureName||category?.adultNames?.[varIdx]||'Scribby';
      let scribbyVisual='';
      if(cat==='birds'){
        scribbyVisual=renderAdultBird(varIdx);
      }else if(cat==='reptiles'){
        scribbyVisual=renderAdultReptile(varIdx);
      }else if(cat==='mammals'){
        scribbyVisual=renderAdultMammal(varIdx);
      }else if(cat==='mystical'){
        scribbyVisual=renderAdultMystical(varIdx);
      }else if(cat==='prehistoric'){
        scribbyVisual=renderAdultPrehistoric(varIdx);
      }else if(cat==='aquatic'){
        scribbyVisual=renderAdultAquatic(varIdx);
      }else if(cat==='alien'){
        scribbyVisual=renderAdultAlien(varIdx);
      }else if(cat==='insects'){
        scribbyVisual=renderAdultInsect(varIdx);
      }else{
        const emoji=category?.adultVariants?.[varIdx]||'ðŸ¾';
        scribbyVisual=`<div style="font-size:4rem;">${emoji}</div>`;
      }
      return`
        <button onclick="showPendingScribbyTrade('${trade.code}')" class="bg-yellow-100 ring-2 ring-yellow-400 rounded-2xl p-3 flex flex-col items-center transition-colors relative">
          <div class="absolute top-1 right-1 bg-yellow-500 text-white text-[8px] font-bold px-1.5 py-0.5 rounded-full">PENDING</div>
          <div class="mb-1 opacity-60" style="width:64px;height:64px;display:flex;align-items:center;justify-content:center;overflow:visible;">
            <div style="transform:scale(0.22);transform-origin:center center;width:120px;height:120px;display:flex;align-items:center;justify-content:center;">${scribbyVisual}</div>
          </div>
          <p class="text-yellow-700 font-bold text-xs truncate w-full text-center">${name}</p>
        </button>
      `;
    }).join('');

    const pendingAccCards=pendingAccessories.map(trade=>{
      const acc=trade.accessory||ACCESSORIES[trade.accIdx];
      const qty=trade.quantity||1;
      const isRoom=acc?.type==='room';
      const isToy=acc?.type==='toy';
      const iconHtml=isRoom?renderFurnitureIcon(acc.emoji,40):isToy?renderToyIcon(acc.emoji,40):`<span class="text-3xl">${acc?.emoji||'ðŸŽ'}</span>`;
      return`
        <button onclick="showPendingAccessoryTradeByCode('${trade.code}')" class="bg-yellow-100 ring-2 ring-yellow-400 rounded-2xl p-3 flex flex-col items-center transition-colors relative">
          <div class="absolute top-1 right-1 bg-yellow-500 text-white text-[8px] font-bold px-1.5 py-0.5 rounded-full">PENDING</div>
          ${qty>1?`<div class="absolute top-1 left-1 bg-orange-500 text-white text-[8px] font-bold px-1.5 py-0.5 rounded-full">Ã—${qty}</div>`:''}
          <div class="mb-1 opacity-60">${iconHtml}</div>
          <p class="text-yellow-700 font-bold text-xs truncate w-full text-center">${acc?.name||'Item'}</p>
        </button>
      `;
    }).join('');

    h=`<div class="p-5 pb-6">
      <div class="flex items-center justify-between mb-4">
        <button onclick="setScreen('home')" class="bg-white/20 text-white font-bold w-10 h-10 rounded-xl flex items-center justify-center text-xl">â†</button>
        <div class="text-center">
          <p class="text-white text-lg font-bold">Trade with Friends</p>
          <p class="text-white/70 text-xs">Give and receive items</p>
        </div>
        <div class="w-10"></div>
      </div>

      <div class="space-y-4">
        <!-- Pending Trades Section (only shows if there are pending trades) -->
        ${hasPendingTrades?`
        <div class="bg-yellow-50 rounded-2xl p-4 border-2 border-yellow-300">
          <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2">
              ${renderPendingIcon(28)}
              <h3 class="text-yellow-800 font-bold text-lg">Your Pending Trades</h3>
            </div>
            <span class="text-yellow-600 text-sm">${pendingScribbies.length+pendingAccessories.length} waiting</span>
          </div>
          <p class="text-yellow-700 text-sm mb-3">These items are waiting to be claimed. Tap to view code or cancel:</p>
          <div class="grid grid-cols-4 gap-2">
            ${pendingScribbyCards}
            ${pendingAccCards}
          </div>
        </div>
        `:''}

        <!-- Get from Friend Section -->
        <div class="bg-white rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-3">
            ${renderReceiveIcon(28)}
            <h3 class="text-purple-800 font-bold text-lg">Get from a Friend</h3>
          </div>
          <p class="text-purple-600 text-sm mb-3">Has a friend shared something with you? Enter their code!</p>
          <div class="grid grid-cols-2 gap-2">
            <button onclick="showRedeemTrade()" class="bg-gradient-to-r from-purple-500 to-violet-500 text-white font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition-colors">
              <span>âŒ¨ï¸</span>
              <span>Type Code</span>
            </button>
            <button onclick="showRedeemTrade();setTimeout(toggleQRScanner,300)" class="bg-gradient-to-r from-violet-500 to-purple-500 text-white font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition-colors">
              <span>ðŸ“·</span>
              <span>Scan QR</span>
            </button>
          </div>
        </div>

        <!-- Give Scribbies Section -->
        <div class="bg-white rounded-2xl p-4">
          <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2">
              ${renderGiveScribbyIcon(28)}
              <h3 class="text-purple-800 font-bold text-lg">Give a Scribby</h3>
            </div>
            <span class="text-purple-500 text-sm">${adultScribbies.length} available</span>
          </div>
          <p class="text-purple-600 text-sm mb-3">Tap a Scribby to share it with a friend:</p>
          <div class="grid grid-cols-4 gap-2">
            ${scribbyCards}
          </div>
        </div>

        <!-- Give Food Section -->
        <div class="bg-white rounded-2xl p-4">
          <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2">
              ${renderGiveFoodIcon(28)}
              <h3 class="text-purple-800 font-bold text-lg">Give Food</h3>
            </div>
            <span class="text-purple-500 text-sm">${tradeableFood.length} available</span>
          </div>
          <p class="text-purple-600 text-sm mb-3">Tap food to share it:</p>
          <div class="grid grid-cols-4 gap-2">
            ${foodCards}
          </div>
        </div>

        <!-- Give Accessories Section -->
        <div class="bg-white rounded-2xl p-4">
          <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2">
              ${renderGiveAccessoriesIcon(28)}
              <h3 class="text-purple-800 font-bold text-lg">Give Accessories</h3>
            </div>
            <span class="text-purple-500 text-sm">${tradeableAccessories.length} available</span>
          </div>
          <p class="text-purple-600 text-sm mb-3">Tap an accessory to share it:</p>
          <div class="grid grid-cols-4 gap-2">
            ${accessoryCards}
          </div>
        </div>

        <!-- Give Room Items Section -->
        <div class="bg-white rounded-2xl p-4">
          <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2">
              ${renderGiveRoomIcon(28)}
              <h3 class="text-purple-800 font-bold text-lg">Give Room Items</h3>
            </div>
            <span class="text-purple-500 text-sm">${tradeableRoom.length} available</span>
          </div>
          <p class="text-purple-600 text-sm mb-3">Tap an item to share it:</p>
          <div class="grid grid-cols-4 gap-2">
            ${roomCards}
          </div>
        </div>

        <!-- How it works -->
        <div class="bg-purple-50 rounded-2xl p-4 border border-purple-100">
          <div class="flex items-center gap-2 mb-2">
            ${renderHowItWorksIcon(24)}
            <h3 class="text-purple-800 font-semibold text-sm">How Trading Works</h3>
          </div>
          <div class="space-y-1 text-purple-700 text-xs">
            <p>ðŸ‘† <strong>To give:</strong> Tap an item â†’ Show the code to your friend</p>
            <p>ðŸ¤² <strong>To get:</strong> Ask your friend for their code â†’ Type it or scan</p>
            <p>ðŸ”„ <strong>Changed your mind?</strong> You can cancel anytime before they claim it!</p>
          </div>
        </div>
      </div>
    </div>`;
    }
  }

  else if(screen==='album'&&!pMode){
    const graduated=S.graduatedBuddies||[];

    // Build collection tracking data (only for fully designed categories)
    const collected={};
    FULLY_DESIGNED_CATEGORIES.forEach(cat=>{
      collected[cat]={hasAny:false,variants:new Set()};
    });
    graduated.forEach(buddy=>{
      if(buddy.creatureCategory&&FULLY_DESIGNED_CATEGORIES.includes(buddy.creatureCategory)){
        collected[buddy.creatureCategory].hasAny=true;
        if(buddy.creatureVariant!==undefined&&buddy.creatureVariant!==null){
          collected[buddy.creatureCategory].variants.add(buddy.creatureVariant);
        }
      }
    });

    // Count total collected unique variants
    let totalCollected=0;
    let totalPossible=0;
    FULLY_DESIGNED_CATEGORIES.forEach(cat=>{
      const category=CREATURE_CATEGORIES[cat];
      if(category){
        totalPossible+=category.adultVariants.length;
        totalCollected+=collected[cat].variants.size;
      }
    });

    // Helper to render uncollected placeholder
    const uncollectedCircle=`<div style="width:50px;height:50px;border-radius:50%;border:3px dashed rgba(147,112,219,0.3);display:flex;align-items:center;justify-content:center;"><span class="text-purple-300 text-2xl">?</span></div>`;

    h=`<div class="p-5 pb-6">
      <div class="flex items-center justify-between mb-2">
        <button onclick="setScreen('home')" class="bg-white/20 text-white font-bold w-10 h-10 rounded-xl flex items-center justify-center text-xl">â†</button>
        <div class="text-center">
          <p class="text-white text-lg font-bold">${totalCollected}/${totalPossible} Scribbies Collected</p>
          <p class="text-white/70 text-xs">${graduated.length} graduated companion${graduated.length!==1?'s':''}</p>
        </div>
        <div class="w-10"></div>
      </div>

      <div class="space-y-4">
        ${FULLY_DESIGNED_CATEGORIES.map(categoryKey=>{
          const category=CREATURE_CATEGORIES[categoryKey];
          const categoryName=categoryKey.charAt(0).toUpperCase()+categoryKey.slice(1);
          const hasAnyCollected=collected[categoryKey].hasAny;
          const collectedVariants=collected[categoryKey].variants;
          const categoryBuddies=graduated.filter(b=>b.creatureCategory===categoryKey);

          return`<div class="bg-white rounded-2xl p-4">
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-purple-800 font-bold text-lg">${categoryName}</h3>
              <span class="text-purple-500 text-sm">${collectedVariants.size}/${category.adultVariants.length}</span>
            </div>

            <!-- Blob Stage -->
            <div class="mb-3 pb-3 border-b border-purple-200">
              <p class="text-purple-600 text-sm font-semibold mb-2">Blob Stage</p>
              <div class="flex items-center gap-3">
                ${hasAnyCollected?`
                  <div class="cursor-pointer hover:scale-110 transition-transform" style="transform:scale(0.6);transform-origin:left center;" onclick="showCollectionStageCard('blob','${categoryKey}')">${renderBlob(categoryKey)}</div>
                  <div class="text-sm text-purple-700">
                    <p class="font-semibold">Blob</p>
                    <p class="text-xs text-purple-500">First evolution stage</p>
                  </div>
                `:`
                  <div style="opacity:0.3;">${uncollectedCircle}</div>
                  <div class="text-sm text-purple-400">
                    <p class="font-semibold">???</p>
                    <p class="text-xs">Graduate a ${categoryName.toLowerCase()} to unlock</p>
                  </div>
                `}
              </div>
            </div>

            <!-- Baby Stage -->
            <div class="mb-3 pb-3 border-b border-purple-200">
              <p class="text-purple-600 text-sm font-semibold mb-2">Baby Stage</p>
              <div class="flex items-center gap-3">
                ${hasAnyCollected?`
                  <div class="cursor-pointer hover:scale-110 transition-transform" style="transform:scale(0.55);transform-origin:left center;" onclick="showCollectionStageCard('baby','${categoryKey}')">${renderBaby(categoryKey)}</div>
                  <div class="text-sm text-purple-700">
                    <p class="font-semibold">${categoryName} Baby</p>
                    <p class="text-xs text-purple-500">Developing features</p>
                  </div>
                `:`
                  <div style="opacity:0.3;">${uncollectedCircle}</div>
                  <div class="text-sm text-purple-400">
                    <p class="font-semibold">???</p>
                    <p class="text-xs">Graduate a ${categoryName.toLowerCase()} to unlock</p>
                  </div>
                `}
              </div>
            </div>

            <!-- Teen Stage -->
            <div class="mb-3 pb-3 border-b border-purple-200">
              <p class="text-purple-600 text-sm font-semibold mb-2">Teen Stage</p>
              <div class="flex items-center justify-around gap-4">
                ${[0,5,8].map(variantIdx=>{
                  const isCollected=collectedVariants.has(variantIdx);
                  const buddyInfo=categoryBuddies.find(b=>b.creatureVariant===variantIdx);
                  const name=category.teenNames[variantIdx];
                  return`<div class="flex flex-col items-center ${isCollected?'cursor-pointer hover:bg-purple-50 rounded-lg p-2':''}" ${isCollected&&buddyInfo?`onclick="showScribbyCard('${categoryKey}',${variantIdx},${buddyInfo.id},'teen')"`:''}>
                    <div style="width:70px;height:75px;overflow:visible;display:flex;align-items:center;justify-content:center;">
                      ${isCollected?`
                        <div style="transform:scale(0.45);transform-origin:center;">${renderTeen(categoryKey,variantIdx)}</div>
                      `:`
                        <div style="width:50px;height:50px;border-radius:50%;border:2px dashed rgba(147,112,219,0.25);display:flex;align-items:center;justify-content:center;">
                          <span class="text-purple-200 text-xl">?</span>
                        </div>
                      `}
                    </div>
                    <p class="text-[9px] ${isCollected?'text-purple-600':'text-purple-300'} leading-tight text-center">${isCollected?name:'???'}</p>
                  </div>`;
                }).join('')}
              </div>
            </div>

            <!-- Adult Stage -->
            <div>
              <p class="text-purple-600 text-sm font-semibold mb-2">Adult Stage</p>
              <div class="grid grid-cols-5 gap-x-2 gap-y-3">
                ${category.adultVariants.map((emoji,idx)=>{
                  const isCollected=collectedVariants.has(idx);
                  const buddyInfo=categoryBuddies.find(b=>b.creatureVariant===idx);

                  return`<div class="flex flex-col items-center pt-1 ${isCollected?'cursor-pointer hover:bg-purple-50 rounded-lg transition-colors':''}" ${isCollected&&buddyInfo?`onclick="showScribbyCard('${categoryKey}',${idx},${buddyInfo.id})"`:''}>
                    <div style="width:60px;height:70px;overflow:visible;display:flex;align-items:center;justify-content:center;">
                      ${isCollected?`
                        <div style="transform:scale(0.25);transform-origin:center;">${categoryKey==='birds'?renderAdultBird(idx):categoryKey==='reptiles'?renderAdultReptile(idx):categoryKey==='mammals'?renderAdultMammal(idx):categoryKey==='mystical'?renderAdultMystical(idx):categoryKey==='prehistoric'?renderAdultPrehistoric(idx):categoryKey==='aquatic'?renderAdultAquatic(idx):categoryKey==='alien'?renderAdultAlien(idx):categoryKey==='insects'?renderAdultInsect(idx):`<div class="text-2xl">${emoji}</div>`}</div>
                      `:`
                        <div style="width:50px;height:50px;border-radius:50%;border:3px dashed rgba(147,112,219,0.3);display:flex;align-items:center;justify-content:center;">
                          <span class="text-purple-300 text-2xl">?</span>
                        </div>
                      `}
                    </div>
                    <p class="text-[9px] ${isCollected?'text-purple-600':'text-purple-300'} leading-tight text-center mt-1" style="position:relative;z-index:100;">${isCollected?category.adultNames[idx]:'???'}</p>
                    ${buddyInfo?`<p class="text-[7px] text-purple-400 leading-tight">${buddyInfo.name}</p>`:''}
                  </div>`;
                }).join('')}
              </div>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  }

  else if(screen==='verses'&&!pMode){
    const activeVerses=S.verses.filter(v=>v.status==='active');
    const storedVerses=S.verses.filter(v=>v.status==='saved');
    const statusFiltered=verseFilter==='active'?activeVerses:storedVerses;
    const filteredVerses=filterTag?statusFiltered.filter(v=>v.tags.includes(filterTag)):statusFiltered;
    const usedTags=[...new Set(statusFiltered.flatMap(v=>v.tags))].sort();
    const list=filteredVerses.map(v=>{
      const isActive=v.status==='active';
      return`<div class="bg-white rounded-2xl p-4 mb-3">
      <div class="flex gap-3">
        <div class="flex-1${v.userAdded?' cursor-pointer':''}" ${v.userAdded?`onclick="openModal('edit',${JSON.stringify(v).replace(/"/g,'&quot;')})"`:''}>
          <div class="flex justify-between mb-1">
            <p class="font-bold text-purple-800">${v.ref}</p>
            <div class="text-right">
              <div class="text-sm mb-0.5">${getStars(v.mastery)}</div>
              <div class="text-xs text-purple-500 font-semibold">${v.mastery.toFixed(1)} / 5</div>
            </div>
          </div>
          <div class="h-1.5 bg-purple-100 rounded-full mb-2">
            <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full transition-all" style="width:${v.mastery/5*100}%"></div>
          </div>
          <p class="text-purple-700 text-sm line-clamp-2">${v.text}</p>
          <div class="flex flex-wrap gap-1 mt-2">${v.tags.map(t=>`<span class="text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-600">${t}</span>`).join('')}</div>
        </div>
        <div class="flex flex-col gap-2">
          <button onclick="selectedVerse=${v.id};setScreen('practice')" class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl flex items-center justify-center text-xl" title="Practice this verse">â–¶ï¸</button>
          <button onclick="if(confirm('Delete this verse?'))deleteVerse(${v.id})" class="flex-shrink-0 w-12 h-10 bg-red-100 text-red-500 rounded-xl flex items-center justify-center text-lg" title="Delete verse">ðŸ—‘ï¸</button>
        </div>
      </div>
      <div class="flex justify-end mt-2 pt-2 border-t border-purple-100">
        <button onclick="toggleVerseStatus(${v.id})" class="text-xs px-3 py-1.5 rounded-lg ${isActive?'bg-gray-100 text-gray-600 hover:bg-gray-200':'bg-green-100 text-green-700 hover:bg-green-200'} font-medium">
          ${isActive?'Store for later':'Practice now'}
        </button>
      </div>
    </div>`}).join('');
    const statusTabs=`<div class="flex gap-2 mb-3">
      <button onclick="verseFilter='active';filterTag=null;render()" class="flex-1 py-2 px-3 rounded-xl font-semibold text-sm ${verseFilter==='active'?'bg-white text-purple-700':'bg-white/20 text-white'}">
        Practice Now (${activeVerses.length})
      </button>
      <button onclick="verseFilter='saved';filterTag=null;render()" class="flex-1 py-2 px-3 rounded-xl font-semibold text-sm ${verseFilter==='saved'?'bg-white text-purple-700':'bg-white/20 text-white'}">
        Stored (${storedVerses.length})
      </button>
    </div>`;
    h=`<div class="p-5 pb-6">
      <div class="flex justify-between items-center mb-4">
        <button onclick="setScreen('home')" class="bg-white/20 text-white font-bold w-10 h-10 rounded-xl flex items-center justify-center text-xl">â†</button>
        <h1 class="text-2xl font-bold text-white">My Verses</h1>
        <button onclick="openModal('add')" class="bg-white/20 text-white font-bold py-2 px-4 rounded-xl">+ Add</button>
      </div>
      ${S.verses.length?statusTabs:''}
      ${usedTags.length?`<div class="mb-4">
        <p class="text-white/80 text-xs mb-2">Filter by tag:</p>
        <div class="flex flex-wrap gap-2">
          <button onclick="filterTag=null;render()" class="text-xs px-3 py-1.5 rounded-full ${!filterTag?'bg-white text-purple-700':'bg-white/20 text-white'}">All</button>
          ${usedTags.map(t=>`<button onclick="filterTag='${t}';render()" class="text-xs px-3 py-1.5 rounded-full ${filterTag===t?'bg-white text-purple-700':'bg-white/20 text-white'}">${t}</button>`).join('')}
        </div>
      </div>`:''}
      ${S.verses.length?filteredVerses.length?list:`<div class="bg-white/95 rounded-3xl p-8 text-center"><p class="text-4xl mb-4">${filterTag?'ðŸ”':'ðŸ“š'}</p><p class="text-purple-800">${filterTag?`No verses with "${filterTag}" tag`:verseFilter==='active'?'No verses to practice. Check "Stored" or add new ones!':'No stored verses yet.'}</p>${filterTag?`<button onclick="filterTag=null;render()" class="mt-3 text-purple-600 font-semibold">Show All</button>`:''}</div>`:'<div class="bg-white/95 rounded-3xl p-8 text-center"><p class="text-4xl mb-4">ðŸ“–</p><p class="text-purple-800">No verses yet!</p></div>'}
    </div>`;
  }

  else if(screen==='library'&&!pMode){
    // Combine curated and downloaded libraries
    const library=getAllLibraryVerses();
    const userVerseRefs=S.verses.map(v=>v.ref);

    // 4-level hierarchical navigation: Collections -> Books -> Chapters -> Verses
    if(!libraryView.collection){
      // COLLECTION LIST VIEW (Level 1)
      const collectionStats={};
      library.forEach(v=>{
        const coll=getBookCollection(v.book);
        if(coll){
          if(!collectionStats[coll])collectionStats[coll]=0;
          collectionStats[coll]++;
        }
      });

      // Get practiced counts per collection
      const practicedCounts=getPracticedCountsByCollection();

      // Bible collections (always shown) and downloadable collections
      const bibleCollections=['Old Testament','New Testament'];
      const downloadableCollections=Object.keys(COLLECTIONS).filter(name=>COLLECTIONS[name].packId);

      // Get which packs are downloaded
      const downloadedPackIds=JSON.parse(localStorage.getItem('downloadedPacks')||'[]');

      const addedCount=userVerseRefs.length;
      const availableCount=library.length;
      h=`<div class="p-5 pb-6">
        <div class="flex justify-between items-center mb-3">
          <button onclick="setScreen('home');libraryView={collection:null,book:null,chapter:null}" class="bg-white/20 text-white font-bold w-10 h-10 rounded-xl flex items-center justify-center text-xl">â†</button>
          <h1 class="text-2xl font-bold text-white">Scripture Library</h1>
          <div class="w-10"></div>
        </div>
        <div class="bg-white/20 rounded-xl p-2 mb-4 flex justify-around text-center">
          <div><p class="text-white text-lg font-bold">${addedCount}</p><p class="text-white/70 text-xs">In Practice</p></div>
          <div class="border-l border-white/30"></div>
          <div><p class="text-white text-lg font-bold">${availableCount}</p><p class="text-white/70 text-xs">Available</p></div>
        </div>
        ${downloadProgress?`<div class="bg-white/95 rounded-2xl p-4 mb-4">
          <p class="text-purple-800 font-bold mb-2">${downloadProgress.status==='downloading'?`Downloading ${downloadProgress.currentBook}...`:downloadProgress.status==='processing'?'Processing verses...':'Download complete!'}</p>
          <div class="h-2 bg-purple-100 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-green-500 to-emerald-500 rounded-full transition-all duration-300" style="width:100%"></div>
          </div>
        </div>`:''}

        <!-- Search Bar -->
        <form onsubmit="triggerLibrarySearch(event)" class="mb-4">
          <div class="flex gap-2">
            <input type="text" id="library-search" placeholder="Search verses, quotes, tags..." value="${searchQuery}"
              oninput="debouncedSearchRender(this.value)"
              class="flex-1 px-4 py-3 rounded-2xl bg-white/95 text-purple-800 placeholder-purple-400 outline-none focus:ring-2 focus:ring-white">
            <button type="submit" class="bg-white/95 text-purple-600 font-bold px-4 py-3 rounded-2xl hover:bg-white">ðŸ”</button>
          </div>
        </form>

        ${searchQuery?`
          <!-- Search Results -->
          <p class="text-white/80 text-sm mb-3">Search results for "${searchQuery}":</p>
          ${(()=>{
            const results=library.filter(v=>
              v.text.toLowerCase().includes(searchQuery.toLowerCase())||
              v.ref.toLowerCase().includes(searchQuery.toLowerCase())||
              (v.tags&&v.tags.some(t=>t.toLowerCase().includes(searchQuery.toLowerCase())))
            ).slice(0,50); // Limit to 50 results
            if(!results.length)return'<div class="bg-white/95 rounded-2xl p-8 text-center"><p class="text-purple-800">No verses found</p></div>';
            return results.map(v=>{
              const alreadyAdded=userVerseRefs.includes(v.ref);
              return`<div class="bg-white rounded-2xl p-4 mb-3">
                <div class="flex justify-between items-start mb-2">
                  <p class="font-bold text-purple-800 flex items-center gap-1.5">${isDoctrineMastery(v)?renderDoctrineMasteryIcon(14):''}${v.ref}</p>
                  ${alreadyAdded?`<span class="text-xs text-green-600 font-semibold">âœ“ Added</span>`:`<button onclick="addLibraryVerseByRef('${v.ref.replace(/'/g,"\\'")}',${JSON.stringify(v).replace(/"/g,'&quot;')})" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs font-bold px-3 py-1 rounded-full">+ Add</button>`}
                </div>
                <p class="text-purple-700 text-sm">${v.text}</p>
                ${v.tags&&v.tags.length?`<div class="flex flex-wrap gap-1 mt-2">${v.tags.map(t=>`<span class="text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-600">${t}</span>`).join('')}</div>`:''}
              </div>`;
            }).join('');
          })()}
        `:`
          <!-- Your Scripture Library -->
          <p class="text-white/80 text-sm mb-3">Your Scripture Library:</p>
          ${(()=>{
            // Build list of all available collections
            let html='';

            // 1. Bible collections (always available - have curated verses)
            ['Old Testament','New Testament'].forEach(collName=>{
              const count=collectionStats[collName]||0;
              const practiced=practicedCounts[collName]||0;
              const hasFullDownload=localStorage.getItem(COLLECTION_STORAGE_KEYS[collName]);
              const canDownloadFull=COLLECTION_URLS[collName]&&!hasFullDownload;
              const status=hasFullDownload?'âœ“ Full':'curated';
              html+='<div class="w-full bg-white rounded-2xl p-4 mb-3"><div class="flex justify-between items-center gap-3"><button onclick="libraryView.collection=\''+collName+'\';render()" class="flex-1 text-left min-w-0"><p class="font-bold text-purple-800">ðŸ“– '+collName+'</p><p class="text-xs text-purple-600 mt-1"><span class="text-green-600">'+practiced+' practiced</span> / '+count+' verses <span class="'+(hasFullDownload?'text-green-600':'text-orange-500')+'">('+status+')</span></p></button>'+(canDownloadFull?'<button onclick="downloadCollection(\''+collName+'\')" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs font-bold px-3 py-2 rounded-xl">â¬‡ï¸ Full</button>':'')+(hasFullDownload?'<button onclick="deleteCollection(\''+collName+'\')" class="text-red-400 hover:text-red-600 p-2">ðŸ—‘ï¸</button>':'')+'</div></div>';
            });

            // 2. LDS Scriptures with full downloads available
            ['Book of Mormon','Doctrine and Covenants','Pearl of Great Price'].forEach(collName=>{
              const collData=COLLECTIONS[collName];
              if(!collData)return;
              const packId=collData.packId;
              const hasFullDownload=localStorage.getItem(COLLECTION_STORAGE_KEYS[collName]);
              const hasPack=packId&&isPackDownloaded(packId);
              if(!hasFullDownload&&!hasPack)return; // Not downloaded at all
              const count=collectionStats[collName]||0;
              const practiced=practicedCounts[collName]||0;
              const pack=packId?SCRIPTURE_PACKS[packId]:null;
              const icon=pack?pack.icon:'ðŸ“˜';
              const status=hasFullDownload?'âœ“ Full':'curated';
              const canDownloadFull=COLLECTION_URLS[collName]&&!hasFullDownload;
              html+='<div class="w-full bg-white rounded-2xl p-4 mb-3"><div class="flex justify-between items-center gap-3"><button onclick="libraryView.collection=\''+collName.replace(/'/g,"\\'")+'\';render()" class="flex-1 text-left min-w-0"><p class="font-bold text-purple-800">'+icon+' '+collName+'</p><p class="text-xs text-purple-600 mt-1"><span class="text-green-600">'+practiced+' practiced</span> / '+count+' verses <span class="'+(hasFullDownload?'text-green-600':'text-orange-500')+'">('+status+')</span></p></button>'+(canDownloadFull?'<button onclick="downloadCollection(\''+collName+'\')" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs font-bold px-3 py-2 rounded-xl">â¬‡ï¸ Full</button>':'')+(hasFullDownload?'<button onclick="deleteCollection(\''+collName+'\')" class="text-red-400 hover:text-red-600 p-2">ðŸ—‘ï¸</button>':'')+(hasPack&&!hasFullDownload?'<button onclick="removeScripturePack(\''+packId+'\')" class="text-red-400 hover:text-red-600 p-2">ðŸ—‘ï¸</button>':'')+'</div></div>';
            });

            // 3. Torah & Tanakh and Quran (can have full downloads)
            ['Torah & Tanakh','Quran'].forEach(collName=>{
              const collData=COLLECTIONS[collName];
              if(!collData)return;
              const packId=collData.packId;
              const hasFullDownload=localStorage.getItem(COLLECTION_STORAGE_KEYS[collName]);
              const hasPack=packId&&isPackDownloaded(packId);
              if(!hasFullDownload&&!hasPack)return; // Not downloaded at all
              const count=collectionStats[collName]||0;
              const practiced=practicedCounts[collName]||0;
              const pack=packId?SCRIPTURE_PACKS[packId]:null;
              const icon=pack?pack.icon:'ðŸ“–';
              const status=hasFullDownload?'âœ“ Full':'curated';
              const canDownloadFull=COLLECTION_URLS[collName]&&!hasFullDownload;
              html+='<div class="w-full bg-white rounded-2xl p-4 mb-3"><div class="flex justify-between items-center gap-3"><button onclick="libraryView.collection=\''+collName.replace(/'/g,"\\'")+'\';render()" class="flex-1 text-left min-w-0"><p class="font-bold text-purple-800">'+icon+' '+collName+'</p><p class="text-xs text-purple-600 mt-1"><span class="text-green-600">'+practiced+' practiced</span> / '+count+' verses <span class="'+(hasFullDownload?'text-green-600':'text-orange-500')+'">('+status+')</span></p></button>'+(canDownloadFull?'<button onclick="downloadCollection(\''+collName+'\')" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs font-bold px-3 py-2 rounded-xl">â¬‡ï¸ Full</button>':'')+(hasFullDownload?'<button onclick="deleteCollection(\''+collName+'\')" class="text-red-400 hover:text-red-600 p-2">ðŸ—‘ï¸</button>':'')+(hasPack&&!hasFullDownload?'<button onclick="removeScripturePack(\''+packId+'\')" class="text-red-400 hover:text-red-600 p-2">ðŸ—‘ï¸</button>':'')+'</div></div>';
            });

            // 4. Other downloaded scripture packs (no full download available)
            const otherPacks=['jewish-wisdom','hadith','buddhist-sutras','bhagavad-gita','hindu-wisdom','guru-granth','catholic-prayers','christian-classics','articles-of-faith','lds-quotes','inspirational-quotes'];
            otherPacks.forEach(packId=>{
              if(!isPackDownloaded(packId))return;
              const pack=SCRIPTURE_PACKS[packId];
              if(!pack)return;
              // Find collection name for this pack
              const collName=Object.keys(COLLECTIONS).find(c=>COLLECTIONS[c].packId===packId);
              if(!collName)return;
              const count=collectionStats[collName]||0;
              const practiced=practicedCounts[collName]||0;
              html+='<div class="w-full bg-white rounded-2xl p-4 mb-3"><div class="flex justify-between items-center gap-3"><button onclick="libraryView.collection=\''+collName.replace(/'/g,"\\'")+'\';render()" class="flex-1 text-left min-w-0"><p class="font-bold text-purple-800">'+pack.icon+' '+collName+'</p><p class="text-xs text-purple-600 mt-1"><span class="text-green-600">'+practiced+' practiced</span> / '+count+' verses</p></button><button onclick="removeScripturePack(\''+packId+'\')" class="text-red-400 hover:text-red-600 p-2">ðŸ—‘ï¸</button></div></div>';
            });

            return html||'<p class="text-white/60 text-center py-4">No scriptures downloaded yet</p>';
          })()}

          <!-- Get More Scriptures -->
          ${(()=>{
            let html='';
            let hasItems=false;

            // Full library downloads (LDS)
            const fullLibraryLDS=['Book of Mormon','Doctrine and Covenants','Pearl of Great Price'];
            const availableFullLDS=fullLibraryLDS.filter(c=>!localStorage.getItem(COLLECTION_STORAGE_KEYS[c])&&!isPackDownloaded(COLLECTIONS[c]?.packId));
            if(availableFullLDS.length>0){
              hasItems=true;
              html+='<p class="text-white/80 text-sm mb-3 mt-6">LDS Scriptures (Full Library):</p>';
              availableFullLDS.forEach(collName=>{
                const pack=SCRIPTURE_PACKS[COLLECTIONS[collName]?.packId];
                const icon=pack?pack.icon:'ðŸ“˜';
                html+='<div class="w-full bg-white/90 rounded-2xl p-4 mb-3 border-2 border-dashed border-purple-300"><div class="flex justify-between items-center gap-3"><div class="flex-1"><p class="font-bold text-purple-800">'+icon+' '+collName+'</p></div><button onclick="downloadCollection(\''+collName+'\')" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs font-bold px-3 py-2 rounded-xl">â¬‡ï¸ Download</button></div></div>';
              });
            }

            // Full library downloads (Other religions - Torah, Quran)
            const fullLibraryOther=[{name:'Torah & Tanakh',icon:'âœ¡ï¸',desc:'Complete Hebrew Bible (23,000+ verses)'},{name:'Quran',icon:'â˜ªï¸',desc:'Complete Quran (6,236 verses)'}];
            const availableFullOther=fullLibraryOther.filter(c=>!localStorage.getItem(COLLECTION_STORAGE_KEYS[c.name])&&!isPackDownloaded(COLLECTIONS[c.name]?.packId));
            if(availableFullOther.length>0){
              hasItems=true;
              html+='<p class="text-white/80 text-sm mb-3 mt-6">Full Scripture Libraries:</p>';
              availableFullOther.forEach(coll=>{
                html+='<div class="w-full bg-white/90 rounded-2xl p-4 mb-3 border-2 border-dashed border-purple-300"><div class="flex justify-between items-center gap-3"><div class="flex-1"><p class="font-bold text-purple-800">'+coll.icon+' '+coll.name+'</p><p class="text-xs text-purple-500">'+coll.desc+'</p></div><button onclick="downloadCollection(\''+coll.name+'\')" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs font-bold px-3 py-2 rounded-xl">â¬‡ï¸ Download</button></div></div>';
              });
            }

            // Other scripture packs by category (curated only - no full download)
            const categories={'Doctrine Mastery':['dm-old-testament','dm-new-testament','dm-book-of-mormon','dm-doctrine-covenants'],'LDS Extras':['articles-of-faith','lds-quotes'],'Judaism':['jewish-wisdom'],'Islam':['hadith'],'Buddhism':['buddhist-sutras'],'Hinduism':['bhagavad-gita','hindu-wisdom'],'Sikhism':['guru-granth'],'Christian':['catholic-prayers','christian-classics'],'Inspirational':['inspirational-quotes']};
            for(const [cat,ids] of Object.entries(categories)){
              const available=ids.filter(id=>!isPackDownloaded(id)&&SCRIPTURE_PACKS[id]);
              if(available.length>0){
                if(!hasItems)html+='<p class="text-white/80 text-sm mb-3 mt-6">Get More Scriptures:</p>';
                hasItems=true;
                html+='<p class="text-white/70 text-xs mb-2 mt-3">'+cat+':</p>';
                available.forEach(id=>{
                  const pack=SCRIPTURE_PACKS[id];
                  const verseCount=pack.verses?pack.verses.length:pack.quotes?pack.quotes.length:0;
                  html+='<div class="w-full bg-white/90 rounded-2xl p-3 mb-2 border-2 border-dashed border-purple-300"><div class="flex justify-between items-center gap-3"><div class="flex-1"><p class="font-bold text-purple-800 text-sm">'+pack.icon+' '+pack.name+'</p><p class="text-xs text-purple-500">'+verseCount+' curated verses</p></div><button onclick="downloadScripturePack(\''+id+'\')" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold text-xs px-3 py-2 rounded-xl">+ Add</button></div></div>';
                });
              }
            }

            return html;
          })()}

          <!-- Manage Downloads -->
          ${downloadedPackIds.length>0?`
            <div class="mt-6 p-4 bg-white/30 rounded-2xl">
              <p class="text-white text-sm font-bold mb-2">Manage Downloads</p>
              ${downloadedPackIds.map(id=>{
                const pack=SCRIPTURE_PACKS[id];
                const packCount=getPackVerseCount(id);
                const actualCount=collectionStats[Object.keys(COLLECTIONS).find(c=>COLLECTIONS[c].packId===id)]||0;
                const hasIssue=actualCount===0&&packCount>0;
                return pack?`<div class="flex justify-between items-center bg-white/50 rounded-xl p-2 mb-2">
                  <div>
                    <span class="text-purple-800 text-sm">${pack.icon} ${pack.name}</span>
                    <span class="text-purple-500 text-xs ml-1">(${actualCount}/${packCount})</span>
                  </div>
                  <div class="flex gap-1">
                    ${hasIssue?`<button onclick="retryScripturePack('${id}')" class="text-orange-600 text-xs font-bold px-2 py-1">Retry</button>`:''}
                    <button onclick="if(confirm('Remove ${pack.name}?'))removeScripturePack('${id}')" class="text-red-500 text-xs font-bold px-2 py-1">Remove</button>
                  </div>
                </div>`:'';
              }).join('')}
            </div>
          `:''}
        `}
      </div>`;

    }else if(!libraryView.book){
      // BOOK LIST VIEW (Level 2) - or direct to verses for special collections
      const collectionData=COLLECTIONS[libraryView.collection];
      const collectionBooks=collectionData.books;
      const isSpecialCollection=collectionData.isSpecial;

      // For special collections (Articles of Faith, LDS Leader Quotes), show verses directly
      if(isSpecialCollection){
        const collectionVerses=library.filter(v=>collectionBooks.includes(v.book)).sort((a,b)=>a.verse-b.verse);
        const list=collectionVerses.map(v=>{
          const alreadyAdded=userVerseRefs.includes(v.ref);
          return`<div class="bg-white rounded-2xl p-4 mb-3">
            <div class="flex justify-between items-start mb-2">
              <p class="font-bold text-purple-800 flex items-center gap-1.5">${isDoctrineMastery(v)?renderDoctrineMasteryIcon(14):''}${v.ref}</p>
              ${alreadyAdded?`<span class="text-xs text-green-600 font-semibold flex items-center gap-1">âœ“ Added</span>`:`<button onclick="addLibraryVerseByRef('${v.ref.replace(/'/g,"\\'")}',${JSON.stringify(v).replace(/"/g,'&quot;')})" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs font-bold px-3 py-1 rounded-full flex-shrink-0">+ Add</button>`}
            </div>
            <p class="text-purple-700 text-sm">${v.text}</p>
            ${v.tags&&v.tags.length?`<div class="flex flex-wrap gap-1 mt-2">${v.tags.map(t=>`<span class="text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-600">${t}</span>`).join('')}</div>`:''}
            ${v.speaker?`<p class="text-purple-500 text-xs mt-2 italic">â€” ${v.speaker}</p>`:''}
          </div>`;
        }).join('');

        h=`<div class="p-5 pb-6">
          <div class="flex justify-between items-center mb-4">
            <button onclick="libraryView={collection:null,book:null,chapter:null};searchQuery='';render()" class="bg-white/20 text-white font-bold w-10 h-10 rounded-xl flex items-center justify-center text-xl">â†</button>
            <h1 class="text-xl font-bold text-white">${libraryView.collection}</h1>
            <div class="text-white/80 text-xs">${collectionVerses.length} verses</div>
          </div>
          <p class="text-white/80 text-sm mb-3">${libraryView.collection==='Articles of Faith'?'The 13 Articles of Faith':'Inspirational quotes from LDS leaders'}:</p>
          ${list}
        </div>`;
      }else{
        // Normal book list for non-special collections
        const bookGroups={};
        library.forEach(v=>{
          if(collectionBooks.includes(v.book)){
            if(!bookGroups[v.book])bookGroups[v.book]={name:v.book,count:0};
            bookGroups[v.book].count++;
          }
        });
        const books=Object.values(bookGroups).sort((a,b)=>getBookOrder(a.name)-getBookOrder(b.name));

        h=`<div class="p-5 pb-6">
          <div class="flex justify-between items-center mb-4">
            <button onclick="libraryView={collection:null,book:null,chapter:null};searchQuery='';render()" class="bg-white/20 text-white font-bold w-10 h-10 rounded-xl flex items-center justify-center text-xl">â†</button>
            <h1 class="text-xl font-bold text-white">${libraryView.collection}</h1>
            <div class="w-10"></div>
          </div>
          <p class="text-white/80 text-sm mb-3">Select a book:</p>
          ${books.length?books.map(b=>`<button onclick="libraryView.book='${b.name.replace(/'/g,"\\'")}';render()" class="w-full bg-white rounded-2xl p-4 mb-3 text-left hover:bg-purple-50 transition-colors">
            <div class="flex justify-between items-center">
              <p class="font-bold text-purple-800">${b.name}</p>
              <div class="flex items-center gap-2">
                <span class="text-xs text-purple-600">${b.count} verses</span>
                <span class="text-purple-400">â†’</span>
              </div>
            </div>
          </button>`).join(''):'<div class="bg-white/95 rounded-2xl p-8 text-center"><p class="text-purple-800">Download the full library to browse ${libraryView.collection}</p></div>'}
        </div>`;
      }

    }else if(!libraryView.chapter){
      // CHAPTER LIST VIEW (Level 3)
      const bookVerses=library.filter(v=>v.book===libraryView.book);
      const chapterGroups={};
      bookVerses.forEach(v=>{
        const ch=v.chapter||1;
        if(!chapterGroups[ch])chapterGroups[ch]={chapter:ch,count:0};
        chapterGroups[ch].count++;
      });
      const chapters=Object.values(chapterGroups).sort((a,b)=>a.chapter-b.chapter);

      h=`<div class="p-5 pb-6">
        <div class="flex justify-between items-center mb-4">
          <button onclick="libraryView.chapter=null;libraryView.book=null;render()" class="bg-white/20 text-white font-bold w-10 h-10 rounded-xl flex items-center justify-center text-xl">â†</button>
          <h1 class="text-xl font-bold text-white">${libraryView.book}</h1>
          <div class="w-10"></div>
        </div>
        <p class="text-white/80 text-sm mb-3">Select a chapter:</p>
        <div class="grid grid-cols-4 gap-2">
          ${chapters.map(ch=>`<button onclick="libraryView.chapter=${ch.chapter};render()" class="bg-white rounded-xl p-3 text-center hover:bg-purple-50 transition-colors">
            <p class="font-bold text-purple-800 text-lg">${ch.chapter}</p>
            <p class="text-xs text-purple-600">${ch.count} verses</p>
          </button>`).join('')}
        </div>
      </div>`;

    }else{
      // VERSE LIST VIEW (Level 4)
      const chapterVerses=library.filter(v=>v.book===libraryView.book&&v.chapter===libraryView.chapter).sort((a,b)=>a.verse-b.verse);

      const list=chapterVerses.map(v=>{
        const alreadyAdded=userVerseRefs.includes(v.ref);
        return`<div class="bg-white rounded-2xl p-4 mb-3">
          <div class="flex justify-between items-start mb-2">
            <p class="font-bold text-purple-800 flex items-center gap-1.5">${isDoctrineMastery(v)?renderDoctrineMasteryIcon(14):''}${v.ref}</p>
            ${alreadyAdded?`<span class="text-xs text-green-600 font-semibold flex items-center gap-1">âœ“ Added</span>`:`<button onclick="addLibraryVerseByRef('${v.ref.replace(/'/g,"\\'")}',${JSON.stringify(v).replace(/"/g,'&quot;')})" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs font-bold px-3 py-1 rounded-full flex-shrink-0">+ Add</button>`}
          </div>
          <p class="text-purple-700 text-sm">${v.text}</p>
          ${v.tags&&v.tags.length?`<div class="flex flex-wrap gap-1 mt-2">${v.tags.map(t=>`<span class="text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-600">${t}</span>`).join('')}</div>`:''}
        </div>`;
      }).join('');

      h=`<div class="p-5 pb-6">
        <div class="flex justify-between items-center mb-4">
          <button onclick="libraryView.chapter=null;render()" class="bg-white/20 text-white font-bold w-10 h-10 rounded-xl flex items-center justify-center text-xl">â†</button>
          <div class="text-center">
            <h1 class="text-lg font-bold text-white">${libraryView.book}</h1>
            <p class="text-white/80 text-sm">Chapter ${libraryView.chapter}</p>
          </div>
          <div class="w-10"></div>
        </div>
        ${list}
      </div>`;
    }
  }

  else if(screen==='practice'&&!pMode){
    // Compact buddy status for practice screens
    const buddyStatus=`<div class="bg-white/20 rounded-2xl p-3 mb-4 flex items-center gap-3">
      <div style="transform:scale(0.5);transform-origin:center;margin:-50px -30px;">${renderBuddyVisual()}</div>
      <div class="flex-1">
        <div class="flex justify-between items-center mb-1">
          <span class="text-white font-semibold text-sm">${getStageName()}</span>
          <span class="text-white/90 font-bold">âœ¨ ${(()=>{
            const stage=S.buddyStage||'egg';
            if(stage==='egg')return `${S.eggXP||0}/${STAGES.egg.hatchXP}`;
            if(stage==='adult')return 'Max';
            return `${S.growthXP||0}/${STAGES[stage].growthNeeded}`;
          })()} XP</span>
        </div>
        <div class="h-1.5 bg-white/20 rounded-full overflow-hidden">
          <div class="h-full bg-gradient-to-r from-yellow-400 to-orange-400 rounded-full transition-all" style="width:${(()=>{
            const stage=S.buddyStage||'egg';
            if(stage==='egg')return Math.min((S.eggXP||0)/STAGES.egg.hatchXP*100,100);
            if(stage==='adult')return 100;
            const stageData=STAGES[stage];
            return Math.min((S.growthXP||0)/stageData.growthNeeded*100,100);
          })()}%"></div>
        </div>
      </div>
    </div>`;

    if(!selectedVerse){
      // Verse selection screen
      const activeVerses=S.verses.filter(v=>v.status==='active');
      const savedVerses=S.verses.filter(v=>v.status==='saved');
      const reviewList=activeVerses.filter(needsReview);
      const dueForReview=getDueVerses();
      const filteredVerses=verseFilter==='active'?activeVerses:savedVerses;

      const verseList=filteredVerses.map(v=>{
        const bonus=v.mastery>=5?getReviewBonus(v):0;
        const daysSince=v.lastPracticed?Math.floor((Date.now()-new Date(v.lastPracticed).getTime())/(1000*60*60*24)):null;
        const isActive=v.status==='active';
        const isDue=isActive&&isDueForReview(v);
        const reviewTime=isActive?getReviewTimeText(v):null;
        return`<div class="w-full bg-white rounded-2xl p-4 mb-3 text-left ${isDue?'ring-2 ring-amber-400':''}">
          <button onclick="selectVerse(${v.id})" class="w-full text-left">
            <div class="flex justify-between mb-1">
              <div class="flex items-center gap-2">
                <p class="font-bold text-purple-800">${v.ref}</p>
                ${isDue?`<span class="text-xs px-2 py-0.5 rounded-full bg-amber-500 text-white font-bold animate-pulse">Due!</span>`:''}
              </div>
              <div class="flex gap-2 items-center">
                ${bonus>0?`<span class="text-xs px-2 py-1 rounded-full bg-green-500 text-white">+${bonus} XP</span>`:''}
                <div class="text-right">
                  <div class="text-sm">${getStars(v.mastery)}</div>
                  <div class="text-xs text-purple-500 font-semibold">${v.mastery.toFixed(1)}/5</div>
                </div>
              </div>
            </div>
            <div class="h-1.5 bg-purple-100 rounded-full mb-2">
              <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full transition-all" style="width:${v.mastery/5*100}%"></div>
            </div>
            <p class="text-purple-700 text-sm line-clamp-2">${v.text}</p>
            ${isActive&&reviewTime&&!isDue?`<p class="text-purple-400 text-xs mt-1">Next review: ${reviewTime}</p>`:daysSince!==null?`<p class="text-purple-400 text-xs mt-1">Last practiced ${daysSince} day${daysSince!==1?'s':''} ago</p>`:''}
          </button>
          <div class="flex justify-end mt-2 pt-2 border-t border-purple-100">
            <button onclick="event.stopPropagation();toggleVerseStatus(${v.id})" class="text-xs px-3 py-1.5 rounded-lg ${isActive?'bg-gray-100 text-gray-600 hover:bg-gray-200':'bg-green-100 text-green-700 hover:bg-green-200'} font-medium">
              ${isActive?'Store for later':'Practice now'}
            </button>
          </div>
        </div>`}).join('');

      const filterTabs=`<div class="flex gap-2 mb-3">
        <button onclick="verseFilter='active';render()" class="flex-1 py-2 px-3 rounded-xl font-semibold text-sm ${verseFilter==='active'?'bg-white text-purple-700':'bg-white/20 text-white'}">
          Practice Now (${activeVerses.length})
        </button>
        <button onclick="verseFilter='saved';render()" class="flex-1 py-2 px-3 rounded-xl font-semibold text-sm ${verseFilter==='saved'?'bg-white text-purple-700':'bg-white/20 text-white'}">
          Stored (${savedVerses.length})
        </button>
      </div>`;

      h=`<div class="p-5 pb-6">
        ${buddyStatus}
        <div class="flex items-center gap-3 mb-4">
          <button onclick="setScreen('home')" class="bg-white/20 text-white font-bold w-10 h-10 rounded-xl flex items-center justify-center text-xl flex-shrink-0">â†</button>
          <button onclick="openModal('add')" class="flex-1 bg-white/20 text-white font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-2">
            <span class="text-xl">+</span>
            <span>Add Verse or Quote to Practice</span>
          </button>
        </div>
        ${S.verses.length?`
          ${filterTabs}
          ${filteredVerses.length?verseList:`<div class="bg-white/95 rounded-2xl p-6 text-center"><p class="text-purple-600">${verseFilter==='active'?'No verses to practice. Check "Stored" or add new ones!':'No stored verses yet. Tap "Store for later" on any verse.'}</p></div>`}`:'<div class="bg-white/95 rounded-3xl p-8 text-center"><p class="text-purple-800">Add verses first!</p></div>'}
      </div>`;
    }else{
      // Mode selection screen
      const modes=[{id:'predict',n:'Predict',i:'ðŸŽ¯',s:'â­',x:'2-8',desc:'4 levels!'},{id:'blanks',n:'Fill Blanks',i:'âœï¸',s:'â­â­â­',x:'2-8',desc:'4 levels!'},{id:'chunk',n:'Chunk Master',i:'ðŸ§©',s:'â­â­',x:'3-6',desc:'Learn in pieces'},{id:'jumble',n:'Word Jumble',i:'ðŸ”€',s:'â­â­â­',x:'7'},{id:'first',n:'First Letters',i:'ðŸ”¤',s:'â­â­â­â­',x:'8'},{id:'recall',n:'Full Recall',i:'ðŸ’­',s:'â­â­â­â­â­',x:'10-15'}];
      const btns=modes.map(m=>`<button onclick="startPractice('${m.id}')" class="w-full bg-white/95 rounded-2xl p-4 mb-3 flex items-center gap-3 text-left">
        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-2xl">${m.i}</div>
        <div class="flex-1"><p class="font-bold text-purple-800">${m.n} <span class="text-yellow-500 text-sm">${m.s}</span></p></div>
        <span class="text-purple-400 text-sm">+${m.x}</span></button>`).join('');
      const selectedV=selectedVerse==='random'||selectedVerse==='review'||selectedVerse==='smartreview'?null:S.verses.find(v=>v.id===selectedVerse);
      h=`<div class="p-5 pb-24">
        ${buddyStatus}
        <div class="flex items-center gap-3 mb-4">
          <button onclick="selectedVerse=null;render()" class="text-white text-2xl">â†</button>
          <h1 class="text-2xl font-bold text-white">Choose Mode</h1>
        </div>
        ${selectedV?`<div class="bg-white/90 rounded-2xl p-4 mb-4">
          <p class="font-bold text-purple-800 mb-1">${selectedV.ref}</p>
          <p class="text-purple-600 text-sm line-clamp-2">${selectedV.text}</p>
        </div>`:selectedVerse==='review'?`<div class="bg-white/90 rounded-2xl p-4 mb-4 text-center">
          <p class="text-purple-800 font-bold">ðŸ“š Review Mode</p>
          <p class="text-purple-600 text-sm">A mastered verse will be chosen for you</p>
          <p class="text-green-600 text-sm font-semibold mt-1">+Bonus XP for reviewing!</p>
        </div>`:selectedVerse==='smartreview'?`<div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl p-4 mb-4 text-center border-2 border-amber-300">
          <p class="text-orange-800 font-bold">ðŸ§  Smart Review</p>
          <p class="text-orange-600 text-sm">The most urgent verse will be chosen</p>
          <p class="text-amber-600 text-sm font-semibold mt-1">Spaced repetition for better memory!</p>
        </div>`:''}
        ${btns}
      </div>`;
    }
  }

  else if(screen==='closet'&&!pMode){
    // Wearable categories only (no food, no furniture, no medicine, no toys)
    const categories={casual:'ðŸ‘• Casual',fancy:'ðŸŽ© Fancy',fun:'ðŸŽª Fun',cool:'ðŸ˜Ž Cool',cute:'ðŸ’– Cute',faith:'âœï¸ Faith',seasonal:'ðŸŽ„ Seasonal',special:'âœ¨ Special'};
    const typeNames={hat:'ðŸŽ© Hats',eyes:'ðŸ‘“ Eyewear',held:'ðŸŽ’ Held Items',back:'ðŸ¦¸ Back Items',effect:'âœ¨ Effects'};
    // Get owned wearable accessories by type
    const byType={hat:[],eyes:[],held:[],back:[],effect:[]};
    ACCESSORIES.forEach((acc,idx)=>{
      if(S.inventory.includes(idx)&&['hat','eyes','held','back','effect'].includes(acc.type)){
        byType[acc.type].push({...acc,idx,owned:true});
      }
    });
    // Shop items: exclude food, room, medicine, and toys (medicine/toys go in food section)
    const unowned=ACCESSORIES.map((acc,idx)=>({...acc,idx,owned:S.inventory.includes(idx)})).filter(a=>!a.owned&&!['food','room','medicine','toy'].includes(a.type)).sort((a,b)=>a.cost-b.cost);

    h=`<div class="p-5 pb-6">
      <div class="flex items-center gap-3 mb-4">
        <button onclick="setScreen('home')" class="bg-white/20 text-white font-bold w-10 h-10 rounded-xl flex items-center justify-center text-xl">â†</button>
        <h1 class="text-2xl font-bold text-white">Closet</h1>
      </div>
      <p class="text-white text-sm mb-4">Your XP: ${S.xp}</p>

      <div class="bg-white/95 rounded-3xl p-4 mb-4">
        <p class="font-bold text-purple-800 mb-3">Currently Wearing</p>
        <div class="grid grid-cols-5 gap-2">
          ${Object.entries(typeNames).map(([type,label])=>{
            const equippedIdx=S.equipped[type];
            const equipped=equippedIdx!==null?ACCESSORIES[equippedIdx]:null;
            return`<div class="text-center">
              <button onclick="${equipped?`unequipAccessory('${type}')`:'void(0)'}" class="w-full aspect-square rounded-xl ${equipped?'bg-purple-100':'bg-gray-100'} flex items-center justify-center text-3xl mb-1">
                ${equipped?equipped.emoji:'â€”'}
              </button>
              <p class="text-xs text-purple-600">${type}</p>
            </div>`;
          }).join('')}
        </div>
      </div>

      <div class="bg-white/95 rounded-3xl p-4 mb-4">
        <p class="font-bold text-purple-800 mb-3">Your Wardrobe</p>
        ${Object.entries(byType).filter(([type,items])=>items.length>0).map(([type,items])=>`
          <div class="mb-3">
            <p class="text-sm font-semibold text-purple-700 mb-2">${typeNames[type]}</p>
            <div class="grid grid-cols-4 gap-2">
              ${items.map(acc=>{
                const isEquipped=S.equipped[acc.type]===acc.idx;
                return`<button onclick="equipAccessory(${acc.idx})" class="p-2 rounded-xl ${isEquipped?'bg-purple-200 ring-2 ring-purple-500':'bg-purple-50'} text-center">
                  <div class="text-2xl mb-1">${acc.emoji}</div>
                  <div class="text-xs text-purple-800">${acc.name}</div>
                  ${isEquipped?'<div class="text-xs text-purple-600 font-semibold">Worn</div>':''}
                </button>`;
              }).join('')}
            </div>
          </div>
        `).join('')}
        ${Object.values(byType).every(arr=>arr.length===0)?'<p class="text-purple-500 text-sm text-center py-4">No wearable items yet! Buy some below.</p>':''}
      </div>

      <div class="bg-white/95 rounded-3xl p-4 mb-4">
        <p class="font-bold text-purple-800 mb-3">Shop</p>
        ${Object.entries(categories).map(([cat,label])=>{
          const items=unowned.filter(a=>a.cat===cat).sort((a,b)=>a.cost-b.cost);
          if(items.length===0)return'';
          return`<div class="mb-3">
            <p class="text-sm font-semibold text-purple-700 mb-2">${label}</p>
            <div class="grid grid-cols-3 gap-2">
              ${items.map(acc=>{
                const canAfford=S.xp>=acc.cost;
                return`<button onclick="buyAccessory(${acc.idx})" class="p-2 rounded-xl ${canAfford?'bg-purple-50':'bg-gray-100 opacity-50'} text-center" ${!canAfford?'disabled':''}>
                  <div class="text-2xl mb-1">${acc.emoji}</div>
                  <div class="text-xs text-purple-800 font-semibold">${acc.name}</div>
                  <div class="text-xs ${canAfford?'text-purple-600':'text-gray-500'}">${acc.cost} XP</div>
                </button>`;
              }).join('')}
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  }

  else if(screen==='room'&&!pMode){
    // Get owned room items from inventory
    const ownedRoom=[];
    (S.inventory||[]).forEach(idx=>{
      const acc=ACCESSORIES[idx];
      if(acc&&acc.type==='room'&&!ownedRoom.find(r=>r.idx===idx)){
        ownedRoom.push({...acc,idx});
      }
    });

    // Get buyable room items (not owned)
    const buyableRoom=ACCESSORIES.map((acc,idx)=>({...acc,idx})).filter(a=>a.type==='room'&&!S.inventory.includes(a.idx)).sort((a,b)=>a.cost-b.cost);

    h=`<div class="p-5 pb-6">
      <div class="flex items-center gap-3 mb-4">
        <button onclick="setScreen('home')" class="bg-white/20 text-white font-bold w-10 h-10 rounded-xl flex items-center justify-center text-xl">â†</button>
        <h1 class="text-2xl font-bold text-white">Room</h1>
      </div>
      <p class="text-white text-sm mb-4">Your XP: ${S.xp}</p>

      ${ownedRoom.length>0?`<div class="bg-white/95 rounded-3xl p-4 mb-4">
        <p class="font-bold text-purple-800 mb-3">ðŸ  Your Room Items (${ownedRoom.length})</p>
        <div class="grid grid-cols-3 gap-2">
          ${ownedRoom.map(acc=>{
            const isPlaced=(S.placedFurniture||[]).includes(acc.idx);
            return`<div class="p-3 rounded-xl ${isPlaced?'bg-green-50 ring-2 ring-green-400':'bg-blue-50'} text-center flex flex-col items-center">
              <div class="mb-1">${renderFurnitureIcon(acc.emoji, 56)}</div>
              <div class="text-xs ${isPlaced?'text-green-800':'text-blue-800'} font-semibold">${acc.name}</div>
              ${acc.desc?`<div class="text-[10px] ${isPlaced?'text-green-600':'text-blue-600'} mt-1">${acc.desc}</div>`:''}
              <button onclick="${isPlaced?`unplaceFurniture(${acc.idx})`:`placeFurniture(${acc.idx})`}" class="mt-2 px-3 py-1 rounded-lg text-xs font-bold ${isPlaced?'bg-red-100 text-red-600 hover:bg-red-200':'bg-green-100 text-green-600 hover:bg-green-200'}">
                ${isPlaced?'Unplace':'Place'}
              </button>
            </div>`;
          }).join('')}
        </div>
      </div>`:`<div class="bg-white/95 rounded-3xl p-4 mb-4">
        <p class="font-bold text-purple-800 mb-3">ðŸ  Your Room</p>
        <p class="text-purple-500 text-sm text-center py-4">No room items yet! Buy some below.</p>
      </div>`}

      <div class="bg-white/95 rounded-3xl p-4 mb-4">
        <p class="font-bold text-purple-800 mb-3">ðŸ›’ Furniture Shop</p>
        ${buyableRoom.length>0?`
          <div class="grid grid-cols-3 gap-2">
            ${buyableRoom.map(acc=>{
              const canAfford=S.xp>=acc.cost;
              return`<button onclick="buyAccessory(${acc.idx})" class="p-3 rounded-xl ${canAfford?'bg-blue-50 hover:bg-blue-100':'bg-gray-100 opacity-50'} text-center flex flex-col items-center" ${!canAfford?'disabled':''}>
                <div class="mb-1">${renderFurnitureIcon(acc.emoji, 56)}</div>
                <div class="text-xs text-blue-800 font-semibold">${acc.name}</div>
                <div class="text-xs ${canAfford?'text-blue-600':'text-gray-500'}">${acc.cost} XP</div>
                ${acc.desc?`<div class="text-[10px] text-blue-500 mt-1">${acc.desc}</div>`:''}
              </button>`;
            }).join('')}
          </div>
        `:`<p class="text-purple-500 text-sm text-center py-4">You own all room items!</p>`}
      </div>

    </div>`;
  }

  else if(screen==='guide'&&!pMode){
    // Only owner can access guide
    if(window.currentUser?.email?.toLowerCase()!==OWNER_EMAIL.toLowerCase()){
      setScreen('home');
      return;
    }
    h=`<div class="p-5 pb-6">
      <div class="flex items-center gap-3 mb-4">
        <button onclick="setScreen('home')" class="bg-white/20 text-white font-bold w-10 h-10 rounded-xl flex items-center justify-center text-xl">â†</button>
        <h1 class="text-2xl font-bold text-white">Scribby Guide</h1>
      </div>

      <div class="mb-4 bg-white/20 rounded-2xl p-4 text-center">
        <p class="text-white text-sm">Preview all buddy categories and their evolution stages</p>
      </div>

      <div class="space-y-4">
        ${CATEGORY_KEYS.map(categoryKey=>{
          const category=CREATURE_CATEGORIES[categoryKey];
          const categoryName=categoryKey.charAt(0).toUpperCase()+categoryKey.slice(1);
          const isFullyDesigned=FULLY_DESIGNED_CATEGORIES.includes(categoryKey);

          return`<div class="bg-white rounded-2xl p-4 ${!isFullyDesigned?'opacity-75 border-2 border-dashed border-purple-300':''}">
            <h3 class="text-purple-800 font-bold text-lg mb-3">${categoryName} ${!isFullyDesigned?'<span class="text-xs font-normal text-purple-400">(emoji only)</span>':''}</h3>

            <!-- Egg Stage -->
            <div class="mb-3 pb-3 border-b border-purple-200">
              <p class="text-purple-600 text-sm font-semibold mb-2">Egg Stage</p>
              <div class="flex items-center gap-3">
                <div class="cursor-pointer hover:scale-110 transition-transform" style="transform:scale(0.32);transform-origin:center center;" onclick="showCreaturePreview('egg','${categoryKey}')">${renderEgg(categoryKey)}</div>
                <div class="text-sm text-purple-700">
                  <p class="font-semibold">Egg</p>
                  <p class="text-xs text-purple-500">Type: ${category.eggType}</p>
                </div>
              </div>
            </div>

            <!-- Blob Stage -->
            <div class="mb-3 pb-3 border-b border-purple-200">
              <p class="text-purple-600 text-sm font-semibold mb-2">Blob Stage</p>
              <div class="flex items-center gap-3">
                <div class="cursor-pointer hover:scale-110 transition-transform" style="transform:scale(0.6);transform-origin:left center;" onclick="showCreaturePreview('blob','${categoryKey}')">${category.blobEmoji==='blob'?renderBlob(categoryKey):`<div class="text-4xl">${category.blobEmoji}</div>`}</div>
                <div class="text-sm text-purple-700">
                  <p class="font-semibold">Blob</p>
                  <p class="text-xs text-purple-500">Hatches from egg (cute creature with eyes!)</p>
                </div>
              </div>
            </div>

            <!-- Baby/Child Stage -->
            <div class="mb-3 pb-3 border-b border-purple-200">
              <p class="text-purple-600 text-sm font-semibold mb-2">Baby Stage</p>
              <div class="flex items-center gap-3">
                <div class="cursor-pointer hover:scale-110 transition-transform" style="transform:scale(0.7);transform-origin:left center;" onclick="showCreaturePreview('baby','${categoryKey}')">${category.babyEmoji==='baby'?renderBaby(categoryKey):`<div class="text-4xl">${category.babyEmoji}</div>`}</div>
                <div class="text-sm text-purple-700">
                  <p class="font-semibold">${categoryName} Baby</p>
                  <p class="text-xs text-purple-500">Evolved blob with category traits!</p>
                </div>
              </div>
            </div>

            <!-- Teen Stage -->
            <div class="mb-3 pb-3 border-b border-purple-200">
              <p class="text-purple-600 text-sm font-semibold mb-2">Teen Stage</p>
              <div class="flex items-center justify-around gap-${categoryKey==='mystical'?'2':'4'}" style="flex-wrap:wrap;">
                ${(categoryKey==='mystical'?[0,2,4,6,8]:[0,5,8]).map(idx=>`
                  <div class="flex flex-col items-center">
                    <div class="cursor-pointer hover:scale-110 transition-transform" style="transform:scale(${categoryKey==='mystical'?'0.55':'0.7'});transform-origin:center;" onclick="showCreaturePreview('teen','${categoryKey}',${idx})">${category.teenEmoji==='teen'&&isFullyDesigned?renderTeen(categoryKey,idx):`<div class="text-2xl">${category.teenVariants[idx]}</div>`}</div>
                    <p class="text-[8px] text-purple-600 leading-tight mt-1 text-center">${category.teenNames[idx]||'Teen '+(idx+1)}</p>
                  </div>
                `).join('')}
              </div>
            </div>

            <!-- Adult Stage -->
            <div>
              <p class="text-purple-600 text-sm font-semibold mb-2">Adult Stage</p>
              <div class="grid grid-cols-5 gap-x-2 gap-y-3">
                ${category.adultVariants.map((emoji,idx)=>`
                  <div class="flex flex-col items-center pt-2">
                    <div class="cursor-pointer hover:scale-110 transition-transform" style="width:84px;height:98px;overflow:visible;display:flex;align-items:center;justify-content:center;" onclick="showCreaturePreview('adult','${categoryKey}',${idx})">
                      <div style="transform:scale(0.35);transform-origin:center;">${categoryKey==='birds'?renderAdultBird(idx):categoryKey==='reptiles'?renderAdultReptile(idx):categoryKey==='mammals'?renderAdultMammal(idx):categoryKey==='mystical'?renderAdultMystical(idx):categoryKey==='prehistoric'?renderAdultPrehistoric(idx):categoryKey==='aquatic'?renderAdultAquatic(idx):categoryKey==='alien'?renderAdultAlien(idx):categoryKey==='insects'?renderAdultInsect(idx):`<div class="text-3xl">${emoji}</div>`}</div>
                    </div>
                    <p class="text-[9px] text-purple-600 leading-tight text-center mt-2" style="position:relative;z-index:100;">${category.adultNames[idx]}</p>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  }

  else if(screen==='settings'&&!pMode){
    const user=window.currentUser;
    h=`<div class="p-5 pb-6">
      <div class="flex items-center gap-3 mb-4">
        <button onclick="setScreen('home')" class="bg-white/20 text-white font-bold w-10 h-10 rounded-xl flex items-center justify-center text-xl">â†</button>
        <h1 class="text-2xl font-bold text-white">Settings</h1>
      </div>

      <!-- Account Section -->
      <div class="bg-white/95 rounded-3xl p-5 mb-4">
        <p class="font-bold text-purple-800 mb-3">ðŸ‘¤ Account</p>
        ${user?`
          <div class="flex items-center gap-3 mb-3">
            <img src="${user.photoURL||''}" alt="" class="w-12 h-12 rounded-full bg-purple-200">
            <div>
              <p class="font-semibold text-purple-800">${user.displayName}</p>
              <p class="text-purple-500 text-xs">${user.email}</p>
            </div>
          </div>
          <p class="text-green-600 text-sm mb-3">âœ“ Signed in - Trading enabled!</p>
          <button onclick="signOutUser()" class="w-full bg-purple-100 text-purple-700 font-semibold py-2 rounded-xl">Sign Out</button>
        `:`
          <p class="text-purple-600 text-sm mb-3">Sign in to trade Scribbies with friends and back up your collection to the cloud.</p>
          <button onclick="signInWithGoogle()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2">
            <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="white" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="white" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="white" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="white" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Sign in with Google
          </button>
          <p class="text-purple-400 text-xs text-center mt-2">You can still play without signing in!</p>
        `}
      </div>

      <!-- Stats Section -->
      <div class="bg-white/95 rounded-3xl p-5 mb-4">
        <p class="font-bold text-purple-800 mb-2">ðŸ“Š Stats</p>
        <p class="text-purple-600 text-sm">XP: ${S.xp} | Streak: ${S.streak} days</p>
        <p class="text-purple-600 text-sm">Verses: ${S.verses.length} | Mastered: ${M}</p>
        <p class="text-purple-600 text-sm">Graduated Scribbies: ${S.graduatedBuddies?.length||0}</p>
      </div>

      <!-- Debug Tools (Developer Only) -->
      ${isDevUser()?`
      <div class="bg-white/95 rounded-3xl p-5 mb-4 border-2 border-yellow-400">
        <p class="font-bold text-purple-800 mb-3">ðŸ§ª Developer Debug Tools</p>
        <div class="grid grid-cols-2 gap-2 mb-3">
          <button onclick="addTestScribby()" class="bg-purple-100 text-purple-700 font-semibold py-2 rounded-xl text-sm">+ Scribby</button>
          <button onclick="addTestFood()" class="bg-orange-100 text-orange-700 font-semibold py-2 rounded-xl text-sm">+ Food</button>
          <button onclick="addTestClothing()" class="bg-pink-100 text-pink-700 font-semibold py-2 rounded-xl text-sm">+ Clothing</button>
          <button onclick="addTestFurniture()" class="bg-blue-100 text-blue-700 font-semibold py-2 rounded-xl text-sm">+ Furniture</button>
        </div>
        <button onclick="addTestCoins()" class="w-full bg-yellow-100 text-yellow-700 font-semibold py-2 rounded-xl mb-2">+ 500 Coins</button>
        <button onclick="showEvolutionPreview()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-semibold py-2 rounded-xl mb-2">ðŸŽ‰ Preview Evolution Screens</button>
        <p class="text-purple-400 text-xs text-center">Your UID: ${window.currentUser?.uid||'Not signed in'}</p>
      </div>
      `:''}

      <!-- Danger Zone -->
      <button onclick="if(confirm('Reset all progress? This cannot be undone!')){localStorage.removeItem('sb');location.reload()}" class="w-full bg-red-100 text-red-600 font-semibold py-3 rounded-2xl">Reset Progress</button>
    </div>`;
  }

  // EVOLUTION CELEBRATION - The magical moment! (works for hatching AND growing)
  else if(pState.evolving){
    const phase=pState.evolvePhase||'collect';
    const evoType=pState.evolveType||'grew'; // 'hatched' or 'grew'
    const prevStage=pState.prevStage||'egg';
    const category=S.creatureCategory||'birds';
    const categoryData=CREATURE_CATEGORIES[category];
    const categoryName=category.charAt(0).toUpperCase()+category.slice(1);
    const currentStage=S.buddyStage;

    // Stage names for display
    const stageNames={egg:'Egg',blob:'Blob',child:'Child',teen:'Teen',adult:'Adult'};
    const newStageName=stageNames[currentStage]||currentStage;

    // Render previous form (for collect phase)
    const renderPrevForm=()=>{
      if(prevStage==='egg')return renderEgg(category);
      if(prevStage==='blob')return renderBlob(category);
      if(prevStage==='child')return renderBaby(category);
      if(prevStage==='teen')return renderTeen(category);
      return renderBuddyVisual();
    };

    // Render new form
    const renderNewForm=()=>{
      if(currentStage==='blob')return renderBlob(category);
      if(currentStage==='child')return renderBaby(category);
      if(currentStage==='teen')return renderTeen(category);
      if(currentStage==='adult')return renderBuddyVisual();
      return renderBuddyVisual();
    };

    // Generate MASSIVE burst effects (stars, smoke, lightning) - only for burst phase
    let burstEffects='';
    if(phase==='burst'){
      // BIG smoke puffs - more of them, bigger, more colorful
      const smokeColors=['rgba(168,85,247,0.7)','rgba(236,72,153,0.6)','rgba(251,191,36,0.5)','rgba(52,211,153,0.5)','rgba(96,165,250,0.5)'];
      for(let i=0;i<12;i++){
        const x=10+Math.random()*80;
        const y=15+Math.random()*70;
        const size=100+Math.random()*100;
        const delay=Math.random()*0.2;
        burstEffects+=`<div style="position:absolute;left:${x}%;top:${y}%;width:${size}px;height:${size}px;background:${smokeColors[i%5]};border-radius:50%;filter:blur(25px);animation:evo-smoke-burst 2s ease-out ${delay}s forwards;z-index:5;"></div>`;
      }
      // LOTS of exploding stars - shooting outward
      for(let i=0;i<24;i++){
        const angle=(i*15)*Math.PI/180;
        const dist=120+Math.random()*100;
        const ex=Math.cos(angle)*dist;
        const ey=Math.sin(angle)*dist;
        const colors=['#fbbf24','#f472b6','#a78bfa','#34d399','#60a5fa','#fb7185'];
        const size=20+Math.random()*16;
        burstEffects+=`<div style="position:absolute;left:50%;top:45%;font-size:${size}px;--ex:${ex}px;--ey:${ey}px;animation:evo-star-explode 1.2s ease-out ${i*0.03}s forwards;color:${colors[i%6]};z-index:20;">âœ¨</div>`;
      }
      // More lightning bolts around the edges
      burstEffects+=`<div style="position:absolute;left:15%;top:10%;font-size:50px;animation:evo-lightning 0.4s ease-in-out 4;color:#fef08a;text-shadow:0 0 30px #fbbf24,0 0 60px #fbbf24;z-index:25;">âš¡</div>`;
      burstEffects+=`<div style="position:absolute;right:15%;top:8%;font-size:45px;animation:evo-lightning 0.4s ease-in-out 4 0.1s;color:#fef08a;text-shadow:0 0 30px #fbbf24,0 0 60px #fbbf24;z-index:25;">âš¡</div>`;
      burstEffects+=`<div style="position:absolute;left:10%;top:50%;font-size:40px;animation:evo-lightning 0.4s ease-in-out 4 0.2s;color:#fef08a;text-shadow:0 0 30px #fbbf24,0 0 60px #fbbf24;z-index:25;">âš¡</div>`;
      burstEffects+=`<div style="position:absolute;right:10%;top:55%;font-size:42px;animation:evo-lightning 0.4s ease-in-out 4 0.15s;color:#fef08a;text-shadow:0 0 30px #fbbf24,0 0 60px #fbbf24;z-index:25;">âš¡</div>`;
      // Multiple expanding rings
      burstEffects+=`<div style="position:absolute;left:50%;top:45%;width:50px;height:50px;border:6px solid rgba(251,191,36,0.9);border-radius:50%;animation:evo-ring-expand 1.2s ease-out forwards;z-index:15;"></div>`;
      burstEffects+=`<div style="position:absolute;left:50%;top:45%;width:50px;height:50px;border:5px solid rgba(168,85,247,0.8);border-radius:50%;animation:evo-ring-expand 1.2s ease-out 0.15s forwards;z-index:15;"></div>`;
      burstEffects+=`<div style="position:absolute;left:50%;top:45%;width:50px;height:50px;border:4px solid rgba(236,72,153,0.7);border-radius:50%;animation:evo-ring-expand 1.2s ease-out 0.3s forwards;z-index:15;"></div>`;
      // Central flash
      burstEffects+=`<div style="position:absolute;left:50%;top:45%;transform:translate(-50%,-50%);width:400px;height:400px;background:radial-gradient(circle,rgba(255,255,255,1) 0%,rgba(251,191,36,0.9) 20%,rgba(168,85,247,0.5) 50%,transparent 70%);border-radius:50%;animation:evo-flash 1s ease-out;z-index:10;"></div>`;
    }

    // Confetti for reveal phase
    let confetti='';
    if(phase==='reveal'||phase==='naming'){
      const colors=['#fbbf24','#f472b6','#a78bfa','#34d399','#60a5fa','#fb7185'];
      for(let i=0;i<30;i++){
        const x=Math.random()*100;
        const delay=Math.random()*2;
        const color=colors[i%colors.length];
        const size=8+Math.random()*8;
        confetti+=`<div style="position:absolute;left:${x}%;top:-20px;width:${size}px;height:${size}px;background:${color};border-radius:50%;animation:hatch-confetti ${2+Math.random()}s ease-out ${delay}s infinite;"></div>`;
      }
    }

    const isHatching=evoType==='hatched';

    h=`<div class="p-5 min-h-screen flex items-center justify-center" style="background:linear-gradient(135deg,#1e1b4b,#312e81,#4c1d95);">
      <div class="text-center max-w-md w-full relative" style="min-height:500px;overflow:visible;">
        ${confetti}${burstEffects}

        ${phase==='collect'?`
          <!-- Phase 1: Show creature + XP + Collect button -->
          <div class="mb-8 pt-8" style="overflow:visible;">
            <div class="evo-spin-buildup inline-block" style="transform-origin:center;overflow:visible;">
              <div style="transform:scale(0.8);transform-origin:center;overflow:visible;">
                ${renderPrevForm()}
              </div>
            </div>
          </div>
          <div class="text-yellow-300 text-4xl font-black mb-6">+${pState.xpEarned||10} XP</div>
          <button onclick="pState.evolvePhase='burst';render()" class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-black py-5 px-12 rounded-2xl text-xl shadow-lg shadow-orange-500/50 animate-pulse">
            Collect XP
          </button>
        `:''}

        ${phase==='burst'?`
          <!-- Phase 2: EXPLOSION! Auto-advance after animation -->
          <div class="relative" style="min-height:400px;"></div>
        `:''}

        ${phase==='reveal'?(()=>{
          // Get rarity and theme for TCG card styling
          const rarity=currentStage==='adult'&&categoryData.adultRarities?categoryData.adultRarities[S.creatureVariant||0]:'Common';
          const rarityFrame=RARITY_FRAMES[rarity]||RARITY_FRAMES['Common'];
          const theme=CATEGORY_CARD_THEMES[category]||CATEGORY_CARD_THEMES.mammals;
          const frameBorder=rarityFrame.rainbow?'background:'+rarityFrame.border+';padding:4px;':'border:4px solid '+rarityFrame.border+';';
          const frameGlow=rarityFrame.glow!=='none'?'box-shadow:'+rarityFrame.glow+';':'';
          const shineEffect=rarityFrame.shine?'<div style="position:absolute;top:0;left:-100%;width:50%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:card-shine 3s ease-in-out infinite;pointer-events:none;z-index:50;"></div>':'';
          const raritySparkles=generateRaritySparkles(rarityFrame.sparkles);
          const categoryParticles=generateCardParticles(theme.particles,6);
          const creatureName=currentStage==='adult'?categoryData.adultNames[S.creatureVariant||0]:newStageName;

          return `
          <!-- Phase 3: New Form Revealed with TCG Card! -->
          <div class="pt-4 hatch-creature-pop" style="overflow:visible;">
            <!-- TCG Card Frame -->
            <div class="relative mx-auto" style="${frameBorder}border-radius:16px;${frameGlow}overflow:hidden;max-width:280px;">
              ${shineEffect}
              ${raritySparkles}
              <div style="background:linear-gradient(145deg,#1a1035,#0f0a1f);border-radius:12px;overflow:hidden;">
                <!-- Card Header -->
                <div class="flex justify-between items-center px-3 py-2" style="background:linear-gradient(90deg,${theme.accent}40,transparent);">
                  <div>
                    <h2 class="text-lg font-black text-white tracking-tight" style="text-shadow:0 2px 4px rgba(0,0,0,0.3);">${isHatching?newStageName:(S.buddyName||creatureName)}</h2>
                    <p class="text-white/70 text-xs">${categoryName} Scribby</p>
                  </div>
                  ${currentStage==='adult'?'<span class="text-xs font-bold px-2 py-0.5 rounded-full bg-gradient-to-r '+RARITY_COLORS[rarity]+' text-white shadow-lg">'+rarity+'</span>':''}
                </div>
                <!-- Creature Display -->
                <div class="mx-2 mb-2 rounded-xl overflow-hidden" style="border:4px solid ${theme.accent};">
                  <div class="relative flex items-center justify-center py-6" style="min-height:220px;background:${theme.bg};">
                    ${categoryParticles}
                    <div style="position:absolute;inset:0;background:radial-gradient(ellipse at center,rgba(255,255,255,0.35) 0%,transparent 60%);pointer-events:none;"></div>
                    <div style="transform:scale(0.85);transform-origin:center;position:relative;z-index:10;">${renderNewForm()}</div>
                  </div>
                </div>
                <!-- Type Badge -->
                <div class="flex justify-center -mt-3 relative z-10">
                  <span style="background:linear-gradient(135deg,${theme.accent},${theme.accent}dd);border:2px solid rgba(255,255,255,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.3);" class="text-white text-xs font-bold px-4 py-1 rounded-full">
                    ${categoryName} Scribby
                  </span>
                </div>
                <div class="py-3"></div>
              </div>
            </div>
            <p class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-pink-300 to-purple-300 mt-4 mb-4 animate-pulse">${isHatching?'Hatched!':(S.buddyName||creatureName)+' Evolved!'}</p>
          </div>
          ${isHatching&&!S.buddyName?`
            <button onclick="pState.evolvePhase='naming';render()" class="bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold py-4 px-10 rounded-2xl text-lg shadow-lg">
              Name Your Scribby
            </button>
          `:`
            <button onclick="pState.evolving=false;pState.celebration=false;setScreen('home')" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-4 px-10 rounded-2xl text-lg shadow-lg">
              Continue
            </button>
          `}
        `;})():''}

        ${phase==='naming'?`
          <!-- Phase 4: Name Your Friend (only for hatching) -->
          <div class="pt-6 mb-6" style="overflow:visible;">
            <div class="inline-block mb-4" style="overflow:visible;">
              <div style="transform:scale(0.7);transform-origin:center;overflow:visible;">
                ${renderNewForm()}
              </div>
            </div>
          </div>
          <div class="bg-white/95 rounded-2xl p-4 mb-4 mx-4">
            <input type="text" id="evo-name-input" placeholder="Enter a name..." maxlength="20"
              class="w-full text-center text-xl font-bold text-purple-800 bg-purple-50 rounded-xl py-3 px-4 outline-none focus:ring-2 focus:ring-purple-400"
              value="${S.buddyName||''}"
              onkeydown="if(event.key==='Enter'){const n=this.value.trim();if(n){S.buddyName=n;save();pState.evolving=false;pState.celebration=false;setScreen('home')}}">
          </div>
          <button onclick="const inp=document.getElementById('evo-name-input');const n=inp?inp.value.trim():'';if(n){S.buddyName=n;save();pState.evolving=false;pState.celebration=false;setScreen('home')}else{alert('Please enter a name!')}" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-4 px-10 rounded-2xl text-lg shadow-lg">
            Done
          </button>
          <button onclick="S.buddyName='Scribby';save();pState.evolving=false;pState.celebration=false;setScreen('home')" class="block mx-auto mt-3 text-white/60 text-sm">
            Skip
          </button>
        `:''}
      </div>
    </div>`;
  }

  // Celebration screen (check BEFORE practice modes)
  else if(pState.celebration){
    const masteryChanged=pState.newMastery>pState.oldMastery;
    const performance=pState.xpEarned>=10?'excellent':pState.xpEarned>=5?'good':'okay';
    h=`<div class="p-5 min-h-screen flex items-center justify-center">
      <div class="bg-white/95 rounded-3xl p-6 text-center max-w-md w-full">
        <div class="flex justify-center mb-4" style="transform:scale(0.6);transform-origin:center;">${renderBuddyVisual()}</div>
        <h2 class="text-2xl font-bold text-purple-800 mb-4">Practice Complete!</h2>

        <div class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-2xl p-4 mb-4">
          <p class="text-4xl font-bold text-orange-600 mb-2">+${pState.xpEarned} XP</p>
          <div class="text-left space-y-1 text-sm">
            <div class="flex justify-between text-purple-700">
              <span>Base XP:</span>
              <span class="font-semibold">+${pState.baseXP}</span>
            </div>
            ${pState.multiplier<1?`<div class="flex justify-between text-purple-600">
              <span>Mode multiplier (${Math.round(pState.multiplier*100)}%):</span>
              <span class="font-semibold">${Math.round(pState.baseXP*pState.multiplier)-pState.baseXP}</span>
            </div>`:''}
            ${pState.lengthBonus>0?`<div class="flex justify-between text-amber-700">
              <span>Length bonus (${pState.wordCount} words, ${pState.lengthMultiplier}x):</span>
              <span class="font-semibold">+${pState.lengthBonus}</span>
            </div>`:''}
            ${pState.reviewBonus>0?`<div class="flex justify-between text-green-700">
              <span>Review bonus:</span>
              <span class="font-semibold">+${pState.reviewBonus}</span>
            </div>`:''}
            ${pState.firstPracticeBonus>0?`<div class="flex justify-between text-blue-700">
              <span>First practice today:</span>
              <span class="font-semibold">+${pState.firstPracticeBonus}</span>
            </div>`:''}
            ${pState.happinessBonus>0?`<div class="flex justify-between text-pink-600">
              <span>Happy buddy bonus (${Math.round(pState.happinessMult*100)}%):</span>
              <span class="font-semibold">+${pState.happinessBonus}</span>
            </div>`:''}
          </div>
        </div>

        ${masteryChanged?`<div class="bg-purple-50 rounded-2xl p-4 mb-4">
          <p class="text-purple-700 font-semibold mb-2">Mastery Progress</p>
          <div class="flex items-center justify-center gap-2">
            <span class="text-sm">${getStars(pState.oldMastery)}</span>
            <span class="text-purple-400">â†’</span>
            <span class="text-sm sparkle">${getStars(pState.newMastery)}</span>
          </div>
          ${pState.newMastery>=5?'<p class="text-green-600 font-bold mt-2">âœ¨ Mastered! (+50 XP bonus)</p>':''}
        </div>`:''}

        <button onclick="collectXP()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-4 rounded-2xl mb-2">
          Collect XP
        </button>
        <button onclick="continuePracticing()" class="w-full bg-purple-100 text-purple-700 font-semibold py-3 rounded-2xl">
          Continue Practicing
        </button>
      </div>
    </div>`;
  }

  else if(pMode==='refused'){
    const refusalMessages={
      verySad:["I'm too sad to practice right now... ðŸ˜¢","I can't focus... I'm so unhappy...","Please... I need some happiness first..."],
      sad:["I don't really feel like practicing...",`Can we do something else? I'm not in the mood...`,"Maybe later... I'm feeling down..."]
    };
    const happyLvl=getHappinessLevel();
    const msgs=refusalMessages[happyLvl]||refusalMessages.sad;
    const msg=msgs[Math.floor(Math.random()*msgs.length)];
    h=`<div class="p-5">
      <div class="flex justify-between mb-4">
        <button onclick="pMode=null;render()" class="text-white text-xl">âœ•</button>
        <p class="text-white font-semibold">ðŸ˜” Not Now</p>
        <div></div>
      </div>
      <div class="bg-white/95 rounded-3xl p-6 text-center">
        <div class="text-7xl mb-4">${getBuddyEmoji()}</div>
        <p class="text-purple-800 text-xl font-semibold mb-3">${S.buddyName||'Buddy'} refuses to practice!</p>
        <p class="text-purple-600 mb-6">${msg}</p>
        <div class="bg-purple-50 rounded-xl p-4 mb-4">
          <p class="text-purple-700 text-sm mb-2">ðŸ’¡ Tip: Try feeding ${S.buddyName||'your buddy'} some treats to improve happiness!</p>
        </div>
        <button onclick="pMode=null;render()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 rounded-xl">
          Okay
        </button>
      </div>
    </div>`;
  }

  else if(pMode==='predict'){
    const buddyStatusCompact=getPracticeStatusBar();
    const p=pState.total>0?Math.round(pState.correct/pState.total*100):0;
    const roundNames=['','Round 1: Easy','Round 2: Medium','Round 3: Hard','Round 4: Master'];
    const roundDesc=['','Every 4th word + hints','Every 3rd word + letter count','Every 2nd word, limited context','Every word, minimal context'];

    // Apply context limit to displayed text
    let displayText=pState.rev.join(' ');
    if(pState.contextLimit&&pState.rev.length>pState.contextLimit){
      const limited=pState.rev.slice(-pState.contextLimit);
      displayText='... '+limited.join(' ');
    }

    let inner='';
    if(pState.done){
      const finalXP=Math.round((pState.totalXP||5)*10)/10;
      inner=`<div class="text-center">
        <p class="text-green-500 font-bold text-xl mb-2">ðŸ† Master Level Complete!</p>
        <p class="text-purple-600 mb-2">You predicted every word!</p>
        <div class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-xl p-3 mb-4">
          <p class="text-2xl font-bold text-orange-600">+${finalXP} XP</p>
          <p class="text-orange-500 text-xs">All 4 rounds completed!</p>
        </div>
        <button onclick="completePractice()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 rounded-xl">Collect XP</button>
      </div>`;
    }else if(pState.roundComplete){
      const roundXPDisplay=Math.round(pState.roundXP*10)/10;
      const totalXPDisplay=Math.round(pState.totalXP*10)/10;
      const accuracy=pState.total>0?Math.round(pState.correct/pState.total*100):0;
      inner=`<div class="text-center">
        <p class="text-green-500 font-bold text-xl mb-2">âœ¨ ${roundNames[pState.round]} Complete!</p>
        <p class="text-purple-600 text-sm mb-2">${accuracy}% accuracy</p>
        <div class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-xl p-3 mb-4">
          <p class="text-2xl font-bold text-orange-600">+${roundXPDisplay} XP</p>
          <p class="text-orange-500 text-xs">Total earned: ${totalXPDisplay} XP</p>
        </div>
        <p class="text-purple-600 text-sm mb-4">Ready for <b>${roundNames[pState.round+1]}</b>?<br><span class="text-purple-400 text-xs">${roundDesc[pState.round+1]}</span></p>
        <button onclick="advancePredictRound()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 rounded-xl mb-2">Continue to Next Level ðŸ”¥</button>
        <button onclick="exitPredictEarly()" class="w-full bg-purple-100 text-purple-600 font-semibold py-2.5 rounded-xl">Collect ${totalXPDisplay} XP & Exit</button>
      </div>`;
    }else{
      const targetIdx=pState.predictIndices[pState.currentPredictIdx];
      const startIdx=pState.rev.length; // Where revealed text ends
      // Get the phrase from revealed position to checkpoint (inclusive)
      const phraseWords=pState.W.slice(startIdx,targetIdx+1);
      const correctPhrase=phraseWords.join(' ');

      // Generate decoy phrases by grabbing other chunks from the verse
      const decoyPhrases=[];
      const phraseLen=phraseWords.length;
      for(let i=0;i<pState.W.length-phraseLen&&decoyPhrases.length<2;i++){
        if(i!==startIdx){
          const chunk=pState.W.slice(i,i+phraseLen).join(' ');
          if(chunk!==correctPhrase&&!decoyPhrases.includes(chunk)){
            decoyPhrases.push(chunk);
          }
        }
      }
      // If we don't have enough decoys, shuffle words from different parts
      while(decoyPhrases.length<2){
        const shuffled=[...phraseWords].sort(()=>Math.random()-0.5).join(' ');
        if(shuffled!==correctPhrase&&!decoyPhrases.includes(shuffled)){
          decoyPhrases.push(shuffled);
        }
      }
      predictOptions=shuffle([correctPhrase,...decoyPhrases]);

      inner=`<p class="text-purple-500 text-sm text-center mb-2">What comes next?</p><div class="space-y-2">${predictOptions.map((w,i)=>`<button onclick="selectPredictByIndex(${i})" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white py-3 px-4 rounded-xl text-sm">${w}</button>`).join('')}</div>`;
    }

    h=`<div class="p-5">${buddyStatusCompact}
      <div class="flex justify-between items-center mb-4">
        <button onclick="pMode=null;render()" class="text-white text-xl">âœ•</button>
        <div class="text-center">
          <p class="text-white font-semibold">ðŸŽ¯ Predict</p>
          <p class="text-white/60 text-xs">${roundNames[pState.round]}</p>
        </div>
        <p class="text-white/60">${pState.currentPredictIdx}/${pState.total}</p>
      </div>
      <div class="bg-white/95 rounded-3xl p-5 ${pState.wrong?'shake':''}">
        <div class="flex justify-between items-center mb-2">
          <p class="text-purple-600 font-medium">${pVerse.ref}</p>
          <div class="flex gap-1">${[1,2,3,4].map(r=>`<div class="w-2 h-2 rounded-full ${r<pState.round?'bg-green-500':r===pState.round?'bg-yellow-400':'bg-purple-200'}"></div>`).join('')}</div>
        </div>
        <p class="text-purple-800 mb-4">${displayText}${pState.done||pState.roundComplete?'':' ...'}</p>
        ${pState.wrong&&!pState.done&&!pState.roundComplete?'<p class="text-orange-500 text-sm text-center mb-2">Not quite!</p>':''}
        ${inner}
      </div>
    </div>`;
  }

  else if(pMode==='blanks'){
    const buddyStatusCompact=getPracticeStatusBar();
    // Display with color coding: green for filled, yellow for current blank, normal for given words
    const disp=pState.blanks.map((w,i)=>{
      if(w==='')return '<span class="bg-yellow-200 px-1 rounded font-bold">____</span>';
      if(pState.filledIndices&&pState.filledIndices.includes(i))return `<span class="text-green-600 font-semibold">${w}</span>`;
      return w;
    }).join(' ');

    const roundNames=['','Round 1: Easy','Round 2: Warm Up','Round 3: Medium','Round 4: Challenging','Round 5: Hard','Round 6: Master'];
    const roundDesc=['','Every 6th word','Every 5th word','Every 4th word','Every 3rd word','Every 2nd word','All words!'];

    let inner='';
    if(pState.done){
      const finalXP=Math.round((pState.totalXP||8)*10)/10;
      inner=`<div class="text-center">
        <p class="text-green-500 font-bold text-xl mb-2">ðŸ† Master Level Complete!</p>
        <p class="text-purple-600 mb-2">You filled in every word!</p>
        <div class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-xl p-3 mb-4">
          <p class="text-2xl font-bold text-orange-600">+${finalXP} XP</p>
          <p class="text-orange-500 text-xs">All 6 rounds completed!</p>
        </div>
        <button onclick="completePractice()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 rounded-xl">Collect XP</button>
      </div>`;
    }else if(pState.roundComplete){
      const roundXPDisplay=Math.round(pState.roundXP*10)/10;
      const totalXPDisplay=Math.round(pState.totalXP*10)/10;
      inner=`<div class="text-center">
        <p class="text-green-500 font-bold text-xl mb-2">âœ¨ ${roundNames[pState.round]} Complete!</p>
        <div class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-xl p-3 mb-4">
          <p class="text-2xl font-bold text-orange-600">+${roundXPDisplay} XP</p>
          <p class="text-orange-500 text-xs">Total earned: ${totalXPDisplay} XP${pState.hintsUsed?` (${pState.hintsUsed} hints used)`:''}</p>
        </div>
        <p class="text-purple-600 text-sm mb-4">Ready for <b>${roundNames[pState.round+1]}</b>?<br><span class="text-purple-400 text-xs">${roundDesc[pState.round+1]}</span></p>
        <button onclick="advanceBlankRound()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 rounded-xl mb-2">Continue to Next Level ðŸ”¥</button>
        <button onclick="exitBlanksEarly()" class="w-full bg-purple-100 text-purple-600 font-semibold py-2.5 rounded-xl">Collect ${totalXPDisplay} XP & Exit</button>
      </div>`;
    }else if(pState.revealed){
      // Word revealed after too many wrong attempts
      const word=pState.missing[pState.cBlank];
      inner=`<div class="bg-orange-50 rounded-xl p-4 mb-3 text-center">
        <p class="text-orange-600 text-sm font-semibold mb-2">The word was:</p>
        <p class="text-2xl font-bold text-purple-800">${word}</p>
        <p class="text-orange-400 text-xs mt-2">Take a moment to remember it!</p>
      </div>
      <button onclick="skipBlankWord()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 rounded-xl">Continue â†’</button>`;
    }else{
      const word=pState.missing[pState.cBlank]||'';
      const hintLevel=pState.hintLevel||0;
      let hintText='';
      let hintIcon='ðŸ’¡';

      if(hintLevel===0){
        hintText=`The word has <b>${word.length}</b> letters`;
      }else if(hintLevel===1){
        hintText=`${word.length} letters, starts with "<b>${word[0].toUpperCase()}</b>"`;
        hintIcon='ðŸ”¤';
      }else if(hintLevel===2){
        hintText=`Starts with "<b>${word[0].toUpperCase()}</b>", ends with "<b>${word[word.length-1]}</b>"`;
        hintIcon='ðŸŽ¯';
      }else if(hintLevel>=3){
        // Show more letters
        const revealed=word.split('').map((c,i)=>i===0||i===word.length-1||i===Math.floor(word.length/2)?c:'_').join(' ');
        hintText=`Pattern: <b>${revealed}</b>`;
        hintIcon='ðŸ”“';
      }

      const wrongFeedback=pState.wrong?`<div class="bg-red-50 rounded-xl p-3 mb-3">
        <p class="text-red-500 text-sm font-semibold mb-1">âŒ "${pState.wrongAnswer}" is not correct</p>
        <p class="text-purple-600 text-xs">${hintIcon} Hint: ${hintText}</p>
        ${hintLevel>=3?'<p class="text-orange-500 text-xs mt-1">âš ï¸ One more wrong = answer revealed!</p>':''}
      </div>`:`<div class="bg-purple-50 rounded-xl p-2 mb-3 text-center">
        <p class="text-purple-500 text-xs">${hintIcon} ${hintText}</p>
      </div>`;

      inner=`${wrongFeedback}<input id="inp" value="${pState.inp}" oninput="pState.inp=this.value;pState.wrong=false;pState.wrongAnswer=''" onkeypress="if(event.key==='Enter')checkBlanks()" placeholder="Type the missing word..." class="w-full border-2 ${pState.wrong?'border-red-400':'border-purple-200'} rounded-xl px-4 py-3 mb-3"><button onclick="checkBlanks()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 rounded-xl">Check</button>`;
    }

    h=`<div class="p-5">${buddyStatusCompact}
      <div class="flex justify-between mb-4">
        <button onclick="pMode=null;render()" class="text-white text-xl">âœ•</button>
        <div class="text-center">
          <p class="text-white font-semibold">âœï¸ Fill in the Blanks</p>
          <p class="text-white/60 text-xs">${roundNames[pState.round]} - ${roundDesc[pState.round]}</p>
        </div>
        <p class="text-white/60">${pState.cBlank}/${pState.missing.length}</p>
      </div>
      <div class="bg-white/95 rounded-3xl p-5">
        <div class="flex justify-between items-center mb-2">
          <p class="text-purple-600 font-medium">${pVerse.ref}</p>
          <div class="flex gap-1">${[1,2,3,4,5,6].map(r=>`<div class="w-2 h-2 rounded-full ${r<=pState.round?'bg-green-500':'bg-purple-200'}"></div>`).join('')}</div>
        </div>
        <p class="text-purple-800 mb-4 leading-relaxed">${disp}</p>
        ${inner}
      </div>
    </div>`;
  }

  else if(pMode==='hangman'){
    const buddyStatusCompact=getPracticeStatusBar();
    const hangmanStages=['ðŸ˜Š','ðŸ˜Š','ðŸ˜','ðŸ˜Ÿ','ðŸ˜°','ðŸ˜±','ðŸ’€','ðŸ’€','â˜ ï¸'];
    let inner='';
    if(pState.done){
      const xp=pState.won?6:3;
      const fullVerse=pState.W.join(' ');
      inner=`<div class="text-center"><p class="text-4xl mb-2">${pState.won?'ðŸŽ‰':'ðŸ˜¢'}</p><p class="text-xl font-bold ${pState.won?'text-green-500':'text-orange-500'} mb-3">${pState.won?'You Won!':'Game Over'}</p><div class="bg-purple-50 rounded-xl p-4 mb-4"><p class="text-purple-800 text-sm">${fullVerse}</p></div><button onclick="completePractice()" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 px-8 rounded-xl">+${xp} XP</button></div>`;
    }else{
      const display=pState.W.map(word=>
        word.split('').map(c=>
          !/[a-zA-Z]/.test(c)?`<span class="text-purple-400">${c}</span>`:
          pState.guessed.includes(clean(c))?`<span class="text-purple-800 font-bold">${c}</span>`:
          `<span class="inline-block w-6 h-0.5 bg-purple-300 rounded mx-px"></span>`
        ).join('')
      ).join(' ');
      const alphabet='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
      const keyboard=alphabet.map(l=>`<button onclick="guessLetter('${l.toLowerCase()}')" class="w-10 h-10 rounded-lg font-bold text-sm ${pState.guessed.includes(l.toLowerCase())?'bg-gray-200 text-gray-400 cursor-not-allowed':'bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white'}" ${pState.guessed.includes(l.toLowerCase())?'disabled':''}>${l}</button>`).join('');
      inner=`<div class="text-center mb-4"><div class="text-6xl mb-2">${hangmanStages[pState.wrong]}</div><p class="text-purple-600 text-sm font-semibold">Wrong guesses: ${pState.wrong}/${pState.maxWrong}</p></div><div class="bg-purple-50 rounded-xl p-4 mb-4"><div class="text-lg leading-relaxed">${display}</div></div><div class="grid grid-cols-7 gap-2">${keyboard}</div>`;
    }
    h=`<div class="p-5">${buddyStatusCompact}<div class="flex justify-between mb-4"><button onclick="pMode=null;render()" class="text-white text-xl">âœ•</button><p class="text-white font-semibold">âš”ï¸ Hangman</p><p class="text-white/60">${pVerse.ref}</p></div>
      <div class="bg-white/95 rounded-3xl p-5">${inner}</div></div>`;
  }

  else if(pMode==='match'){
    const buddyStatusCompact=getPracticeStatusBar();
    let inner='';
    if(pState.done){
      inner=`<div class="text-center">
        <p class="text-green-500 font-bold text-xl mb-2">ðŸŽ‰ All Matched!</p>
        <p class="text-purple-600 mb-4">Great memory!</p>
        <button onclick="completePractice()" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 px-8 rounded-xl">+6 XP</button>
      </div>`;
    }else if(!pState.verses||pState.verses.length<2){
      inner=`<div class="text-center">
        <p class="text-orange-500 mb-4">You need at least 2 verses to play Verse Match!</p>
        <button onclick="pMode=null;render()" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 px-8 rounded-xl">Back</button>
      </div>`;
    }else{
      const textCards=pState.verses.map((v,i)=>`
        <button onclick="selectMatchText(${i})" class="w-full p-3 rounded-xl text-left text-sm transition-all ${v.matched?'bg-green-100 border-2 border-green-400 opacity-60':pState.selectedText===i?'bg-yellow-100 border-2 border-yellow-400 ring-2 ring-yellow-300':'bg-purple-50 border-2 border-purple-200 hover:border-purple-400'}">
          ${v.matched?'âœ“ ':''}<span class="${v.matched?'text-green-700':'text-purple-800'}">${v.text.length>80?v.text.substring(0,80)+'...':v.text}</span>
        </button>
      `).join('');
      const refCards=pState.refs.map((r,i)=>`
        <button onclick="selectMatchRef(${i})" class="w-full p-3 rounded-xl text-center font-semibold transition-all ${r.matched?'bg-green-100 border-2 border-green-400 opacity-60':pState.selectedRef===i?'bg-yellow-100 border-2 border-yellow-400 ring-2 ring-yellow-300':'bg-purple-50 border-2 border-purple-200 hover:border-purple-400'}">
          ${r.matched?'âœ“ ':''}<span class="${r.matched?'text-green-700':'text-purple-800'}">${r.ref}</span>
        </button>
      `).join('');
      inner=`
        ${pState.wrong?'<p class="text-red-500 text-sm text-center mb-3">âŒ Not a match! Try again.</p>':''}
        <p class="text-purple-500 text-xs mb-2 font-semibold">TAP A VERSE TEXT:</p>
        <div class="space-y-2 mb-4">${textCards}</div>
        <p class="text-purple-500 text-xs mb-2 font-semibold">THEN TAP ITS REFERENCE:</p>
        <div class="grid grid-cols-2 gap-2">${refCards}</div>
      `;
    }
    h=`<div class="p-5">${buddyStatusCompact}
      <div class="flex justify-between mb-4">
        <button onclick="pMode=null;render()" class="text-white text-xl">âœ•</button>
        <p class="text-white font-semibold">ðŸ”— Verse Match</p>
        <p class="text-white/60">${pState.matchedCount||0}/${pState.verses?.length||0}</p>
      </div>
      <div class="bg-white/95 rounded-3xl p-5">${inner}</div>
    </div>`;
  }

  else if(pMode==='jumble'){
    const buddyStatusCompact=getPracticeStatusBar();
    let inner='';
    if(pState.done)inner=`<div class="text-center"><p class="text-green-500 font-bold text-xl mb-4">âœ¨ Perfect!</p><button onclick="completePractice()" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 px-8 rounded-xl">+7 XP</button></div>`;
    else inner=`<div class="flex flex-wrap gap-2">${pState.shuf.map((w,i)=>`<button onclick="selectJumble(${i})" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white px-3 py-2 rounded-lg">${w}</button>`).join('')}</div>`;
    h=`<div class="p-5">${buddyStatusCompact}<div class="flex justify-between mb-4"><button onclick="pMode=null;render()" class="text-white text-xl">âœ•</button><p class="text-white font-semibold">ðŸ”€ Jumble</p><p class="text-white/60">${pState.sel.length}/${pState.W.length}</p></div>
      <div class="bg-white/95 rounded-3xl p-5"><p class="text-purple-600 font-medium mb-2">${pVerse.ref}</p><div class="bg-purple-50 rounded-xl p-3 mb-3 min-h-16"><p class="text-purple-800">${pState.sel.join(' ')||'Tap in order...'}</p></div>${pState.wrong?'<p class="text-red-500 text-sm text-center mb-2">Wrong order!</p>':''}${inner}</div></div>`;
  }

  else if(pMode==='first'){
    const buddyStatusCompact=getPracticeStatusBar();
    const disp=pState.hints.map((h,i)=>i<pState.cWord?`<span class="text-green-600">${pState.W[i]}</span>`:i===pState.cWord?`<span class="bg-yellow-200 px-1 rounded">${h}</span>`:`<span class="text-purple-400">${h}</span>`).join(' ');
    let inner='';
    if(pState.done)inner=`<div class="text-center"><p class="text-green-500 font-bold text-xl mb-4">âœ¨ Amazing!</p><button onclick="completePractice()" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 px-8 rounded-xl">+8 XP</button></div>`;
    else inner=`<input id="inp" value="${pState.inp}" oninput="pState.inp=this.value;pState.wrong=false" onkeypress="if(event.key==='Enter')checkFirst()" placeholder="Type word..." class="w-full border-2 ${pState.wrong?'border-red-400':'border-purple-200'} rounded-xl px-4 py-3 mb-3">${pState.wrong?'<p class="text-red-500 text-sm mb-2">Try again!</p>':''}<button onclick="checkFirst()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 rounded-xl">Check</button>`;
    h=`<div class="p-5">${buddyStatusCompact}<div class="flex justify-between mb-4"><button onclick="pMode=null;render()" class="text-white text-xl">âœ•</button><p class="text-white font-semibold">ðŸ”¤ First Letters</p><p class="text-white/60">${pState.cWord}/${pState.W.length}</p></div>
      <div class="bg-white/95 rounded-3xl p-5"><p class="text-purple-600 font-medium mb-2">${pVerse.ref}</p><p class="text-purple-800 font-mono text-sm mb-4">${disp}</p>${inner}</div></div>`;
  }

  else if(pMode==='recall'){
    const buddyStatusCompact=getPracticeStatusBar();
    let inner='';
    if(pState.checked){
      // Build the comparison display
      const comparisonHtml=pState.comparison?pState.comparison.map(c=>{
        if(c.type==='correct'){
          return `<span class="text-green-600 font-medium">${c.expected}</span>`;
        }else if(c.type==='wrong'){
          return `<span class="relative inline-block"><span class="text-red-500 line-through text-xs absolute -top-3 left-0 whitespace-nowrap">${c.actual}</span><span class="text-green-600 font-medium bg-green-100 px-1 rounded">${c.expected}</span></span>`;
        }else if(c.type==='missing'){
          return `<span class="text-red-500 font-medium bg-red-100 px-1 rounded">${c.expected}</span>`;
        }else if(c.type==='extra'){
          return `<span class="text-orange-500 line-through">${c.actual}</span>`;
        }
        return '';
      }).join(' '):'';

      const legendHtml=`<div class="flex flex-wrap gap-3 text-xs mt-3 pt-3 border-t border-purple-200">
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-green-500"></span> Correct</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-red-100 border border-red-300"></span> Missed</span>
        <span class="flex items-center gap-1"><span class="text-red-500 line-through">abc</span> Wrong word</span>
      </div>`;

      if(pState.done){
        inner=`<div class="text-center mb-4"><p class="text-4xl font-bold text-green-500">${pState.score}%</p><p class="text-purple-600 mb-2">Great job!</p></div>
          <div class="bg-purple-50 rounded-xl p-3 mb-4"><p class="text-sm leading-relaxed">${comparisonHtml}</p>${legendHtml}</div>
          <button onclick="completePractice()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 rounded-xl">+${pState.score===100?15:10} XP</button>`;
      }else{
        inner=`<div class="text-center mb-4"><p class="text-4xl font-bold text-orange-500">${pState.score}%</p><p class="text-purple-600 mb-2">Need 80%+ to pass</p></div>
          <div class="bg-purple-50 rounded-xl p-3 mb-4"><p class="text-sm leading-relaxed">${comparisonHtml}</p>${legendHtml}</div>
          <button onclick="startPractice('recall')" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 rounded-xl">Try Again</button>`;
      }
    }else{
      inner=`<textarea id="inp" oninput="pState.inp=this.value" placeholder="Type the verse from memory..." class="w-full border-2 border-purple-200 rounded-xl px-4 py-3 h-32 mb-3">${pState.inp}</textarea><button onclick="checkRecall()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 rounded-xl">Check</button>`;
    }
    h=`<div class="p-5">${buddyStatusCompact}<div class="flex justify-between mb-4"><button onclick="pMode=null;render()" class="text-white text-xl">âœ•</button><p class="text-white font-semibold">ðŸ’­ Recall</p><p class="text-white/60">+10-15</p></div>
      <div class="bg-white/95 rounded-3xl p-5"><p class="text-purple-600 font-medium mb-1">${pVerse.ref}</p><p class="text-purple-400 text-sm mb-3">Type from memory</p>${inner}</div></div>`;
  }

  else if(pMode==='chunk'){
    const buddyStatusCompact=getPracticeStatusBar();
    const phase=pState.phases[pState.currentPhase];
    const progress=Math.round((pState.currentPhase/pState.phases.length)*100);

    // Phase indicator dots
    const phaseDots=pState.phases.map((p,i)=>`<div class="w-2 h-2 rounded-full ${i<pState.currentPhase?'bg-green-500':i===pState.currentPhase?'bg-yellow-400':'bg-purple-200'}"></div>`).join('');

    let inner='';
    if(pState.done){
      // Final completion
      const hintPenalty=Math.min(3,(pState.hintsUsed||0)*0.5);
      const finalXP=Math.max(3,6-hintPenalty);
      inner=`<div class="text-center">
        <p class="text-green-500 font-bold text-xl mb-2">ðŸ† Verse Mastered!</p>
        <p class="text-purple-600 mb-2">You learned the whole verse in chunks!</p>
        <div class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-xl p-3 mb-4">
          <p class="text-2xl font-bold text-orange-600">+${Math.round(finalXP*10)/10} XP</p>
          ${pState.hintsUsed?`<p class="text-orange-500 text-xs">${pState.hintsUsed} hints used</p>`:''}
        </div>
        <button onclick="completePractice()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 rounded-xl">Collect XP</button>
      </div>`;
    }else if(pState.phaseComplete){
      // Phase complete - advance to next
      const isCombine=phase.type==='combine';
      inner=`<div class="text-center">
        <p class="text-green-500 font-bold text-xl mb-2">âœ¨ ${isCombine?'Combined!':'Chunk Learned!'}</p>
        <p class="text-purple-600 text-sm mb-3">${pState.phaseAccuracy}% accuracy</p>
        <button onclick="advanceChunkPhase()" class="w-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 rounded-xl">Continue â†’</button>
      </div>`;
    }else{
      // Active practice
      const isCombine=phase.type==='combine';
      const chunkNum=isCombine?`Chunks 1-${phase.upTo+1}`:`Chunk ${phase.chunkIdx+1}`;
      const phaseType=isCombine?'ðŸ”— Combine':'ðŸ“ Learn';

      // Show the text to memorize (or hint if requested)
      const targetText=phase.text;
      const textDisplay=pState.showingHint?
        `<div class="bg-green-50 border-2 border-green-300 rounded-xl p-4 mb-3">
          <p class="text-purple-800 leading-relaxed">${targetText}</p>
          <button onclick="hideChunkHint()" class="mt-2 text-sm text-green-600 font-semibold">Hide & Try Again</button>
        </div>`:
        `<div class="bg-purple-50 rounded-xl p-4 mb-3 text-center">
          <p class="text-purple-500 text-xs font-semibold mb-1">${phaseType} - ${chunkNum}</p>
          <p class="text-purple-800 leading-relaxed">${targetText}</p>
        </div>`;

      // Comparison feedback when wrong
      const comparisonHtml=pState.comparison?`<div class="bg-red-50 rounded-xl p-3 mb-3">
        <p class="text-red-500 text-sm font-semibold mb-2">âŒ Not quite right:</p>
        <p class="text-sm leading-relaxed">${pState.comparison.map(c=>{
          if(c.type==='correct')return`<span class="text-green-600">${c.word}</span>`;
          if(c.type==='wrong')return`<span class="text-red-500 line-through">${c.actual}</span><span class="text-green-600 bg-green-100 px-1 rounded">${c.expected}</span>`;
          return`<span class="text-red-500 bg-red-100 px-1 rounded">${c.word}</span>`;
        }).join(' ')}</p>
      </div>`:'';

      inner=`${textDisplay}
        ${comparisonHtml}
        <p class="text-purple-500 text-xs mb-2">Now type it from memory:</p>
        <textarea id="inp" oninput="pState.inp=this.value;pState.wrong=false;pState.comparison=null" placeholder="Type the ${isCombine?'combined chunks':'chunk'} here..." class="w-full border-2 ${pState.wrong?'border-red-400':'border-purple-200'} rounded-xl px-4 py-3 h-24 mb-3">${pState.inp}</textarea>
        <div class="flex gap-2">
          <button onclick="showChunkHint()" class="flex-1 bg-purple-100 text-purple-600 font-semibold py-3 rounded-xl">ðŸ‘ï¸ Peek</button>
          <button onclick="checkChunk()" class="flex-2 bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-bold py-3 px-6 rounded-xl">Check</button>
        </div>`;
    }

    h=`<div class="p-5">${buddyStatusCompact}
      <div class="flex justify-between items-center mb-4">
        <button onclick="pMode=null;render()" class="text-white text-xl">âœ•</button>
        <div class="text-center">
          <p class="text-white font-semibold">ðŸ§© Chunk Master</p>
          <p class="text-white/60 text-xs">${pState.chunks.length} chunks</p>
        </div>
        <p class="text-white/60">${pState.currentPhase+1}/${pState.phases.length}</p>
      </div>
      <div class="bg-white/95 rounded-3xl p-5">
        <div class="flex justify-between items-center mb-3">
          <p class="text-purple-600 font-medium">${pVerse.ref}</p>
          <div class="flex gap-1">${phaseDots}</div>
        </div>
        <div class="w-full bg-purple-100 rounded-full h-2 mb-4">
          <div class="bg-gradient-to-r from-violet-500 to-fuchsia-500 h-2 rounded-full transition-all" style="width:${progress}%"></div>
        </div>
        ${inner}
      </div>
    </div>`;
  }

  // No bottom bar needed - stats are on the buddy card


  // Modal
  if(modal){
    if(modal==='feed'){
      // Feed modal with tabs
      const categories={yummy:'ðŸª Yummy',healthy:'ðŸ¥¦ Healthy',premium:'ðŸ‘‘ Premium'};
      const foodsByCategory={};
      FOODS.forEach(f=>{
        if(!foodsByCategory[f.cat])foodsByCategory[f.cat]=[];
        foodsByCategory[f.cat].push(f);
      });

      const catInfo={
        yummy:'Safe - always accepted â€¢ Ã—1.0 growth â€¢ ðŸ˜Š +15-25 â€¢ â¤ï¸ +5 or -10 (junk food reduces health!)',
        healthy:'Risky but efficient - may refuse (keeps food, loses happiness) â€¢ Ã—1.3 growth â€¢ ðŸ˜Š +10/-15 â€¢ â¤ï¸ +20',
        premium:'Best value - always accepted, max benefits â€¢ Ã—2.0 growth â€¢ ðŸ˜Š +30 â€¢ â¤ï¸ +25'
      };

      // Get stored food from ACCESSORIES inventory (count multiples)
      const storedFoodCounts={};
      (S.inventory||[]).forEach(idx=>{
        const acc=ACCESSORIES[idx];
        if(acc&&acc.type==='food'){
          if(!storedFoodCounts[idx])storedFoodCounts[idx]={...acc,idx,count:0};
          storedFoodCounts[idx].count++;
        }
      });
      const storedFood=Object.values(storedFoodCounts);

      // Get buyable stored food items from ACCESSORIES
      const buyableStoredFood=ACCESSORIES.map((acc,idx)=>({...acc,idx})).filter(a=>a.type==='food').sort((a,b)=>a.cost-b.cost);

      // Get medicine for buddy care
      const medicineItems=ACCESSORIES.map((acc,idx)=>({...acc,idx})).filter(a=>a.type==='medicine').sort((a,b)=>a.cost-b.cost);

      let content='';
      if(feedTab==='buy'){
        // Buy food tab
        content=`
          <p class="text-sm text-purple-600 mb-4">Your XP: ${S.xp}</p>
          ${Object.entries(foodsByCategory).map(([cat,foods])=>`
            <div class="mb-4">
              <p class="text-sm font-semibold text-purple-700 mb-1">${categories[cat]}</p>
              <p class="text-xs text-purple-500 mb-2">${catInfo[cat]}</p>
              <div class="grid grid-cols-3 gap-2">
                ${foods.map(f=>{
                  const canAfford=S.xp>=f.cost;
                  const healthStr=f.health>=0?`+${f.health}`:`${f.health}`;
                  const healthColor=f.health>=0?'text-green-600':'text-red-600';
                  const happyStr=f.happiness>=0?`+${f.happiness}`:`${f.happiness}`;
                  const happyColor=f.happiness>=0?'text-yellow-600':'text-red-600';
                  return`<button onclick="openFoodPopup(${FOODS.indexOf(f)})" class="p-3 rounded-xl ${canAfford?'bg-purple-50 hover:bg-purple-100':'bg-gray-100 opacity-50'} text-center" ${!canAfford?'disabled':''}>
                    <div class="text-3xl mb-1">${f.emoji}</div>
                    <div class="text-xs text-purple-800 font-semibold">${f.name}</div>
                    <div class="text-xs ${canAfford?'text-purple-600':'text-gray-500'} mb-1">${f.cost} XP</div>
                    <div class="text-[10px] flex justify-center gap-1">
                      <span class="${happyColor}">ðŸ˜Š${happyStr}</span>
                      <span class="${healthColor}">â¤ï¸${healthStr}</span>
                    </div>
                  </button>`;
                }).join('')}
              </div>
            </div>
          `).join('')}

          <div class="mb-4 mt-6 pt-4 border-t border-purple-200">
            <p class="text-sm font-semibold text-purple-700 mb-1">ðŸŽ Special Food</p>
            <p class="text-xs text-purple-500 mb-2">Save for later, trade with friends, or feed your buddy</p>
            <div class="grid grid-cols-3 gap-2">
              ${buyableStoredFood.map(acc=>{
                const canAfford=S.xp>=acc.cost;
                return`<button onclick="buyAccessory(${acc.idx})" class="p-3 rounded-xl ${canAfford?'bg-orange-50 hover:bg-orange-100':'bg-gray-100 opacity-50'} text-center" ${!canAfford?'disabled':''}>
                  <div class="text-3xl mb-1">${acc.emoji}</div>
                  <div class="text-xs text-orange-800 font-semibold">${acc.name}</div>
                  <div class="text-xs ${canAfford?'text-orange-600':'text-gray-500'}">${acc.cost} XP</div>
                </button>`;
              }).join('')}
            </div>
          </div>

          ${medicineItems.length>0?`
          <div class="mb-4 mt-4 pt-4 border-t border-purple-200">
            <p class="text-sm font-semibold text-green-700 mb-1">â¤ï¸ Medicine</p>
            <p class="text-xs text-green-600 mb-2">Heal your buddy when they're not feeling well</p>
            <div class="grid grid-cols-3 gap-2">
              ${medicineItems.map(acc=>{
                const canAfford=S.xp>=acc.cost;
                return`<button onclick="buyAccessory(${acc.idx})" class="p-3 rounded-xl ${canAfford?'bg-green-50 hover:bg-green-100':'bg-gray-100 opacity-50'} text-center" ${!canAfford?'disabled':''}>
                  <div class="text-3xl mb-1">${acc.emoji}</div>
                  <div class="text-xs text-green-800 font-semibold">${acc.name}</div>
                  <div class="text-xs ${canAfford?'text-green-600':'text-gray-500'}">${acc.cost} XP</div>
                  ${acc.healthBoost?`<div class="text-[10px] text-green-600">+${acc.healthBoost} â¤ï¸</div>`:''}
                </button>`;
              }).join('')}
            </div>
          </div>
          `:''}

        `;
      }else{
        // My food tab - show both foodInventory and stored food
        const hasFoodInventory=S.foodInventory.length>0;
        const hasStoredFood=storedFood.length>0;

        if(!hasFoodInventory&&!hasStoredFood){
          content=`<div class="text-center py-8"><p class="text-purple-400">No food in inventory</p><p class="text-purple-300 text-sm mt-2">Buy food to feed your buddy!</p></div>`;
        }else{
          // Combine all food into one grid for simplicity
          content=`
            <p class="text-sm font-semibold text-purple-700 mb-2">ðŸ½ï¸ Tap to Feed</p>
            <div class="grid grid-cols-3 gap-2">
              ${S.foodInventory.map((foodIdx,invIdx)=>{
                const f=FOODS[foodIdx];
                const healthStr=f.health>=0?`+${f.health}`:`${f.health}`;
                const healthColor=f.health>=0?'text-green-600':'text-red-500';
                const happyStr=f.happiness>=0?`+${f.happiness}`:`${f.happiness}`;
                const happyColor=f.happiness>=0?'text-yellow-600':'text-red-500';
                return`<button onclick="feedFromInventory(${invIdx})" class="p-3 rounded-xl bg-purple-50 hover:bg-purple-100 text-center">
                  <div class="text-3xl mb-1">${f.emoji}</div>
                  <div class="text-xs text-purple-800 font-semibold mb-1">${f.name}</div>
                  <div class="text-[10px] flex justify-center gap-2">
                    <span class="${happyColor}">ðŸ˜Š${happyStr}</span>
                    <span class="${healthColor}">â¤ï¸${healthStr}</span>
                  </div>
                </button>`;
              }).join('')}
              ${storedFood.map(acc=>`
                <button onclick="useFood(${acc.idx})" class="p-3 rounded-xl bg-purple-50 hover:bg-purple-100 text-center relative">
                  <div class="text-3xl mb-1">${acc.emoji}</div>
                  <div class="text-xs text-purple-800 font-semibold">${acc.name}</div>
                  ${acc.count>1?`<div class="absolute -top-1 -right-1 bg-purple-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">Ã—${acc.count}</div>`:''}
                </button>
              `).join('')}
            </div>
          `;
        }
      }

      h+=`<div class="fixed inset-0 bg-black/50 z-50 flex items-end" onclick="if(event.target===this)closeModal()">
        <div class="bg-white rounded-t-3xl w-full p-5 max-h-[80vh] overflow-y-auto">
          <div class="flex justify-between mb-4">
            <h2 class="text-lg font-bold text-purple-800">Feed ${S.buddyName||'Buddy'}</h2>
            <button onclick="closeModal()" class="text-2xl text-purple-400">&times;</button>
          </div>
          <div class="flex gap-2 mb-4">
            <button onclick="feedTab='buy';render()" class="flex-1 py-2 rounded-xl text-sm font-semibold ${feedTab==='buy'?'bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white':'bg-purple-100 text-purple-600'}">ðŸ›’ Shop</button>
            <button onclick="feedTab='myFood';render()" class="flex-1 py-2 rounded-xl text-sm font-semibold ${feedTab==='myFood'?'bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white':'bg-purple-100 text-purple-600'}">ðŸ± My Food (${S.foodInventory.length+storedFood.reduce((a,b)=>a+b.count,0)})</button>
          </div>
          ${content}
        </div>
      </div>`;
    }else if(modal==='mastered'){
      // Mastered verses modal
      const masteredVerses=S.verses.filter(v=>v.mastery>=5);
      h+=`<div class="fixed inset-0 bg-black/50 z-50 flex items-end" onclick="if(event.target===this)closeModal()">
        <div class="bg-white rounded-t-3xl w-full p-5 max-h-[80vh] overflow-y-auto">
          <div class="flex justify-between mb-4">
            <h2 class="text-lg font-bold text-purple-800">â­ Mastered Verses (${masteredVerses.length})</h2>
            <button onclick="closeModal()" class="text-2xl text-purple-400">&times;</button>
          </div>
          ${masteredVerses.length===0?`
            <div class="text-center py-8">
              <div class="text-6xl mb-4">ðŸŒŸ</div>
              <p class="text-purple-600 font-semibold mb-2">No mastered verses yet!</p>
              <p class="text-purple-400 text-sm">Practice your verses to reach 5/5 mastery.</p>
              <p class="text-purple-400 text-xs mt-2">Earn +50 XP bonus for each mastered verse!</p>
            </div>
          `:`
            <div class="space-y-3">
              ${masteredVerses.map(v=>`
                <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-4 border border-purple-100">
                  <div class="flex justify-between items-start mb-2">
                    <p class="font-bold text-purple-800">${v.ref}</p>
                    <div class="flex items-center gap-1">
                      <span class="text-yellow-500 text-lg">â­</span>
                      <span class="text-xs font-semibold text-purple-600">Mastered</span>
                    </div>
                  </div>
                  <p class="text-purple-700 text-sm mb-2">${v.text.length>350?v.text.substring(0,350)+'...':v.text}</p>
                  ${v.tags&&v.tags.length?`<div class="flex flex-wrap gap-1">${v.tags.map(t=>`<span class="text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-600">${t}</span>`).join('')}</div>`:''}
                  <div class="flex gap-2 mt-3">
                    <button onclick="closeModal();startPractice(${v.id},'recall')" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-xs font-semibold py-2 rounded-xl">Review</button>
                    <button onclick="closeModal();startPractice(${v.id},'blanks')" class="flex-1 bg-gradient-to-r from-yellow-400 to-orange-400 text-white text-xs font-semibold py-2 rounded-xl">Fill Blanks</button>
                  </div>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      </div>`;
    }else{
      // Edit/Add verse modal
      const isEdit=modal==='edit';
      const isAdd=modal==='add';

      let modalContent='';

      if(isAdd&&addTab==='library'){
        // Library browser in modal
        const library=getAllLibraryVerses();
        const userVerseRefs=S.verses.map(v=>v.ref);
        const inPractice=userVerseRefs.length;
        const totalAvailable=library.length;

        // Library view for modal with search
        if(searchQuery){
          // Show search results
          const results=library.filter(v=>
            v.text.toLowerCase().includes(searchQuery.toLowerCase())||
            v.ref.toLowerCase().includes(searchQuery.toLowerCase())||
            (v.tags&&v.tags.some(t=>t.toLowerCase().includes(searchQuery.toLowerCase())))||
            (v.speaker&&v.speaker.toLowerCase().includes(searchQuery.toLowerCase()))
          ).slice(0,30);

          let content=`<form onsubmit="triggerLibrarySearch(event)" class="mb-3">
            <div class="flex gap-2">
              <input type="text" id="library-search" placeholder="Search verses, quotes, tags..." value="${searchQuery}"
                oninput="debouncedSearchRender(this.value)"
                class="flex-1 px-3 py-2 rounded-xl bg-purple-50 text-purple-800 placeholder-purple-400 outline-none focus:ring-2 focus:ring-purple-300 text-sm">
              <button type="submit" class="bg-purple-100 text-purple-600 font-bold px-3 py-2 rounded-xl">ðŸ”</button>
            </div>
          </form>
          <button onclick="searchQuery='';render()" class="text-purple-600 text-xs mb-2">â† Back to library</button>
          <p class="text-purple-500 text-xs mb-2">${results.length} result${results.length!==1?'s':''} for "${searchQuery}"</p>`;

          if(results.length===0){
            content+=`<p class="text-purple-400 text-center py-4">No matches found</p>`;
          }else{
            results.forEach(v=>{
              const alreadyAdded=userVerseRefs.includes(v.ref);
              content+=`<div class="bg-purple-50 rounded-xl p-3 mb-2">
                <div class="flex justify-between items-start mb-1">
                  <p class="font-semibold text-purple-800 text-sm">${v.ref}</p>
                  ${alreadyAdded?`<span class="text-xs text-green-600">âœ“ Added</span>`:`<button onclick="addLibraryVerseByRef('${v.ref.replace(/'/g,"\\'")}',${JSON.stringify(v).replace(/"/g,'&quot;')});closeModal()" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs px-2 py-1 rounded-full">+ Add</button>`}
                </div>
                <p class="text-purple-700 text-xs">${v.text.length>200?v.text.substring(0,200)+'...':v.text}</p>
                ${v.speaker?`<p class="text-purple-400 text-xs mt-1 italic">â€” ${v.speaker}</p>`:''}
              </div>`;
            });
          }
          modalContent=content;
        }else if(!libraryView.collection){
          const collectionStats={};
          library.forEach(v=>{
            const coll=getBookCollection(v.book);
            if(coll){if(!collectionStats[coll])collectionStats[coll]=0;collectionStats[coll]++;}
          });

          // Get practiced counts per collection
          const practicedCounts=getPracticedCountsByCollection();

          const downloadedPackIds=JSON.parse(localStorage.getItem('downloadedPacks')||'[]');

          // Search bar + Stats header
          let content=`<form onsubmit="triggerLibrarySearch(event)" class="mb-3">
            <div class="flex gap-2">
              <input type="text" id="library-search" placeholder="Search verses, quotes, tags..." value="${searchQuery}"
                oninput="debouncedSearchRender(this.value)"
                class="flex-1 px-3 py-2 rounded-xl bg-purple-50 text-purple-800 placeholder-purple-400 outline-none focus:ring-2 focus:ring-purple-300 text-sm">
              <button type="submit" class="bg-purple-100 text-purple-600 font-bold px-3 py-2 rounded-xl">ðŸ”</button>
            </div>
          </form>
          <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-2 mb-4 flex justify-around text-center">
            <div><p class="text-purple-800 font-bold">${inPractice}</p><p class="text-purple-500 text-[10px]">In Practice</p></div>
            <div class="border-l border-purple-200"></div>
            <div><p class="text-purple-800 font-bold">${totalAvailable}</p><p class="text-purple-500 text-[10px]">Available</p></div>
          </div>
          <p class="text-purple-600 text-xs font-bold mb-2">ðŸ“š Your Scripture Library</p>`;

          // Bible collections
          ['Old Testament','New Testament'].forEach(collName=>{
            const count=collectionStats[collName]||0;
            const practiced=practicedCounts[collName]||0;
            const hasFullDownload=localStorage.getItem(COLLECTION_STORAGE_KEYS[collName]);
            const canDownloadFull=COLLECTION_URLS[collName]&&!hasFullDownload;
            content+=`<div class="w-full bg-purple-50 rounded-xl p-3 mb-2 flex items-center gap-2">
              <button onclick="libraryView.collection='${collName}';render()" class="flex-1 text-left">
                <p class="font-semibold text-purple-800">ðŸ“– ${collName}</p>
                <p class="text-xs text-purple-600"><span class="text-green-600">${practiced} practiced</span> / ${count} verses</p>
              </button>
              ${canDownloadFull?`<button onclick="downloadCollection('${collName}')" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs px-2 py-1 rounded-lg">â¬‡ï¸</button>`:''}
              ${hasFullDownload?`<button onclick="deleteCollection('${collName}')" class="text-red-400 p-1">ðŸ—‘ï¸</button>`:''}
            </div>`;
          });

          // Downloaded LDS scriptures
          ['Book of Mormon','Doctrine and Covenants','Pearl of Great Price'].forEach(collName=>{
            const collData=COLLECTIONS[collName];
            if(!collData)return;
            const packId=collData.packId;
            const hasFullDownload=localStorage.getItem(COLLECTION_STORAGE_KEYS[collName]);
            const hasPack=packId&&isPackDownloaded(packId);
            if(!hasFullDownload&&!hasPack)return;
            const count=collectionStats[collName]||0;
            const practiced=practicedCounts[collName]||0;
            const pack=packId?SCRIPTURE_PACKS[packId]:null;
            const icon=pack?pack.icon:'ðŸ“˜';
            const canDownloadFull=COLLECTION_URLS[collName]&&!hasFullDownload;
            content+=`<div class="w-full bg-purple-50 rounded-xl p-3 mb-2 flex items-center gap-2">
              <button onclick="libraryView.collection='${collName.replace(/'/g,"\\'")}';render()" class="flex-1 text-left">
                <p class="font-semibold text-purple-800">${icon} ${collName}</p>
                <p class="text-xs text-purple-600"><span class="text-green-600">${practiced} practiced</span> / ${count} verses</p>
              </button>
              ${canDownloadFull?`<button onclick="downloadCollection('${collName}')" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs px-2 py-1 rounded-lg">â¬‡ï¸</button>`:''}
              ${hasFullDownload?`<button onclick="deleteCollection('${collName}')" class="text-red-400 p-1">ðŸ—‘ï¸</button>`:''}
              ${hasPack&&!hasFullDownload?`<button onclick="removeScripturePack('${packId}')" class="text-red-400 p-1">ðŸ—‘ï¸</button>`:''}
            </div>`;
          });

          // Torah & Tanakh and Quran (can have full downloads)
          ['Torah & Tanakh','Quran'].forEach(collName=>{
            const collData=COLLECTIONS[collName];
            if(!collData)return;
            const packId=collData.packId;
            const hasFullDownload=localStorage.getItem(COLLECTION_STORAGE_KEYS[collName]);
            const hasPack=packId&&isPackDownloaded(packId);
            if(!hasFullDownload&&!hasPack)return;
            const count=collectionStats[collName]||0;
            const practiced=practicedCounts[collName]||0;
            const pack=packId?SCRIPTURE_PACKS[packId]:null;
            const icon=pack?pack.icon:'ðŸ“–';
            const canDownloadFull=COLLECTION_URLS[collName]&&!hasFullDownload;
            content+=`<div class="w-full bg-purple-50 rounded-xl p-3 mb-2 flex items-center gap-2">
              <button onclick="libraryView.collection='${collName.replace(/'/g,"\\'")}';render()" class="flex-1 text-left">
                <p class="font-semibold text-purple-800">${icon} ${collName}</p>
                <p class="text-xs text-purple-600"><span class="text-green-600">${practiced} practiced</span> / ${count} verses</p>
              </button>
              ${canDownloadFull?`<button onclick="downloadCollection('${collName}')" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs px-2 py-1 rounded-lg">â¬‡ï¸</button>`:''}
              ${hasFullDownload?`<button onclick="deleteCollection('${collName}')" class="text-red-400 p-1">ðŸ—‘ï¸</button>`:''}
              ${hasPack&&!hasFullDownload?`<button onclick="removeScripturePack('${packId}')" class="text-red-400 p-1">ðŸ—‘ï¸</button>`:''}
            </div>`;
          });

          // Other downloaded packs (no full download available)
          ['jewish-wisdom','hadith','buddhist-sutras','bhagavad-gita','hindu-wisdom','guru-granth','catholic-prayers','christian-classics','articles-of-faith','lds-quotes','inspirational-quotes'].forEach(packId=>{
            if(!isPackDownloaded(packId))return;
            const pack=SCRIPTURE_PACKS[packId];
            if(!pack)return;
            const collName=Object.keys(COLLECTIONS).find(c=>COLLECTIONS[c].packId===packId);
            if(!collName)return;
            const count=collectionStats[collName]||0;
            const practiced=practicedCounts[collName]||0;
            content+=`<div class="w-full bg-purple-50 rounded-xl p-3 mb-2 flex items-center gap-2">
              <button onclick="libraryView.collection='${collName.replace(/'/g,"\\'")}';render()" class="flex-1 text-left">
                <p class="font-semibold text-purple-800">${pack.icon} ${collName}</p>
                <p class="text-xs text-purple-600"><span class="text-green-600">${practiced} practiced</span> / ${count} verses</p>
              </button>
              <button onclick="removeScripturePack('${packId}')" class="text-red-400 p-1">ðŸ—‘ï¸</button>
            </div>`;
          });

          // Get More section - LDS
          const fullLibraryLDS=['Book of Mormon','Doctrine and Covenants','Pearl of Great Price'];
          const availableFullLDS=fullLibraryLDS.filter(c=>!localStorage.getItem(COLLECTION_STORAGE_KEYS[c])&&!isPackDownloaded(COLLECTIONS[c]?.packId));
          if(availableFullLDS.length>0){
            content+=`<p class="text-purple-600 text-xs font-bold mb-2 mt-4">âœ¨ LDS Scriptures</p>`;
            availableFullLDS.forEach(collName=>{
              const pack=SCRIPTURE_PACKS[COLLECTIONS[collName]?.packId];
              const icon=pack?pack.icon:'ðŸ“˜';
              content+=`<div class="w-full bg-purple-50/50 rounded-xl p-3 mb-2 border border-dashed border-purple-300 flex items-center gap-2">
                <p class="flex-1 font-semibold text-purple-800">${icon} ${collName}</p>
                <button onclick="downloadCollection('${collName}')" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs px-2 py-1 rounded-lg">â¬‡ï¸</button>
              </div>`;
            });
          }

          // Full library downloads - Torah & Quran
          const fullLibraryOther=[{name:'Torah & Tanakh',icon:'âœ¡ï¸',desc:'Complete Hebrew Bible'},{name:'Quran',icon:'â˜ªï¸',desc:'Complete Quran'}];
          const availableFullOther=fullLibraryOther.filter(c=>!localStorage.getItem(COLLECTION_STORAGE_KEYS[c.name])&&!isPackDownloaded(COLLECTIONS[c.name]?.packId));
          if(availableFullOther.length>0){
            content+=`<p class="text-purple-600 text-xs font-bold mb-2 mt-4">âœ¨ Full Scripture Libraries</p>`;
            availableFullOther.forEach(coll=>{
              content+=`<div class="w-full bg-purple-50/50 rounded-xl p-3 mb-2 border border-dashed border-purple-300 flex items-center gap-2">
                <div class="flex-1"><p class="font-semibold text-purple-800">${coll.icon} ${coll.name}</p><p class="text-purple-400 text-[10px]">${coll.desc}</p></div>
                <button onclick="downloadCollection('${coll.name}')" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs px-2 py-1 rounded-lg">â¬‡ï¸</button>
              </div>`;
            });
          }

          // Curated packs (no full download)
          const categories={'LDS':['articles-of-faith','lds-quotes'],'Judaism':['jewish-wisdom'],'Islam':['hadith'],'Buddhism':['buddhist-sutras'],'Hinduism':['bhagavad-gita','hindu-wisdom'],'Sikhism':['guru-granth'],'Christian':['catholic-prayers','christian-classics']};
          let hasMore=false;
          for(const [cat,ids] of Object.entries(categories)){
            const available=ids.filter(id=>!isPackDownloaded(id)&&SCRIPTURE_PACKS[id]);
            if(available.length>0){
              if(!hasMore){content+=`<p class="text-purple-600 text-xs font-bold mb-2 mt-4">âœ¨ Curated Verses</p>`;hasMore=true;}
              content+=`<p class="text-purple-400 text-[10px] mb-1">${cat}:</p>`;
              available.forEach(id=>{
                const pack=SCRIPTURE_PACKS[id];
                content+=`<div class="w-full bg-purple-50/50 rounded-xl p-2 mb-1 border border-dashed border-purple-300 flex items-center gap-2">
                  <p class="flex-1 text-purple-800 text-sm">${pack.icon} ${pack.name}</p>
                  <button onclick="downloadScripturePack('${id}')" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs px-2 py-1 rounded-lg">+ Add</button>
                </div>`;
              });
            }
          }

          modalContent=content;
        }else if(!libraryView.book){
          const collectionData=COLLECTIONS[libraryView.collection];
          const collectionBooks=collectionData.books;
          const isSpecialCollection=collectionData.isSpecial;

          if(isSpecialCollection){
            // For special collections, show verses directly in modal
            const collectionVerses=library.filter(v=>collectionBooks.includes(v.book)).sort((a,b)=>a.verse-b.verse);
            modalContent=`<button onclick="libraryView={collection:null,book:null,chapter:null};render()" class="text-purple-600 text-sm mb-3">â† Back to collections</button>
              <p class="text-purple-600 text-xs mb-2">${libraryView.collection==='Articles of Faith'?'The 13 Articles of Faith':'LDS Leader quotes'}:</p>` +
              collectionVerses.map(v=>{
                const alreadyAdded=userVerseRefs.includes(v.ref);
                return`<div class="bg-purple-50 rounded-xl p-3 mb-2">
                  <div class="flex justify-between items-start mb-1">
                    <p class="font-semibold text-purple-800 text-sm">${v.ref}</p>
                    ${alreadyAdded?`<span class="text-xs text-green-600">âœ“ Added</span>`:`<button onclick="addLibraryVerseByRef('${v.ref.replace(/'/g,"\\'")}',${JSON.stringify(v).replace(/"/g,'&quot;')});closeModal()" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs px-2 py-1 rounded-full">+ Add</button>`}
                  </div>
                  <p class="text-purple-700 text-xs">${v.text.length>300?v.text.substring(0,300)+'...':v.text}</p>
                  ${v.speaker?`<p class="text-purple-400 text-xs mt-1 italic">â€” ${v.speaker}</p>`:''}
                </div>`;
              }).join('');
          }else{
            // Normal book list for non-special collections
            const bookGroups={};
            library.forEach(v=>{if(collectionBooks.includes(v.book)){if(!bookGroups[v.book])bookGroups[v.book]={name:v.book,count:0};bookGroups[v.book].count++;}});
            const books=Object.values(bookGroups).sort((a,b)=>getBookOrder(a.name)-getBookOrder(b.name));
            modalContent=`<button onclick="libraryView={collection:null,book:null,chapter:null};render()" class="text-purple-600 text-sm mb-3">â† Back to collections</button>` +
              books.map(b=>`<button onclick="libraryView.book='${b.name.replace(/'/g,"\\'")}';render()" class="w-full bg-purple-50 rounded-xl p-3 mb-2 text-left hover:bg-purple-100">
                <p class="font-semibold text-purple-800">${b.name}</p>
                <p class="text-xs text-purple-600">${b.count} verses</p>
              </button>`).join('');
          }
        }else if(!libraryView.chapter){
          const bookVerses=library.filter(v=>v.book===libraryView.book);
          const chapterGroups={};
          bookVerses.forEach(v=>{const ch=v.chapter||1;if(!chapterGroups[ch])chapterGroups[ch]={chapter:ch,count:0};chapterGroups[ch].count++;});
          const chapters=Object.values(chapterGroups).sort((a,b)=>a.chapter-b.chapter);
          modalContent=`<button onclick="libraryView.book=null;render()" class="text-purple-600 text-sm mb-3">â† Back to books</button><div class="grid grid-cols-4 gap-2">` +
            chapters.map(ch=>`<button onclick="libraryView.chapter=${ch.chapter};render()" class="bg-purple-50 rounded-xl p-2 text-center hover:bg-purple-100">
              <p class="font-bold text-purple-800">${ch.chapter}</p>
              <p class="text-xs text-purple-600">${ch.count}v</p>
            </button>`).join('')+'</div>';
        }else{
          const chapterVerses=library.filter(v=>v.book===libraryView.book&&v.chapter===libraryView.chapter).sort((a,b)=>a.verse-b.verse);
          modalContent=`<button onclick="libraryView.chapter=null;render()" class="text-purple-600 text-sm mb-3">â† Back to chapters</button>` +
            chapterVerses.map(v=>{
              const alreadyAdded=userVerseRefs.includes(v.ref);
              return`<div class="bg-purple-50 rounded-xl p-3 mb-2">
                <div class="flex justify-between items-start mb-1">
                  <p class="font-semibold text-purple-800 text-sm">${v.ref}</p>
                  ${alreadyAdded?`<span class="text-xs text-green-600 font-semibold">âœ“ Added</span>`:`<button onclick="addLibraryVerseByRef('${v.ref.replace(/'/g,"\\'")}',${JSON.stringify(v).replace(/"/g,'&quot;')});closeModal()" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs font-bold px-2 py-1 rounded-full">+ Add</button>`}
                </div>
                <p class="text-purple-700 text-xs">${v.text}</p>
              </div>`;
            }).join('');
        }
      }else{
        // Custom form (original add/edit form)
        modalContent=`
          ${isAdd?`<div class="flex gap-2 mb-3">
            <button onclick="form.type='scripture';render()" class="flex-1 py-2 rounded-xl text-sm font-semibold ${form.type==='scripture'?'bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white':'bg-purple-100 text-purple-600'}">Scripture</button>
            <button onclick="form.type='quote';render()" class="flex-1 py-2 rounded-xl text-sm font-semibold ${form.type==='quote'?'bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white':'bg-purple-100 text-purple-600'}">Quote</button>
          </div>`:''}
          <input value="${form.ref}" oninput="form.ref=this.value" placeholder="${form.type==='scripture'?'Reference (Alma 32:21)':'Author'}" class="w-full border border-purple-200 rounded-xl px-4 py-2 mb-3 text-sm">
          <textarea oninput="form.text=this.value" placeholder="Text..." class="w-full border border-purple-200 rounded-xl px-4 py-2 mb-3 h-24 text-sm">${form.text}</textarea>
          <p class="text-xs text-purple-500 mb-2">Tags (up to 3):</p>
          <div class="flex flex-wrap gap-1 mb-4">${TAGS.map(t=>`<button onclick="toggleTag('${t}')" class="text-xs px-2 py-1 rounded-full ${form.tags.includes(t)?'bg-violet-500 text-white':'bg-purple-100 text-purple-600'}">${t}</button>`).join('')}</div>
          ${isAdd?`<div class="mb-4">
            <p class="text-xs text-purple-500 mb-2">Add to:</p>
            <div class="flex gap-2">
              <button onclick="form.startPracticing=true;render()" class="flex-1 py-2 px-3 rounded-xl text-sm font-medium ${form.startPracticing?'bg-green-100 text-green-700 ring-2 ring-green-400':'bg-gray-100 text-gray-600'}">
                Practice now
              </button>
              <button onclick="form.startPracticing=false;render()" class="flex-1 py-2 px-3 rounded-xl text-sm font-medium ${!form.startPracticing?'bg-amber-100 text-amber-700 ring-2 ring-amber-400':'bg-gray-100 text-gray-600'}">
                Store for later
              </button>
            </div>
          </div>`:''}
          <div class="flex gap-2">
            ${isEdit?`<button onclick="deleteVerse(${editV?.id})" class="flex-1 py-3 rounded-xl bg-red-100 text-red-600 font-semibold">Delete</button>`:''}
            <button onclick="saveVerse()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-semibold">${isEdit?'Save':'Add'}</button>
          </div>
        `;
      }

      h+=`<div class="fixed inset-0 bg-black/50 z-50 flex items-end" onclick="if(event.target===this)closeModal()">
        <div class="bg-white rounded-t-3xl w-full p-5 max-h-[80vh] overflow-y-auto">
          <div class="flex justify-between mb-4">
            <h2 class="text-lg font-bold text-purple-800">${isEdit?'Edit':'Add'} Verse</h2>
            <button onclick="closeModal()" class="text-2xl text-purple-400">&times;</button>
          </div>
          ${isAdd?`<div class="flex gap-2 mb-4">
            <button onclick="addTab='library';render()" class="flex-1 py-2 rounded-xl text-sm font-semibold ${addTab==='library'?'bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white':'bg-purple-100 text-purple-600'}">Browse Library</button>
            <button onclick="addTab='custom';render()" class="flex-1 py-2 rounded-xl text-sm font-semibold ${addTab==='custom'?'bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white':'bg-purple-100 text-purple-600'}">Custom</button>
          </div>`:''}
          ${modalContent}
        </div></div>`;
    }
  }

  // Food detail popup
  if(foodPopup){
    const food=FOODS[foodPopup.foodIdx];
    const maxQty=Math.floor(S.xp/food.cost);
    const totalCost=food.cost*foodPopup.qty;
    const canBuy=S.xp>=totalCost&&maxQty>=1;
    const pref=getScribbyFoodPreference(food);

    // Build effects list
    const effects=[];
    if(food.happiness>0)effects.push({icon:'ðŸ˜Š',text:`+${food.happiness} Happiness`,color:'text-green-600',type:'positive'});
    if(food.happiness<0)effects.push({icon:'ðŸ˜¢',text:`${food.happiness} Happiness`,color:'text-red-600',type:'negative'});
    if(food.health>0)effects.push({icon:'â¤ï¸',text:`+${food.health} Health`,color:'text-green-600',type:'positive'});
    if(food.health<0)effects.push({icon:'ðŸ’”',text:`${food.health} Health`,color:'text-red-600',type:'negative'});
    if(food.happinessPenalty)effects.push({icon:'ðŸ˜¤',text:`-${food.happinessPenalty} if rejected`,color:'text-orange-600',type:'warning'});

    h+=`<div class="fixed inset-0 bg-black/70 z-[90] flex items-center justify-center p-4" onclick="if(event.target===this)closeFoodPopup()">
      <div class="bg-white rounded-3xl p-5 max-w-sm w-full animate-bounce-in">
        <div class="flex justify-between items-start mb-3">
          <div class="flex items-center gap-3">
            <div class="text-5xl">${food.emoji}</div>
            <div>
              <h2 class="text-xl font-bold text-purple-800">${food.name}</h2>
              <p class="text-purple-600 text-sm">${food.cost} XP each</p>
            </div>
          </div>
          <button onclick="closeFoodPopup()" class="text-2xl text-purple-400">&times;</button>
        </div>

        <!-- Scribby Preference -->
        <div class="bg-purple-50 rounded-xl p-3 mb-4">
          <div class="flex items-center gap-2">
            <span class="text-2xl">${pref.icon}</span>
            <span class="${pref.color} text-sm font-medium">${pref.text}</span>
          </div>
        </div>

        <!-- Effects -->
        <div class="mb-4">
          <p class="text-xs text-purple-500 font-semibold mb-2">EFFECTS:</p>
          <div class="grid grid-cols-2 gap-2">
            ${effects.map(e=>`
              <div class="flex items-center gap-2 ${e.type==='negative'||e.type==='warning'?'bg-red-50':'bg-green-50'} rounded-lg p-2">
                <span class="text-lg">${e.icon}</span>
                <span class="text-xs ${e.color} font-medium">${e.text}</span>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Quantity Picker -->
        <div class="bg-purple-50 rounded-xl p-4 mb-4">
          <p class="text-xs text-purple-500 font-semibold mb-2">QUANTITY:</p>
          <div class="flex items-center justify-center gap-4">
            <button id="foodPopupMinus" onclick="setFoodQty(foodPopup.qty-1)" class="w-10 h-10 rounded-full bg-purple-200 text-purple-800 font-bold text-xl" ${foodPopup.qty<=1?'disabled':''}>-</button>
            <div class="text-center">
              <p id="foodPopupQty" class="text-3xl font-bold text-purple-800">${foodPopup.qty}</p>
              <p class="text-xs text-purple-500">Max: ${maxQty}</p>
            </div>
            <button id="foodPopupPlus" onclick="setFoodQty(foodPopup.qty+1)" class="w-10 h-10 rounded-full bg-purple-200 text-purple-800 font-bold text-xl" ${foodPopup.qty>=maxQty?'disabled':''}>+</button>
          </div>
          <div class="flex justify-center gap-2 mt-2">
            <button onclick="setFoodQty(5)" class="px-3 py-1 rounded-full bg-purple-200 text-purple-700 text-xs font-semibold">5</button>
            <button onclick="setFoodQty(10)" class="px-3 py-1 rounded-full bg-purple-200 text-purple-700 text-xs font-semibold">10</button>
            <button onclick="setFoodQty(${maxQty})" class="px-3 py-1 rounded-full bg-purple-200 text-purple-700 text-xs font-semibold">Max</button>
          </div>
        </div>

        <!-- Buy Button -->
        <button id="foodPopupBuyBtn" onclick="buyFoodQty()" class="w-full py-4 rounded-2xl ${canBuy?'bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white':'bg-gray-200 text-gray-500'} font-bold text-lg" ${!canBuy?'disabled':''}>
          <span id="foodPopupTotal">Buy ${foodPopup.qty} for ${totalCost} XP</span>
        </button>
        <p class="text-center text-purple-400 text-xs mt-2">Your XP: ${S.xp}</p>
      </div>
    </div>`;
  }

  // Tutorial overlay
  if(tutorialStep>0&&tutorialStep<=TUTORIAL_STEPS.length){
    const step=TUTORIAL_STEPS[tutorialStep-1];
    const isLast=tutorialStep===TUTORIAL_STEPS.length;
    h+=`<div class="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4">
      <div class="bg-white rounded-3xl p-6 max-w-sm w-full text-center animate-bounce-in">
        <div class="text-5xl mb-3">${step.icon}</div>
        <h2 class="text-xl font-bold text-purple-800 mb-2">${step.title}</h2>
        <p class="text-purple-600 text-sm mb-6">${step.text}</p>
        <div class="flex gap-3">
          ${!isLast?`<button onclick="skipTutorial()" class="flex-1 py-3 rounded-xl bg-purple-100 text-purple-600 font-semibold">Skip</button>`:''}
          <button onclick="nextTutorial()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-semibold">${isLast?'Start Playing!':'Next â†’'}</button>
        </div>
        <div class="flex justify-center gap-1 mt-4">
          ${TUTORIAL_STEPS.map((s,i)=>`<div class="w-2 h-2 rounded-full ${i<tutorialStep?'bg-purple-500':'bg-purple-200'}"></div>`).join('')}
        </div>
      </div>
    </div>`;
  }

  // Verse management tutorial overlay (shown on practice screen after initial tutorial)
  if(verseTutorialStep>0&&verseTutorialStep<=VERSE_TUTORIAL_STEPS.length&&screen==='practice'){
    const step=VERSE_TUTORIAL_STEPS[verseTutorialStep-1];
    const isLast=verseTutorialStep===VERSE_TUTORIAL_STEPS.length;
    const storedCount=S.verses.filter(v=>v.status==='saved').length;

    h+=`<div class="fixed inset-0 bg-black/60 z-[100] flex items-end justify-center p-4 pb-24">
      <div class="bg-white rounded-3xl p-5 max-w-sm w-full text-center animate-bounce-in shadow-2xl">
        <div class="text-4xl mb-2">${step.icon}</div>
        <h2 class="text-lg font-bold text-purple-800 mb-1">${step.title}</h2>
        <p class="text-purple-600 text-sm mb-4">${step.text}</p>
        ${storedCount>0&&verseTutorialStep===1?`<p class="text-purple-500 text-xs mb-3 bg-purple-50 rounded-lg p-2">You have <b>${storedCount} verses</b> waiting in your Stored section!</p>`:''}
        <div class="flex gap-3">
          ${!isLast?`<button onclick="skipVerseTutorial()" class="flex-1 py-2.5 rounded-xl bg-purple-100 text-purple-600 font-semibold text-sm">Skip</button>`:''}
          <button onclick="nextVerseTutorial()" class="flex-1 py-2.5 rounded-xl bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white font-semibold text-sm">${isLast?'Got it!':'Next â†’'}</button>
        </div>
        <div class="flex justify-center gap-1 mt-3">
          ${VERSE_TUTORIAL_STEPS.map((s,i)=>`<div class="w-1.5 h-1.5 rounded-full ${i<verseTutorialStep?'bg-purple-500':'bg-purple-200'}"></div>`).join('')}
        </div>
      </div>
    </div>`;
  }

  $.innerHTML=h;

  // Auto-advance burst phase after animation
  if(pState.evolving&&pState.evolvePhase==='burst'){
    setTimeout(()=>{pState.evolvePhase='reveal';render()},1500);
  }

  setTimeout(()=>{
    const i=document.getElementById('inp');
    if(i)i.focus();
    // Restore focus and cursor position for library search
    if(activeInputId){
      const searchInput=document.getElementById(activeInputId);
      if(searchInput){
        searchInput.focus();
        if(cursorPos!==null){
          searchInput.setSelectionRange(cursorPos,cursorPos);
        }
      }
      activeInputId=null;
      cursorPos=null;
    }
  },10);
}

// Clean up old library storage format (if it exists)
try{
  if(localStorage.getItem('fullLibrary')){
    console.log('Removing old fullLibrary format to free up space');
    localStorage.removeItem('fullLibrary');
  }
}catch(e){
  console.error('Failed to clean old library:',e);
}

// Load all downloaded collections from localStorage
LIBRARY.downloaded=loadDownloadedCollections();

// Global drag event listeners for accessory positioning
document.addEventListener('touchmove',onDrag,{passive:false});
document.addEventListener('mousemove',onDrag);
document.addEventListener('touchend',endDrag);
document.addEventListener('mouseup',endDrag);

// Creature preview modal
function showCreaturePreview(stage,categoryKey,variantIdx=0){
  const category=CREATURE_CATEGORIES[categoryKey];
  const categoryName=categoryKey.charAt(0).toUpperCase()+categoryKey.slice(1);
  let creatureHTML='';
  let stageName='';
  let creatureName='';

  if(stage==='egg'){
    stageName='Egg Stage';
    creatureName='Egg';
    creatureHTML=renderEgg(categoryKey);
  }else if(stage==='blob'){
    stageName='Blob Stage';
    creatureName='Blob';
    creatureHTML=category.blobEmoji==='blob'?renderBlob(categoryKey):`<div style="font-size:10rem;line-height:1;">${category.blobEmoji}</div>`;
  }else if(stage==='baby'){
    stageName='Baby Stage';
    creatureName=`${categoryName} Baby`;
    creatureHTML=category.babyEmoji==='baby'?renderBaby(categoryKey):`<div style="font-size:10rem;line-height:1;">${category.babyEmoji}</div>`;
  }else if(stage==='teen'){
    stageName='Teen Stage';
    creatureName=category.teenNames[variantIdx];
    creatureHTML=renderTeen(categoryKey,variantIdx);
  }else if(stage==='adult'){
    stageName='Adult Stage';
    creatureName=category.adultNames[variantIdx];
    if(categoryKey==='birds'){
      creatureHTML=renderAdultBird(variantIdx);
    }else if(categoryKey==='reptiles'){
      creatureHTML=renderAdultReptile(variantIdx);
    }else if(categoryKey==='mammals'){
      creatureHTML=renderAdultMammal(variantIdx);
    }else if(categoryKey==='mystical'){
      creatureHTML=renderAdultMystical(variantIdx);
    }else if(categoryKey==='prehistoric'){
      creatureHTML=renderAdultPrehistoric(variantIdx);
    }else if(categoryKey==='aquatic'){
      creatureHTML=renderAdultAquatic(variantIdx);
    }else if(categoryKey==='alien'){
      creatureHTML=renderAdultAlien(variantIdx);
    }else if(categoryKey==='insects'){
      creatureHTML=renderAdultInsect(variantIdx);
    }else{
      creatureHTML=`<div style="font-size:10rem;line-height:1;">${category.adultVariants[variantIdx]}</div>`;
    }
  }

  // Get theme and rarity info
  const theme=CATEGORY_CARD_THEMES[categoryKey]||CATEGORY_CARD_THEMES.mammals;
  const rarity=stage==='adult'&&category.adultRarities?category.adultRarities[variantIdx]:'Common';
  const rarityFrame=RARITY_FRAMES[rarity]||RARITY_FRAMES['Common'];

  // Generate frame border style
  const frameBorder=rarityFrame.rainbow?
    `background:${rarityFrame.border};padding:4px;`:`border:4px solid ${rarityFrame.border};`;
  const frameGlow=rarityFrame.glow!=='none'?`box-shadow:${rarityFrame.glow};`:'';
  const shineEffect=rarityFrame.shine?`<div style="position:absolute;top:0;left:-100%;width:50%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:card-shine 3s ease-in-out infinite;pointer-events:none;z-index:50;"></div>`:'';
  const raritySparkles=generateRaritySparkles(rarityFrame.sparkles);
  const categoryParticles=generateCardParticles(theme.particles,6);

  // Dev rarity editor for adult stage
  const isDev=isDevUser();
  let rarityHTML='';
  if(stage==='adult'&&category.adultRarities){
    if(isDev){
      const rarityOptions=Object.keys(RARITY_WEIGHTS).map(r=>
        `<option value="${r}" ${r===rarity?'selected':''} class="text-gray-800">${r}</option>`
      ).join('');
      rarityHTML=`<select onchange="updateCreatureRarity('${categoryKey}',${variantIdx},this.value)"
        class="px-2 py-0.5 rounded text-xs bg-gradient-to-r ${RARITY_COLORS[rarity]} text-white border-none cursor-pointer shadow-lg">
        ${rarityOptions}
      </select>`;
    }else{
      rarityHTML=`<span class="text-xs font-bold px-2 py-0.5 rounded-full bg-gradient-to-r ${RARITY_COLORS[rarity]} text-white shadow-lg">${rarity}</span>`;
    }
  }

  const modal=document.getElementById('creaturePreviewModal');
  const card=document.getElementById('creaturePreviewCard');

  card.innerHTML=`
    <!-- TCG Card Frame -->
    <div class="relative" style="${frameBorder}border-radius:16px;${frameGlow}overflow:hidden;">
      ${shineEffect}
      ${raritySparkles}
      <div style="background:linear-gradient(145deg,#1a1035,#0f0a1f);border-radius:12px;overflow:hidden;">

        <!-- Card Header -->
        <div class="flex justify-between items-center px-3 py-2" style="background:linear-gradient(90deg,${theme.accent}40,transparent);">
          <div>
            <h2 class="text-lg font-black text-white tracking-tight" style="text-shadow:0 2px 4px rgba(0,0,0,0.3);">${creatureName}</h2>
            <p class="text-white/70 text-xs">${stageName}</p>
          </div>
          <div class="flex items-center gap-2">
            ${rarityHTML}
            ${isDev?`<button onclick="toggleCreatureEditMode()" id="editModeBtn" class="bg-blue-500/80 text-white font-bold px-2 h-8 rounded-full flex items-center justify-center text-xs hover:bg-blue-600 transition-colors">Edit</button>`:''}
            <button onclick="closeCreaturePreview()" class="bg-white/20 text-white font-bold w-8 h-8 rounded-full flex items-center justify-center text-sm hover:bg-white/30 transition-colors">Ã—</button>
          </div>
        </div>

        <!-- Edit Mode Controls (hidden by default) -->
        <div id="editModePanel" class="hidden mx-2 mb-2 p-2 bg-black/50 rounded-lg text-white text-xs">
          <p class="font-bold mb-1">Arrows=move | +/-=z | &lt;&gt;=rotate | Shift=10x</p>
          <p id="selectedPartInfo">No part selected</p>
          <div class="flex gap-2 mt-2 flex-wrap">
            <button onclick="toggleCreatureAnimations()" id="animToggleBtn" class="bg-yellow-500 px-2 py-1 rounded text-xs">Stop Anims</button>
            <button onclick="copyCreaturePositions()" class="bg-green-500 px-2 py-1 rounded text-xs">Copy Positions</button>
            <button onclick="resetCreaturePositions()" class="bg-red-500 px-2 py-1 rounded text-xs">Reset</button>
          </div>
        </div>

        <!-- Creature Display -->
        <div class="mx-2 mb-2 rounded-xl overflow-hidden" style="border:4px solid ${theme.accent};">
          <div class="relative flex items-center justify-center py-6" style="min-height:220px;background:${theme.bg};">
            ${categoryParticles}
            <div style="position:absolute;inset:0;background:radial-gradient(ellipse at center,rgba(255,255,255,0.35) 0%,transparent 60%);pointer-events:none;"></div>
            <div id="creatureEditContainer" style="transform:scale(0.85);transform-origin:center;position:relative;z-index:10;">${creatureHTML}</div>
          </div>
        </div>

        <!-- Type Badge -->
        <div class="flex justify-center -mt-3 relative z-10">
          <span style="background:linear-gradient(135deg,${theme.accent},${theme.accent}dd);border:2px solid rgba(255,255,255,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.3);" class="text-white text-xs font-bold px-4 py-1 rounded-full">
            ${categoryName} Scribby
          </span>
        </div>

        <!-- Footer -->
        <p class="text-white/40 text-xs text-center py-3">Tap outside to close</p>
      </div>
    </div>
  `;

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

// Update creature rarity (dev only)
function updateCreatureRarity(categoryKey,variantIdx,newRarity){
  if(!isDevUser())return;
  const category=CREATURE_CATEGORIES[categoryKey];
  if(category&&category.adultRarities){
    category.adultRarities[variantIdx]=newRarity;
    console.log(`Updated ${categoryKey} variant ${variantIdx} to ${newRarity}`);
    // Save to localStorage
    saveCustomRarities();
    // Re-render the preview to update colors
    showCreaturePreview('adult',categoryKey,variantIdx);
  }
}

// Save custom rarities to localStorage
function saveCustomRarities(){
  const rarityData={};
  Object.keys(CREATURE_CATEGORIES).forEach(key=>{
    const cat=CREATURE_CATEGORIES[key];
    if(cat.adultRarities){
      rarityData[key]=cat.adultRarities.slice();
    }
  });
  localStorage.setItem('customRarities',JSON.stringify(rarityData));
  console.log('Custom rarities saved');
}

// Load custom rarities from localStorage
function loadCustomRarities(){
  const saved=localStorage.getItem('customRarities');
  if(saved){
    try{
      const rarityData=JSON.parse(saved);
      Object.keys(rarityData).forEach(key=>{
        if(CREATURE_CATEGORIES[key]&&CREATURE_CATEGORIES[key].adultRarities){
          CREATURE_CATEGORIES[key].adultRarities=rarityData[key];
        }
      });
      console.log('Custom rarities loaded');
    }catch(e){
      console.error('Failed to load custom rarities',e);
    }
  }
}

function closeCreaturePreview(){
  const modal=document.getElementById('creaturePreviewModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
  // Exit edit mode when closing
  if(window.creatureEditMode){
    window.creatureEditMode=false;
    document.removeEventListener('keydown',handleCreatureEditKeys);
  }
}

// Creature Editor State
window.creatureEditMode=false;
window.selectedCreaturePart=null;
window.creaturePositionChanges={};
window.originalPositions={};

function toggleCreatureEditMode(){
  window.creatureEditMode=!window.creatureEditMode;
  const panel=document.getElementById('editModePanel');
  const btn=document.getElementById('editModeBtn');
  const container=document.getElementById('creatureEditContainer');

  if(window.creatureEditMode){
    panel.classList.remove('hidden');
    btn.textContent='Done';
    btn.classList.remove('bg-blue-500/80');
    btn.classList.add('bg-orange-500/80');

    // Make all positioned children clickable
    const parts=container.querySelectorAll('[style*="position:absolute"]');
    parts.forEach((part,idx)=>{
      part.dataset.partIdx=idx;
      part.style.cursor='pointer';
      part.style.outline='none';
      // Store original position
      const style=part.getAttribute('style')||'';
      window.originalPositions[idx]=style;

      part.addEventListener('click',selectCreaturePart);
    });

    document.addEventListener('keydown',handleCreatureEditKeys);
  }else{
    panel.classList.add('hidden');
    btn.textContent='Edit';
    btn.classList.remove('bg-orange-500/80');
    btn.classList.add('bg-blue-500/80');

    // Remove click handlers and outlines
    const parts=container.querySelectorAll('[style*="position:absolute"]');
    parts.forEach(part=>{
      part.style.cursor='';
      part.style.outline='';
      part.removeEventListener('click',selectCreaturePart);
    });

    document.removeEventListener('keydown',handleCreatureEditKeys);
    window.selectedCreaturePart=null;
  }
}

function selectCreaturePart(e){
  e.stopPropagation();

  // Remove outline from previously selected
  if(window.selectedCreaturePart){
    window.selectedCreaturePart.style.outline='';
  }

  // Select new part
  window.selectedCreaturePart=e.currentTarget;
  window.selectedCreaturePart.style.outline='2px solid #00ff00';

  // Show part info
  const style=window.selectedCreaturePart.getAttribute('style')||'';
  const topMatch=style.match(/top:\s*(-?[\d.]+px)/);
  const leftMatch=style.match(/left:\s*(-?[\d.]+px|[\d.]+%)/);
  const rightMatch=style.match(/right:\s*(-?[\d.]+px)/);
  const zMatch=style.match(/z-index:\s*(-?\d+)/);
  const rotMatch=style.match(/rotate\((-?[\d.]+)deg\)/);

  const info=document.getElementById('selectedPartInfo');
  info.innerHTML=`<strong>Part ${window.selectedCreaturePart.dataset.partIdx}</strong> | z: <span class="text-yellow-300">${zMatch?zMatch[1]:'auto'}</span> | rot: <span class="text-cyan-300">${rotMatch?rotMatch[1]+'Â°':'0Â°'}</span><br>
    top: ${topMatch?topMatch[1]:'auto'}, left: ${leftMatch?leftMatch[1]:'auto'}, right: ${rightMatch?rightMatch[1]:'auto'}`;
}

function handleCreatureEditKeys(e){
  if(!window.selectedCreaturePart||!window.creatureEditMode)return;

  const step=e.shiftKey?10:1;
  const style=window.selectedCreaturePart.getAttribute('style')||'';
  let newStyle=style;

  if(e.key==='ArrowUp'){
    e.preventDefault();
    newStyle=adjustPosition(style,'top',-step);
  }else if(e.key==='ArrowDown'){
    e.preventDefault();
    newStyle=adjustPosition(style,'top',step);
  }else if(e.key==='ArrowLeft'){
    e.preventDefault();
    newStyle=adjustPosition(style,'left',-step);
  }else if(e.key==='ArrowRight'){
    e.preventDefault();
    newStyle=adjustPosition(style,'left',step);
  }else if(e.key==='='||e.key==='+'||e.key===']'){
    e.preventDefault();
    newStyle=adjustZIndex(style,step);
  }else if(e.key==='-'||e.key==='_'||e.key==='['){
    e.preventDefault();
    newStyle=adjustZIndex(style,-step);
  }else if(e.key==='.'||e.key==='>'){
    e.preventDefault();
    newStyle=adjustRotation(style,step);
  }else if(e.key===','||e.key==='<'){
    e.preventDefault();
    newStyle=adjustRotation(style,-step);
  }

  if(newStyle!==style){
    window.selectedCreaturePart.setAttribute('style',newStyle);
    window.creaturePositionChanges[window.selectedCreaturePart.dataset.partIdx]=newStyle;
    // Update info display
    selectCreaturePart({currentTarget:window.selectedCreaturePart,stopPropagation:()=>{}});
  }
}

function adjustPosition(style,prop,delta){
  const regex=new RegExp(`${prop}:\\s*(-?[\\d.]+)px`);
  const match=style.match(regex);

  if(match){
    const currentVal=parseFloat(match[1]);
    const newVal=currentVal+delta;
    return style.replace(regex,`${prop}:${newVal}px`);
  }else{
    // Property doesn't exist with px value, try to add it
    return style+`;${prop}:${delta}px`;
  }
}

function adjustZIndex(style,delta){
  const regex=/z-index:\s*(-?\d+)/;
  const match=style.match(regex);

  if(match){
    const currentVal=parseInt(match[1]);
    const newVal=Math.max(0,currentVal+delta);
    return style.replace(regex,`z-index:${newVal}`);
  }else{
    // z-index doesn't exist, add it with default of 10 + delta
    const newVal=Math.max(0,10+delta);
    return style+`;z-index:${newVal}`;
  }
}

function adjustRotation(style,delta){
  const regex=/rotate\((-?[\d.]+)deg\)/;
  const match=style.match(regex);

  if(match){
    const currentVal=parseFloat(match[1]);
    const newVal=currentVal+delta;
    return style.replace(regex,`rotate(${newVal}deg)`);
  }else{
    // No rotate in transform, need to add or modify transform
    const transformRegex=/transform:\s*([^;]+)/;
    const transformMatch=style.match(transformRegex);
    if(transformMatch){
      // Append rotate to existing transform
      return style.replace(transformRegex,`transform:${transformMatch[1]} rotate(${delta}deg)`);
    }else{
      // No transform at all, add one
      return style+`;transform:rotate(${delta}deg)`;
    }
  }
}

function copyCreaturePositions(){
  let output='Position changes:\\n';
  for(const[idx,style]of Object.entries(window.creaturePositionChanges)){
    const topMatch=style.match(/top:\s*(-?[\d.]+px)/);
    const leftMatch=style.match(/left:\s*(-?[\d.]+px|[\d.]+%)/);
    const zMatch=style.match(/z-index:\s*(-?\d+)/);
    output+=`Part ${idx}: top=${topMatch?topMatch[1]:'auto'}, left=${leftMatch?leftMatch[1]:'auto'}, z=${zMatch?zMatch[1]:'auto'}\\n`;
  }

  // Copy full changed styles
  const fullOutput=JSON.stringify(window.creaturePositionChanges,null,2);
  navigator.clipboard.writeText(fullOutput).then(()=>{
    alert('Position changes copied to clipboard!\\n\\n'+output);
  }).catch(()=>{
    console.log(fullOutput);
    alert('Check console for position data');
  });
}

function resetCreaturePositions(){
  const container=document.getElementById('creatureEditContainer');
  for(const[idx,style]of Object.entries(window.originalPositions)){
    const part=container.querySelector(`[data-part-idx="${idx}"]`);
    if(part)part.setAttribute('style',style);
  }
  window.creaturePositionChanges={};
  if(window.selectedCreaturePart){
    window.selectedCreaturePart.style.outline='';
    window.selectedCreaturePart=null;
  }
  document.getElementById('selectedPartInfo').textContent='No part selected (positions reset)';
}

// Toggle creature animations on/off
window.creatureAnimationsPaused=false;
function toggleCreatureAnimations(){
  const container=document.getElementById('creatureEditContainer');
  const btn=document.getElementById('animToggleBtn');
  window.creatureAnimationsPaused=!window.creatureAnimationsPaused;

  if(window.creatureAnimationsPaused){
    // Stop all animations
    container.style.animationPlayState='paused';
    const allElements=container.querySelectorAll('*');
    allElements.forEach(el=>{
      el.style.animationPlayState='paused';
    });
    btn.textContent='Play Anims';
    btn.classList.remove('bg-yellow-500');
    btn.classList.add('bg-purple-500');
  }else{
    // Resume all animations
    container.style.animationPlayState='running';
    const allElements=container.querySelectorAll('*');
    allElements.forEach(el=>{
      el.style.animationPlayState='running';
    });
    btn.textContent='Stop Anims';
    btn.classList.remove('bg-purple-500');
    btn.classList.add('bg-yellow-500');
  }
}

// Scribby info card for collection - Trading Card Style!
function showScribbyCard(categoryKey,variantIdx,buddyId,stage='adult'){
  const buddy=S.graduatedBuddies.find(b=>b.id===buddyId);
  if(!buddy)return;

  const category=CREATURE_CATEGORIES[categoryKey];
  const categoryName=categoryKey.charAt(0).toUpperCase()+categoryKey.slice(1);
  const creatureName=stage==='teen'?category.teenNames[variantIdx]:category.adultNames[variantIdx];

  let creatureHTML='';
  let creatureScale=0.85;

  if(stage==='teen'){
    creatureHTML=renderTeen(categoryKey,variantIdx);
    creatureScale=0.75;
  }else if(categoryKey==='birds'){
    creatureHTML=renderAdultBird(variantIdx);
  }else if(categoryKey==='reptiles'){
    creatureHTML=renderAdultReptile(variantIdx);
  }else if(categoryKey==='mammals'){
    creatureHTML=renderAdultMammal(variantIdx);
  }else if(categoryKey==='mystical'){
    creatureHTML=renderAdultMystical(variantIdx);
  }else if(categoryKey==='prehistoric'){
    creatureHTML=renderAdultPrehistoric(variantIdx);
  }else if(categoryKey==='aquatic'){
    creatureHTML=renderAdultAquatic(variantIdx);
  }else if(categoryKey==='alien'){
    creatureHTML=renderAdultAlien(variantIdx);
  }else if(categoryKey==='insects'){
    creatureHTML=renderAdultInsect(variantIdx);
  }else{
    creatureHTML=`<div style="font-size:8rem;line-height:1;">${category.adultVariants[variantIdx]}</div>`;
  }

  const hatchDate=buddy.hatchDate?new Date(buddy.hatchDate).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'Unknown';
  const gradDate=buddy.graduatedDate?new Date(buddy.graduatedDate).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'Unknown';

  // Get the cute blurb for this creature
  const blurb=getCreatureBlurb(categoryKey,stage,variantIdx);

  // Calculate a "power level" based on stats for fun
  const powerLevel=Math.min(100,Math.round((buddy.happiness||50)*.4+(buddy.health||50)*.4+(buddy.daysRaised||1)*2));

  // Get rarity from the variant's adultRarities (individual creature rarity)
  const rarity=category.adultRarities&&category.adultRarities[variantIdx]?category.adultRarities[variantIdx]:'Common';
  const rarityFrame=RARITY_FRAMES[rarity]||RARITY_FRAMES['Common'];
  const theme=CATEGORY_CARD_THEMES[categoryKey]||CATEGORY_CARD_THEMES.mammals;

  // Generate frame border style
  const frameBorder=rarityFrame.rainbow?
    `background:${rarityFrame.border};padding:4px;`:`border:4px solid ${rarityFrame.border};`;
  const frameGlow=rarityFrame.glow!=='none'?`box-shadow:${rarityFrame.glow};`:'';
  const shineEffect=rarityFrame.shine?`<div style="position:absolute;top:0;left:-100%;width:50%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:card-shine 3s ease-in-out infinite;pointer-events:none;z-index:50;"></div>`:'';
  const raritySparkles=generateRaritySparkles(rarityFrame.sparkles);
  const categoryParticles=generateCardParticles(theme.particles,6);

  const modal=document.getElementById('scribbyCardModal');
  const content=document.getElementById('scribbyCardContent');

  content.innerHTML=`
    <!-- Trading Card Frame with Rarity Border -->
    <div class="relative" style="${frameBorder}border-radius:16px;${frameGlow}overflow:hidden;">
      ${shineEffect}
      ${raritySparkles}
      <div style="background:linear-gradient(145deg,#1a1035,#0f0a1f);border-radius:12px;overflow:hidden;">

        <!-- Card Header with Category Color -->
        <div class="flex justify-between items-center px-3 py-2" style="background:linear-gradient(90deg,${theme.accent}40,transparent);">
          <div>
            <h2 class="text-lg font-black text-white tracking-tight" style="text-shadow:0 2px 4px rgba(0,0,0,0.3);">${buddy.name||creatureName}</h2>
            <p class="text-white/70 text-xs">${creatureName}</p>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs font-bold px-2 py-0.5 rounded-full bg-gradient-to-r ${RARITY_COLORS[rarity]} text-white shadow-lg">${rarity}</span>
            <button onclick="closeScribbyCard()" class="bg-white/20 text-white font-bold w-8 h-8 rounded-full flex items-center justify-center text-sm hover:bg-white/30 transition-colors">Ã—</button>
          </div>
        </div>

        <!-- Creature Display Area with Category Theme -->
        <div class="mx-2 mb-2 rounded-xl overflow-hidden" style="border:4px solid ${theme.accent};">
          <div class="relative flex items-center justify-center py-6" style="min-height:220px;background:${theme.bg};">
            <!-- Category particles -->
            ${categoryParticles}
            <!-- Radial highlight -->
            <div style="position:absolute;inset:0;background:radial-gradient(ellipse at center,rgba(255,255,255,0.35) 0%,transparent 60%);pointer-events:none;"></div>
            <!-- Creature -->
            <div style="transform:scale(${creatureScale});transform-origin:center;position:relative;z-index:10;">${creatureHTML}</div>
          </div>
        </div>

        <!-- Type Badge -->
        <div class="flex justify-center -mt-3 relative z-10">
          <span style="background:linear-gradient(135deg,${theme.accent},${theme.accent}dd);border:2px solid rgba(255,255,255,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.3);" class="text-white text-xs font-bold px-4 py-1 rounded-full">
            ${categoryName} Scribby
          </span>
        </div>

          <!-- Blurb Section -->
          <div class="mx-3 mt-2 mb-2 p-2 rounded-lg" style="background:rgba(255,255,255,0.1);">
            <p class="text-white/90 text-xs italic leading-relaxed">"${blurb}"</p>
          </div>

          <!-- Stats Section - Pokemon Style -->
          <div class="mx-3 mb-2 p-2 rounded-lg" style="background:rgba(0,0,0,0.2);">
            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
              <div class="flex justify-between text-white/80">
                <span>HP</span>
                <span class="font-bold text-red-300">${buddy.health||100}</span>
              </div>
              <div class="flex justify-between text-white/80">
                <span>JOY</span>
                <span class="font-bold text-yellow-300">${buddy.happiness||100}</span>
              </div>
              <div class="flex justify-between text-white/80">
                <span>DAYS</span>
                <span class="font-bold text-cyan-300">${buddy.daysRaised||'?'}</span>
              </div>
              <div class="flex justify-between text-white/80">
                <span>PWR</span>
                <span class="font-bold text-purple-300">${powerLevel}</span>
              </div>
            </div>
          </div>

          <!-- Dates Footer -->
          <div class="mx-3 mb-2 flex justify-between text-[10px] text-white/50">
            <span>Hatched: ${hatchDate}</span>
            <span>Graduated: ${gradDate}</span>
          </div>

          <!-- Card Number / ID -->
          <div class="text-center pb-2">
            <span class="text-[9px] text-white/30 font-mono">#${String(buddyId).padStart(4,'0')} â€¢ SCRIBBIES</span>
          </div>

        </div>
      </div>
    </div>

    <!-- Action Buttons Below Card -->
    ${stage!=='teen'?`
    <button onclick="showTradeTerms(${buddy.id})" class="w-full mt-3 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-bold py-2.5 rounded-xl flex items-center justify-center gap-2 shadow-lg">
      <span>ðŸŽ</span>
      <span>Share This Scribby</span>
    </button>
    `:`
    <div class="w-full mt-3 bg-white/10 text-white/50 font-semibold py-2.5 rounded-xl text-center text-sm">
      Only adult Scribbies can be traded
    </div>
    `}
    <p class="text-white/40 text-xs text-center mt-2">Tap outside to close</p>
  `;

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function closeScribbyCard(){
  const modal=document.getElementById('scribbyCardModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

// Show info card for blob/baby stages (shared across all variants in a category) - Trading Card Style!
function showCollectionStageCard(stage,categoryKey){
  const category=CREATURE_CATEGORIES[categoryKey];
  const categoryName=categoryKey.charAt(0).toUpperCase()+categoryKey.slice(1);

  let creatureHTML='';
  let stageName='';
  let creatureScale=1.0;

  if(stage==='blob'){
    creatureHTML=renderBlob(categoryKey);
    stageName=`${categoryName} Blob`;
    creatureScale=1.1;
  }else if(stage==='baby'){
    creatureHTML=renderBaby(categoryKey);
    stageName=`${categoryName} Baby`;
    creatureScale=0.9;
  }

  // Get the cute blurb for this stage
  const blurb=getCreatureBlurb(categoryKey,stage==='baby'?'baby':'blob',0);

  // Stage evolution info
  const stageInfo={
    blob:{level:1,xpNeeded:75,nextStage:'Baby'},
    baby:{level:2,xpNeeded:100,nextStage:'Teen'}
  };
  const info=stageInfo[stage]||stageInfo.blob;

  const modal=document.getElementById('scribbyCardModal');
  const content=document.getElementById('scribbyCardContent');

  content.innerHTML=`
    <!-- Trading Card Frame -->
    <div class="relative" style="background:linear-gradient(145deg,#1e3a5f,#0f2744);border-radius:16px;padding:4px;">
      <div style="background:linear-gradient(145deg,#e0f4ff,#c7e8ff);border-radius:14px;padding:3px;">
        <div style="background:linear-gradient(180deg,#3b82f6,#2563eb);border-radius:12px;overflow:hidden;">

          <!-- Card Header -->
          <div class="flex justify-between items-center px-3 py-2" style="background:linear-gradient(90deg,rgba(255,255,255,0.1),transparent);">
            <div>
              <h2 class="text-lg font-black text-white tracking-tight">${stageName}</h2>
              <p class="text-white/70 text-xs">Stage ${info.level} Evolution</p>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs font-bold px-2 py-0.5 rounded-full bg-gradient-to-r from-cyan-400 to-blue-500 text-white">Lv.${info.level}</span>
              <button onclick="closeScribbyCard()" class="bg-white/20 text-white font-bold w-8 h-8 rounded-full flex items-center justify-center text-sm hover:bg-white/30">Ã—</button>
            </div>
          </div>

          <!-- Creature Display Area -->
          <div class="mx-2 rounded-xl overflow-hidden" style="background:linear-gradient(180deg,#60a5fa,#3b82f6);border:3px solid #93c5fd;">
            <div class="relative flex items-center justify-center py-6" style="min-height:150px;background:radial-gradient(ellipse at center,rgba(255,255,255,0.3) 0%,transparent 70%);">
              <div style="transform:scale(${creatureScale});transform-origin:center;">${creatureHTML}</div>
              <!-- Sparkle effects -->
              <div class="absolute top-3 left-4 text-cyan-300 text-sm animate-pulse">âœ¨</div>
              <div class="absolute bottom-4 right-5 text-blue-200 text-sm animate-pulse" style="animation-delay:0.5s;">âœ¨</div>
            </div>
          </div>

          <!-- Type Badge -->
          <div class="flex justify-center -mt-3 relative z-10">
            <span class="bg-gradient-to-r from-cyan-400 to-blue-500 text-white text-xs font-bold px-4 py-1 rounded-full border-2 border-cyan-300 shadow-lg">
              ${categoryName} Type
            </span>
          </div>

          <!-- Blurb Section -->
          <div class="mx-3 mt-2 mb-2 p-3 rounded-lg" style="background:rgba(255,255,255,0.1);">
            <p class="text-white/90 text-xs italic leading-relaxed">"${blurb}"</p>
          </div>

          <!-- Evolution Info -->
          <div class="mx-3 mb-2 p-2 rounded-lg" style="background:rgba(0,0,0,0.2);">
            <div class="flex items-center justify-between text-xs text-white/80">
              <span>Next Evolution:</span>
              <span class="font-bold text-cyan-300">${info.nextStage} (${info.xpNeeded} XP)</span>
            </div>
          </div>

          <!-- Card Footer -->
          <div class="text-center pb-2">
            <span class="text-[9px] text-white/30 font-mono">STAGE ${info.level} â€¢ SCRIBBIES</span>
          </div>

        </div>
      </div>
    </div>

    <p class="text-white/40 text-xs text-center mt-3">Tap outside to close</p>
  `;

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

// Debug: Add a test graduated Scribby for testing trades
function addTestScribby(){
  const randomCat=FULLY_DESIGNED_CATEGORIES[Math.floor(Math.random()*FULLY_DESIGNED_CATEGORIES.length)];
  const category=CREATURE_CATEGORIES[randomCat];
  const variants=category.adultVariants.length;
  const randomVariant=Math.floor(Math.random()*variants);
  const adultName=category.adultNames[randomVariant]||'Scribby';

  const testBuddy={
    id:Date.now(),
    name:adultName,
    creatureCategory:randomCat,
    creatureVariant:randomVariant,
    creatureName:adultName,
    graduatedAt:Date.now(),
    finalHappiness:100,
    versesLearned:5,
    totalXpEarned:500,
    daysSpent:7,
    traits:['Friendly','Curious']
  };

  S.graduatedBuddies.push(testBuddy);
  save();

  // Also save to cloud if signed in
  if(window.currentUser && window.cloudFunctions){
    window.cloudFunctions.saveGraduatedBuddy(testBuddy);
  }

  alert(`Added ${adultName} to your collection!`);
  render();
}

// Debug: Add random food item to inventory
function addTestFood(){
  // Food items are indexes 48-57 in ACCESSORIES (type:'food')
  const foodIndexes=ACCESSORIES.map((a,i)=>a.type==='food'?i:null).filter(i=>i!==null);
  const randomFood=foodIndexes[Math.floor(Math.random()*foodIndexes.length)];
  const food=ACCESSORIES[randomFood];
  if(!S.inventory)S.inventory=[];
  S.inventory.push(randomFood);
  save();
  alert(`Added ${food.emoji} ${food.name} to your inventory!`);
  render();
}

// Debug: Add random clothing/wearable item to inventory
function addTestClothing(){
  // Wearables are hat, eyes, held, back, effect types
  const clothingIndexes=ACCESSORIES.map((a,i)=>['hat','eyes','held','back','effect'].includes(a.type)?i:null).filter(i=>i!==null);
  const randomClothing=clothingIndexes[Math.floor(Math.random()*clothingIndexes.length)];
  const clothing=ACCESSORIES[randomClothing];
  if(!S.inventory)S.inventory=[];
  S.inventory.push(randomClothing);
  save();
  alert(`Added ${clothing.emoji} ${clothing.name} to your wardrobe!`);
  render();
}

// Debug: Add random furniture/room item to inventory
function addTestFurniture(){
  // Room items are type:'room'
  const furnitureIndexes=ACCESSORIES.map((a,i)=>a.type==='room'?i:null).filter(i=>i!==null);
  const randomFurniture=furnitureIndexes[Math.floor(Math.random()*furnitureIndexes.length)];
  const furniture=ACCESSORIES[randomFurniture];
  if(!S.inventory)S.inventory=[];
  S.inventory.push(randomFurniture);
  save();
  alert(`Added ${furniture.emoji} ${furniture.name} to your room items!`);
  render();
}

// Debug: Add coins
function addTestCoins(){
  S.coins=(S.coins||0)+500;
  save();
  alert('Added 500 coins!');
  render();
}

// Debug: Preview evolution screens
let evoPreviewState={active:false,category:'birds',fromStage:'egg',toStage:'blob',phase:'collect'};
function showEvolutionPreview(){
  // Open a modal to select which evolution to preview
  const modal=document.getElementById('scribbyCardModal');
  const content=document.getElementById('scribbyCardContent');

  const evolutions=[
    {from:'egg',to:'blob',label:'Egg â†’ Blob (Hatching)'},
    {from:'blob',to:'child',label:'Blob â†’ Baby'},
    {from:'child',to:'teen',label:'Baby â†’ Teen'},
    {from:'teen',to:'adult',label:'Teen â†’ Adult'}
  ];

  content.innerHTML=`
    <div class="bg-gradient-to-br from-purple-600 via-pink-600 to-violet-700 rounded-2xl p-5">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-white">ðŸŽ‰ Evolution Preview</h2>
        <button onclick="closeScribbyCard()" class="bg-white/20 text-white font-bold w-8 h-8 rounded-full">Ã—</button>
      </div>
      <p class="text-white/80 text-sm mb-4">Select a category and evolution to preview:</p>

      <div class="mb-4">
        <label class="text-white/70 text-xs mb-1 block">Category:</label>
        <select id="evo-category" class="w-full p-2 rounded-lg bg-white/20 text-white border border-white/30">
          ${FULLY_DESIGNED_CATEGORIES.map(c=>`<option value="${c}" class="text-gray-800">${c.charAt(0).toUpperCase()+c.slice(1)}</option>`).join('')}
        </select>
      </div>

      <div class="space-y-2 mb-4">
        ${evolutions.map((e,i)=>`
          <button onclick="triggerEvolutionPreview('${e.from}','${e.to}')" class="w-full bg-white/10 hover:bg-white/20 text-white font-semibold py-3 rounded-xl flex items-center justify-between px-4 transition-colors">
            <span>${e.label}</span>
            <span class="text-white/50">â†’</span>
          </button>
        `).join('')}
      </div>

      <p class="text-white/50 text-xs text-center">Click an evolution to see the celebration!</p>
    </div>
  `;

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function triggerEvolutionPreview(fromStage,toStage){
  // Get category BEFORE closing modal (element will be gone after close)
  const categorySelect=document.getElementById('evo-category');
  const category=categorySelect?categorySelect.value:'birds';

  closeScribbyCard();

  // Save current state
  const savedCategory=S.creatureCategory;
  const savedStage=S.buddyStage;
  const savedVariant=S.creatureVariant;

  // Set up for preview
  S.creatureCategory=category;
  S.buddyStage=toStage;
  S.creatureVariant=0;

  // Set up pState for evolution
  pState.evolving=true;
  pState.evolvePhase='collect';
  pState.evolveType=fromStage==='egg'?'hatched':'grew';
  pState.prevStage=fromStage;
  pState.xpEarned=25;
  pState.celebration=false;

  // Store original state for restoration
  evoPreviewState={
    active:true,
    savedCategory,
    savedStage,
    savedVariant
  };

  // Set pMode to skip home screen check in render()
  pMode='evolution-preview';

  render();
}

// Developer UID for debug access
const DEV_UID='wC9mWv2LUCSlXyUrt8vEv25k9Pz2';

// Check if current user is developer
function isDevUser(){
  return window.currentUser&&window.currentUser.uid===DEV_UID;
}

// Trade terms confirmation
// Show pending trade status for a Scribby that's waiting to be claimed
async function showPendingTrade(buddyId){
  const buddy=S.graduatedBuddies.find(b=>b.id===buddyId);
  if(!buddy||!buddy.pendingTradeCode)return;

  const modal=document.getElementById('tradeTermsModal');
  const content=document.getElementById('tradeTermsContent');

  // Show loading while checking status
  content.innerHTML=`<div class="text-center py-8"><p class="text-white text-lg">Checking trade status...</p></div>`;
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  // Check if trade was claimed
  if(window.cloudFunctions&&window.currentUser){
    const status=await window.cloudFunctions.checkTradeStatus(buddy.pendingTradeCode);
    if(status==='claimed'){
      // Trade was claimed - remove buddy and show success message
      const idx=S.graduatedBuddies.findIndex(b=>b.id===buddyId);
      if(idx>-1){
        const buddyName=buddy.name||buddy.creatureName;
        S.graduatedBuddies.splice(idx,1);
        save();
        content.innerHTML=`
          <div class="text-center py-4">
            <p class="text-5xl mb-3">ðŸŽ‰</p>
            <h2 class="text-2xl font-bold text-white mb-2">Trade Complete!</h2>
            <p class="text-white/80 mb-4">${buddyName} has found a new home with your friend!</p>
            <button onclick="closeTradeTerms();render()" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold py-3 px-6 rounded-xl">Awesome!</button>
          </div>
        `;
        return;
      }
    }else if(status==='expired'||status==='not_found'){
      // Trade expired - remove pending status
      delete buddy.pendingTradeCode;
      delete buddy.pendingTradeExpiry;
      save();
      content.innerHTML=`
        <div class="text-center py-4">
          <p class="text-4xl mb-3">â°</p>
          <h2 class="text-xl font-bold text-white mb-2">Trade Expired</h2>
          <p class="text-white/80 mb-4">${buddy.name||buddy.creatureName} is back in your collection!</p>
          <button onclick="closeTradeTerms();render()" class="bg-white/20 text-white font-bold py-3 px-6 rounded-xl">OK</button>
        </div>
      `;
      return;
    }
  }

  // Render the Scribby visual
  const cat=buddy.category||buddy.creatureCategory;
  const category=CREATURE_CATEGORIES[cat];
  const varIdx=buddy.variant!==undefined?buddy.variant:buddy.creatureVariant;
  let scribbyVisual='';
  if(cat==='birds'){
    scribbyVisual=renderAdultBird(varIdx);
  }else if(cat==='reptiles'){
    scribbyVisual=renderAdultReptile(varIdx);
  }else if(cat==='mammals'){
    scribbyVisual=renderAdultMammal(varIdx);
  }else if(cat==='mystical'){
    scribbyVisual=renderAdultMystical(varIdx);
  }else if(cat==='prehistoric'){
    scribbyVisual=renderAdultPrehistoric(varIdx);
  }else if(cat==='aquatic'){
    scribbyVisual=renderAdultAquatic(varIdx);
  }else if(cat==='alien'){
    scribbyVisual=renderAdultAlien(varIdx);
  }else if(cat==='insects'){
    scribbyVisual=renderAdultInsect(varIdx);
  }else{
    const emoji=category?.adultVariants?.[varIdx]||'ðŸ¾';
    scribbyVisual=`<div style="font-size:5rem;">${emoji}</div>`;
  }

  content.innerHTML=`
    <div class="text-center mb-4">
      <div class="mx-auto mb-2 opacity-70" style="width:96px;height:96px;display:flex;align-items:center;justify-content:center;overflow:visible;">
        <div style="transform:scale(0.32);transform-origin:center center;width:120px;height:120px;display:flex;align-items:center;justify-content:center;">${scribbyVisual}</div>
      </div>
      <div class="inline-block bg-yellow-500 text-white text-sm font-bold px-3 py-1 rounded-full mb-2">Pending Trade</div>
      <h2 class="text-2xl font-bold text-white">${buddy.name||buddy.creatureName}</h2>
      <p class="text-white/80 text-sm mt-1">Waiting for a friend to claim</p>
    </div>
    <div class="bg-white/20 rounded-xl p-4 text-center mb-4">
      <p class="text-white/70 text-xs mb-1">Trade Code:</p>
      <p class="text-white font-mono text-2xl font-bold tracking-widest">${buddy.pendingTradeCode}</p>
    </div>
    <div class="bg-white/10 rounded-xl p-4 text-white/90 text-sm mb-4">
      <p>Share this code with a friend so they can claim ${buddy.name||buddy.creatureName}!</p>
      <p class="mt-2 text-white/70 text-xs">Once they enter the code, your Scribby will be transferred to them.</p>
    </div>
    <div class="flex gap-3">
      <button onclick="cancelPendingTrade(${buddyId});closeTradeTerms()" class="flex-1 bg-red-500/70 text-white font-bold py-3 rounded-xl">Cancel Trade</button>
      <button onclick="closeTradeTerms()" class="flex-1 bg-white/20 text-white font-bold py-3 rounded-xl">Close</button>
    </div>
  `;

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function showTradeTerms(buddyId){
  closeScribbyCard();

  // Check if user is signed in
  if(!window.currentUser){
    const modal=document.getElementById('tradeTermsModal');
    const content=document.getElementById('tradeTermsContent');

    content.innerHTML=`
      <div class="text-center mb-4">
        <p class="text-4xl mb-2">ðŸ”</p>
        <h2 class="text-2xl font-bold text-white">Sign In Required</h2>
        <p class="text-white/80 text-sm mt-1">You need to sign in to trade Scribbies</p>
      </div>
      <div class="bg-white/10 rounded-xl p-4 text-white/90 text-sm mb-4">
        <p>Trading uses our secure online system to ensure your Scribbies are transferred safely. Sign in with Google to enable trading!</p>
      </div>
      <button onclick="closeTradeTerms();signInWithGoogle()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 mb-3">
        <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="white" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="white" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="white" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="white" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign in with Google
      </button>
      <button onclick="closeTradeTerms()" class="w-full bg-white/20 text-white font-bold py-3 rounded-xl">Cancel</button>
    `;

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    return;
  }

  const buddy=S.graduatedBuddies.find(b=>b.id===buddyId);
  if(!buddy)return;

  const modal=document.getElementById('tradeTermsModal');
  const content=document.getElementById('tradeTermsContent');

  // Render the Scribby visual for the modal
  const cat=buddy.category||buddy.creatureCategory;
  const category=CREATURE_CATEGORIES[cat];
  const varIdx=buddy.variant!==undefined?buddy.variant:buddy.creatureVariant;
  let scribbyVisual='';
  if(cat==='birds'){
    scribbyVisual=renderAdultBird(varIdx);
  }else if(cat==='reptiles'){
    scribbyVisual=renderAdultReptile(varIdx);
  }else if(cat==='mammals'){
    scribbyVisual=renderAdultMammal(varIdx);
  }else if(cat==='mystical'){
    scribbyVisual=renderAdultMystical(varIdx);
  }else if(cat==='prehistoric'){
    scribbyVisual=renderAdultPrehistoric(varIdx);
  }else if(cat==='aquatic'){
    scribbyVisual=renderAdultAquatic(varIdx);
  }else if(cat==='alien'){
    scribbyVisual=renderAdultAlien(varIdx);
  }else if(cat==='insects'){
    scribbyVisual=renderAdultInsect(varIdx);
  }else{
    const emoji=category?.adultVariants?.[varIdx]||'ðŸ¾';
    scribbyVisual=`<div style="font-size:5rem;">${emoji}</div>`;
  }

  content.innerHTML=`
    <div class="text-center mb-4">
      <div class="mx-auto mb-2" style="width:96px;height:96px;display:flex;align-items:center;justify-content:center;overflow:visible;">
        <div style="transform:scale(0.32);transform-origin:center center;width:120px;height:120px;display:flex;align-items:center;justify-content:center;">${scribbyVisual}</div>
      </div>
      <h2 class="text-2xl font-bold text-white">Share ${buddy.name||buddy.creatureName}?</h2>
      <p class="text-white/80 text-sm mt-1">Give this Scribby to a friend</p>
    </div>
    <div class="bg-white/10 rounded-xl p-4 space-y-3 text-white/90 text-sm">
      <div class="flex gap-3">
        <span class="text-lg">ðŸ“±</span>
        <p>You'll get a <strong>trade code</strong> to share with your friend.</p>
      </div>
      <div class="flex gap-3">
        <span class="text-lg">ðŸ”„</span>
        <p>You can <strong>cancel anytime</strong> before they claim it.</p>
      </div>
    </div>
    <div class="flex gap-3 mt-5">
      <button onclick="closeTradeTerms()" class="flex-1 bg-white/20 text-white font-bold py-3 rounded-xl">Cancel</button>
      <button onclick="initiateTrade(${buddyId})" class="flex-1 bg-gradient-to-r from-purple-500 to-violet-500 text-white font-bold py-3 rounded-xl">Share!</button>
    </div>
  `;

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function closeTradeTerms(){
  const modal=document.getElementById('tradeTermsModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

// Track selected trade quantity
let tradeQuantity=1;

// Accessory trading
function showAccessoryTrade(accIdx){
  // Check if user is signed in
  if(!window.currentUser){
    const modal=document.getElementById('tradeTermsModal');
    const content=document.getElementById('tradeTermsContent');

    content.innerHTML=`
      <div class="text-center mb-4">
        <p class="text-4xl mb-2">ðŸ”</p>
        <h2 class="text-2xl font-bold text-white">Sign In Required</h2>
        <p class="text-white/80 text-sm mt-1">You need to sign in to trade items</p>
      </div>
      <div class="bg-white/10 rounded-xl p-4 text-white/90 text-sm mb-4">
        <p>Trading uses our secure online system. Sign in with Google to enable trading!</p>
      </div>
      <button onclick="closeTradeTerms();signInWithGoogle()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 mb-3">
        <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="white" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="white" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="white" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="white" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign in with Google
      </button>
      <button onclick="closeTradeTerms()" class="w-full bg-white/20 text-white font-bold py-3 rounded-xl">Cancel</button>
    `;

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    return;
  }

  const acc=ACCESSORIES[accIdx];
  if(!acc||!S.inventory.includes(accIdx))return;

  // Count how many of this item we have
  const itemCount=(S.inventory||[]).filter(idx=>idx===accIdx).length;
  tradeQuantity=1; // Reset to 1

  const modal=document.getElementById('tradeTermsModal');
  const content=document.getElementById('tradeTermsContent');

  const quantitySelector=itemCount>1?`
    <div class="bg-white/10 rounded-xl p-4 mb-4">
      <p class="text-white/80 text-sm mb-2">You have <strong>${itemCount}</strong> of this item. How many to send?</p>
      <div class="flex items-center justify-center gap-4">
        <button onclick="updateTradeQuantity(${accIdx},-1)" class="w-10 h-10 bg-white/20 rounded-full text-white text-xl font-bold">âˆ’</button>
        <span id="tradeQtyDisplay" class="text-white text-2xl font-bold w-12 text-center">1</span>
        <button onclick="updateTradeQuantity(${accIdx},1)" class="w-10 h-10 bg-white/20 rounded-full text-white text-xl font-bold">+</button>
      </div>
    </div>
  `:'';

  content.innerHTML=`
    <div class="text-center mb-4">
      <p class="text-5xl mb-2">${acc.emoji}${itemCount>1?`<span class="text-xl">Ã—${itemCount}</span>`:''}</p>
      <h2 class="text-2xl font-bold text-white">Share ${acc.name}?</h2>
      <p class="text-white/80 text-sm mt-1">Give this item to a friend</p>
    </div>
    ${quantitySelector}
    <div class="bg-white/10 rounded-xl p-4 space-y-3 text-white/90 text-sm">
      <div class="flex gap-3">
        <span class="text-lg">ðŸ“±</span>
        <p>You'll get a <strong>trade code</strong> to share with your friend.</p>
      </div>
      <div class="flex gap-3">
        <span class="text-lg">ðŸ”„</span>
        <p>You can <strong>cancel anytime</strong> before they claim it.</p>
      </div>
    </div>
    <div class="flex gap-3 mt-5">
      <button onclick="closeTradeTerms()" class="flex-1 bg-white/20 text-white font-bold py-3 rounded-xl">Cancel</button>
      <button onclick="initiateAccessoryTrade(${accIdx},tradeQuantity)" class="flex-1 bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold py-3 rounded-xl">Share!</button>
    </div>
  `;

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function updateTradeQuantity(accIdx,delta){
  const itemCount=(S.inventory||[]).filter(idx=>idx===accIdx).length;
  tradeQuantity=Math.max(1,Math.min(itemCount,tradeQuantity+delta));
  const display=document.getElementById('tradeQtyDisplay');
  if(display)display.textContent=tradeQuantity;
}

async function initiateAccessoryTrade(accIdx,quantity=1){
  closeTradeTerms();

  if(!window.currentUser){
    alert('You must be signed in to trade!');
    return;
  }

  // Verify we have enough of this item
  const ownedCount=(S.inventory||[]).filter(idx=>idx===accIdx).length;
  if(ownedCount<quantity){
    alert(`You only have ${ownedCount} of this item!`);
    return;
  }

  const acc=ACCESSORIES[accIdx];

  // Show loading state
  const modal=document.getElementById('tradeQRModal');
  const content=document.getElementById('tradeQRContent');
  content.innerHTML=`<div class="text-center py-8"><p class="text-white text-lg">Creating trade...</p></div>`;
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  // Create trade in Firebase with full item data
  const tradeData={
    type:'accessory',
    accessoryIdx:accIdx,
    accessory:{...acc}, // Full accessory data for recipient
    quantity:quantity
  };
  const shortCode=await window.cloudFunctions.createTradeOffer(tradeData);

  if(!shortCode){
    content.innerHTML=`
      <div class="text-center py-8">
        <p class="text-red-300 text-lg mb-4">Failed to create trade</p>
        <button onclick="closeTradeQR()" class="bg-white/20 text-white font-bold py-3 px-6 rounded-xl">Close</button>
      </div>
    `;
    return;
  }

  // IMMEDIATELY remove items from inventory
  for(let i=0;i<quantity;i++){
    const invIdx=S.inventory.indexOf(accIdx);
    if(invIdx!==-1)S.inventory.splice(invIdx,1);
  }

  // Store pending trade info locally (for cancel/restore and UI)
  if(!S.pendingAccessoryTrades)S.pendingAccessoryTrades=[];
  S.pendingAccessoryTrades.push({
    accIdx:accIdx,
    code:shortCode,
    accessory:{...acc}, // Store for restore if cancelled
    quantity:quantity,
    createdAt:Date.now()
  });
  save();

  const qtyText=quantity>1?` Ã—${quantity}`:'';

  // Update modal with trade code
  content.innerHTML=`
    <div class="text-center mb-4">
      <p class="text-5xl mb-2">${acc.emoji}${qtyText?`<span class="text-xl">${qtyText}</span>`:''}</p>
      <h2 class="text-xl font-bold text-white">${acc.name}${qtyText} Ready to Share!</h2>
      <p class="text-white/70 text-sm mt-1">Show this to your friend</p>
    </div>
    <div class="bg-white rounded-2xl p-4 flex flex-col items-center justify-center">
      <div id="tradeQRCode" class="flex items-center justify-center"></div>
    </div>
    <div class="mt-4 bg-white/20 rounded-xl p-4 text-center">
      <p class="text-white/70 text-xs mb-1">Or tell them this code:</p>
      <p class="text-white font-mono text-2xl font-bold tracking-widest">${shortCode}</p>
    </div>
    <div class="flex gap-2 mt-4">
      <button onclick="cancelAccessoryTradeByCode('${shortCode}')" class="flex-1 bg-white/30 text-white font-bold py-3 rounded-xl">Cancel Trade</button>
      <button onclick="closeTradeQR();render()" class="flex-1 bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold py-3 rounded-xl">Done</button>
    </div>
  `;

  // Generate QR code
  setTimeout(()=>{
    const qrContainer=document.getElementById('tradeQRCode');
    if(qrContainer&&typeof QRCode!=='undefined'){
      qrContainer.innerHTML='';
      new QRCode(qrContainer,{
        text:shortCode,
        width:180,
        height:180,
        colorDark:'#db2777',
        colorLight:'#ffffff',
        correctLevel:QRCode.CorrectLevel.M
      });
    }
  },100);
}

// Generate trade code and QR
let activeTradeTimer=null;
let activeTradeExpiry=null;

async function initiateTrade(buddyId){
  closeTradeTerms();

  if(!window.currentUser){
    alert('You must be signed in to trade!');
    return;
  }

  const buddyIdx=S.graduatedBuddies.findIndex(b=>b.id===buddyId);
  if(buddyIdx===-1)return;

  const buddy={...S.graduatedBuddies[buddyIdx]}; // Copy buddy data
  const buddyName=buddy.name||buddy.creatureName;

  // Show loading state
  const modal=document.getElementById('tradeQRModal');
  const content=document.getElementById('tradeQRContent');
  content.innerHTML=`<div class="text-center py-8"><p class="text-white text-lg">Creating trade...</p></div>`;
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  // Create trade in Firebase with full Scribby data
  const tradeData={
    type:'scribby',
    buddy:{...buddy}
  };
  const shortCode=await window.cloudFunctions.createTradeOffer(tradeData);

  if(!shortCode){
    content.innerHTML=`
      <div class="text-center py-8">
        <p class="text-red-300 text-lg mb-4">Failed to create trade</p>
        <button onclick="closeTradeQR()" class="bg-white/20 text-white font-bold py-3 px-6 rounded-xl">Close</button>
      </div>
    `;
    return;
  }

  // IMMEDIATELY remove Scribby from graduatedBuddies
  S.graduatedBuddies.splice(buddyIdx,1);

  // Store in pending trades for restore capability
  if(!S.pendingScribbyTrades)S.pendingScribbyTrades=[];
  S.pendingScribbyTrades.push({
    buddy:{...buddy},
    code:shortCode,
    createdAt:Date.now()
  });
  save();

  // Render the Scribby visual for the modal
  const cat=buddy.category||buddy.creatureCategory;
  const category=CREATURE_CATEGORIES[cat];
  const varIdx=buddy.variant!==undefined?buddy.variant:buddy.creatureVariant;
  let scribbyVisual='';
  if(cat==='birds'){
    scribbyVisual=renderAdultBird(varIdx);
  }else if(cat==='reptiles'){
    scribbyVisual=renderAdultReptile(varIdx);
  }else if(cat==='mammals'){
    scribbyVisual=renderAdultMammal(varIdx);
  }else if(cat==='mystical'){
    scribbyVisual=renderAdultMystical(varIdx);
  }else if(cat==='prehistoric'){
    scribbyVisual=renderAdultPrehistoric(varIdx);
  }else if(cat==='aquatic'){
    scribbyVisual=renderAdultAquatic(varIdx);
  }else if(cat==='alien'){
    scribbyVisual=renderAdultAlien(varIdx);
  }else if(cat==='insects'){
    scribbyVisual=renderAdultInsect(varIdx);
  }else{
    const emoji=category?.adultVariants?.[varIdx]||'ðŸ¾';
    scribbyVisual=`<div style="font-size:4rem;">${emoji}</div>`;
  }

  // Update modal with trade code
  content.innerHTML=`
    <div class="text-center mb-4">
      <div class="mx-auto mb-2" style="width:80px;height:80px;display:flex;align-items:center;justify-content:center;overflow:visible;">
        <div style="transform:scale(0.28);transform-origin:center center;width:120px;height:120px;display:flex;align-items:center;justify-content:center;">${scribbyVisual}</div>
      </div>
      <h2 class="text-xl font-bold text-white">${buddyName} Ready to Share!</h2>
      <p class="text-white/70 text-sm mt-1">Show this to your friend</p>
    </div>
    <div class="bg-white rounded-2xl p-4 flex flex-col items-center justify-center">
      <div id="tradeQRCode" class="flex items-center justify-center"></div>
    </div>
    <div class="mt-4 bg-white/20 rounded-xl p-4 text-center">
      <p class="text-white/70 text-xs mb-1">Or tell them this code:</p>
      <p class="text-white font-mono text-2xl font-bold tracking-widest">${shortCode}</p>
    </div>
    <div class="flex gap-2 mt-4">
      <button onclick="cancelScribbyTradeByCode('${shortCode}')" class="flex-1 bg-white/30 text-white font-bold py-3 rounded-xl">Cancel Trade</button>
      <button onclick="closeTradeQR();render()" class="flex-1 bg-gradient-to-r from-purple-500 to-violet-500 text-white font-bold py-3 rounded-xl">Done</button>
    </div>
  `;

  modal.classList.remove('hidden');
  modal.classList.add('flex');

  // Generate QR code with just the short code (easy to read when scanned)
  setTimeout(()=>{
    const qrContainer=document.getElementById('tradeQRCode');
    if(qrContainer&&typeof QRCode!=='undefined'){
      qrContainer.innerHTML=''; // Clear any existing QR
      new QRCode(qrContainer,{
        text:shortCode,
        width:180,
        height:180,
        colorDark:'#7c3aed',
        colorLight:'#ffffff',
        correctLevel:QRCode.CorrectLevel.M
      });
    }
  },100);
}

function startTradeTimer(){
  if(activeTradeTimer)clearInterval(activeTradeTimer);

  activeTradeTimer=setInterval(()=>{
    const now=Date.now();
    const remaining=activeTradeExpiry-now;

    if(remaining<=0){
      clearInterval(activeTradeTimer);
      activeTradeTimer=null;
      // Just update the display - code is expired, Scribby is already gone
      const timerEl=document.getElementById('tradeTimer');
      if(timerEl){
        timerEl.textContent='EXPIRED';
        timerEl.classList.add('text-red-300');
      }
      return;
    }

    const mins=Math.floor(remaining/60000);
    const secs=Math.floor((remaining%60000)/1000);
    const timerEl=document.getElementById('tradeTimer');
    if(timerEl){
      timerEl.textContent=`${mins}:${secs.toString().padStart(2,'0')}`;
    }
  },1000);
}

// Cancel a pending trade and return item to user
function cancelPendingTrade(buddyId){
  const buddy=S.graduatedBuddies.find(b=>b.id===buddyId);
  if(buddy&&buddy.pendingTradeCode){
    delete buddy.pendingTradeCode;
    delete buddy.pendingTradeExpiry;
    save();
    closeTradeQR();
    render();
    alert('Trade cancelled. Your Scribby is back in your collection!');
  }
}

// Check Firebase for claimed trades and remove those Scribbies/items
async function checkClaimedTrades(){
  if(!window.cloudFunctions||!window.currentUser)return;

  let changed=false;

  // Check pending Scribby trades
  const pendingBuddies=(S.graduatedBuddies||[]).filter(b=>b.pendingTradeCode);
  for(const buddy of pendingBuddies){
    const status=await window.cloudFunctions.checkTradeStatus(buddy.pendingTradeCode);
    if(status==='claimed'){
      // Trade was claimed - remove buddy from local collection
      const idx=S.graduatedBuddies.findIndex(b=>b.id===buddy.id);
      if(idx>-1){
        S.graduatedBuddies.splice(idx,1);
        changed=true;
        console.log(`Trade claimed: ${buddy.name||buddy.creatureName} has been transferred`);
      }
    }else if(status==='expired'||status==='not_found'){
      // Trade expired or not found - remove pending status, buddy stays
      delete buddy.pendingTradeCode;
      delete buddy.pendingTradeExpiry;
      changed=true;
    }
  }

  // Check pending accessory trades
  if(S.pendingAccessoryTrades&&S.pendingAccessoryTrades.length>0){
    const stillPending=[];
    for(const trade of S.pendingAccessoryTrades){
      const status=await window.cloudFunctions.checkTradeStatus(trade.code);
      if(status==='claimed'){
        // Trade was claimed - remove item from inventory
        const invIdx=S.inventory.indexOf(trade.accIdx);
        if(invIdx>-1){
          S.inventory.splice(invIdx,1);
          changed=true;
          console.log(`Accessory trade claimed: ${ACCESSORIES[trade.accIdx]?.name} has been transferred`);
        }
      }else if(status==='expired'||status==='not_found'){
        // Trade expired - item stays in inventory (no action needed, just don't keep in pending)
        changed=true;
      }else{
        // Still pending
        stillPending.push(trade);
      }
    }
    S.pendingAccessoryTrades=stillPending;
  }

  if(changed){
    save();
    render();
  }
}

// Show pending accessory trade status
async function showPendingAccessoryTrade(accIdx){
  const trade=(S.pendingAccessoryTrades||[]).find(t=>t.accIdx===accIdx);
  if(!trade)return;

  const acc=ACCESSORIES[accIdx];
  const isRoom=acc?.type==='room';
  const isToy=acc?.type==='toy';
  const iconHtml=isRoom?renderFurnitureIcon(acc.emoji,64):isToy?renderToyIcon(acc.emoji,64):`<span class="text-5xl">${acc?.emoji||'ðŸŽ'}</span>`;
  const modal=document.getElementById('tradeTermsModal');
  const content=document.getElementById('tradeTermsContent');

  // Show loading while checking status
  content.innerHTML=`<div class="text-center py-8"><p class="text-white text-lg">Checking trade status...</p></div>`;
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  // Check if trade was claimed
  if(window.cloudFunctions&&window.currentUser){
    const status=await window.cloudFunctions.checkTradeStatus(trade.code);
    if(status==='claimed'){
      // Trade was claimed - remove from inventory and pending list
      const invIdx=S.inventory.indexOf(accIdx);
      if(invIdx>-1)S.inventory.splice(invIdx,1);
      const pendIdx=S.pendingAccessoryTrades.findIndex(t=>t.accIdx===accIdx);
      if(pendIdx>-1)S.pendingAccessoryTrades.splice(pendIdx,1);
      save();
      content.innerHTML=`
        <div class="text-center py-4">
          <p class="text-5xl mb-3">ðŸŽ‰</p>
          <h2 class="text-2xl font-bold text-white mb-2">Trade Complete!</h2>
          <p class="text-white/80 mb-4">${acc.name} has been sent to your friend!</p>
          <button onclick="closeTradeTerms();render()" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold py-3 px-6 rounded-xl">Awesome!</button>
        </div>
      `;
      return;
    }else if(status==='expired'||status==='not_found'){
      // Trade expired - remove from pending list
      const pendIdx=S.pendingAccessoryTrades.findIndex(t=>t.accIdx===accIdx);
      if(pendIdx>-1)S.pendingAccessoryTrades.splice(pendIdx,1);
      save();
      content.innerHTML=`
        <div class="text-center py-4">
          <p class="text-4xl mb-3">â°</p>
          <h2 class="text-xl font-bold text-white mb-2">Trade Expired</h2>
          <p class="text-white/80 mb-4">${acc.name} is back in your collection!</p>
          <button onclick="closeTradeTerms();render()" class="bg-white/20 text-white font-bold py-3 px-6 rounded-xl">OK</button>
        </div>
      `;
      return;
    }
  }

  // Still pending - show code and cancel option
  content.innerHTML=`
    <div class="text-center mb-4">
      <div class="flex justify-center mb-2 opacity-70">${iconHtml}</div>
      <div class="inline-block bg-yellow-500 text-white text-sm font-bold px-3 py-1 rounded-full mb-2">Pending Trade</div>
      <h2 class="text-2xl font-bold text-white">${acc.name}</h2>
      <p class="text-white/80 text-sm mt-1">Waiting for a friend to claim</p>
    </div>
    <div class="bg-white/20 rounded-xl p-4 text-center mb-4">
      <p class="text-white/70 text-xs mb-1">Trade Code:</p>
      <p class="text-white font-mono text-2xl font-bold tracking-widest">${trade.code}</p>
    </div>
    <div class="bg-white/10 rounded-xl p-4 text-white/90 text-sm mb-4">
      <p>Share this code with a friend so they can claim ${acc.name}!</p>
    </div>
    <div class="flex gap-3">
      <button onclick="cancelPendingAccessoryTrade(${accIdx});closeTradeTerms()" class="flex-1 bg-red-500/70 text-white font-bold py-3 rounded-xl">Cancel Trade</button>
      <button onclick="closeTradeTerms()" class="flex-1 bg-white/20 text-white font-bold py-3 rounded-xl">Close</button>
    </div>
  `;

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

// Cancel a pending accessory trade and return item to user
// Cancel accessory trade by trade code - restores item to inventory
async function cancelAccessoryTradeByCode(tradeCode){
  if(!S.pendingAccessoryTrades)return;
  const idx=S.pendingAccessoryTrades.findIndex(t=>t.code===tradeCode);
  if(idx===-1){
    alert('Trade not found');
    return;
  }

  const pendingTrade=S.pendingAccessoryTrades[idx];

  // Cancel in Firebase (delete the trade document)
  if(window.cloudFunctions){
    await window.cloudFunctions.cancelTrade(tradeCode);
  }

  // Restore items to inventory (handle quantity)
  const quantity=pendingTrade.quantity||1;
  for(let i=0;i<quantity;i++){
    S.inventory.push(pendingTrade.accIdx);
  }

  // Remove from pending list
  S.pendingAccessoryTrades.splice(idx,1);
  save();
  closeTradeQR();
  render();
  alert(`Trade cancelled. ${quantity>1?quantity+' items are':'Your item is'} back in your inventory!`);
}

// Legacy function for backwards compatibility
function cancelPendingAccessoryTrade(accIdx){
  if(!S.pendingAccessoryTrades)return;
  const trade=S.pendingAccessoryTrades.find(t=>t.accIdx===accIdx);
  if(trade){
    cancelAccessoryTradeByCode(trade.code);
  }
}

// Cancel Scribby trade by trade code - restores Scribby to collection
async function cancelScribbyTradeByCode(tradeCode){
  if(!S.pendingScribbyTrades)return;
  const idx=S.pendingScribbyTrades.findIndex(t=>t.code===tradeCode);
  if(idx===-1){
    alert('Trade not found');
    return;
  }

  const pendingTrade=S.pendingScribbyTrades[idx];

  // Cancel in Firebase (delete the trade document)
  if(window.cloudFunctions){
    try{
      await window.cloudFunctions.cancelTrade(tradeCode);
    }catch(e){
      console.log('Firebase cancel failed, continuing with local restore');
    }
  }

  // Restore Scribby to collection
  if(!S.graduatedBuddies)S.graduatedBuddies=[];
  S.graduatedBuddies.push(pendingTrade.buddy);

  // Remove from pending list
  S.pendingScribbyTrades.splice(idx,1);
  save();
  closeTradeQR();
  render();
  alert(`Trade cancelled. ${pendingTrade.buddy.name||pendingTrade.buddy.creatureName} is back in your collection!`);
}

// Show pending Scribby trade details with option to cancel
function showPendingScribbyTrade(tradeCode){
  const trade=(S.pendingScribbyTrades||[]).find(t=>t.code===tradeCode);
  if(!trade)return;

  const buddy=trade.buddy;
  const cat=buddy.category||buddy.creatureCategory;
  const category=CREATURE_CATEGORIES[cat];
  const varIdx=buddy.variant!==undefined?buddy.variant:buddy.creatureVariant;
  const name=buddy.name||buddy.creatureName||category?.adultNames?.[varIdx]||'Scribby';

  let scribbyVisual='';
  if(cat==='birds'){
    scribbyVisual=renderAdultBird(varIdx);
  }else if(cat==='reptiles'){
    scribbyVisual=renderAdultReptile(varIdx);
  }else if(cat==='mammals'){
    scribbyVisual=renderAdultMammal(varIdx);
  }else if(cat==='mystical'){
    scribbyVisual=renderAdultMystical(varIdx);
  }else if(cat==='prehistoric'){
    scribbyVisual=renderAdultPrehistoric(varIdx);
  }else if(cat==='aquatic'){
    scribbyVisual=renderAdultAquatic(varIdx);
  }else if(cat==='alien'){
    scribbyVisual=renderAdultAlien(varIdx);
  }else if(cat==='insects'){
    scribbyVisual=renderAdultInsect(varIdx);
  }else{
    const emoji=category?.adultVariants?.[varIdx]||'ðŸ¾';
    scribbyVisual=`<div style="font-size:4rem;">${emoji}</div>`;
  }

  const modal=document.getElementById('tradeQRModal');
  const content=document.getElementById('tradeQRContent');
  content.innerHTML=`
    <div class="text-center mb-4">
      <div class="mx-auto mb-2" style="width:80px;height:80px;display:flex;align-items:center;justify-content:center;overflow:visible;">
        <div style="transform:scale(0.28);transform-origin:center center;width:120px;height:120px;display:flex;align-items:center;justify-content:center;">${scribbyVisual}</div>
      </div>
      <h2 class="text-xl font-bold text-white">${name}</h2>
      <p class="text-yellow-300 text-sm mt-1">â³ Waiting to be claimed</p>
    </div>
    <div class="bg-white rounded-2xl p-4 flex flex-col items-center justify-center">
      <div id="tradeQRCode" class="flex items-center justify-center"></div>
    </div>
    <div class="mt-4 bg-white/20 rounded-xl p-4 text-center">
      <p class="text-white/70 text-xs mb-1">Trade code:</p>
      <p class="text-white font-mono text-2xl font-bold tracking-widest">${tradeCode}</p>
    </div>
    <div class="flex gap-2 mt-4">
      <button onclick="cancelScribbyTradeByCode('${tradeCode}')" class="flex-1 bg-red-500/70 text-white font-bold py-3 rounded-xl">Cancel Trade</button>
      <button onclick="closeTradeQR();render()" class="flex-1 bg-white/20 text-white font-bold py-3 rounded-xl">Close</button>
    </div>
  `;
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  // Generate QR code
  setTimeout(()=>{
    const qrContainer=document.getElementById('tradeQRCode');
    if(qrContainer&&typeof QRCode!=='undefined'){
      qrContainer.innerHTML='';
      new QRCode(qrContainer,{
        text:tradeCode,
        width:180,
        height:180,
        colorDark:'#a16207',
        colorLight:'#ffffff',
        correctLevel:QRCode.CorrectLevel.M
      });
    }
  },100);
}

// Show pending accessory trade details with option to cancel
function showPendingAccessoryTradeByCode(tradeCode){
  const trade=(S.pendingAccessoryTrades||[]).find(t=>t.code===tradeCode);
  if(!trade)return;

  const acc=trade.accessory||ACCESSORIES[trade.accIdx];
  const quantity=trade.quantity||1;
  const qtyText=quantity>1?` Ã—${quantity}`:'';
  const isRoom=acc?.type==='room';
  const isToy=acc?.type==='toy';
  const iconHtml=isRoom?renderFurnitureIcon(acc.emoji,64):isToy?renderToyIcon(acc.emoji,64):`<span class="text-5xl">${acc?.emoji||'ðŸŽ'}</span>`;

  const modal=document.getElementById('tradeQRModal');
  const content=document.getElementById('tradeQRContent');
  content.innerHTML=`
    <div class="text-center mb-4">
      <div class="flex justify-center mb-2">${iconHtml}${qtyText?`<span class="text-xl text-white ml-1">${qtyText}</span>`:''}</div>
      <h2 class="text-xl font-bold text-white">${acc?.name||'Item'}${qtyText}</h2>
      <p class="text-yellow-300 text-sm mt-1">â³ Waiting to be claimed</p>
    </div>
    <div class="bg-white rounded-2xl p-4 flex flex-col items-center justify-center">
      <div id="tradeQRCode" class="flex items-center justify-center"></div>
    </div>
    <div class="mt-4 bg-white/20 rounded-xl p-4 text-center">
      <p class="text-white/70 text-xs mb-1">Trade code:</p>
      <p class="text-white font-mono text-2xl font-bold tracking-widest">${tradeCode}</p>
    </div>
    <div class="flex gap-2 mt-4">
      <button onclick="cancelAccessoryTradeByCode('${tradeCode}')" class="flex-1 bg-red-500/70 text-white font-bold py-3 rounded-xl">Cancel Trade</button>
      <button onclick="closeTradeQR();render()" class="flex-1 bg-white/20 text-white font-bold py-3 rounded-xl">Close</button>
    </div>
  `;
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  // Generate QR code
  setTimeout(()=>{
    const qrContainer=document.getElementById('tradeQRCode');
    if(qrContainer&&typeof QRCode!=='undefined'){
      qrContainer.innerHTML='';
      new QRCode(qrContainer,{
        text:tradeCode,
        width:180,
        height:180,
        colorDark:'#a16207',
        colorLight:'#ffffff',
        correctLevel:QRCode.CorrectLevel.M
      });
    }
  },100);
}

// Clean up any expired pending trades (called on render)
// Restores items to inventory when trades expire (24 hour expiry)
function cleanupExpiredTrades(){
  const now=Date.now();
  const TRADE_EXPIRY_MS=24*60*60*1000; // 24 hours
  let cleaned=false;

  // Clean up old-style Scribby trades (backwards compatibility)
  (S.graduatedBuddies||[]).forEach(buddy=>{
    if(buddy.pendingTradeExpiry&&buddy.pendingTradeExpiry<now){
      delete buddy.pendingTradeCode;
      delete buddy.pendingTradeExpiry;
      cleaned=true;
    }
  });

  // Clean up expired Scribby trades from new pending array - RESTORE buddies
  if(S.pendingScribbyTrades&&S.pendingScribbyTrades.length>0){
    const expired=S.pendingScribbyTrades.filter(t=>(t.createdAt+TRADE_EXPIRY_MS)<now);
    expired.forEach(t=>{
      // Restore the buddy to collection
      if(t.buddy){
        if(!S.graduatedBuddies)S.graduatedBuddies=[];
        S.graduatedBuddies.push(t.buddy);
      }
    });
    if(expired.length>0){
      S.pendingScribbyTrades=S.pendingScribbyTrades.filter(t=>(t.createdAt+TRADE_EXPIRY_MS)>=now);
      cleaned=true;
    }
  }

  // Clean up expired accessory trades - RESTORE items to inventory
  if(S.pendingAccessoryTrades&&S.pendingAccessoryTrades.length>0){
    const expired=S.pendingAccessoryTrades.filter(t=>(t.createdAt+TRADE_EXPIRY_MS)<now||(t.expiry&&t.expiry<now));
    expired.forEach(t=>{
      // Restore the accessory to inventory
      if(t.accIdx!==undefined){
        if(!S.inventory)S.inventory=[];
        S.inventory.push(t.accIdx);
      }
    });
    if(expired.length>0){
      S.pendingAccessoryTrades=S.pendingAccessoryTrades.filter(t=>(t.createdAt+TRADE_EXPIRY_MS)>=now&&(!t.expiry||t.expiry>=now));
      cleaned=true;
    }
  }

  if(cleaned)save();
}

function closeTradeQR(){
  if(activeTradeTimer){
    clearInterval(activeTradeTimer);
    activeTradeTimer=null;
  }

  const modal=document.getElementById('tradeQRModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');

  render();
}

// Redeem trade code
function showRedeemTrade(){
  const modal=document.getElementById('redeemTradeModal');
  const content=document.getElementById('redeemTradeContent');

  // Check if signed in
  if(!window.currentUser){
    content.innerHTML=`
      <div class="text-center mb-4">
        <p class="text-4xl mb-2">ðŸ”</p>
        <h2 class="text-2xl font-bold text-white">Sign In Required</h2>
        <p class="text-white/80 text-sm mt-1">You need to sign in to receive Scribbies</p>
      </div>
      <div class="bg-white/10 rounded-xl p-4 text-white/90 text-sm mb-4">
        <p>Sign in with Google to receive Scribbies from friends!</p>
      </div>
      <button onclick="closeRedeemTrade();signInWithGoogle()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 mb-3">
        <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="white" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="white" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="white" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="white" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign in with Google
      </button>
      <button onclick="closeRedeemTrade()" class="w-full bg-white/20 text-white font-bold py-3 rounded-xl">Cancel</button>
    `;

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    return;
  }

  content.innerHTML=`
    <div class="text-center mb-4">
      <p class="text-4xl mb-2">ðŸ“¦</p>
      <h2 class="text-2xl font-bold text-white">Receive a Scribby</h2>
      <p class="text-white/80 text-sm mt-1">Scan QR code or enter code manually</p>
    </div>

    <!-- QR Scanner Section -->
    <div id="qrScannerSection" class="mb-4">
      <div id="qrScannerContainer" class="hidden rounded-xl overflow-hidden mb-3">
        <div id="qrReader" style="width:100%;"></div>
      </div>
      <button onclick="toggleQRScanner()" id="scanQRBtn" class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 mb-3">
        <span>ðŸ“·</span>
        <span>Scan QR Code</span>
      </button>
    </div>

    <div class="flex items-center gap-3 mb-4">
      <div class="flex-1 h-px bg-white/30"></div>
      <span class="text-white/50 text-sm">or enter code</span>
      <div class="flex-1 h-px bg-white/30"></div>
    </div>

    <div class="mb-4">
      <input type="text" id="tradeCodeInput" placeholder="SCRIB-XXXXXX"
        class="w-full px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/50 text-center font-mono text-xl tracking-wider uppercase outline-none focus:ring-2 focus:ring-white"
        maxlength="12">
    </div>
    <div class="flex gap-3">
      <button onclick="closeRedeemTrade()" class="flex-1 bg-white/20 text-white font-bold py-3 rounded-xl">Cancel</button>
      <button onclick="redeemTradeCode()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold py-3 rounded-xl">Claim Item</button>
    </div>
  `;

  modal.classList.remove('hidden');
  modal.classList.add('flex');

  setTimeout(()=>{
    document.getElementById('tradeCodeInput')?.focus();
  },100);
}

let qrScanner=null;

function closeRedeemTrade(){
  // Stop QR scanner if running
  if(qrScanner){
    qrScanner.stop().catch(()=>{});
    qrScanner=null;
  }
  const modal=document.getElementById('redeemTradeModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

function showSendScribbyPicker(){
  const modal=document.getElementById('redeemTradeModal');
  const content=document.getElementById('redeemTradeContent');

  // Get all adult Scribbies available for trading
  const adultScribbies=(S.graduatedBuddies||[]).filter(b=>b.stage==='adult');

  if(adultScribbies.length===0){
    content.innerHTML=`
      <div class="text-center mb-4">
        <p class="text-4xl mb-2">ðŸ“¤</p>
        <h2 class="text-2xl font-bold text-white">Send a Scribby</h2>
      </div>
      <div class="bg-white/10 rounded-xl p-6 text-center mb-4">
        <p class="text-white/90 mb-2">You don't have any adult Scribbies to share yet!</p>
        <p class="text-white/70 text-sm">Keep practicing to help your Scribby grow to adult stage, then you can share it with friends.</p>
      </div>
      <button onclick="closeRedeemTrade()" class="w-full bg-white/20 text-white font-bold py-3 rounded-xl">Close</button>
    `;
  }else{
    const scribbyGrid=adultScribbies.map(buddy=>{
      const cat=buddy.category||buddy.creatureCategory;
      const category=CREATURE_CATEGORIES[cat];
      const varIdx=buddy.variant!==undefined?buddy.variant:buddy.creatureVariant;
      const emoji=category?.adultVariants?.[varIdx]||'ðŸ¾';
      const name=buddy.name||buddy.creatureName||category?.adultNames?.[varIdx]||'Scribby';
      return`
        <button onclick="closeRedeemTrade();showTradeTerms(${buddy.id})" class="bg-white/10 hover:bg-white/20 rounded-xl p-3 text-center transition-colors">
          <div class="text-3xl mb-1">${emoji}</div>
          <p class="text-white font-semibold text-sm truncate">${name}</p>
          <p class="text-white/60 text-xs">${category?cat.charAt(0).toUpperCase()+cat.slice(1):'Unknown'}</p>
        </button>
      `;
    }).join('');

    content.innerHTML=`
      <div class="text-center mb-4">
        <p class="text-4xl mb-2">ðŸ“¤</p>
        <h2 class="text-2xl font-bold text-white">Send a Scribby</h2>
        <p class="text-white/80 text-sm mt-1">Choose a Scribby to share with a friend</p>
      </div>
      <div class="grid grid-cols-3 gap-3 mb-4 max-h-64 overflow-y-auto">
        ${scribbyGrid}
      </div>
      <button onclick="closeRedeemTrade()" class="w-full bg-white/20 text-white font-bold py-3 rounded-xl">Cancel</button>
    `;
  }

  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

async function toggleQRScanner(){
  const container=document.getElementById('qrScannerContainer');
  const btn=document.getElementById('scanQRBtn');

  if(qrScanner){
    // Stop scanner
    await qrScanner.stop();
    qrScanner=null;
    container.classList.add('hidden');
    btn.innerHTML='<span>ðŸ“·</span><span>Scan QR Code</span>';
    return;
  }

  // Start scanner
  container.classList.remove('hidden');
  btn.innerHTML='<span>âœ•</span><span>Stop Scanning</span>';

  try{
    qrScanner=new Html5Qrcode('qrReader');
    await qrScanner.start(
      {facingMode:'environment'},
      {fps:10,qrbox:{width:200,height:200}},
      (decodedText)=>{
        // Successfully scanned!
        document.getElementById('tradeCodeInput').value=decodedText;
        qrScanner.stop().then(()=>{
          qrScanner=null;
          container.classList.add('hidden');
          btn.innerHTML='<span>ðŸ“·</span><span>Scan QR Code</span>';
          // Auto-claim after scan
          redeemTradeCode();
        });
      },
      ()=>{} // Ignore scan errors
    );
  }catch(err){
    console.error('QR Scanner error:',err);
    container.classList.add('hidden');
    btn.innerHTML='<span>ðŸ“·</span><span>Scan QR Code</span>';
    alert('Could not access camera. Please enter the code manually.');
  }
}

async function redeemTradeCode(){
  const input=document.getElementById('tradeCodeInput');
  const code=input?.value?.trim()?.toUpperCase();

  if(!code||code.length<6){
    alert('Please enter a valid trade code');
    return;
  }

  if(!window.currentUser){
    alert('You must be signed in to receive items!');
    return;
  }

  // Show loading
  const content=document.getElementById('redeemTradeContent');
  content.innerHTML=`<div class="text-center py-8"><p class="text-white text-lg">Claiming item...</p></div>`;

  // Claim from Firebase
  const result=await window.cloudFunctions.claimTradeOffer(code);

  if(!result.success){
    content.innerHTML=`
      <div class="text-center py-8">
        <p class="text-red-300 text-lg mb-2">Failed to claim</p>
        <p class="text-white/70 text-sm mb-4">${result.error}</p>
        <button onclick="showRedeemTrade()" class="bg-white/20 text-white font-bold py-3 px-6 rounded-xl">Try Again</button>
      </div>
    `;
    return;
  }

  closeRedeemTrade();

  // Support both old format (result.buddy) and new format (result.tradeData)
  const tradeData=result.tradeData||result.buddy;
  const tradeType=tradeData?.type||(tradeData?.accessoryIdx!==undefined?'accessory':'scribby');

  // Check if it's an accessory or a Scribby
  if(tradeType==='accessory'){
    // Add accessory to inventory (handle quantity)
    const accIdx=tradeData.accessoryIdx;
    const quantity=tradeData.quantity||1;
    if(!S.inventory)S.inventory=[];
    for(let i=0;i<quantity;i++){
      S.inventory.push(accIdx);
    }
    save();

    const acc=tradeData.accessory||ACCESSORIES[accIdx];
    const qtyText=quantity>1?` Ã—${quantity}`:'';
    alert(`ðŸŽ‰ You received ${acc?.emoji||''} ${acc?.name||'an accessory'}${qtyText} from ${result.senderName}!`);
  }else{
    // Add buddy to local collection
    const buddyData=tradeData.buddy||tradeData;
    const newBuddy={...buddyData};
    newBuddy.id=Date.now();
    newBuddy.receivedDate=new Date().toISOString();
    newBuddy.tradedFrom=result.senderName||'A friend';

    S.graduatedBuddies.push(newBuddy);
    save();

    // Also save to cloud
    await window.cloudFunctions.saveGraduatedBuddy(newBuddy);

    alert(`ðŸŽ‰ You received ${newBuddy.name||newBuddy.creatureName} from ${result.senderName}! Check your collection.`);
  }

  render();
}

render();
</script>

<!-- Scribby Info Card Modal -->
<div id="scribbyCardModal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/80 backdrop-blur-sm" onclick="closeScribbyCard()">
  <div id="scribbyCardContent" class="max-w-xs mx-4" onclick="event.stopPropagation()">
  </div>
</div>

<!-- Creature Preview Modal - TCG Style -->
<div id="creaturePreviewModal" class="hidden fixed inset-0 items-center justify-center bg-black/80 backdrop-blur-sm" style="z-index:200;" onclick="closeCreaturePreview()">
  <div id="creaturePreviewCard" class="max-w-xs mx-4" onclick="event.stopPropagation()">
  </div>
</div>

<!-- Trade Terms Modal -->
<div id="tradeTermsModal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/70 backdrop-blur-sm" onclick="closeTradeTerms()">
  <div id="tradeTermsContent" class="bg-gradient-to-br from-cyan-500 via-blue-500 to-indigo-600 rounded-3xl p-5 max-w-sm mx-4 shadow-2xl" onclick="event.stopPropagation()">
  </div>
</div>

<!-- Trade QR Code Modal -->
<div id="tradeQRModal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/70 backdrop-blur-sm">
  <div id="tradeQRContent" class="bg-gradient-to-br from-cyan-500 via-blue-500 to-indigo-600 rounded-3xl p-5 max-w-sm mx-4 shadow-2xl" onclick="event.stopPropagation()">
  </div>
</div>

<!-- Redeem Trade Modal -->
<div id="redeemTradeModal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/70 backdrop-blur-sm" onclick="closeRedeemTrade()">
  <div id="redeemTradeContent" class="bg-gradient-to-br from-green-500 via-emerald-500 to-teal-600 rounded-3xl p-5 max-w-sm mx-4 shadow-2xl" onclick="event.stopPropagation()">
  </div>
</div>

</body>
</html>
